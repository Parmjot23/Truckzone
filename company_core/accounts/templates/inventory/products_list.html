{% extends 'customer_portal_base.html' %}
{% block title %}Product Library{% endblock %}

{% block content %}
<div class="page-shell">
    {% include 'inventory/partials/_inventory_nav.html' %}
    <div class="page-header">
        <div>
            <h2 class="mb-1">Product Library</h2>
            <p class="text-muted mb-0">Manage stock items, pricing, and descriptions used across invoices.</p>
        </div>
        <div class="page-toolbar">
            <a href="{% url 'accounts:inventory_products_template' %}" class="btn btn-outline-primary btn-sm">
                <i class="fa-solid fa-file-arrow-down me-1"></i> Download Excel
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importProductsModal">
                <i class="fa-solid fa-file-import me-1"></i> Import Excel
            </button>
            <a href="#addProductCard" class="btn btn-primary btn-sm">
                <i class="fa-solid fa-plus me-1"></i> Add product
            </a>
        </div>
    </div>

    <div class="surface-card p-4" id="addProductCard">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
            <div>
                <h2 class="h5 mb-1">Add a new product</h2>
                <p class="text-muted mb-0">Create reusable parts for invoices, work orders, and inventory tracking.</p>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-lg-3">
                <label for="newProductName" class="form-label">Product name</label>
                <input type="text" class="form-control" id="newProductName" placeholder="e.g. Brake pads">
            </div>
            <div class="col-lg-2">
                <label for="newProductSku" class="form-label">SKU</label>
                <input type="text" class="form-control" id="newProductSku" placeholder="Optional">
            </div>
            <div class="col-lg-2">
                <label for="newProductCategory" class="form-label">Category</label>
                <select class="form-select" id="newProductCategory">
                    <option value="">Uncategorized</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <label for="newProductSupplier" class="form-label">Supplier</label>
                <select class="form-select" id="newProductSupplier">
                    <option value="">No supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <label for="newProductBrand" class="form-label">Brand</label>
                <select class="form-select" id="newProductBrand">
                    <option value="">No brand</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <label for="newProductModel" class="form-label">Model</label>
                <select class="form-select" id="newProductModel">
                    <option value="">No model</option>
                    {% for model in models %}
                    <option value="{{ model.id }}">{{ model.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <label for="newProductVin" class="form-label">VIN</label>
                <select class="form-select" id="newProductVin">
                    <option value="">No VIN</option>
                    {% for vin in vins %}
                    <option value="{{ vin.id }}">{{ vin.vin }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-1">
                <label for="newProductItemType" class="form-label">Type</label>
                <select class="form-select" id="newProductItemType">
                    {% for value, label in item_type_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2">
                <label for="newProductLocation" class="form-label">Location</label>
                <select class="form-select" id="newProductLocation">
                    <option value="">No location</option>
                    {% for location in locations %}
                    <option value="{{ location.name }}">{{ location.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-4">
                <label for="newProductDescription" class="form-label">Description</label>
                <textarea class="form-control" id="newProductDescription" rows="2" placeholder="Add product details"></textarea>
            </div>
            <div class="col-lg-2">
                <label for="newProductCostPrice" class="form-label">Cost price</label>
                <input type="number" class="form-control" id="newProductCostPrice" placeholder="e.g. 45.00" min="0" step="0.01">
            </div>
            <div class="col-lg-2">
                <label for="newProductSalePrice" class="form-label">Sale price</label>
                <input type="number" class="form-control" id="newProductSalePrice" placeholder="Optional" min="0" step="0.01">
            </div>
            <div class="col-lg-2">
                <label for="newProductQuantity" class="form-label">On hand</label>
                <input type="number" class="form-control" id="newProductQuantity" placeholder="e.g. 10" min="0" step="1">
            </div>
            <div class="col-lg-2">
                <label for="newProductReorder" class="form-label">Reorder level</label>
                <input type="number" class="form-control" id="newProductReorder" placeholder="e.g. 2" min="0" step="1">
            </div>
            <div class="col-lg-3">
                <label for="newProductImage" class="form-label">Image</label>
                <input type="file" class="form-control" id="newProductImage" accept="image/*">
            </div>
        </div>
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mt-3">
            <button type="button" class="btn btn-primary" id="addProductButton">Add to library</button>
            <div id="newProductStatus" class="text-muted small">New entries save automatically when you add them.</div>
        </div>
    </div>

    <div class="surface-card p-4">
        <form method="get" action="{% url 'accounts:inventory_products' %}" data-live-search-form>
            <div class="row align-items-end gy-3 mb-2">
                <div class="col-md-7 col-lg-6">
                    <label for="productSearchInput" class="form-label fw-semibold">Search products</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                        <input type="search" class="form-control" id="productSearchInput" name="q" placeholder="Search name, SKU, supplier, category, brand, model, VIN, or location" value="{{ search_query }}">
                    </div>
                </div>
                <div class="col-md-5 col-lg-4 ms-lg-auto">
                    <div class="d-flex flex-column align-items-md-end gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="bulkEditButton" data-bs-toggle="modal" data-bs-target="#bulkEditModal" disabled>
                            <i class="fa-regular fa-pen-to-square me-1"></i> Edit selected
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="bulkDeleteButton" disabled>
                            <i class="fa-regular fa-trash-can me-1"></i> Delete selected
                        </button>
                        <div id="bulkDeleteStatus" class="small text-muted"></div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row g-3">
                        <div class="col-lg-4 col-md-6">
                            <label for="filterGroupSelect" class="form-label fw-semibold">Category groups</label>
                            <select id="filterGroupSelect" name="group" class="form-select" multiple size="4">
                                {% for group in category_groups %}
                                <option value="{{ group.id }}" {% if group.id|stringformat:"s" in selected_group_ids %}selected{% endif %}>{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <label for="filterCategorySelect" class="form-label fw-semibold">Categories</label>
                            <select id="filterCategorySelect" name="category" class="form-select" multiple size="4">
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if category.id|stringformat:"s" in selected_category_ids %}selected{% endif %}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <label for="filterBrandSelect" class="form-label fw-semibold">Brands</label>
                            <select id="filterBrandSelect" name="brand" class="form-select" multiple size="4">
                                {% for brand in brands %}
                                <option value="{{ brand.id }}" {% if brand.id|stringformat:"s" in selected_brand_ids %}selected{% endif %}>{{ brand.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-12 d-flex flex-wrap gap-2 align-items-center">
                            <button type="submit" class="btn btn-outline-secondary btn-sm">Apply filters</button>
                            <a href="{% url 'accounts:inventory_products' %}" class="btn btn-link btn-sm">Clear</a>
                            <span class="text-muted small">Tip: hold Ctrl (Windows) or Cmd (Mac) to select multiple filters.</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <div id="productsEmptyState" class="alert alert-info mt-4{% if products_count or search_query or selected_group_ids or selected_category_ids or selected_brand_ids %} d-none{% endif %}">
            No products yet. Add items to start tracking stock and pricing.
        </div>

        <div class="table-responsive mt-3{% if not products_count %} d-none{% endif %}" id="productsTableWrapper">
            <table class="table table-striped align-middle" id="productsTable"
                   data-save-url="{% url 'accounts:inventory_product_inline_save' %}"
                   data-delete-url-template="{% url 'accounts:inventory_product_delete' 0 %}"
                   data-bulk-update-url="{% url 'accounts:inventory_products_bulk_update' %}">
                <thead>
                    <tr>
                        <th scope="col" class="text-center" style="width: 4%;">
                            <div class="form-check mb-0">
                                <input class="form-check-input" type="checkbox" id="selectAllProducts" aria-label="Select all products">
                            </div>
                        </th>
                        <th scope="col" style="width: 8%;">Image</th>
                        <th scope="col" style="width: 16%;">Product</th>
                        <th scope="col" style="width: 18%;">Description</th>
                        <th scope="col" style="width: 13%;">Category / Supplier</th>
                        <th scope="col" style="width: 11%;">Pricing</th>
                        <th scope="col" style="width: 11%;">Stock</th>
                        <th scope="col" style="width: 11%;">Type / Location</th>
                        <th scope="col" class="text-end" style="width: 8%;">Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    {% for product in products %}
                    <tr class="product-row"
                        data-product-id="{{ product.id }}"
                        data-product-name="{{ product.name|default_if_none:''|escape }}"
                        data-product-sku="{{ product.sku|default_if_none:''|escape }}"
                        data-product-description="{{ product.description|default_if_none:''|escape }}"
                        data-product-category-id="{{ product.category_id|default_if_none:'' }}"
                        data-product-category-name="{{ product.category.name|default_if_none:''|escape }}"
                        data-product-supplier-id="{{ product.supplier_id|default_if_none:'' }}"
                        data-product-supplier-name="{{ product.supplier.name|default_if_none:''|escape }}"
                        data-product-brand-id="{{ product.brand_id|default_if_none:'' }}"
                        data-product-brand-name="{{ product.brand.name|default_if_none:''|escape }}"
                        data-product-model-id="{{ product.vehicle_model_id|default_if_none:'' }}"
                        data-product-model-name="{{ product.vehicle_model.name|default_if_none:''|escape }}"
                        data-product-vin-id="{{ product.vin_number_id|default_if_none:'' }}"
                        data-product-vin="{{ product.vin_number.vin|default_if_none:''|escape }}"
                        data-product-cost-price="{{ product.cost_price|default_if_none:'' }}"
                        data-product-sale-price="{{ product.sale_price|default_if_none:'' }}"
                        {% if product.user_id in stock_user_ids %}
                        data-product-quantity="{{ product.quantity_in_stock|default_if_none:'' }}"
                        data-product-reorder="{{ product.reorder_level|default_if_none:'' }}"
                        data-stock-visible="true"
                        {% else %}
                        data-product-quantity=""
                        data-product-reorder=""
                        data-stock-visible="false"
                        {% endif %}
                        data-product-item-type="{{ product.item_type|default_if_none:'inventory' }}"
                        data-product-location="{{ product.location|default_if_none:''|escape }}"
                        data-product-image-url="{% if product.image %}{{ product.image.url }}{% endif %}">
                        <td class="text-center align-top">
                            <div class="form-check mb-0">
                                <input type="checkbox" class="form-check-input product-select-checkbox" aria-label="Select product {{ product.name|default:'row' }}">
                            </div>
                        </td>
                        <td>
                            <div class="product-display product-image-display">
                                <div class="product-image-placeholder text-muted small">No image</div>
                                <img class="product-image-thumb d-none" alt="" loading="lazy">
                            </div>
                            <div class="product-edit d-none">
                                <input type="file" class="form-control form-control-sm product-image-input" accept="image/*">
                            </div>
                        </td>
                        <td>
                            <div class="product-display">
                                <div class="product-name-display fw-semibold"></div>
                                <div class="product-sku-display text-muted small"></div>
                            </div>
                            <div class="product-edit d-none">
                                <input type="text" class="form-control form-control-sm product-name-input" placeholder="Product name">
                                <input type="text" class="form-control form-control-sm mt-2 product-sku-input" placeholder="SKU (optional)">
                            </div>
                        </td>
                        <td>
                            <div class="product-display product-description-display text-muted small"></div>
                            <div class="product-edit d-none">
                                <textarea class="form-control form-control-sm product-description-input" rows="2" placeholder="Description"></textarea>
                            </div>
                        </td>
                        <td>
                            <div class="product-display">
                                <div class="product-category-display fw-semibold"></div>
                                <div class="product-supplier-display text-muted small"></div>
                                <div class="product-brand-display text-muted small"></div>
                                <div class="product-model-display text-muted small"></div>
                                <div class="product-vin-display text-muted small"></div>
                            </div>
                            <div class="product-edit d-none">
                                <select class="form-select form-select-sm product-category-input">
                                    <option value="">Uncategorized</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mt-2 product-supplier-input">
                                    <option value="">No supplier</option>
                                    {% for supplier in suppliers %}
                                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mt-2 product-brand-input">
                                    <option value="">No brand</option>
                                    {% for brand in brands %}
                                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mt-2 product-model-input">
                                    <option value="">No model</option>
                                    {% for model in models %}
                                    <option value="{{ model.id }}">{{ model.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mt-2 product-vin-input">
                                    <option value="">No VIN</option>
                                    {% for vin in vins %}
                                    <option value="{{ vin.id }}">{{ vin.vin }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </td>
                        <td>
                            <div class="product-display">
                                <div class="product-cost-price-display fw-semibold"></div>
                                <div class="product-sale-price-display text-muted small"></div>
                            </div>
                            <div class="product-edit d-none">
                                <input type="number" class="form-control form-control-sm product-cost-price-input" min="0" step="0.01" placeholder="Cost">
                                <input type="number" class="form-control form-control-sm mt-2 product-sale-price-input" min="0" step="0.01" placeholder="Sale (optional)">
                            </div>
                        </td>
                        <td>
                            <div class="product-display">
                                <div class="product-quantity-display fw-semibold"></div>
                                <div class="product-reorder-display text-muted small"></div>
                            </div>
                            <div class="product-edit d-none">
                                <input type="number" class="form-control form-control-sm product-quantity-input" min="0" step="1" placeholder="On hand">
                                <input type="number" class="form-control form-control-sm mt-2 product-reorder-input" min="0" step="1" placeholder="Reorder">
                            </div>
                        </td>
                        <td>
                            <div class="product-display">
                                <div class="product-item-type-display fw-semibold"></div>
                                <div class="product-location-display text-muted small"></div>
                            </div>
                            <div class="product-edit d-none">
                                <select class="form-select form-select-sm product-item-type-input">
                                    {% for value, label in item_type_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-select-sm mt-2 product-location-input">
                                    <option value="">No location</option>
                                    {% for location in locations %}
                                    <option value="{{ location.name }}">{{ location.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </td>
                        <td class="text-end align-top">
                            <div class="btn-group btn-group-sm product-view-actions" role="group" aria-label="Product actions">
                                <button type="button" class="btn btn-outline-secondary product-edit-btn">Edit</button>
                                <button type="button" class="btn btn-outline-secondary product-attributes-btn" data-bs-toggle="modal" data-bs-target="#editProductModal" data-product-id="{{ product.id }}">Attributes</button>
                                <button type="button" class="btn btn-outline-danger product-delete-btn">Delete</button>
                            </div>
                            <div class="btn-group btn-group-sm product-edit-actions d-none" role="group" aria-label="Edit actions">
                                <button type="button" class="btn btn-primary product-save-btn">Save</button>
                                <button type="button" class="btn btn-outline-secondary product-cancel-btn">Cancel</button>
                            </div>
                            <div class="row-status text-muted small mt-2" aria-live="polite"></div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="productsNoResults" class="alert alert-secondary mt-4 mb-0{% if products_count %} d-none{% elif not search_query and not selected_group_ids and not selected_category_ids and not selected_brand_ids %} d-none{% endif %}">
            No products match your filters. Try a different selection.
        </div>

        {% if products.paginator.count %}
        <nav class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3" aria-label="Products pagination">
            <div class="text-muted small">
                {{ products.start_index }}-{{ products.end_index }} of {{ products.paginator.count }}
            </div>
            <ul class="pagination mb-0">
                {% with qs=querystring %}
                {% if products.has_previous %}
                    <li class="page-item"><a class="page-link" href="?{% if qs %}{{ qs }}&{% endif %}page=1">First</a></li>
                    <li class="page-item"><a class="page-link" href="?{% if qs %}{{ qs }}&{% endif %}page={{ products.previous_page_number }}">Previous</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">First</span></li>
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}

                {% if products.has_next %}
                    <li class="page-item"><a class="page-link" href="?{% if qs %}{{ qs }}&{% endif %}page={{ products.next_page_number }}">Next</a></li>
                    <li class="page-item"><a class="page-link" href="?{% if qs %}{{ qs }}&{% endif %}page={{ products.paginator.num_pages }}">Last</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                    <li class="page-item disabled"><span class="page-link">Last</span></li>
                {% endif %}
                {% endwith %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<input type="hidden" id="inlineCsrfToken" value="{{ csrf_token }}">

<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkEditModalLabel">Bulk edit products</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-2" id="bulkEditSelectedCount">0 products selected</p>
                <p class="text-muted small mb-3">Leave fields blank to keep current values. Select "Clear" to remove a value.</p>
                <form id="bulkEditForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="bulkEditCategory" class="form-label">Category</label>
                            <select class="form-select form-select-sm" id="bulkEditCategory">
                                <option value="__keep__" selected>No change</option>
                                <option value="">Clear</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditSupplier" class="form-label">Supplier</label>
                            <select class="form-select form-select-sm" id="bulkEditSupplier">
                                <option value="__keep__" selected>No change</option>
                                <option value="">Clear</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditBrand" class="form-label">Brand</label>
                            <select class="form-select form-select-sm" id="bulkEditBrand">
                                <option value="__keep__" selected>No change</option>
                                <option value="">Clear</option>
                                {% for brand in brands %}
                                <option value="{{ brand.id }}">{{ brand.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditModel" class="form-label">Model</label>
                            <select class="form-select form-select-sm" id="bulkEditModel">
                                <option value="__keep__" selected>No change</option>
                                <option value="">Clear</option>
                                {% for model in models %}
                                <option value="{{ model.id }}">{{ model.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditVin" class="form-label">VIN</label>
                            <select class="form-select form-select-sm" id="bulkEditVin">
                                <option value="__keep__" selected>No change</option>
                                <option value="">Clear</option>
                                {% for vin in vins %}
                                <option value="{{ vin.id }}">{{ vin.vin }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditItemType" class="form-label">Type</label>
                            <select class="form-select form-select-sm" id="bulkEditItemType">
                                <option value="__keep__" selected>No change</option>
                                {% for value, label in item_type_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditLocation" class="form-label">Location</label>
                            <select class="form-select form-select-sm" id="bulkEditLocation">
                                <option value="__keep__" selected>No change</option>
                                <option value="">Clear</option>
                                {% for location in locations %}
                                <option value="{{ location.name }}">{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditCostPrice" class="form-label">Cost price</label>
                            <input type="number" class="form-control form-control-sm" id="bulkEditCostPrice" min="0" step="0.01" placeholder="Leave blank to keep">
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditSalePrice" class="form-label">Sale price</label>
                            <input type="number" class="form-control form-control-sm" id="bulkEditSalePrice" min="0" step="0.01" placeholder="Leave blank to keep">
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditQuantity" class="form-label">On hand</label>
                            <input type="number" class="form-control form-control-sm" id="bulkEditQuantity" min="0" step="1" placeholder="Leave blank to keep">
                        </div>
                        <div class="col-md-4">
                            <label for="bulkEditReorder" class="form-label">Reorder level</label>
                            <input type="number" class="form-control form-control-sm" id="bulkEditReorder" min="0" step="1" placeholder="Leave blank to keep">
                        </div>
                        <div class="col-md-8">
                            <label for="bulkEditImage" class="form-label">Image</label>
                            <input type="file" class="form-control form-control-sm" id="bulkEditImage" accept="image/*">
                        </div>
                        <div class="col-12">
                            <label for="bulkEditDescription" class="form-label">Description</label>
                            <textarea class="form-control form-control-sm" id="bulkEditDescription" rows="3" placeholder="Leave blank to keep"></textarea>
                        </div>
                    </div>
                </form>
                <div id="bulkEditStatus" class="small text-muted mt-3" aria-live="polite"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="bulkEditApplyButton">Apply changes</button>
            </div>
        </div>
    </div>
</div>

<template id="productRowTemplate">
    <tr class="product-row"
        data-product-id=""
        data-product-name=""
        data-product-sku=""
        data-product-description=""
        data-product-category-id=""
        data-product-category-name=""
        data-product-supplier-id=""
        data-product-supplier-name=""
        data-product-brand-id=""
        data-product-brand-name=""
        data-product-model-id=""
        data-product-model-name=""
        data-product-vin-id=""
        data-product-vin=""
        data-product-cost-price=""
        data-product-sale-price=""
        data-product-quantity=""
        data-product-reorder=""
        data-stock-visible="true"
        data-product-item-type="inventory"
        data-product-location=""
        data-product-image-url="">
        <td class="text-center align-top">
            <div class="form-check mb-0">
                <input type="checkbox" class="form-check-input product-select-checkbox" aria-label="Select product">
            </div>
        </td>
        <td>
            <div class="product-display product-image-display">
                <div class="product-image-placeholder text-muted small">No image</div>
                <img class="product-image-thumb d-none" alt="" loading="lazy">
            </div>
            <div class="product-edit d-none">
                <input type="file" class="form-control form-control-sm product-image-input" accept="image/*">
            </div>
        </td>
        <td>
            <div class="product-display">
                <div class="product-name-display fw-semibold"></div>
                <div class="product-sku-display text-muted small"></div>
            </div>
            <div class="product-edit d-none">
                <input type="text" class="form-control form-control-sm product-name-input" placeholder="Product name">
                <input type="text" class="form-control form-control-sm mt-2 product-sku-input" placeholder="SKU (optional)">
            </div>
        </td>
        <td>
            <div class="product-display product-description-display text-muted small"></div>
            <div class="product-edit d-none">
                <textarea class="form-control form-control-sm product-description-input" rows="2" placeholder="Description"></textarea>
            </div>
        </td>
        <td>
            <div class="product-display">
                <div class="product-category-display fw-semibold"></div>
                <div class="product-supplier-display text-muted small"></div>
                <div class="product-brand-display text-muted small"></div>
                <div class="product-model-display text-muted small"></div>
                <div class="product-vin-display text-muted small"></div>
            </div>
            <div class="product-edit d-none">
                <select class="form-select form-select-sm product-category-input">
                    <option value="">Uncategorized</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm mt-2 product-supplier-input">
                    <option value="">No supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm mt-2 product-brand-input">
                    <option value="">No brand</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}">{{ brand.name }}</option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm mt-2 product-model-input">
                    <option value="">No model</option>
                    {% for model in models %}
                    <option value="{{ model.id }}">{{ model.name }}</option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm mt-2 product-vin-input">
                    <option value="">No VIN</option>
                    {% for vin in vins %}
                    <option value="{{ vin.id }}">{{ vin.vin }}</option>
                    {% endfor %}
                </select>
            </div>
        </td>
        <td>
            <div class="product-display">
                <div class="product-cost-price-display fw-semibold"></div>
                <div class="product-sale-price-display text-muted small"></div>
            </div>
            <div class="product-edit d-none">
                <input type="number" class="form-control form-control-sm product-cost-price-input" min="0" step="0.01" placeholder="Cost">
                <input type="number" class="form-control form-control-sm mt-2 product-sale-price-input" min="0" step="0.01" placeholder="Sale (optional)">
            </div>
        </td>
        <td>
            <div class="product-display">
                <div class="product-quantity-display fw-semibold"></div>
                <div class="product-reorder-display text-muted small"></div>
            </div>
            <div class="product-edit d-none">
                <input type="number" class="form-control form-control-sm product-quantity-input" min="0" step="1" placeholder="On hand">
                <input type="number" class="form-control form-control-sm mt-2 product-reorder-input" min="0" step="1" placeholder="Reorder">
            </div>
        </td>
        <td>
            <div class="product-display">
                <div class="product-item-type-display fw-semibold"></div>
                <div class="product-location-display text-muted small"></div>
            </div>
            <div class="product-edit d-none">
                <select class="form-select form-select-sm product-item-type-input">
                    {% for value, label in item_type_choices %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
                <select class="form-select form-select-sm mt-2 product-location-input">
                    <option value="">No location</option>
                    {% for location in locations %}
                    <option value="{{ location.name }}">{{ location.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </td>
        <td class="text-end align-top">
            <div class="btn-group btn-group-sm product-view-actions" role="group" aria-label="Product actions">
                <button type="button" class="btn btn-outline-secondary product-edit-btn">Edit</button>
                <button type="button" class="btn btn-outline-secondary product-attributes-btn" data-bs-toggle="modal" data-bs-target="#editProductModal">Attributes</button>
                <button type="button" class="btn btn-outline-danger product-delete-btn">Delete</button>
            </div>
            <div class="btn-group btn-group-sm product-edit-actions d-none" role="group" aria-label="Edit actions">
                <button type="button" class="btn btn-primary product-save-btn">Save</button>
                <button type="button" class="btn btn-outline-secondary product-cancel-btn">Cancel</button>
            </div>
            <div class="row-status text-muted small mt-2" aria-live="polite"></div>
        </td>
    </tr>
</template>

<div class="modal fade" id="importProductsModal" tabindex="-1" aria-labelledby="importProductsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importProductsModalLabel">Import products from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'accounts:inventory_products_import' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'accounts:inventory_products' %}">
                <div class="modal-body">
                    <p class="small text-muted">Upload the Excel template exported from this page. Existing SKUs will be updated, and new SKUs will be created.</p>
                    <div class="mb-3">
                        <label for="id_product_import_file" class="form-label fw-semibold">Excel file</label>
                        <input type="file" class="form-control" id="id_product_import_file" name="file" accept=".xlsx,.xls">
                        <small class="form-text text-muted">Supported format: .xlsx (Microsoft Excel).</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-import me-1"></i> Import products
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade inventory-modal" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form method="post" action="{% url 'accounts:inventory_product_attributes_update' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="editProductModalLabel">Edit product attributes</h5>
                        <p class="modal-subtitle mb-0">Update category-specific details without leaving this screen.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="editProductFormContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #productsTable {
        min-width: 980px;
    }

    #productsTable td {
        vertical-align: top;
    }

    #productsTable .product-display {
        white-space: pre-wrap;
        word-break: break-word;
    }

    #productsTable .product-image-display {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 58px;
    }

    #productsTable .product-image-thumb {
        width: 56px;
        height: 56px;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
        object-fit: cover;
        background: #fff;
    }

    #productsTable .product-image-placeholder {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        border-radius: 0.5rem;
        border: 1px dashed #d7dde5;
        background: #f8f9fa;
        text-align: center;
    }

    #productsTable .product-edit textarea,
    #productsTable .product-edit input,
    #productsTable .product-edit select {
        font-size: 0.95rem;
    }

    .status-saving {
        color: var(--bs-primary, #0d6efd) !important;
    }

    .status-error {
        color: var(--bs-danger, #dc3545) !important;
    }

    .status-success {
        color: var(--bs-success, #198754) !important;
    }

    .product-select-checkbox {
        cursor: pointer;
    }

    #editProductModal .modal-dialog {
        height: calc(100vh - 2rem);
        max-height: calc(100vh - 2rem);
        display: flex;
        margin: 1rem auto;
    }

    #editProductModal .modal-content {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-radius: 18px;
        border: 1px solid rgba(226, 232, 240, 0.9);
        box-shadow: 0 24px 50px rgba(15, 23, 42, 0.2);
    }

    #editProductModal .modal-content > form {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    #editProductModal .modal-header {
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        color: #fff;
        border-bottom: none;
    }

    #editProductModal .modal-title {
        font-weight: 800;
        letter-spacing: -0.01em;
        color: inherit;
    }

    #editProductModal .modal-subtitle {
        margin: 0.15rem 0 0 0;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.85);
    }

    #editProductModal .btn-close {
        filter: invert(1);
        opacity: 0.85;
    }

    #editProductModal .modal-body {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
        padding: 1.25rem;
        background: #f8fafc;
    }

    #editProductModal .modal-footer {
        padding: 0.85rem 1.25rem;
        background: #f1f5f9;
        border-top: none;
    }

    #editProductModal .product-attributes-shell {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        padding: 1.1rem;
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.06);
    }

    #editProductModal .product-attributes-shell .row > [class*="col-"] {
        display: flex;
        flex-direction: column;
    }

    #editProductModal .product-attributes-shell .fw-semibold {
        font-weight: 700;
        color: #0f172a;
    }

    #editProductModal .product-attributes-shell label {
        margin-bottom: 0.35rem;
    }

    #editProductModal .product-attributes-shell select,
    #editProductModal .product-attributes-shell input:not([type="checkbox"]):not([type="radio"]),
    #editProductModal .product-attributes-shell textarea {
        width: 100%;
        border-radius: 0.65rem;
        border: 1px solid #d6dde6;
        padding: 0.55rem 0.75rem;
        background: #fff;
        min-height: 2.4rem;
    }

    #editProductModal .product-attributes-shell textarea {
        min-height: 4.25rem;
    }

    #editProductModal .product-attributes-shell select:focus,
    #editProductModal .product-attributes-shell input:not([type="checkbox"]):not([type="radio"]):focus,
    #editProductModal .product-attributes-shell textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.2);
        outline: none;
    }

    #editProductModal .product-attributes-shell .form-text {
        margin-top: 0.25rem;
    }

    #editProductModal .product-modal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 0.9rem 1rem;
    }

    #editProductModal .product-modal-grid .form-group {
        margin-bottom: 0;
    }

    #editProductModal .product-modal-grid .span-2 {
        grid-column: 1 / -1;
    }

    #editProductModal label {
        font-weight: 600;
        color: #0f172a;
        font-size: 0.9rem;
    }

    #editProductModal .form-control,
    #editProductModal .form-select {
        border-radius: 0.65rem;
        border-color: #d6dde6;
    }

    #editProductModal .form-control:focus,
    #editProductModal .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.2);
    }

    #editProductModal .form-text {
        font-size: 0.85rem;
    }

    #editProductModal .btn-link {
        font-weight: 600;
    }

    #editProductModal .attribute-create-actions {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
    }

    #editProductModal .attribute-create-wrapper {
        margin-top: 0.5rem;
    }

    #editProductModal .attribute-create-panel {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 14px;
        border: 1px solid #e2e8f0;
        background: #fff;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.06);
    }

    #editProductModal .attribute-create-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    #editProductModal .attribute-create-category {
        font-size: 0.85rem;
        color: #64748b;
    }

    #editProductModal .attribute-create-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem 1rem;
    }

    #editProductModal .attribute-create-span-2 {
        grid-column: 1 / -1;
    }

    #editProductModal .attribute-create-flags {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem 1.5rem;
        margin-top: 0.75rem;
    }

    #editProductModal .attribute-create-footer {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-top: 0.9rem;
    }

    #editProductModal .attribute-create-status {
        font-size: 0.85rem;
    }

    #editProductModal .attribute-field-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
    }

    #editProductModal .attribute-field-header label {
        margin-bottom: 0;
    }

    #editProductModal .attribute-edit-link {
        padding: 0;
        font-size: 0.75rem;
        font-weight: 600;
        color: #2563eb;
        text-decoration: none;
    }

    #editProductModal .attribute-edit-link:hover {
        text-decoration: underline;
    }

    #editProductModal .attribute-help {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1rem;
        height: 1rem;
        margin-left: 0.35rem;
        border-radius: 999px;
        background: #e2e8f0;
        color: #334155;
        font-size: 0.7rem;
        font-weight: 700;
        line-height: 1;
        cursor: help;
    }

    @media (max-width: 576px) {
        #editProductModal .modal-dialog {
            height: 100vh;
            max-height: 100vh;
            margin: 0;
        }

        #editProductModal .modal-content {
            border-radius: 0;
        }
    }

    @media (max-width: 991.98px) {
        #productsTable {
            min-width: 100%;
        }
    }
</style>
<script>
(function () {
    let selectAllCheckbox = null;
    let bulkDeleteButton = null;
    let bulkDeleteStatus = null;
    let bulkEditButton = null;
    let bulkEditStatus = null;
    let bulkEditApplyButton = null;
    let bulkEditSelectedCount = null;
    let currentSearchQuery = '';

    const itemTypeLabels = {
        inventory: 'Inventory',
        non_inventory: 'Non-inventory',
    };

    function getTable() {
        return document.getElementById('productsTable');
    }

    function getCsrfToken() {
        const inlineTokenInput = document.getElementById('inlineCsrfToken');
        if (inlineTokenInput && inlineTokenInput.value && inlineTokenInput.value !== 'NOTPROVIDED') {
            return inlineTokenInput.value;
        }
        const name = 'csrftoken';
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (let i = 0; i < cookies.length; i += 1) {
            const parts = cookies[i].split('=');
            const key = decodeURIComponent(parts[0]);
            if (key === name) {
                return decodeURIComponent(parts[1] || '');
            }
        }
        return '';
    }

    function buildUrl(template, id) {
        return template.replace(/\/0\//, '/' + id + '/');
    }

    function valueOrEmpty(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return String(value);
    }

    function normalizeStockVisibility(value, fallback) {
        if (value === true || value === 'true' || value === '1' || value === 1) {
            return true;
        }
        if (value === false || value === 'false' || value === '0' || value === 0) {
            return false;
        }
        if (fallback === undefined) {
            return true;
        }
        return fallback;
    }

    function getItemTypeLabel(value) {
        return itemTypeLabels[value] || 'Inventory';
    }

    function formatMoney(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numeric = Number(value);
        if (!isFinite(numeric)) {
            return String(value);
        }
        return numeric.toFixed(2);
    }

    function showStatus(target, message, state) {
        if (!target) {
            return;
        }
        target.textContent = message || '';
        target.classList.remove('status-saving', 'status-error', 'status-success');
        if (state) {
            target.classList.add('status-' + state);
        }
    }

    function fetchAttributeFields(selectEl) {
        const form = selectEl.closest('form');
        if (!form) {
            return;
        }
        const container = form.querySelector('[data-attribute-fields]');
        if (!container) {
            return;
        }
        const url = container.getAttribute('data-attribute-url');
        if (!url) {
            return;
        }
        const categoryId = selectEl.value || '';
        const productId = container.getAttribute('data-product-id') || '';
        const params = new URLSearchParams();
        params.set('category_id', categoryId);
        if (productId) {
            params.set('product_id', productId);
        }
        fetch(url + '?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('Failed to load attributes.');
                }
                return response.json();
            })
            .then(function (data) {
                container.innerHTML = data.html || '';
            })
            .catch(function () {
                // Keep existing attribute fields if the update fails.
            });
    }

    function getAttributeCreatePanel(element) {
        const form = element ? element.closest('form') : null;
        if (!form) {
            return null;
        }
        return form.querySelector('[data-attribute-create-panel]');
    }

    function getAttributeCategorySelect(element) {
        const form = element ? element.closest('form') : null;
        if (!form) {
            return null;
        }
        return form.querySelector('[data-attribute-source]');
    }

    function normalizeAttributeFlag(value) {
        return value === true || value === 'true' || value === '1' || value === 1;
    }

    function setAttributeCreateMode(panel, mode) {
        if (!panel) {
            return;
        }
        const titleEl = panel.querySelector('[data-attribute-panel-title]');
        const submitButton = panel.querySelector('[data-attribute-create-submit]');

        if (titleEl && !panel.dataset.defaultTitle) {
            panel.dataset.defaultTitle = titleEl.textContent.trim();
        }
        if (submitButton && !panel.dataset.defaultSubmitLabel) {
            panel.dataset.defaultSubmitLabel = submitButton.getAttribute('data-default-label') || submitButton.textContent.trim();
        }

        if (mode === 'edit') {
            if (titleEl) {
                titleEl.textContent = 'Edit attribute';
            }
            if (submitButton) {
                submitButton.textContent = 'Save changes';
            }
        } else {
            delete panel.dataset.editingId;
            delete panel.dataset.editingCategoryId;
            delete panel.dataset.editingCategoryName;
            if (titleEl) {
                titleEl.textContent = panel.dataset.defaultTitle || 'New attribute';
            }
            if (submitButton) {
                submitButton.textContent = panel.dataset.defaultSubmitLabel || 'Save attribute';
            }
        }
    }

    function applyAttributeEditData(panel, meta) {
        if (!panel || !meta) {
            return;
        }
        panel.dataset.editingId = meta.id || '';
        panel.dataset.editingCategoryId = meta.categoryId || '';
        panel.dataset.editingCategoryName = meta.categoryName || '';

        const nameInput = panel.querySelector('[data-attribute-create-name]');
        const typeInput = panel.querySelector('[data-attribute-create-type]');
        const optionsInput = panel.querySelector('[data-attribute-create-options]');
        const unitInput = panel.querySelector('[data-attribute-create-unit]');
        const orderInput = panel.querySelector('[data-attribute-create-order]');
        const descriptionInput = panel.querySelector('[data-attribute-create-description]');
        const filterableInput = panel.querySelector('[data-attribute-create-filterable]');
        const comparableInput = panel.querySelector('[data-attribute-create-comparable]');
        const activeInput = panel.querySelector('[data-attribute-create-active]');
        const statusTarget = panel.querySelector('[data-attribute-create-status]');

        if (nameInput) {
            nameInput.value = meta.name || '';
        }
        if (typeInput) {
            typeInput.value = meta.attributeType || 'select';
        }
        if (optionsInput) {
            optionsInput.value = meta.options || '';
        }
        if (unitInput) {
            unitInput.value = meta.unit || '';
        }
        if (orderInput) {
            orderInput.value = meta.sortOrder !== undefined && meta.sortOrder !== null ? meta.sortOrder : '';
        }
        if (descriptionInput) {
            descriptionInput.value = meta.description || '';
        }
        if (filterableInput) {
            filterableInput.checked = normalizeAttributeFlag(meta.filterable);
        }
        if (comparableInput) {
            comparableInput.checked = normalizeAttributeFlag(meta.comparable);
        }
        if (activeInput) {
            activeInput.checked = normalizeAttributeFlag(meta.active);
        }
        if (statusTarget) {
            statusTarget.textContent = 'Editing this attribute.';
            statusTarget.classList.remove('status-error', 'status-success');
        }
        setAttributeCreateOptionsVisibility(panel, typeInput ? typeInput.value : 'select');
        updateAttributeCreateCategory(panel);
    }

    function setAttributeCreateOptionsVisibility(panel, typeValue) {
        if (!panel) {
            return;
        }
        const optionsGroup = panel.querySelector('[data-attribute-create-options-group]');
        if (!optionsGroup) {
            return;
        }
        const isSelect = (typeValue || 'select') === 'select';
        optionsGroup.classList.toggle('d-none', !isSelect);
    }

    function updateAttributeCreateCategory(panel) {
        if (!panel) {
            return;
        }
        if (panel.dataset.editingId) {
            const labelTarget = panel.querySelector('[data-attribute-category-label]');
            const submitButton = panel.querySelector('[data-attribute-create-submit]');
            const categoryName = panel.dataset.editingCategoryName || 'Selected category';
            if (labelTarget) {
                labelTarget.textContent = categoryName;
            }
            if (submitButton) {
                submitButton.disabled = !panel.dataset.editingCategoryId;
            }
            return;
        }
        const categorySelect = getAttributeCategorySelect(panel);
        const labelTarget = panel.querySelector('[data-attribute-category-label]');
        const submitButton = panel.querySelector('[data-attribute-create-submit]');
        const categoryName = categorySelect && categorySelect.selectedOptions && categorySelect.selectedOptions.length
            ? (categorySelect.selectedOptions[0].textContent || '').trim()
            : '';

        if (labelTarget) {
            labelTarget.textContent = categoryName || 'Choose a category above';
        }
        if (submitButton) {
            submitButton.disabled = !(categorySelect && categorySelect.value);
        }
    }

    function initializeAttributeCreatePanel(container) {
        const panel = container ? container.querySelector('[data-attribute-create-panel]') : null;
        if (!panel) {
            return;
        }
        setAttributeCreateMode(panel, 'create');
        const typeInput = panel.querySelector('[data-attribute-create-type]');
        setAttributeCreateOptionsVisibility(panel, typeInput ? typeInput.value : 'select');
        updateAttributeCreateCategory(panel);
    }

    function resetAttributeCreatePanel(panel) {
        if (!panel) {
            return;
        }
        const nameInput = panel.querySelector('[data-attribute-create-name]');
        const typeInput = panel.querySelector('[data-attribute-create-type]');
        const optionsInput = panel.querySelector('[data-attribute-create-options]');
        const unitInput = panel.querySelector('[data-attribute-create-unit]');
        const orderInput = panel.querySelector('[data-attribute-create-order]');
        const descriptionInput = panel.querySelector('[data-attribute-create-description]');
        const filterableInput = panel.querySelector('[data-attribute-create-filterable]');
        const comparableInput = panel.querySelector('[data-attribute-create-comparable]');
        const activeInput = panel.querySelector('[data-attribute-create-active]');

        if (nameInput) {
            nameInput.value = '';
        }
        if (typeInput) {
            typeInput.value = 'select';
        }
        if (optionsInput) {
            optionsInput.value = '';
        }
        if (unitInput) {
            unitInput.value = '';
        }
        if (orderInput) {
            orderInput.value = '';
        }
        if (descriptionInput) {
            descriptionInput.value = '';
        }
        if (filterableInput) {
            filterableInput.checked = true;
        }
        if (comparableInput) {
            comparableInput.checked = false;
        }
        if (activeInput) {
            activeInput.checked = true;
        }
        setAttributeCreateOptionsVisibility(panel, typeInput ? typeInput.value : 'select');
    }

    function toggleAttributeCreatePanel(panel, shouldOpen) {
        if (!panel) {
            return;
        }
        const isHidden = panel.classList.contains('d-none');
        const openPanel = shouldOpen === undefined ? isHidden : shouldOpen;
        panel.classList.toggle('d-none', !openPanel);
        if (openPanel) {
            updateAttributeCreateCategory(panel);
            const typeInput = panel.querySelector('[data-attribute-create-type]');
            setAttributeCreateOptionsVisibility(panel, typeInput ? typeInput.value : 'select');
            const nameInput = panel.querySelector('[data-attribute-create-name]');
            if (nameInput) {
                nameInput.focus();
            }
        }
    }

    function handleAttributeCreateSubmit(panel) {
        if (!panel) {
            return;
        }
        const editingId = panel.dataset.editingId || '';
        const categorySelect = getAttributeCategorySelect(panel);
        const nameInput = panel.querySelector('[data-attribute-create-name]');
        const typeInput = panel.querySelector('[data-attribute-create-type]');
        const optionsInput = panel.querySelector('[data-attribute-create-options]');
        const unitInput = panel.querySelector('[data-attribute-create-unit]');
        const orderInput = panel.querySelector('[data-attribute-create-order]');
        const descriptionInput = panel.querySelector('[data-attribute-create-description]');
        const filterableInput = panel.querySelector('[data-attribute-create-filterable]');
        const comparableInput = panel.querySelector('[data-attribute-create-comparable]');
        const activeInput = panel.querySelector('[data-attribute-create-active]');
        const statusTarget = panel.querySelector('[data-attribute-create-status]');
        const saveUrl = panel.getAttribute('data-save-url');
        const categoryId = editingId ? (panel.dataset.editingCategoryId || '') : (categorySelect ? categorySelect.value : '');

        if (!categoryId) {
            showStatus(statusTarget, 'Select a category first.', 'error');
            return;
        }
        if (!nameInput || !(nameInput.value || '').trim()) {
            showStatus(statusTarget, 'Attribute name is required.', 'error');
            if (nameInput) {
                nameInput.focus();
            }
            return;
        }
        if (!saveUrl) {
            showStatus(statusTarget, 'Save endpoint is not available.', 'error');
            return;
        }

        const attributeType = typeInput ? typeInput.value : 'select';
        const payload = {
            name: (nameInput.value || '').trim(),
            description: (descriptionInput && descriptionInput.value ? descriptionInput.value : '').trim(),
            value_unit: (unitInput && unitInput.value ? unitInput.value : '').trim(),
            category_id: categoryId,
            attribute_type: attributeType || 'select',
            sort_order: orderInput && orderInput.value ? orderInput.value : 0,
            is_filterable: filterableInput ? filterableInput.checked : true,
            is_comparable: comparableInput ? comparableInput.checked : false,
            is_active: activeInput ? activeInput.checked : true,
            options: attributeType === 'select' && optionsInput ? (optionsInput.value || '') : '',
        };
        if (editingId) {
            payload.id = editingId;
        }

        showStatus(statusTarget, 'Saving...', 'saving');
        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify(payload),
        })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        throw data;
                    });
                }
                return response.json();
            })
            .then(function () {
                if (editingId) {
                    showStatus(statusTarget, 'Changes saved.', 'success');
                } else {
                    resetAttributeCreatePanel(panel);
                    updateAttributeCreateCategory(panel);
                    showStatus(statusTarget, 'Saved. Add another attribute when you are ready.', 'success');
                }
                if (categorySelect) {
                    fetchAttributeFields(categorySelect);
                }
            })
            .catch(function (errorData) {
                const message = errorData && errorData.errors
                    ? Object.values(errorData.errors).flat().join(' ')
                    : 'Could not save this attribute.';
                showStatus(statusTarget, message, 'error');
            });
    }

    function normalizeProduct(raw) {
        const category = raw.category || {};
        const supplier = raw.supplier || {};
        const brand = raw.brand || {};
        const model = raw.vehicle_model || raw.model || {};
        const vin = raw.vin_number || raw.vin || {};
        return {
            id: valueOrEmpty(raw.id),
            name: valueOrEmpty(raw.name),
            sku: valueOrEmpty(raw.sku),
            description: valueOrEmpty(raw.description),
            category_id: valueOrEmpty(raw.category_id || category.id),
            category_name: valueOrEmpty(raw.category_name || category.name),
            supplier_id: valueOrEmpty(raw.supplier_id || supplier.id),
            supplier_name: valueOrEmpty(raw.supplier_name || supplier.name),
            brand_id: valueOrEmpty(raw.brand_id || brand.id),
            brand_name: valueOrEmpty(raw.brand_name || brand.name),
            model_id: valueOrEmpty(raw.vehicle_model_id || raw.model_id || model.id),
            model_name: valueOrEmpty(raw.vehicle_model_name || raw.model_name || model.name),
            vin_id: valueOrEmpty(raw.vin_number_id || raw.vin_id || vin.id),
            vin_value: valueOrEmpty(raw.vin_number || raw.vin_value || vin.vin),
            cost_price: valueOrEmpty(raw.cost_price),
            sale_price: valueOrEmpty(raw.sale_price),
            quantity_in_stock: valueOrEmpty(raw.quantity_in_stock),
            reorder_level: valueOrEmpty(raw.reorder_level),
            stock_visible: normalizeStockVisibility(raw.stock_visible, true),
            item_type: valueOrEmpty(raw.item_type) || 'inventory',
            image_url: valueOrEmpty(raw.image_url || raw.imageUrl),
            location: valueOrEmpty(raw.location),
        };
    }

    function getProductFromRow(row) {
        return normalizeProduct({
            id: row.dataset.productId,
            name: row.dataset.productName,
            sku: row.dataset.productSku,
            description: row.dataset.productDescription,
            category_id: row.dataset.productCategoryId,
            category_name: row.dataset.productCategoryName,
            supplier_id: row.dataset.productSupplierId,
            supplier_name: row.dataset.productSupplierName,
            brand_id: row.dataset.productBrandId,
            brand_name: row.dataset.productBrandName,
            model_id: row.dataset.productModelId,
            model_name: row.dataset.productModelName,
            vin_id: row.dataset.productVinId,
            vin_value: row.dataset.productVin,
            cost_price: row.dataset.productCostPrice,
            sale_price: row.dataset.productSalePrice,
            quantity_in_stock: row.dataset.productQuantity,
            reorder_level: row.dataset.productReorder,
            stock_visible: row.dataset.stockVisible,
            item_type: row.dataset.productItemType,
            image_url: row.dataset.productImageUrl,
            location: row.dataset.productLocation,
        });
    }

    function applyProductToRow(row, rawProduct) {
        if (!row) {
            return;
        }
        const product = normalizeProduct(rawProduct || {});
        row.dataset.productId = product.id || '';
        row.dataset.productName = product.name || '';
        row.dataset.productSku = product.sku || '';
        row.dataset.productDescription = product.description || '';
        row.dataset.productCategoryId = product.category_id || '';
        row.dataset.productCategoryName = product.category_name || '';
        row.dataset.productSupplierId = product.supplier_id || '';
        row.dataset.productSupplierName = product.supplier_name || '';
        row.dataset.productBrandId = product.brand_id || '';
        row.dataset.productBrandName = product.brand_name || '';
        row.dataset.productModelId = product.model_id || '';
        row.dataset.productModelName = product.model_name || '';
        row.dataset.productVinId = product.vin_id || '';
        row.dataset.productVin = product.vin_value || '';
        const stockVisible = normalizeStockVisibility(product.stock_visible, true);
        row.dataset.productCostPrice = product.cost_price || '';
        row.dataset.productSalePrice = product.sale_price || '';
        row.dataset.productQuantity = stockVisible ? (product.quantity_in_stock || '0') : '';
        row.dataset.productReorder = stockVisible ? (product.reorder_level || '0') : '';
        row.dataset.stockVisible = stockVisible ? 'true' : 'false';
        row.dataset.productItemType = product.item_type || 'inventory';
        row.dataset.productImageUrl = product.image_url || '';
        row.dataset.productLocation = product.location || '';

        const nameDisplay = row.querySelector('.product-name-display');
        const skuDisplay = row.querySelector('.product-sku-display');
        const descriptionDisplay = row.querySelector('.product-description-display');
        const categoryDisplay = row.querySelector('.product-category-display');
        const supplierDisplay = row.querySelector('.product-supplier-display');
        const brandDisplay = row.querySelector('.product-brand-display');
        const modelDisplay = row.querySelector('.product-model-display');
        const vinDisplay = row.querySelector('.product-vin-display');
        const costDisplay = row.querySelector('.product-cost-price-display');
        const saleDisplay = row.querySelector('.product-sale-price-display');
        const quantityDisplay = row.querySelector('.product-quantity-display');
        const reorderDisplay = row.querySelector('.product-reorder-display');
        const itemTypeDisplay = row.querySelector('.product-item-type-display');
        const locationDisplay = row.querySelector('.product-location-display');
        const imagePlaceholder = row.querySelector('.product-image-placeholder');
        const imageThumb = row.querySelector('.product-image-thumb');

        if (nameDisplay) {
            nameDisplay.textContent = product.name || 'Untitled product';
        }
        if (skuDisplay) {
            skuDisplay.textContent = product.sku ? 'SKU: ' + product.sku : 'No SKU';
        }
        if (descriptionDisplay) {
            descriptionDisplay.textContent = product.description || 'No description';
        }
        if (categoryDisplay) {
            categoryDisplay.textContent = product.category_name || 'Uncategorized';
        }
        if (supplierDisplay) {
            supplierDisplay.textContent = product.supplier_name || 'No supplier';
        }
        if (brandDisplay) {
            brandDisplay.textContent = product.brand_name ? 'Brand: ' + product.brand_name : 'No brand';
        }
        if (modelDisplay) {
            modelDisplay.textContent = product.model_name ? 'Model: ' + product.model_name : 'No model';
        }
        if (vinDisplay) {
            vinDisplay.textContent = product.vin_value ? 'VIN: ' + product.vin_value : 'No VIN';
        }
        if (costDisplay) {
            const costValue = formatMoney(product.cost_price);
            costDisplay.textContent = costValue ? 'Cost: ' + costValue : 'Cost: -';
        }
        if (saleDisplay) {
            const saleValue = formatMoney(product.sale_price);
            saleDisplay.textContent = saleValue ? 'Sale: ' + saleValue : 'Sale: -';
        }
        if (quantityDisplay) {
            quantityDisplay.textContent = stockVisible
                ? 'On hand: ' + (product.quantity_in_stock || '0')
                : 'On hand: --';
        }
        if (reorderDisplay) {
            reorderDisplay.textContent = stockVisible
                ? 'Reorder: ' + (product.reorder_level || '0')
                : 'Reorder: --';
        }
        if (itemTypeDisplay) {
            itemTypeDisplay.textContent = getItemTypeLabel(product.item_type);
        }
        if (locationDisplay) {
            locationDisplay.textContent = product.location ? 'Location: ' + product.location : 'No location';
        }
        if (imageThumb) {
            if (product.image_url) {
                imageThumb.src = product.image_url;
                imageThumb.alt = product.name ? product.name + ' image' : 'Product image';
                imageThumb.classList.remove('d-none');
            } else {
                imageThumb.removeAttribute('src');
                imageThumb.alt = '';
                imageThumb.classList.add('d-none');
            }
        }
        if (imagePlaceholder) {
            imagePlaceholder.classList.toggle('d-none', Boolean(product.image_url));
        }

        const nameInput = row.querySelector('.product-name-input');
        const skuInput = row.querySelector('.product-sku-input');
        const descriptionInput = row.querySelector('.product-description-input');
        const categoryInput = row.querySelector('.product-category-input');
        const supplierInput = row.querySelector('.product-supplier-input');
        const brandInput = row.querySelector('.product-brand-input');
        const modelInput = row.querySelector('.product-model-input');
        const vinInput = row.querySelector('.product-vin-input');
        const costInput = row.querySelector('.product-cost-price-input');
        const saleInput = row.querySelector('.product-sale-price-input');
        const quantityInput = row.querySelector('.product-quantity-input');
        const reorderInput = row.querySelector('.product-reorder-input');
        const itemTypeInput = row.querySelector('.product-item-type-input');
        const locationInput = row.querySelector('.product-location-input');
        const imageInput = row.querySelector('.product-image-input');
        const attributesButton = row.querySelector('.product-attributes-btn');

        if (nameInput) {
            nameInput.value = product.name || '';
        }
        if (skuInput) {
            skuInput.value = product.sku || '';
        }
        if (descriptionInput) {
            descriptionInput.value = product.description || '';
        }
        if (categoryInput) {
            categoryInput.value = product.category_id || '';
        }
        if (supplierInput) {
            supplierInput.value = product.supplier_id || '';
        }
        if (brandInput) {
            brandInput.value = product.brand_id || '';
        }
        if (modelInput) {
            modelInput.value = product.model_id || '';
        }
        if (vinInput) {
            vinInput.value = product.vin_id || '';
        }
        if (costInput) {
            costInput.value = product.cost_price || '';
        }
        if (saleInput) {
            saleInput.value = product.sale_price || '';
        }
        if (quantityInput) {
            quantityInput.value = stockVisible ? (product.quantity_in_stock || '0') : '';
            quantityInput.disabled = !stockVisible;
        }
        if (reorderInput) {
            reorderInput.value = stockVisible ? (product.reorder_level || '0') : '';
            reorderInput.disabled = !stockVisible;
        }
        if (itemTypeInput) {
            itemTypeInput.value = product.item_type || 'inventory';
        }
        if (locationInput) {
            locationInput.value = product.location || '';
        }
        if (imageInput) {
            imageInput.value = '';
        }
        if (attributesButton) {
            if (product.id) {
                attributesButton.setAttribute('data-product-id', product.id);
                attributesButton.disabled = false;
            } else {
                attributesButton.removeAttribute('data-product-id');
                attributesButton.disabled = true;
            }
        }

        const searchText = [
            product.name,
            product.sku,
            product.description,
            product.category_name,
            product.supplier_name,
            product.brand_name,
            product.model_name,
            product.vin_value,
            product.location,
            getItemTypeLabel(product.item_type),
        ]
            .filter(Boolean)
            .join(' ')
            .toLowerCase();
        row.dataset.searchText = searchText;
    }

    function toggleRowMode(row, isEditing) {
        row.querySelectorAll('.product-display').forEach(function (el) {
            el.classList.toggle('d-none', isEditing);
        });
        row.querySelectorAll('.product-edit').forEach(function (el) {
            el.classList.toggle('d-none', !isEditing);
        });
        const viewActions = row.querySelector('.product-view-actions');
        const editActions = row.querySelector('.product-edit-actions');
        if (viewActions) {
            viewActions.classList.toggle('d-none', isEditing);
        }
        if (editActions) {
            editActions.classList.toggle('d-none', !isEditing);
        }
    }

    function enterEditMode(row) {
        toggleRowMode(row, true);
    }

    function exitEditMode(row, revertChanges) {
        if (revertChanges) {
            applyProductToRow(row, getProductFromRow(row));
        }
        toggleRowMode(row, false);
    }

    function getVisibleRowCheckboxes() {
        return Array.from(document.querySelectorAll('.product-row:not(.d-none) .product-select-checkbox'));
    }

    function hasActiveFilters() {
        const groupSelect = document.getElementById('filterGroupSelect');
        const categorySelect = document.getElementById('filterCategorySelect');
        const brandSelect = document.getElementById('filterBrandSelect');
        const hasGroup = groupSelect && groupSelect.selectedOptions && groupSelect.selectedOptions.length > 0;
        const hasCategory = categorySelect && categorySelect.selectedOptions && categorySelect.selectedOptions.length > 0;
        const hasBrand = brandSelect && brandSelect.selectedOptions && brandSelect.selectedOptions.length > 0;
        return hasGroup || hasCategory || hasBrand;
    }

    function updateBulkSelectionUi() {
        const visibleCheckboxes = getVisibleRowCheckboxes();
        const selectedCheckboxes = visibleCheckboxes.filter(function (checkbox) {
            return checkbox.checked;
        });
        const selectedRows = getSelectedRows();
        if (selectAllCheckbox) {
            if (!visibleCheckboxes.length) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCheckboxes.length === visibleCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        if (bulkDeleteButton) {
            bulkDeleteButton.disabled = selectedCheckboxes.length === 0;
        }
        if (bulkEditButton) {
            bulkEditButton.disabled = selectedRows.length === 0;
        }
        if (bulkEditSelectedCount) {
            const count = selectedRows.length;
            bulkEditSelectedCount.textContent = count === 1
                ? '1 product selected'
                : count + ' products selected';
        }
    }

    function toggleEmptyState() {
        const rows = document.querySelectorAll('.product-row');
        const emptyState = document.getElementById('productsEmptyState');
        const tableWrapper = document.getElementById('productsTableWrapper');
        const hasRows = rows.length > 0;
        const showEmptyState = !hasRows && !currentSearchQuery && !hasActiveFilters();
        if (emptyState) {
            emptyState.classList.toggle('d-none', !showEmptyState);
        }
        if (tableWrapper) {
            tableWrapper.classList.toggle('d-none', !hasRows);
        }
        if (!hasRows && !currentSearchQuery) {
            const noResults = document.getElementById('productsNoResults');
            if (noResults) {
                noResults.classList.add('d-none');
            }
        }
    }

    function filterProducts(query) {
        const normalized = (query || '').trim().toLowerCase();
        const rows = document.querySelectorAll('.product-row');
        let visibleCount = 0;
        rows.forEach(function (row) {
            const searchText = row.dataset.searchText || '';
            const matchesText = !normalized || searchText.includes(normalized);
            if (matchesText) {
                row.classList.remove('d-none');
                visibleCount += 1;
            } else {
                row.classList.add('d-none');
            }
        });
        const noResults = document.getElementById('productsNoResults');
        const filtersActive = hasActiveFilters();
        if (noResults) {
            if ((normalized || filtersActive) && visibleCount === 0) {
                noResults.classList.remove('d-none');
            } else {
                noResults.classList.add('d-none');
            }
        }
        updateBulkSelectionUi();
    }

    function createRowElement(product) {
        const template = document.getElementById('productRowTemplate');
        if (!template || !template.content || !template.content.firstElementChild) {
            return null;
        }
        const row = template.content.firstElementChild.cloneNode(true);
        attachRowEvents(row);
        applyProductToRow(row, product);
        return row;
    }

    function insertProductRow(product) {
        const tbody = document.getElementById('productsTableBody');
        if (!tbody) {
            return;
        }
        const row = createRowElement(product);
        if (!row) {
            return;
        }
        tbody.insertBefore(row, tbody.firstChild);
        toggleEmptyState();
        filterProducts(currentSearchQuery);
        updateBulkSelectionUi();
    }

    function deleteRow(row, opts) {
        const table = getTable();
        if (!table) {
            return;
        }
        const statusTarget = row.querySelector('.row-status');
        const productId = row.dataset.productId;
        const shouldConfirm = opts && opts.confirm === false ? false : true;
        const onSuccess = opts && typeof opts.onSuccess === 'function' ? opts.onSuccess : null;
        const onError = opts && typeof opts.onError === 'function' ? opts.onError : null;

        if (!productId) {
            row.remove();
            toggleEmptyState();
            filterProducts(currentSearchQuery);
            updateBulkSelectionUi();
            if (onSuccess) {
                onSuccess();
            }
            return;
        }
        if (shouldConfirm && !confirm('Remove this product?')) {
            return;
        }
        showStatus(statusTarget, 'Deleting...', 'saving');
        fetch(buildUrl(table.dataset.deleteUrlTemplate, productId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('Failed to delete product.');
                }
                row.remove();
                toggleEmptyState();
                filterProducts(currentSearchQuery);
                updateBulkSelectionUi();
                if (onSuccess) {
                    onSuccess();
                }
            })
            .catch(function () {
                showStatus(statusTarget, 'Could not delete this product. Try again.', 'error');
                updateBulkSelectionUi();
                if (onError) {
                    onError();
                }
            });
    }

    function getSelectedRows() {
        return Array.from(document.querySelectorAll('.product-row')).filter(function (row) {
            const checkbox = row.querySelector('.product-select-checkbox');
            return checkbox && checkbox.checked;
        });
    }

    function bulkDeleteSelectedRows() {
        const selectedRows = getSelectedRows();
        if (!selectedRows.length) {
            return;
        }
        const message = selectedRows.length === 1
            ? 'Remove the selected product?'
            : 'Remove the ' + selectedRows.length + ' selected products?';
        if (!confirm(message)) {
            return;
        }
        if (bulkDeleteStatus) {
            showStatus(bulkDeleteStatus, 'Deleting...', 'saving');
        }
        let remaining = selectedRows.length;
        let errorCount = 0;

        function finalize(success) {
            remaining -= 1;
            if (!success) {
                errorCount += 1;
            }
            if (remaining === 0) {
                if (bulkDeleteStatus) {
                    if (errorCount === 0) {
                        showStatus(bulkDeleteStatus, 'Selected products deleted.', 'success');
                    } else if (errorCount === selectedRows.length) {
                        showStatus(bulkDeleteStatus, 'Could not delete the selected products. Try again.', 'error');
                    } else {
                        showStatus(bulkDeleteStatus, 'Some products could not be deleted. Try again.', 'error');
                    }
                }
                updateBulkSelectionUi();
            }
        }

        selectedRows.forEach(function (row) {
            deleteRow(row, {
                confirm: false,
                onSuccess: function () {
                    finalize(true);
                },
                onError: function () {
                    finalize(false);
                },
            });
        });
    }

    function appendFormValue(formData, key, value) {
        if (value === null || value === undefined) {
            return false;
        }
        formData.append(key, value);
        return true;
    }

    function buildBulkEditFormData(selectedRows) {
        const formData = new FormData();
        selectedRows.forEach(function (row) {
            const productId = row.dataset.productId;
            if (productId) {
                formData.append('product_ids', productId);
            }
        });

        let hasUpdates = false;
        const categorySelect = document.getElementById('bulkEditCategory');
        if (categorySelect && categorySelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'category_id', categorySelect.value) || hasUpdates;
        }
        const supplierSelect = document.getElementById('bulkEditSupplier');
        if (supplierSelect && supplierSelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'supplier_id', supplierSelect.value) || hasUpdates;
        }
        const brandSelect = document.getElementById('bulkEditBrand');
        if (brandSelect && brandSelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'brand_id', brandSelect.value) || hasUpdates;
        }
        const modelSelect = document.getElementById('bulkEditModel');
        if (modelSelect && modelSelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'vehicle_model_id', modelSelect.value) || hasUpdates;
        }
        const vinSelect = document.getElementById('bulkEditVin');
        if (vinSelect && vinSelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'vin_number_id', vinSelect.value) || hasUpdates;
        }
        const typeSelect = document.getElementById('bulkEditItemType');
        if (typeSelect && typeSelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'item_type', typeSelect.value) || hasUpdates;
        }
        const locationSelect = document.getElementById('bulkEditLocation');
        if (locationSelect && locationSelect.value !== '__keep__') {
            hasUpdates = appendFormValue(formData, 'location', locationSelect.value) || hasUpdates;
        }

        const descriptionInput = document.getElementById('bulkEditDescription');
        const descriptionValue = descriptionInput ? descriptionInput.value.trim() : '';
        if (descriptionValue !== '') {
            hasUpdates = appendFormValue(formData, 'description', descriptionValue) || hasUpdates;
        }

        const costInput = document.getElementById('bulkEditCostPrice');
        const costValue = costInput ? costInput.value.trim() : '';
        if (costValue !== '') {
            hasUpdates = appendFormValue(formData, 'cost_price', costValue) || hasUpdates;
        }

        const saleInput = document.getElementById('bulkEditSalePrice');
        const saleValue = saleInput ? saleInput.value.trim() : '';
        if (saleValue !== '') {
            hasUpdates = appendFormValue(formData, 'sale_price', saleValue) || hasUpdates;
        }

        const quantityInput = document.getElementById('bulkEditQuantity');
        const quantityValue = quantityInput ? quantityInput.value.trim() : '';
        if (quantityValue !== '') {
            hasUpdates = appendFormValue(formData, 'quantity_in_stock', quantityValue) || hasUpdates;
        }

        const reorderInput = document.getElementById('bulkEditReorder');
        const reorderValue = reorderInput ? reorderInput.value.trim() : '';
        if (reorderValue !== '') {
            hasUpdates = appendFormValue(formData, 'reorder_level', reorderValue) || hasUpdates;
        }

        const imageInput = document.getElementById('bulkEditImage');
        if (imageInput && imageInput.files && imageInput.files.length) {
            formData.append('image', imageInput.files[0]);
            hasUpdates = true;
        }

        return { formData: formData, hasUpdates: hasUpdates };
    }

    function resetBulkEditForm() {
        const form = document.getElementById('bulkEditForm');
        if (form) {
            form.reset();
        }
        if (bulkEditStatus) {
            showStatus(bulkEditStatus, '', null);
        }
    }

    function collectErrorMessages(errorPayload) {
        if (!errorPayload) {
            return '';
        }
        if (typeof errorPayload === 'string') {
            return errorPayload;
        }
        const values = Array.isArray(errorPayload) ? errorPayload : Object.values(errorPayload);
        const messages = [];
        values.forEach(function (entry) {
            if (!entry) {
                return;
            }
            if (typeof entry === 'string') {
                messages.push(entry);
                return;
            }
            if (Array.isArray(entry)) {
                entry.forEach(function (item) {
                    if (item) {
                        messages.push(item);
                    }
                });
                return;
            }
            if (typeof entry === 'object') {
                Object.values(entry).forEach(function (item) {
                    if (!item) {
                        return;
                    }
                    if (Array.isArray(item)) {
                        item.forEach(function (inner) {
                            if (inner) {
                                messages.push(inner);
                            }
                        });
                    } else if (typeof item === 'string') {
                        messages.push(item);
                    }
                });
            }
        });
        return messages.join(' ');
    }

    function applyBulkEdit() {
        const table = getTable();
        if (!table || !table.dataset.bulkUpdateUrl) {
            return;
        }
        const selectedRows = getSelectedRows();
        if (!selectedRows.length) {
            showStatus(bulkEditStatus, 'Select at least one product.', 'error');
            return;
        }
        const payload = buildBulkEditFormData(selectedRows);
        if (!payload.hasUpdates) {
            showStatus(bulkEditStatus, 'Choose at least one field to update.', 'error');
            return;
        }
        showStatus(bulkEditStatus, 'Updating selected products...', 'saving');
        if (bulkEditApplyButton) {
            bulkEditApplyButton.disabled = true;
        }
        fetch(table.dataset.bulkUpdateUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: payload.formData,
        })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        throw data;
                    });
                }
                return response.json();
            })
            .then(function (data) {
                const updated = data && data.products ? data.products : [];
                const updatedMap = new Map(
                    updated.map(function (product) {
                        return [String(product.id), product];
                    })
                );
                selectedRows.forEach(function (row) {
                    const update = updatedMap.get(row.dataset.productId);
                    if (update) {
                        applyProductToRow(row, update);
                        exitEditMode(row, false);
                    }
                });
                showStatus(
                    bulkEditStatus,
                    'Updated ' + updated.length + ' product' + (updated.length === 1 ? '' : 's') + '.',
                    'success'
                );
                resetBulkEditForm();
                updateBulkSelectionUi();
            })
            .catch(function (errorData) {
                const message = collectErrorMessages(errorData && (errorData.errors || errorData.error))
                    || 'Could not update selected products.';
                showStatus(bulkEditStatus, message, 'error');
            })
            .finally(function () {
                if (bulkEditApplyButton) {
                    bulkEditApplyButton.disabled = false;
                }
            });
    }

    function collectRowPayload(row) {
        const stockVisible = normalizeStockVisibility(row.dataset.stockVisible, true);
        const payload = {
            id: row.dataset.productId || null,
            name: (row.querySelector('.product-name-input')?.value || '').trim(),
            sku: (row.querySelector('.product-sku-input')?.value || '').trim(),
            description: (row.querySelector('.product-description-input')?.value || '').trim(),
            category_id: row.querySelector('.product-category-input')?.value || '',
            supplier_id: row.querySelector('.product-supplier-input')?.value || '',
            brand_id: row.querySelector('.product-brand-input')?.value || '',
            vehicle_model_id: row.querySelector('.product-model-input')?.value || '',
            vin_number_id: row.querySelector('.product-vin-input')?.value || '',
            cost_price: (row.querySelector('.product-cost-price-input')?.value || '').trim(),
            sale_price: (row.querySelector('.product-sale-price-input')?.value || '').trim(),
            quantity_in_stock: (row.querySelector('.product-quantity-input')?.value || '').trim(),
            reorder_level: (row.querySelector('.product-reorder-input')?.value || '').trim(),
            item_type: row.querySelector('.product-item-type-input')?.value || 'inventory',
            location: row.querySelector('.product-location-input')?.value || '',
        };
        if (!stockVisible) {
            payload.quantity_in_stock = null;
            payload.reorder_level = null;
        }
        return payload;
    }

    function getImageFile(input) {
        if (!input || !input.files || !input.files.length) {
            return null;
        }
        return input.files[0];
    }

    function buildFormData(payload, imageFile) {
        const formData = new FormData();
        Object.keys(payload).forEach(function (key) {
            if (payload[key] === null || payload[key] === undefined) {
                return;
            }
            formData.append(key, payload[key]);
        });
        if (imageFile) {
            formData.append('image', imageFile);
        }
        return formData;
    }

    function validatePayload(payload, statusTarget, stockVisible) {
        if (!payload.name) {
            showStatus(statusTarget, 'Product name is required.', 'error');
            return false;
        }
        if (!payload.cost_price) {
            showStatus(statusTarget, 'Cost price is required.', 'error');
            return false;
        }
        const costValue = Number(payload.cost_price);
        if (!isFinite(costValue) || costValue < 0) {
            showStatus(statusTarget, 'Cost price must be a non-negative number.', 'error');
            return false;
        }
        if (payload.sale_price) {
            const saleValue = Number(payload.sale_price);
            if (!isFinite(saleValue) || saleValue < 0) {
                showStatus(statusTarget, 'Sale price must be a non-negative number.', 'error');
                return false;
            }
        }
        if (stockVisible && payload.quantity_in_stock) {
            const quantityValue = Number(payload.quantity_in_stock);
            if (!Number.isInteger(quantityValue) || quantityValue < 0) {
                showStatus(statusTarget, 'On hand must be a non-negative whole number.', 'error');
                return false;
            }
        }
        if (stockVisible && payload.reorder_level) {
            const reorderValue = Number(payload.reorder_level);
            if (!Number.isInteger(reorderValue) || reorderValue < 0) {
                showStatus(statusTarget, 'Reorder level must be a non-negative whole number.', 'error');
                return false;
            }
        }
        return true;
    }

    function saveRow(row) {
        const table = getTable();
        if (!table) {
            return;
        }
        const statusTarget = row.querySelector('.row-status');
        const stockVisible = normalizeStockVisibility(row.dataset.stockVisible, true);
        const payload = collectRowPayload(row);
        const imageFile = getImageFile(row.querySelector('.product-image-input'));
        if (!validatePayload(payload, statusTarget, stockVisible)) {
            return;
        }
        showStatus(statusTarget, 'Saving...', 'saving');
        const formData = buildFormData(payload, imageFile);
        fetch(table.dataset.saveUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
        })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        throw data;
                    });
                }
                return response.json();
            })
            .then(function (data) {
                applyProductToRow(row, data.product);
                exitEditMode(row, false);
                showStatus(statusTarget, 'Saved.', 'success');
                filterProducts(currentSearchQuery);
            })
            .catch(function (errorData) {
                const message = errorData && errorData.errors
                    ? Object.values(errorData.errors).flat().join(' ')
                    : 'Could not save this product.';
                showStatus(statusTarget, message, 'error');
            });
    }

    function attachRowEvents(row) {
        if (!row || row.dataset.initialized === 'true') {
            return;
        }
        row.dataset.initialized = 'true';
        const editButton = row.querySelector('.product-edit-btn');
        const cancelButton = row.querySelector('.product-cancel-btn');
        const saveButton = row.querySelector('.product-save-btn');
        const deleteButton = row.querySelector('.product-delete-btn');
        const selectCheckbox = row.querySelector('.product-select-checkbox');
        if (editButton) {
            editButton.addEventListener('click', function () {
                enterEditMode(row);
            });
        }
        if (cancelButton) {
            cancelButton.addEventListener('click', function () {
                exitEditMode(row, true);
                showStatus(row.querySelector('.row-status'), '', null);
            });
        }
        if (saveButton) {
            saveButton.addEventListener('click', function () {
                saveRow(row);
            });
        }
        if (deleteButton) {
            deleteButton.addEventListener('click', function () {
                deleteRow(row);
            });
        }
        if (selectCheckbox) {
            selectCheckbox.addEventListener('change', function () {
                updateBulkSelectionUi();
            });
        }
    }

    function handleNewProduct() {
        const nameInput = document.getElementById('newProductName');
        const skuInput = document.getElementById('newProductSku');
        const descriptionInput = document.getElementById('newProductDescription');
        const categoryInput = document.getElementById('newProductCategory');
        const supplierInput = document.getElementById('newProductSupplier');
        const brandInput = document.getElementById('newProductBrand');
        const modelInput = document.getElementById('newProductModel');
        const vinInput = document.getElementById('newProductVin');
        const costInput = document.getElementById('newProductCostPrice');
        const saleInput = document.getElementById('newProductSalePrice');
        const quantityInput = document.getElementById('newProductQuantity');
        const reorderInput = document.getElementById('newProductReorder');
        const itemTypeInput = document.getElementById('newProductItemType');
        const locationInput = document.getElementById('newProductLocation');
        const imageInput = document.getElementById('newProductImage');
        const statusTarget = document.getElementById('newProductStatus');
        const table = getTable();
        if (!nameInput || !costInput || !statusTarget || !table) {
            return;
        }
        const payload = {
            name: (nameInput.value || '').trim(),
            sku: (skuInput?.value || '').trim(),
            description: (descriptionInput?.value || '').trim(),
            category_id: categoryInput?.value || '',
            supplier_id: supplierInput?.value || '',
            brand_id: brandInput?.value || '',
            vehicle_model_id: modelInput?.value || '',
            vin_number_id: vinInput?.value || '',
            cost_price: (costInput.value || '').trim(),
            sale_price: (saleInput?.value || '').trim(),
            quantity_in_stock: (quantityInput?.value || '').trim(),
            reorder_level: (reorderInput?.value || '').trim(),
            item_type: itemTypeInput?.value || 'inventory',
            location: locationInput?.value || '',
        };
        if (!validatePayload(payload, statusTarget)) {
            return;
        }
        showStatus(statusTarget, 'Saving...', 'saving');
        const formData = buildFormData(payload, getImageFile(imageInput));
        fetch(table.dataset.saveUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
        })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        throw data;
                    });
                }
                return response.json();
            })
            .then(function (data) {
                insertProductRow(data.product);
                nameInput.value = '';
                if (skuInput) {
                    skuInput.value = '';
                }
                if (descriptionInput) {
                    descriptionInput.value = '';
                }
                if (categoryInput) {
                    categoryInput.value = '';
                }
                if (supplierInput) {
                    supplierInput.value = '';
                }
                if (brandInput) {
                    brandInput.value = '';
                }
                if (modelInput) {
                    modelInput.value = '';
                }
                if (vinInput) {
                    vinInput.value = '';
                }
                if (costInput) {
                    costInput.value = '';
                }
                if (saleInput) {
                    saleInput.value = '';
                }
                if (quantityInput) {
                    quantityInput.value = '';
                }
                if (reorderInput) {
                    reorderInput.value = '';
                }
                if (itemTypeInput) {
                    itemTypeInput.value = 'inventory';
                }
                if (locationInput) {
                    locationInput.value = '';
                }
                if (imageInput) {
                    imageInput.value = '';
                }
                nameInput.focus();
                showStatus(statusTarget, 'Saved. Add another product when you are ready.', 'success');
            })
            .catch(function (errorData) {
                const message = errorData && errorData.errors
                    ? Object.values(errorData.errors).flat().join(' ')
                    : 'Could not save this product.';
                showStatus(statusTarget, message, 'error');
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        selectAllCheckbox = document.getElementById('selectAllProducts');
        bulkDeleteButton = document.getElementById('bulkDeleteButton');
        bulkDeleteStatus = document.getElementById('bulkDeleteStatus');
        bulkEditButton = document.getElementById('bulkEditButton');
        bulkEditStatus = document.getElementById('bulkEditStatus');
        bulkEditApplyButton = document.getElementById('bulkEditApplyButton');
        bulkEditSelectedCount = document.getElementById('bulkEditSelectedCount');

        const rows = document.querySelectorAll('.product-row');
        rows.forEach(function (row) {
            attachRowEvents(row);
            applyProductToRow(row, getProductFromRow(row));
        });

        const searchForm = document.querySelector('[data-live-search-form]');
        if (searchForm) {
            const searchInput = searchForm.querySelector('input[name="q"]');
            if (searchInput) {
                currentSearchQuery = searchInput.value || '';
                let timer;
                searchInput.addEventListener('input', function () {
                    currentSearchQuery = searchInput.value || '';
                    clearTimeout(timer);
                    timer = setTimeout(function () {
                        if (searchForm.requestSubmit) {
                            searchForm.requestSubmit();
                        } else {
                            searchForm.submit();
                        }
                    }, 300);
                });
            }
        }
        toggleEmptyState();

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                const visibleCheckboxes = getVisibleRowCheckboxes();
                visibleCheckboxes.forEach(function (checkbox) {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                updateBulkSelectionUi();
            });
        }

        if (bulkDeleteButton) {
            bulkDeleteButton.addEventListener('click', function () {
                bulkDeleteSelectedRows();
            });
        }

        if (bulkEditApplyButton) {
            bulkEditApplyButton.addEventListener('click', function () {
                applyBulkEdit();
            });
        }

        const bulkEditModal = document.getElementById('bulkEditModal');
        if (bulkEditModal) {
            bulkEditModal.addEventListener('show.bs.modal', function () {
                resetBulkEditForm();
                updateBulkSelectionUi();
            });
        }

        if (!window.__catalogAttributeInit) {
            window.__catalogAttributeInit = true;
            document.addEventListener('change', function (event) {
                const target = event.target;
                if (!target || !(target instanceof HTMLElement)) {
                    return;
                }
                if (target.matches('[data-attribute-source]')) {
                    fetchAttributeFields(target);
                    const panel = getAttributeCreatePanel(target);
                    setAttributeCreateMode(panel, 'create');
                    resetAttributeCreatePanel(panel);
                    updateAttributeCreateCategory(panel);
                }
                if (target.matches('[data-attribute-create-type]')) {
                    const panel = target.closest('[data-attribute-create-panel]');
                    setAttributeCreateOptionsVisibility(panel, target.value);
                }
            });
            document.addEventListener('click', function (event) {
                const editButton = event.target && event.target.closest
                    ? event.target.closest('[data-attribute-edit]')
                    : null;
                if (editButton) {
                    const panel = getAttributeCreatePanel(editButton);
                    if (!panel) {
                        return;
                    }
                    const meta = {
                        id: editButton.getAttribute('data-attribute-id') || '',
                        name: editButton.getAttribute('data-attribute-name') || '',
                        description: editButton.getAttribute('data-attribute-description') || '',
                        unit: editButton.getAttribute('data-attribute-unit') || '',
                        attributeType: editButton.getAttribute('data-attribute-type') || 'select',
                        options: editButton.getAttribute('data-attribute-options') || '',
                        sortOrder: editButton.getAttribute('data-attribute-sort-order') || '',
                        categoryId: editButton.getAttribute('data-attribute-category-id') || '',
                        categoryName: editButton.getAttribute('data-attribute-category-name') || '',
                        filterable: editButton.getAttribute('data-attribute-filterable'),
                        comparable: editButton.getAttribute('data-attribute-comparable'),
                        active: editButton.getAttribute('data-attribute-active'),
                    };
                    setAttributeCreateMode(panel, 'edit');
                    applyAttributeEditData(panel, meta);
                    toggleAttributeCreatePanel(panel, true);
                    setTimeout(function () {
                        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 0);
                    return;
                }
                const toggleButton = event.target && event.target.closest
                    ? event.target.closest('[data-attribute-create-toggle]')
                    : null;
                if (toggleButton) {
                    const panel = getAttributeCreatePanel(toggleButton);
                    setAttributeCreateMode(panel, 'create');
                    resetAttributeCreatePanel(panel);
                    toggleAttributeCreatePanel(panel, true);
                    setTimeout(function () {
                        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 0);
                    return;
                }
                const cancelButton = event.target && event.target.closest
                    ? event.target.closest('[data-attribute-create-cancel]')
                    : null;
                if (cancelButton) {
                    const panel = cancelButton.closest('[data-attribute-create-panel]');
                    setAttributeCreateMode(panel, 'create');
                    resetAttributeCreatePanel(panel);
                    toggleAttributeCreatePanel(panel, false);
                    return;
                }
                const submitButton = event.target && event.target.closest
                    ? event.target.closest('[data-attribute-create-submit]')
                    : null;
                if (submitButton) {
                    const panel = submitButton.closest('[data-attribute-create-panel]');
                    handleAttributeCreateSubmit(panel);
                }
            });
            document.addEventListener('keydown', function (event) {
                const target = event.target;
                if (!target || !(target instanceof HTMLElement)) {
                    return;
                }
                if (target.matches('[data-attribute-create-name]') && event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    const panel = target.closest('[data-attribute-create-panel]');
                    handleAttributeCreateSubmit(panel);
                }
            });
        }

        const editProductModal = document.getElementById('editProductModal');
        const editProductFormContent = document.getElementById('editProductFormContent');
        if (editProductModal && editProductFormContent) {
            editProductModal.addEventListener('show.bs.modal', function (event) {
                const trigger = event.relatedTarget;
                const productId = trigger && trigger.getAttribute ? trigger.getAttribute('data-product-id') : '';
                if (!productId) {
                    editProductFormContent.innerHTML = '<div class="alert alert-warning mb-0">Select a product to edit.</div>';
                    return;
                }
                editProductFormContent.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                fetch("{% url 'accounts:get_product_form' %}?product_id=" + encodeURIComponent(productId) + "&attributes_only=1", {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('Failed to load product form.');
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        editProductFormContent.innerHTML = data.html || '';
                        initializeAttributeCreatePanel(editProductFormContent);
                    })
                    .catch(function () {
                        editProductFormContent.innerHTML = '<div class="alert alert-danger mb-0">Unable to load the product details. Please refresh and try again.</div>';
                    });
            });
            editProductModal.addEventListener('hidden.bs.modal', function () {
                editProductFormContent.innerHTML = '';
            });
        }

        const addButton = document.getElementById('addProductButton');
        if (addButton) {
            addButton.addEventListener('click', function () {
                handleNewProduct();
            });
        }

        [
            'newProductName',
            'newProductSku',
            'newProductDescription',
            'newProductCategory',
            'newProductSupplier',
            'newProductBrand',
            'newProductModel',
            'newProductVin',
            'newProductCostPrice',
            'newProductSalePrice',
            'newProductQuantity',
            'newProductReorder',
            'newProductItemType',
            'newProductLocation',
        ].forEach(function (id) {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        handleNewProduct();
                    }
                });
            }
        });

        filterProducts(currentSearchQuery);
        updateBulkSelectionUi();
    });
})();
</script>

{% endblock %}
