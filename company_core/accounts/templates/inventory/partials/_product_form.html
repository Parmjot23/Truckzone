<!-- inventory/partials/_product_form.html -->
{% load static %}
<input type="hidden" name="product_id" value="{{ form.instance.id }}">
{{ form.non_field_errors }}
<div class="product-attributes-shell">
  <ul class="nav nav-pills product-editor-tabs mb-3" id="editProductTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="edit-tab-basic" data-bs-toggle="pill" data-bs-target="#edit-pane-basic" type="button" role="tab" aria-controls="edit-pane-basic" aria-selected="true">Basic</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="edit-tab-catalog" data-bs-toggle="pill" data-bs-target="#edit-pane-catalog" type="button" role="tab" aria-controls="edit-pane-catalog" aria-selected="false">Catalog</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="edit-tab-pricing" data-bs-toggle="pill" data-bs-target="#edit-pane-pricing" type="button" role="tab" aria-controls="edit-pane-pricing" aria-selected="false">Pricing</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="edit-tab-stock" data-bs-toggle="pill" data-bs-target="#edit-pane-stock" type="button" role="tab" aria-controls="edit-pane-stock" aria-selected="false">Stock</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="edit-tab-attributes" data-bs-toggle="pill" data-bs-target="#edit-pane-attributes" type="button" role="tab" aria-controls="edit-pane-attributes" aria-selected="false">Attributes</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="edit-tab-storefront" data-bs-toggle="pill" data-bs-target="#edit-pane-storefront" type="button" role="tab" aria-controls="edit-pane-storefront" aria-selected="false">Storefront</button>
    </li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="edit-pane-basic" role="tabpanel" aria-labelledby="edit-tab-basic">
      <div class="product-modal-grid">
        <div class="form-group">
          {{ form.name.label_tag }}
          {{ form.name }}
        </div>
        <div class="form-group">
          {{ form.sku.label_tag }}
          {{ form.sku }}
        </div>
        <div class="form-group">
          {{ form.oem_part_number.label_tag }}
          {{ form.oem_part_number }}
        </div>
        <div class="form-group">
          {{ form.barcode_value.label_tag }}
          {{ form.barcode_value }}
        </div>
        <div class="form-group span-2">
          {{ form.alternate_skus.label_tag }}
          {{ form.alternate_skus }}
          {% if form.alternate_skus.help_text %}
          <small class="form-text text-muted">{{ form.alternate_skus.help_text }}</small>
          {% endif %}
          {{ form.alternate_skus.errors }}
        </div>
        <div class="form-group span-2">
          {{ form.description.label_tag }}
          {{ form.description }}
        </div>
        <div class="form-group span-2">
          {{ form.fitment_notes.label_tag }}
          {{ form.fitment_notes }}
        </div>
        <div class="form-group span-2">
          {{ form.image.label_tag }}
          {{ form.image }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="edit-pane-catalog" role="tabpanel" aria-labelledby="edit-tab-catalog">
      <div class="product-modal-grid">
        <div class="form-group">
          {{ form.category.label_tag }}
          {{ form.category }}
        </div>
        <div class="form-group">
          {{ form.supplier.label_tag }}
          {{ form.supplier }}
        </div>
        <div class="form-group">
          {{ form.brand.label_tag }}
          {{ form.brand }}
        </div>
        <div class="form-group">
          {{ form.vehicle_model.label_tag }}
          {{ form.vehicle_model }}
        </div>
        <div class="form-group">
          {{ form.vin_number.label_tag }}
          {{ form.vin_number }}
        </div>
        <div class="form-group">
          {{ form.item_type.label_tag }}
          {{ form.item_type }}
        </div>
        <div class="form-group">
          {{ form.location.label_tag }}
          {{ form.location }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="edit-pane-pricing" role="tabpanel" aria-labelledby="edit-tab-pricing">
      <div class="product-modal-grid">
        <div class="form-group">
          {{ form.cost_price.label_tag }}
          {{ form.cost_price }}
        </div>
        <div class="form-group">
          {{ form.sale_price.label_tag }}
          {{ form.sale_price }}
        </div>
        <div class="form-group">
          {{ form.promotion_price.label_tag }}
          {{ form.promotion_price }}
        </div>
        <div class="form-group">
          {{ form.core_price.label_tag }}
          {{ form.core_price }}
        </div>
        <div class="form-group">
          {{ form.environmental_fee.label_tag }}
          {{ form.environmental_fee }}
        </div>
        <div class="form-group">
          {{ form.margin.label_tag }}
          {{ form.margin }}
        </div>
        <div class="form-group">
          {{ form.warranty_expiry_date.label_tag }}
          {{ form.warranty_expiry_date }}
        </div>
        <div class="form-group">
          {{ form.warranty_length.label_tag }}
          {{ form.warranty_length }}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="edit-pane-stock" role="tabpanel" aria-labelledby="edit-tab-stock">
      <div class="product-modal-grid">
        {% if stock_visible|default:true %}
        <div class="form-group">
          {{ form.quantity_in_stock.label_tag }}
          {{ form.quantity_in_stock }}
        </div>
        <div class="form-group">
          {{ form.reorder_level.label_tag }}
          {{ form.reorder_level }}
        </div>
        <div class="form-group">
          {{ form.max_stock_level.label_tag }}
          {{ form.max_stock_level }}
        </div>
        {% else %}
        <div class="form-group span-2">
          <div class="text-muted small">Stock on hand is managed per store.</div>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="tab-pane fade" id="edit-pane-attributes" role="tabpanel" aria-labelledby="edit-tab-attributes">
      <div class="product-modal-grid">
        <div class="form-group span-2" data-attribute-fields="true" data-attribute-url="{% url 'accounts:get_attribute_fields' %}" data-product-id="{{ form.instance.id|default_if_none:'' }}">
          {% include 'inventory/partials/_attribute_fields.html' with form=form %}
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="edit-pane-storefront" role="tabpanel" aria-labelledby="edit-tab-storefront">
      <div class="product-modal-grid">
        <div class="form-group span-2">
          <div class="form-check storefront-toggle">
            {{ form.is_published_to_store }}
            <label class="form-check-label" for="{{ form.is_published_to_store.id_for_label }}">
              {{ form.is_published_to_store.label }}
            </label>
          </div>
          {% if form.is_published_to_store.help_text %}
          <small class="form-text text-muted">{{ form.is_published_to_store.help_text }}</small>
          {% endif %}
          {{ form.is_published_to_store.errors }}
        </div>
        <div class="form-group span-2">
          <div class="form-check storefront-toggle">
            {{ form.is_featured }}
            <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
              {{ form.is_featured.label }}
            </label>
          </div>
          {% if form.is_featured.help_text %}
          <small class="form-text text-muted">{{ form.is_featured.help_text }}</small>
          {% endif %}
          {{ form.is_featured.errors }}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  if (window.__catalogAttributeInit) {
    return;
  }
  window.__catalogAttributeInit = true;

  function fetchAttributeFields(selectEl) {
    const form = selectEl.closest('form');
    if (!form) {
      return;
    }
    const container = form.querySelector('[data-attribute-fields]');
    if (!container) {
      return;
    }
    const url = container.getAttribute('data-attribute-url');
    if (!url) {
      return;
    }
    const categoryId = selectEl.value || '';
    const productId = container.getAttribute('data-product-id') || '';
    const params = new URLSearchParams();
    params.set('category_id', categoryId);
    if (productId) {
      params.set('product_id', productId);
    }

    fetch(url + '?' + params.toString(), {
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error('Failed to load attributes.');
        }
        return response.json();
      })
      .then((data) => {
        container.innerHTML = data.html || '';
      })
      .catch(() => {
        // Keep existing attribute fields if the update fails.
      });
  }

  document.addEventListener('change', (event) => {
    const target = event.target;
    if (!target || !(target instanceof HTMLElement)) {
      return;
    }
    if (target.matches('[data-attribute-source]')) {
      fetchAttributeFields(target);
    }
  });
})();
</script>
