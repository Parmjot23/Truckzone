{% extends "customer_portal_base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Update Card Details</h2>
    <form action="{% url 'accounts:change_card' %}" method="post" id="payment-form">
        {% csrf_token %}

        <div class="form-group">
            <label for="current-card">Current Card</label>
            <div class="border p-3 mb-3">
                <p><strong>Type:</strong> {{ brand|default:"N/A" }}</p>
                <p><strong>Ending in:</strong> {{ last4|default:"N/A" }}</p>
                <p><strong>Expires:</strong> {{ card_expiry|default:"N/A" }}</p>
            </div>
        </div>

        <div class="form-group">
            <label for="name-on-card">Name on card</label>
            <input 
                type="text" 
                id="name-on-card" 
                name="name_on_card" 
                class="form-control" 
                placeholder="{{ name_on_card|default:'' }}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="address">Address</label>
            <input 
                type="text" 
                id="address" 
                name="address" 
                class="form-control" 
                placeholder="{{ address_line|default:'' }}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="city">City/Town</label>
            <input 
                type="text" 
                id="city" 
                name="city" 
                class="form-control" 
                placeholder="{{ city|default:'' }}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="postal-code">ZIP/Postal Code</label>
            <input 
                type="text" 
                id="postal-code" 
                name="postal_code" 
                class="form-control" 
                placeholder="{{ postal_code|default:'' }}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="card-number">Card Number</label>
            <input 
                type="text" 
                id="card-number" 
                name="card_number" 
                class="form-control" 
                placeholder="1234 1234 1234 1234" 
                required
            >
        </div>

        <div class="form-group">
            <label for="expiry">Expiry</label>
            <input 
                type="text" 
                id="expiry" 
                name="expiry" 
                class="form-control" 
                placeholder="{{ card_expiry|default:'MM / YY' }}" 
                required
            >
        </div>

        <div class="form-group">
            <label for="cvc">CVC (security code)</label>
            <input 
                type="text" 
                id="cvc" 
                name="cvc" 
                class="form-control" 
                placeholder="CVC" 
                required
            >
        </div>

        <button type="submit" class="btn btn-primary">Submit Â»</button>

        <!-- Show any card-related errors here -->
        <div id="card-errors" role="alert" class="text-danger mt-2"></div>
    </form>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  var stripe = Stripe('{{ stripe_publishable_key }}');
  var elements = stripe.elements();

  var style = {
    base: {
      color: '#32325d',
      fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '16px',
      '::placeholder': {
        color: '#aab7c4'
      }
    },
    invalid: {
      color: '#fa755a',
      iconColor: '#fa755a'
    }
  };

  var cardElement = elements.create('card', {style: style});
  cardElement.mount('#card-element');

  cardElement.on('change', function(event) {
    var displayError = document.getElementById('card-errors');
    if (event.error) {
      displayError.textContent = event.error.message;
    } else {
      displayError.textContent = '';
    }
  });

  var form = document.getElementById('payment-form');
  form.addEventListener('submit', function(event) {
    event.preventDefault();

    stripe.createToken(cardElement).then(function(result) {
      if (result.error) {
        var errorElement = document.getElementById('card-errors');
        errorElement.textContent = result.error.message;
      } else {
        var hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', result.token.id);
        form.appendChild(hiddenInput);

        form.submit();
      }
    });
  });
</script>
{% endblock %}
