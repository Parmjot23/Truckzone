{# templates/terminal/register_reader.html #}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register Stripe Terminal Reader</title>

  <!-- CSS — you already cache these in other pages -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
  <style>
    body {font-family: Arial,Helvetica,sans-serif;background:#f8f9fa;}
    #status-banner {display:none;position:fixed;top:0;left:0;right:0;z-index:1061;
      padding:.75rem 1rem;text-align:center;font-weight:600}
    #status-banner.success{background:#198754;color:#fff}
    #status-banner.error  {background:#dc3545;color:#fff}
    #status-banner i{margin-right:.5rem}
    .sending-lock {overflow:hidden}
    #overlay {display:none;position:fixed;inset:0;z-index:1055;
      background:rgba(0,0,0,.6);align-items:center;justify-content:center}
  </style>
</head>

<body class="p-4">

  <h3 class="mb-3"><i class="fas fa-plug"></i> Register your reader</h3>
  <p class="text-muted">Put the WisePOS E into pairing mode, note the <strong>three‑word code</strong> shown on the screen, and click the button below.</p>

  <button id="open-modal-btn" class="btn btn-primary">
    <i class="fas fa-plug"></i> Register Reader
  </button>

  <!-- Bootstrap Modal -->
  <div class="modal fade" id="registerReaderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter 3‑word code</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input id="reg-code-input" class="form-control" placeholder="e.g. clay‑torque‑swim">
        </div>
        <div class="modal-footer">
          <button id="submit-reg" class="btn btn-success">
            <span id="reg-spinner" class="spinner-border spinner-border-sm d-none me-1"></span>
            Register
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay">
    <div class="spinner-border text-light" role="status" style="width:3rem;height:3rem;"></div>
  </div>

  <!-- Status banner -->
  <div id="status-banner"></div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ---------- helpers ---------- */
    const overlay = document.getElementById('overlay');
    const banner  = document.getElementById('status-banner');

    function lockUI(msg){
      overlay.style.display = 'flex';
      document.body.classList.add('sending-lock');
      if(msg) overlay.setAttribute('aria-label', msg);
    }
    function unlockUI(){
      overlay.style.display = 'none';
      document.body.classList.remove('sending-lock');
    }
    function showBanner(type,msg){
      const icon = type==='success'
                   ? '<i class="fas fa-circle-check"></i>'
                   : '<i class="fas fa-triangle-exclamation"></i>';
      banner.className = type;
      banner.innerHTML = icon + ' ' + msg;
      banner.style.display = 'block';
      setTimeout(()=> banner.style.display='none', 4000);
    }

    /* ---------- main ---------- */
    const modalEl  = document.getElementById('registerReaderModal');
    const modal    = new bootstrap.Modal(modalEl);
    const openBtn  = document.getElementById('open-modal-btn');
    const submitBtn= document.getElementById('submit-reg');
    const spinner  = document.getElementById('reg-spinner');
    const input    = document.getElementById('reg-code-input');

    openBtn.addEventListener('click', ()=> {
      input.value='';
      modal.show();
    });

    submitBtn.addEventListener('click', async ()=> {
      const code = input.value.trim();
      if(!code){
        input.focus();
        return showBanner('error','Enter the 3‑word code first');
      }
      spinner.classList.remove('d-none');
      lockUI('Registering reader…');

      try{
        const res = await fetch("{% url 'accounts:register_reader' %}", {
          method:'POST',
          credentials:'include',
          headers:{
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With':'XMLHttpRequest',
            'Content-Type':'application/x-www-form-urlencoded',
          },
          body:new URLSearchParams({registration_code:code})
        });
        const data = await res.json();
        if(res.ok){
          modal.hide();
          showBanner('success','Reader registered successfully!');
        }else{
          showBanner('error', data.error || 'Registration failed');
        }
      }catch(err){
        showBanner('error', err.message || 'Network error');
      }finally{
        unlockUI();
        spinner.classList.add('d-none');
      }
    });
  </script>
</body>
</html>


