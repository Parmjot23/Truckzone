{% extends "suppliers/portal_base.html" %}
{% block extra_css %}{{ block.super }}
  <style>
    .summary-card {
      border-radius: 20px;
      padding: 1.5rem;
      background: #fff;
      box-shadow: 0 20px 35px rgba(13, 148, 136, 0.18);
      border: 1px solid rgba(14, 165, 233, 0.14);
    }

    .summary-card .summary-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
    }

    .products-table thead {
      background: rgba(14, 165, 233, 0.08);
    }

    .products-table thead th {
      border: 0;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      color: #0f172a;
    }

    .products-table tbody tr {
      transition: background 0.2s ease;
    }

    .products-table tbody tr:hover {
      background: rgba(14, 165, 233, 0.08);
    }

    .timeline {
      border-left: 3px solid rgba(13, 148, 136, 0.2);
      margin-left: 0.75rem;
      padding-left: 1.25rem;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 1.25rem;
    }

    .timeline-item:last-child {
      margin-bottom: 0;
    }

    .timeline-item::before {
      content: "";
      position: absolute;
      left: -1.45rem;
      top: 0.35rem;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #0ea5e9;
      box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2);
    }
  </style>
{% endblock %}
{% block portal_content %}
  <div class="row g-4">
    <div class="col-12">
      <div class="row g-4">
        <div class="col-md-3 col-sm-6">
          <div class="summary-card h-100">
            <div class="summary-icon bg-info-subtle text-info mb-3"><i class="fas fa-boxes-stacked"></i></div>
            <div class="text-muted text-uppercase small fw-semibold mb-1">Products supplied</div>
            <div class="h3 mb-0">{{ summary.total_products }}</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="summary-card h-100">
            <div class="summary-icon mb-3" style="background: rgba(13, 148, 136, 0.15); color: #0f766e;"><i class="fas fa-layer-group"></i></div>
            <div class="text-muted text-uppercase small fw-semibold mb-1">Units in stock</div>
            <div class="h3 mb-0">{{ summary.total_stock }}</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="summary-card h-100">
            <div class="summary-icon bg-primary-subtle text-primary mb-3"><i class="fas fa-arrow-trend-up"></i></div>
            <div class="text-muted text-uppercase small fw-semibold mb-1">Units purchased</div>
            <div class="h3 mb-0">{{ summary.total_purchased }}</div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="summary-card h-100">
            <div class="summary-icon bg-warning-subtle text-warning mb-3"><i class="fas fa-triangle-exclamation"></i></div>
            <div class="text-muted text-uppercase small fw-semibold mb-1">Low stock alerts</div>
            <div class="h3 mb-0">{{ summary.low_stock }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <div>
              <h2 class="h5 mb-1">Products purchased from you</h2>
              <p class="text-muted mb-0">Live stock levels and usage from {{ business_contact.name }}'s inventory.</p>
            </div>
          </div>
          {% if products %}
            <div class="table-responsive">
              <table class="table align-middle products-table">
                <thead>
                  <tr>
                    <th scope="col">Product</th>
                    <th scope="col" class="text-center">Live stock</th>
                    <th scope="col" class="text-center">Units received</th>
                    <th scope="col" class="text-center">Units used</th>
                    <th scope="col" class="text-end">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for product in products %}
                    <tr>
                      <td>
                        <div class="fw-semibold">{{ product.name }}</div>
                        {% if product.sku %}<div class="text-muted small">SKU: {{ product.sku }}</div>{% endif %}
                        {% if product.category %}<div class="text-muted small">Category: {{ product.category.name }}</div>{% endif %}
                      </td>
                      <td class="text-center fw-semibold">{{ product.quantity_in_stock }}</td>
                      <td class="text-center">{{ product.total_received }}</td>
                      <td class="text-center">{{ product.total_used }}</td>
                      <td class="text-end">
                        {% if product.reorder_level and product.quantity_in_stock < product.reorder_level %}
                          <span class="badge bg-warning-subtle text-warning">Reorder suggested</span>
                        {% else %}
                          <span class="badge bg-success-subtle text-success">Healthy</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-info mb-0">
              No products have been linked to your supplier account yet. Once {{ business_name|default:default_business_name }} assigns products to you, their status will appear here.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <h2 class="h5">Quick communication</h2>
          <p class="text-muted">Need clarification or want to flag a supply issue? Drop a note and the {{ business_name|default:default_business_name }} team will be notified instantly.</p>
          <div class="d-grid gap-2">
            <a class="btn btn-info text-white" href="{{ business_contact.support_url }}"><i class="fas fa-comments me-2"></i>Message {{ business_name|default:default_business_name }}</a>
            {% if business_contact.email %}
              <a class="btn btn-outline-info" href="mailto:{{ business_contact.email }}"><i class="fas fa-envelope me-2"></i>Email {{ business_contact.name }}</a>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0">Inventory timeline</h2>
            <span class="badge bg-info-subtle text-info">Live feed</span>
          </div>
          {% if recent_transactions %}
            <div class="timeline">
              {% for transaction in recent_transactions %}
                <div class="timeline-item">
                  <div class="fw-semibold">{{ transaction.product.name }}</div>
                  <div class="text-muted small mb-1">
                    {{ transaction.get_transaction_type_display }} · {{ transaction.transaction_date|date:"M d, Y" }}
                  </div>
                  <div class="small">
                    <span class="badge {% if transaction.transaction_type == 'IN' %}bg-success-subtle text-success{% elif transaction.transaction_type == 'OUT' %}bg-danger-subtle text-danger{% else %}bg-secondary-subtle text-secondary{% endif %}">
                      {{ transaction.quantity }} units
                    </span>
                    {% if transaction.remarks %}
                      <span class="text-muted">— {{ transaction.remarks }}</span>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted mb-0">Recent stock movements will appear here as soon as {{ business_name|default:default_business_name }} records them.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endblock %}
