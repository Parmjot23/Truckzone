{% extends 'customer_portal_base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}
    Edit Truck Mechanic Invoice
{% endblock %}
{% block content %}
<div class="container mt-5">

{% load custom_filters %}

    <h2 class="mb-4">Edit Invoice</h2>
    <form method="post">
        {% csrf_token %}
        <div class="form-group mb-4">
            <label for="customer-select">Select Customer:</label>
            <select id="customer-select" name="customer" class="form-control">
                {% for customer in customers %}
                    <option value="{{ customer.id }}" {% if customer.id == selected_customer_id %}selected{% endif %}>{{ customer.name }}</option>
                {% endfor %}
            </select>
        </div>
        {{ form|crispy }}
        <hr>
        <h3>Job Records</h3>
        <div id="jobs">
            {{ income_records.management_form }}
            {% for form in income_records %}
                <div class="form-row mb-2">
                    {{ form.id }}
                    {{ form.line_order }}
                    <div class="col-12 col-md-6 mb-2">
                        {{ form.job|as_crispy_field }}
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        {{ form.qty|as_crispy_field }}
                    </div>
                    <div class="col-6 col-md-2 mb-2">
                        {{ form.rate|as_crispy_field }}
                    </div>
                    <div class="col-12 col-md-1 mb-2">
                        <label>
                            <input type="checkbox" name="{{ form.prefix }}-DELETE">
                            Delete
                        </label>
                    </div>
                </div>
            {% endfor %}
        </div>
        <button type="button" class="btn btn-info mb-3" id="add-job">Add Service</button>
        <hr>
        <div>
            <strong>Total Amount: </strong>
            <span id="total-amount">$0.00</span>
        </div>
        <hr>
        <button type="submit" class="btn btn-primary">Save changes</button>
        <a href="{% url 'accounts:customer_list' %}" class="btn btn-secondary">Cancel</a>
    </form>
</div>
<div class="modal fade" id="addJobModal" tabindex="-1" role="dialog" aria-labelledby="addJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addJobModalLabel">Add Service</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="jobNameSelect" class="font-weight-semibold">Job name</label>
          <select id="jobNameSelect" class="form-control" required>
            <option value="">Select job name</option>
          </select>
          <div class="invalid-feedback">Please select a job name.</div>
        </div>
        <div class="form-group">
          <label for="jobDescriptionSelect" class="font-weight-semibold">Saved descriptions</label>
          <select id="jobDescriptionSelect" class="form-control" disabled>
            <option value="">Select a description</option>
          </select>
          <div id="jobDescriptionNotes" class="small text-muted mt-2" style="display:none;"></div>
        </div>
        <div class="form-group mb-0">
          <label for="jobDescriptionInput" class="font-weight-semibold">Job description</label>
          <textarea id="jobDescriptionInput" class="form-control" rows="3" placeholder="Describe the job"></textarea>
          <div class="invalid-feedback">Please enter a job description.</div>
        </div>
        <div class="form-group mt-3">
          <label for="jobFixedHoursInput" class="font-weight-semibold">Fixed hours <span class="text-muted">(optional)</span></label>
          <input type="number" id="jobFixedHoursInput" class="form-control" placeholder="e.g. 2.5" min="0" step="0.25">
        </div>
        <div class="form-group mt-3">
          <label for="jobFixedRateInput" class="font-weight-semibold">Fixed rate <span class="text-muted">(optional)</span></label>
          <input type="number" id="jobFixedRateInput" class="form-control" placeholder="e.g. 125.00" min="0" step="0.01">
        </div>
        <div id="jobModalError" class="alert alert-danger mt-3 d-none" role="alert"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link text-decoration-none" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmAddJobButton">
          <i class="fas fa-plus-circle mr-1"></i> Add job
        </button>
      </div>
    </div>
  </div>
</div>
{{ job_catalog_json|json_script:"job-catalog-data" }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function createModalController(modalSelector) {
            const modalElement = typeof modalSelector === 'string' ? document.querySelector(modalSelector) : null;
            const $ = window.jQuery || null;
            const $modal = modalElement && $ ? $(modalElement) : null;
            const hasBootstrapModal = !!($modal && typeof $modal.modal === 'function');
            const fallbackListeners = [];
            let fallbackBackdrop = null;

            function ensureBackdrop() {
                if (fallbackBackdrop || !modalElement) {
                    return;
                }
                fallbackBackdrop = document.createElement('div');
                fallbackBackdrop.className = 'modal-backdrop fade show';
                fallbackBackdrop.setAttribute('data-fallback-backdrop', modalElement.id || modalSelector);
                document.body.appendChild(fallbackBackdrop);
            }

            function removeBackdrop() {
                if (fallbackBackdrop && fallbackBackdrop.parentNode) {
                    fallbackBackdrop.parentNode.removeChild(fallbackBackdrop);
                }
                fallbackBackdrop = null;
            }

            function show() {
                if (!modalElement) {
                    return;
                }
                if (hasBootstrapModal) {
                    $modal.modal('show');
                    return;
                }
                modalElement.classList.add('show');
                modalElement.style.display = 'block';
                modalElement.setAttribute('aria-hidden', 'false');
                modalElement.setAttribute('aria-modal', 'true');
                document.body.classList.add('modal-open');
                document.body.style.overflow = 'hidden';
                ensureBackdrop();
            }

            function hide() {
                if (!modalElement) {
                    return;
                }
                if (hasBootstrapModal) {
                    $modal.modal('hide');
                    return;
                }
                modalElement.classList.remove('show');
                modalElement.style.display = 'none';
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                removeBackdrop();
                fallbackListeners.forEach(function(callback) {
                    try {
                        callback();
                    } catch (error) {
                        console.error('Error running modal hidden callback', error);
                    }
                });
            }

            function onHidden(callback) {
                if (typeof callback !== 'function' || !modalElement) {
                    return;
                }
                if (hasBootstrapModal) {
                    $modal.on('hidden.bs.modal', callback);
                } else {
                    fallbackListeners.push(callback);
                }
            }

            if (!hasBootstrapModal && modalElement) {
                modalElement.addEventListener('click', function(event) {
                    const dismissTrigger = event.target.closest('[data-dismiss="modal"]');
                    if (dismissTrigger) {
                        event.preventDefault();
                        hide();
                    }
                });
            }

            return {
                element: modalElement,
                show,
                hide,
                onHidden,
            };
        }

        function updateTotalForms() {
            const rows = document.querySelectorAll('#jobs .form-row');
            const totalForms = rows.length;
            const totalFormsInput = document.getElementById('id_income_records-TOTAL_FORMS');
            if (totalFormsInput) {
                totalFormsInput.value = totalForms;
            }
            rows.forEach((row, index) => {
                const orderInput = row.querySelector('input[name$="-line_order"]');
                if (orderInput) {
                    orderInput.value = index + 1;
                }
            });
        }

        function attachRemoveHandlers() {
            document.querySelectorAll('.remove-form').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.form-row').remove();
                    updateTotalForms();
                    calculateTotal();
                });
            });
        }

        attachRemoveHandlers();

        function addJobRow(prefillText, fixedHours, fixedRate) {
            const formIdx = document.querySelectorAll('#jobs .form-row').length;
            const formHtml = `
                <div class="form-row mb-2">
                    <input type="hidden" name="income_records-${formIdx}-id" id="id_income_records-${formIdx}-id">
                    <input type="hidden" name="income_records-${formIdx}-line_order" id="id_income_records-${formIdx}-line_order" value="${formIdx + 1}">
                    <div class="col-12 col-md-6 mb-2">
                        <textarea name="income_records-${formIdx}-job" class="form-control" required id="id_income_records-${formIdx}-job" rows="3"></textarea>
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        <input type="number" name="income_records-${formIdx}-qty" class="form-control" required id="id_income_records-${formIdx}-qty" step="0.01" oninput="calculateTotal()">
                    </div>
                    <div class="col-6 col-md-2 mb-2">
                        <input type="number" name="income_records-${formIdx}-rate" class="form-control" required id="id_income_records-${formIdx}-rate" step="0.01" oninput="calculateTotal()">
                    </div>
                    <div class="col-12 col-md-1 mb-2">
                        <label>
                            <input type="checkbox" name="income_records-${formIdx}-DELETE">
                            Delete
                        </label>
                    </div>
                </div>`;
            document.getElementById('jobs').insertAdjacentHTML('beforeend', formHtml);
            const newJobField = document.getElementById(`id_income_records-${formIdx}-job`);
            if (prefillText && newJobField) {
                newJobField.value = prefillText;
            }
            const hasFixedHours = fixedHours !== undefined && fixedHours !== null && fixedHours !== '';
            const hasFixedRate = fixedRate !== undefined && fixedRate !== null && fixedRate !== '';
            if (hasFixedHours) {
                const qtyField = document.getElementById(`id_income_records-${formIdx}-qty`);
                if (qtyField) {
                    qtyField.value = fixedHours;
                }
            } else if (hasFixedRate) {
                const qtyField = document.getElementById(`id_income_records-${formIdx}-qty`);
                if (qtyField) {
                    qtyField.value = '1';
                }
            }
            if (hasFixedRate) {
                const rateField = document.getElementById(`id_income_records-${formIdx}-rate`);
                if (rateField) {
                    rateField.value = fixedRate;
                }
            }
            updateTotalForms();
            attachRemoveHandlers();
            calculateTotal();
            return newJobField;
        }

        const jobCatalogDataElement = document.getElementById('job-catalog-data');
        let jobCatalog = [];
        if (jobCatalogDataElement) {
            try {
                const parsed = JSON.parse(jobCatalogDataElement.textContent || '[]');
                if (Array.isArray(parsed)) {
                    jobCatalog = parsed;
                }
            } catch (error) {
                console.error('Unable to parse saved job catalog data:', error);
            }
        }

        const addJobModalController = createModalController('#addJobModal');
        const jobNameSelect = document.getElementById('jobNameSelect');
        const jobDescriptionSelect = document.getElementById('jobDescriptionSelect');
        const jobDescriptionInput = document.getElementById('jobDescriptionInput');
        const jobDescriptionNotes = document.getElementById('jobDescriptionNotes');
        const jobModalError = document.getElementById('jobModalError');
        const confirmAddJobButton = document.getElementById('confirmAddJobButton');
        const addJobButton = document.getElementById('add-job');
        const createServiceUrl = "{% url 'accounts:create_service_description' %}";
        const jobFixedHoursInput = document.getElementById('jobFixedHoursInput');
        const jobFixedRateInput = document.getElementById('jobFixedRateInput');

        function getCsrfToken() {
            const tokenField = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return tokenField ? tokenField.value : '';
        }

        function clearJobModalError() {
            if (jobModalError) {
                jobModalError.classList.add('d-none');
                jobModalError.textContent = '';
            }
        }

        function showJobModalError(message) {
            if (jobModalError) {
                jobModalError.textContent = message;
                jobModalError.classList.remove('d-none');
            } else {
                alert(message);
            }
        }

        function normalizeString(value) {
            return (value || '').toString();
        }

        function formatFixedHoursDisplay(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            const numeric = Number(value);
            if (!isFinite(numeric)) {
                return String(value);
            }
            const normalized = numeric.toFixed(2);
            return normalized.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
        }

        function formatFixedRateDisplay(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            const numeric = Number(value);
            if (!isFinite(numeric)) {
                return String(value);
            }
            const normalized = numeric.toFixed(2);
            return normalized.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
        }

        function findJobInCatalog(jobId, jobName) {
            const normalizedId = jobId !== undefined && jobId !== null && jobId !== '' ? String(jobId) : '';
            const normalizedName = normalizeString(jobName);
            return jobCatalog.find(function(job) {
                if (!job) {
                    return false;
                }
                if (normalizedId && job.id !== undefined && job.id !== null) {
                    return String(job.id) === normalizedId;
                }
                if (normalizedName) {
                    return normalizeString(job.name) === normalizedName;
                }
                return false;
            }) || null;
        }

        function upsertJobCatalogEntry(jobNameData, descriptionData) {
            if (!jobNameData || !descriptionData) {
                return;
            }

            const jobIdValue = jobNameData.id !== undefined && jobNameData.id !== null ? jobNameData.id : '';
            const jobNameValue = normalizeString(jobNameData.name);

            let jobEntry = findJobInCatalog(jobIdValue, jobNameValue);
            if (!jobEntry) {
                jobEntry = {
                    id: jobIdValue,
                    name: jobNameValue,
                    descriptions: [],
                };
                jobCatalog.push(jobEntry);
            }

            if (!Array.isArray(jobEntry.descriptions)) {
                jobEntry.descriptions = [];
            }

            const descriptionIdValue = descriptionData.id !== undefined && descriptionData.id !== null ? descriptionData.id : '';
            const descriptionTextValue = normalizeString(descriptionData.text);
            const descriptionNotesValue = normalizeString(descriptionData.notes);
            const descriptionFixedHoursValue = normalizeString(descriptionData.fixed_hours);
            const descriptionFixedRateValue = normalizeString(descriptionData.fixed_rate);

            let existingDescription = null;
            if (descriptionIdValue !== '') {
                existingDescription = jobEntry.descriptions.find(function(item) {
                    return item && item.id !== undefined && item.id !== null && String(item.id) === String(descriptionIdValue);
                }) || null;
            }

            if (!existingDescription) {
                existingDescription = jobEntry.descriptions.find(function(item) {
                    return item && normalizeString(item.text).toLowerCase() === descriptionTextValue.toLowerCase();
                }) || null;
            }

            if (existingDescription) {
                existingDescription.id = descriptionIdValue;
                existingDescription.text = descriptionTextValue;
                existingDescription.notes = descriptionNotesValue;
                existingDescription.fixed_hours = descriptionFixedHoursValue;
                existingDescription.fixed_rate = descriptionFixedRateValue;
            } else {
                jobEntry.descriptions.push({
                    id: descriptionIdValue,
                    text: descriptionTextValue,
                    notes: descriptionNotesValue,
                    fixed_hours: descriptionFixedHoursValue,
                    fixed_rate: descriptionFixedRateValue,
                });
            }

            jobEntry.descriptions.sort(function(a, b) {
                return normalizeString(a && a.text).localeCompare(normalizeString(b && b.text), undefined, { sensitivity: 'base' });
            });

            jobCatalog.sort(function(a, b) {
                return normalizeString(a && a.name).localeCompare(normalizeString(b && b.name), undefined, { sensitivity: 'base' });
            });
        }

        function refreshJobNameOptions() {
            if (!jobNameSelect) {
                return;
            }
            jobNameSelect.innerHTML = '<option value="">Select job name</option>';
            if (!Array.isArray(jobCatalog) || jobCatalog.length === 0) {
                jobNameSelect.disabled = true;
                if (jobDescriptionSelect) {
                    jobDescriptionSelect.disabled = true;
                }
                return;
            }

            const sortedJobs = [...jobCatalog].sort(function(a, b) {
                return normalizeString(a && a.name).localeCompare(normalizeString(b && b.name), undefined, { sensitivity: 'base' });
            });

            sortedJobs.forEach(function(job) {
                if (!job || !job.name) {
                    return;
                }
                const option = document.createElement('option');
                if (job.id !== undefined && job.id !== null && job.id !== '') {
                    option.value = String(job.id);
                    option.dataset.jobId = String(job.id);
                } else {
                    option.value = job.name;
                }
                option.dataset.jobName = job.name;
                option.textContent = job.name;
                jobNameSelect.appendChild(option);
            });
            jobNameSelect.disabled = false;
        }

        function refreshJobDescriptionOptions(jobId, jobName) {
            if (!jobDescriptionSelect) {
                return;
            }
            jobDescriptionSelect.innerHTML = '<option value="">Select a description</option>';
            const matchedJob = findJobInCatalog(jobId, jobName);

            if (matchedJob && Array.isArray(matchedJob.descriptions) && matchedJob.descriptions.length) {
                const sortedDescriptions = [...matchedJob.descriptions].sort(function(a, b) {
                    return normalizeString(a && a.text).localeCompare(normalizeString(b && b.text), undefined, { sensitivity: 'base' });
                });

                sortedDescriptions.forEach(function(desc) {
                    if (!desc || !desc.text) {
                        return;
                    }
                    const option = document.createElement('option');
                    if (desc.id !== undefined && desc.id !== null && desc.id !== '') {
                        option.value = String(desc.id);
                        option.dataset.serviceId = String(desc.id);
                    } else {
                        option.value = '';
                    }
                    option.textContent = desc.text;
                    option.dataset.description = desc.text;
                    if (desc.notes) {
                        option.dataset.notes = desc.notes;
                    }
                    if (desc.fixed_hours !== undefined && desc.fixed_hours !== null && desc.fixed_hours !== '') {
                        option.dataset.fixedHours = desc.fixed_hours;
                    } else {
                        option.dataset.fixedHours = '';
                    }
                    if (desc.fixed_rate !== undefined && desc.fixed_rate !== null && desc.fixed_rate !== '') {
                        option.dataset.fixedRate = desc.fixed_rate;
                    } else {
                        option.dataset.fixedRate = '';
                    }
                    jobDescriptionSelect.appendChild(option);
                });
                jobDescriptionSelect.disabled = false;
            } else {
                jobDescriptionSelect.disabled = true;
            }

        if (jobDescriptionNotes) {
            jobDescriptionNotes.textContent = '';
            jobDescriptionNotes.style.display = 'none';
        }
        if (jobDescriptionInput) {
            jobDescriptionInput.dataset.selectedServiceId = '';
            jobDescriptionInput.dataset.serviceEdited = '';
        }
        if (jobFixedHoursInput) {
            jobFixedHoursInput.value = '';
            jobFixedHoursInput.dataset.autoFixedHours = '';
            jobFixedHoursInput.dataset.userEdited = '';
        }
        if (jobFixedRateInput) {
            jobFixedRateInput.value = '';
        }
    }

        if (jobNameSelect) {
            jobNameSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const selectedJobId = selectedOption ? (selectedOption.dataset.jobId || selectedOption.value) : '';
                const selectedJobName = selectedOption ? (selectedOption.dataset.jobName || selectedOption.textContent || '') : '';
                this.classList.remove('is-invalid');
                clearJobModalError();
                refreshJobDescriptionOptions(selectedJobId, selectedJobName);
                if (jobFixedHoursInput) {
                    jobFixedHoursInput.value = '';
                    jobFixedHoursInput.dataset.autoFixedHours = '';
                    jobFixedHoursInput.dataset.userEdited = '';
                }
                if (jobFixedRateInput) {
                    jobFixedRateInput.value = '';
                }
            });
        }

        if (jobDescriptionSelect) {
            jobDescriptionSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (!selectedOption) {
                    if (jobDescriptionInput) {
                        jobDescriptionInput.dataset.selectedServiceId = '';
                        jobDescriptionInput.dataset.serviceEdited = '';
                    }
                    if (jobDescriptionNotes) {
                        jobDescriptionNotes.textContent = '';
                        jobDescriptionNotes.style.display = 'none';
                    }
                    if (jobFixedHoursInput) {
                        jobFixedHoursInput.value = '';
                        jobFixedHoursInput.dataset.autoFixedHours = '';
                        jobFixedHoursInput.dataset.userEdited = '';
                    }
                    if (jobFixedRateInput) {
                        jobFixedRateInput.value = '';
                    }
                    return;
                }
                const descriptionText = selectedOption ? (selectedOption.dataset.description || selectedOption.textContent || '') : '';
                if (jobDescriptionInput) {
                    jobDescriptionInput.value = descriptionText;
                    jobDescriptionInput.classList.remove('is-invalid');
                    jobDescriptionInput.dataset.selectedServiceId = selectedOption ? (selectedOption.dataset.serviceId || '') : '';
                    jobDescriptionInput.dataset.serviceEdited = '';
                }
                const notes = selectedOption ? (selectedOption.dataset.notes || '') : '';
                const fixedHoursValue = selectedOption ? (selectedOption.dataset.fixedHours || '') : '';
                const fixedRateValue = selectedOption ? (selectedOption.dataset.fixedRate || '') : '';
                if (jobFixedHoursInput) {
                    const hasFixedHours = fixedHoursValue !== undefined && fixedHoursValue !== null && String(fixedHoursValue) !== '';
                    const hasFixedRate = fixedRateValue !== undefined && fixedRateValue !== null && String(fixedRateValue) !== '';
                    const resolvedFixedHours = hasFixedHours ? fixedHoursValue : (hasFixedRate ? 1 : '');
                    jobFixedHoursInput.value = formatFixedHoursDisplay(resolvedFixedHours);
                    jobFixedHoursInput.dataset.autoFixedHours = (!hasFixedHours && hasFixedRate) ? 'true' : '';
                    jobFixedHoursInput.dataset.userEdited = '';
                }
                if (jobFixedRateInput) {
                    jobFixedRateInput.value = formatFixedRateDisplay(fixedRateValue);
                }
                if (jobDescriptionNotes) {
                    const details = [];
                    if (notes) {
                        details.push(notes);
                    }
                    if (fixedHoursValue !== undefined && fixedHoursValue !== null && String(fixedHoursValue) !== '') {
                        details.push(`Fixed hours: ${formatFixedHoursDisplay(fixedHoursValue)}`);
                    }
                    if (fixedRateValue !== undefined && fixedRateValue !== null && String(fixedRateValue) !== '') {
                        details.push(`Fixed rate: ${formatFixedRateDisplay(fixedRateValue)}`);
                    }
                    if (details.length) {
                        jobDescriptionNotes.textContent = details.join(' â€¢ ');
                        jobDescriptionNotes.style.display = 'block';
                    } else {
                        jobDescriptionNotes.textContent = '';
                        jobDescriptionNotes.style.display = 'none';
                    }
                }
            });
        }

        if (jobDescriptionInput) {
            jobDescriptionInput.addEventListener('input', function() {
                const trimmedValue = this.value.trim();
                if (trimmedValue) {
                    this.classList.remove('is-invalid');
                    this.dataset.serviceEdited = 'true';
                    return;
                }
                this.dataset.selectedServiceId = '';
                this.dataset.serviceEdited = '';
                if (jobDescriptionSelect) {
                    jobDescriptionSelect.value = '';
                }
                if (jobDescriptionNotes && !this.value.trim()) {
                    jobDescriptionNotes.textContent = '';
                    jobDescriptionNotes.style.display = 'none';
                }
                if (jobFixedHoursInput) {
                    jobFixedHoursInput.value = '';
                    jobFixedHoursInput.dataset.autoFixedHours = '';
                    jobFixedHoursInput.dataset.userEdited = '';
                }
                if (jobFixedRateInput) {
                    jobFixedRateInput.value = '';
                }
            });
        }

        if (jobFixedHoursInput && jobDescriptionInput) {
            jobFixedHoursInput.addEventListener('input', function() {
                jobDescriptionInput.dataset.serviceEdited = 'true';
                jobFixedHoursInput.dataset.userEdited = 'true';
                jobFixedHoursInput.dataset.autoFixedHours = '';
            });
        }

        if (jobFixedRateInput && jobDescriptionInput) {
            jobFixedRateInput.addEventListener('input', function() {
                jobDescriptionInput.dataset.serviceEdited = 'true';
            });
        }

        if (addJobButton) {
            addJobButton.addEventListener('click', function() {
                refreshJobNameOptions();
                clearJobModalError();
                if (jobDescriptionSelect) {
                    jobDescriptionSelect.value = '';
                    if (!Array.isArray(jobCatalog) || jobCatalog.length === 0) {
                        jobDescriptionSelect.disabled = true;
                    }
                }
                if (jobDescriptionInput) {
                    jobDescriptionInput.value = '';
                    jobDescriptionInput.classList.remove('is-invalid');
                    jobDescriptionInput.dataset.selectedServiceId = '';
                    jobDescriptionInput.dataset.serviceEdited = '';
                }
                if (jobNameSelect) {
                    jobNameSelect.classList.remove('is-invalid');
                }
                if (jobDescriptionNotes) {
                    jobDescriptionNotes.textContent = '';
                    jobDescriptionNotes.style.display = 'none';
                }
                if (jobFixedHoursInput) {
                    jobFixedHoursInput.value = '';
                    jobFixedHoursInput.dataset.autoFixedHours = '';
                    jobFixedHoursInput.dataset.userEdited = '';
                }
                if (jobFixedRateInput) {
                    jobFixedRateInput.value = '';
                }
                if (addJobModalController) {
                    addJobModalController.show();
                }
                setTimeout(function() {
                    if (jobNameSelect && !jobNameSelect.disabled) {
                        jobNameSelect.focus();
                    } else if (jobDescriptionInput) {
                        jobDescriptionInput.focus();
                    }
                }, 200);
            });
        }

        if (confirmAddJobButton) {
            confirmAddJobButton.addEventListener('click', async function() {
                clearJobModalError();
                if (jobNameSelect && jobNameSelect.disabled) {
                    jobNameSelect.classList.add('is-invalid');
                    jobNameSelect.focus();
                    return;
                }

                const selectedJobOption = jobNameSelect ? jobNameSelect.options[jobNameSelect.selectedIndex] : null;
                const selectedJobId = selectedJobOption ? (selectedJobOption.dataset.jobId || selectedJobOption.value || '') : '';
                const selectedJobName = selectedJobOption ? (selectedJobOption.dataset.jobName || selectedJobOption.textContent || '') : '';

                if (jobNameSelect && (!selectedJobId && !selectedJobName)) {
                    jobNameSelect.classList.add('is-invalid');
                    jobNameSelect.focus();
                    return;
                }

                const descriptionText = jobDescriptionInput ? jobDescriptionInput.value.trim() : '';
                if (!descriptionText) {
                    if (jobDescriptionInput) {
                        jobDescriptionInput.classList.add('is-invalid');
                        jobDescriptionInput.focus();
                    }
                    return;
                }

                const fixedHoursRaw = jobFixedHoursInput ? jobFixedHoursInput.value.trim() : '';
                if (fixedHoursRaw) {
                    const numericFixedHours = Number(fixedHoursRaw);
                    if (!isFinite(numericFixedHours) || numericFixedHours < 0) {
                        showJobModalError('Fixed hours must be a non-negative number.');
                        if (jobFixedHoursInput) {
                            jobFixedHoursInput.focus();
                        }
                        return;
                    }
                }
                const fixedRateRaw = jobFixedRateInput ? jobFixedRateInput.value.trim() : '';
                if (fixedRateRaw) {
                    const numericFixedRate = Number(fixedRateRaw);
                    if (!isFinite(numericFixedRate) || numericFixedRate < 0) {
                        showJobModalError('Fixed rate must be a non-negative number.');
                        if (jobFixedRateInput) {
                            jobFixedRateInput.focus();
                        }
                        return;
                    }
                }

                let selectedServiceId = jobDescriptionInput ? (jobDescriptionInput.dataset.selectedServiceId || '') : '';
                const serviceEdited = jobDescriptionInput ? jobDescriptionInput.dataset.serviceEdited === 'true' : false;

                if (!selectedServiceId) {
                    const jobEntry = findJobInCatalog(selectedJobId, selectedJobName);
                    if (jobEntry && Array.isArray(jobEntry.descriptions)) {
                        const existingMatch = jobEntry.descriptions.find(function(desc) {
                            return desc && normalizeString(desc.text).toLowerCase() === descriptionText.toLowerCase();
                        });
                        if (existingMatch && existingMatch.id !== undefined && existingMatch.id !== null && existingMatch.id !== '') {
                            selectedServiceId = String(existingMatch.id);
                        }
                    }
                }

                const shouldPersistService = serviceEdited || !selectedServiceId;
                if (shouldPersistService) {
                    if (!createServiceUrl) {
                        showJobModalError('We could not save that job description.');
                        return;
                    }

                    const requestBody = {
                        job_name_id: selectedJobOption ? (selectedJobOption.dataset.jobId || selectedJobOption.value || '') : '',
                        job_name: selectedJobName,
                        description: descriptionText,
                        fixed_rate: fixedRateRaw,
                    };
                    const autoFixedHours = jobFixedHoursInput
                        ? jobFixedHoursInput.dataset.autoFixedHours === 'true'
                        : false;
                    const fixedHoursEdited = jobFixedHoursInput
                        ? jobFixedHoursInput.dataset.userEdited === 'true'
                        : false;
                    if (!selectedServiceId || !autoFixedHours || fixedHoursEdited) {
                        requestBody.fixed_hours = fixedHoursRaw;
                    }
                    if (serviceEdited && selectedServiceId) {
                        requestBody.service_id = selectedServiceId;
                    }

                    const csrfToken = getCsrfToken();
                    confirmAddJobButton.disabled = true;
                    confirmAddJobButton.dataset.loading = 'true';

                    try {
                        const response = await fetch(createServiceUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                            },
                            body: JSON.stringify(requestBody),
                        });
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok || !data.success) {
                            throw new Error(data.error || 'We could not save that job description.');
                        }

                        const serviceData = data.service || {};
                        const jobData = serviceData.job_name || { id: selectedJobId, name: selectedJobName };
                        const descriptionData = {
                            id: serviceData.id,
                            text: serviceData.description || descriptionText,
                            notes: serviceData.notes || '',
                            fixed_hours: serviceData.fixed_hours || '',
                            fixed_rate: serviceData.fixed_rate || '',
                        };

                        upsertJobCatalogEntry(jobData, descriptionData);
                        refreshJobDescriptionOptions(jobData.id !== undefined && jobData.id !== null && jobData.id !== '' ? String(jobData.id) : jobData.name, jobData.name);

                        if (jobDescriptionSelect) {
                            jobDescriptionSelect.value = descriptionData.id ? String(descriptionData.id) : '';
                        }
                        if (jobDescriptionInput) {
                            jobDescriptionInput.value = descriptionData.text;
                            jobDescriptionInput.dataset.selectedServiceId = descriptionData.id ? String(descriptionData.id) : '';
                            jobDescriptionInput.dataset.serviceEdited = '';
                        }
                        if (jobFixedHoursInput) {
                            jobFixedHoursInput.value = formatFixedHoursDisplay(descriptionData.fixed_hours);
                            const hasFixedHours = descriptionData.fixed_hours !== undefined && descriptionData.fixed_hours !== null && String(descriptionData.fixed_hours) !== '';
                            const hasFixedRate = descriptionData.fixed_rate !== undefined && descriptionData.fixed_rate !== null && String(descriptionData.fixed_rate) !== '';
                            jobFixedHoursInput.dataset.autoFixedHours = (!hasFixedHours && hasFixedRate) ? 'true' : '';
                            jobFixedHoursInput.dataset.userEdited = '';
                        }
                        if (jobFixedRateInput) {
                            jobFixedRateInput.value = formatFixedRateDisplay(descriptionData.fixed_rate);
                        }
                        if (jobDescriptionSelect) {
                            jobDescriptionSelect.dispatchEvent(new Event('change'));
                        }
                    } catch (error) {
                        showJobModalError(error.message || 'We could not save that job description.');
                        if (jobDescriptionInput) {
                            jobDescriptionInput.focus();
                        }
                        return;
                    } finally {
                        confirmAddJobButton.disabled = false;
                        delete confirmAddJobButton.dataset.loading;
                    }
                }

                const newJobInput = addJobRow(descriptionText, fixedHoursRaw, fixedRateRaw);
                if (addJobModalController) {
                    addJobModalController.hide();
                }
                if (newJobInput) {
                    newJobInput.focus();
                }
            });
        }

        function resetAddJobModalState() {
            if (jobDescriptionInput) {
                jobDescriptionInput.classList.remove('is-invalid');
                jobDescriptionInput.dataset.selectedServiceId = '';
                jobDescriptionInput.dataset.serviceEdited = '';
            }
            if (jobNameSelect) {
                jobNameSelect.classList.remove('is-invalid');
            }
            clearJobModalError();
            if (jobFixedHoursInput) {
                jobFixedHoursInput.value = '';
                jobFixedHoursInput.dataset.autoFixedHours = '';
                jobFixedHoursInput.dataset.userEdited = '';
            }
            if (jobFixedRateInput) {
                jobFixedRateInput.value = '';
            }
        }

        if (addJobModalController) {
            addJobModalController.onHidden(resetAddJobModalState);
        }

        function calculateTotal() {
            let total = 0.00;
            const rows = document.querySelectorAll('#jobs .form-row');
            rows.forEach(row => {
                const qty = parseFloat(row.querySelector('input[name$="-qty"]').value) || 0;
                const rate = parseFloat(row.querySelector('input[name$="-rate"]').value) || 0;
                total += qty * rate;
            });
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            });
            document.getElementById('total-amount').innerText = formatter.format(total);
        }

        document.addEventListener('input', function(event) {
            if (event.target.matches('input[name$="-qty"], input[name$="-rate"]')) {
                calculateTotal();
            }
        });

        calculateTotal();
    });
</script>
{% endblock %}
