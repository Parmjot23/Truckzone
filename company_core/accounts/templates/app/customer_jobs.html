{% extends 'customer_portal_base.html' %}
{% load custom_filters %}
{% block title %}
    {{ invoice_type|capfirst }} Invoices for {{ customer.name }}
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">{{ invoice_type|capfirst }} Invoices for {{ customer.name }}</h2>

    <!-- Invoice Type Tabs -->
    <div class="mb-4">
        <a href="{% url 'accounts:customer_detail' customer.id 'pending' %}"
           class="btn btn-outline-primary {% if invoice_type == 'pending' %}active{% endif %}">
            Pending
        </a>
        <a href="{% url 'accounts:customer_detail' customer.id 'paid' %}"
           class="btn btn-outline-primary {% if invoice_type == 'paid' %}active{% endif %}">
            Paid
        </a>
        <a href="{% url 'accounts:customer_detail' customer.id 'all' %}"
           class="btn btn-outline-primary {% if invoice_type == 'all' %}active{% endif %}">
            All
        </a>
        <a href="{% url 'accounts:customer_detail' customer.id 'overdue' %}"
           class="btn btn-outline-primary {% if invoice_type == 'overdue' %}active{% endif %}">
            Overdue
        </a>
    </div>

    <!-- Back to Customer List -->
    <a href="{% url 'accounts:customer_list' %}" class="btn btn-secondary mb-3">
        Back to Customer List
    </a>

    {% if invoices %}
        <!-- Action Buttons for PDF generation, printing and emailing -->
        <div class="mb-4">
            <button type="button" class="btn btn-primary" id="download-btn">Download PDF</button>
            <button type="button" class="btn btn-warning" id="print-btn">Print PDF</button>
            <button type="button" class="btn btn-success" id="email-btn">Send Email</button>
        </div>

        <p><strong>Email:</strong> {{ customer.email }}</p>

        <!-- Invoice Table -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="invoices-table">
                <thead class="thead-dark">
                    <tr>
                        <th>Date</th>
                        <th>Invoice No</th>
                        <th>Unit No</th>
                        {% if invoice_type == 'overdue' %}
                            <th>Due Date</th>
                        {% endif %}
                        <th>Total Amount</th>
                        <th>Total Paid</th>
                        <th>Balance Due</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr>
                        <td data-label="Date">{{ invoice.date }}</td>
                        <td data-label="Invoice No">
                            <a href="{% url 'accounts:groupedinvoice_detail' invoice.pk %}?source=customer_jobs&invoice_type={{ invoice_type }}&customer_id={{ customer.id }}"
                               class="btn btn-link">
                                {{ invoice.invoice_number }}
                            </a>
                        </td>
                        <td data-label="Unit No">{{ invoice.unit_no|default:"N/A" }}</td>
                        {% if invoice_type == 'overdue' %}
                            <td data-label="Due Date">{{ invoice.due_date|date:"F j, Y" }}</td>
                        {% endif %}
                        <td data-label="Total Amount" class="invoice-amount">{{ invoice.total_amount|currency }}</td>
                        <td data-label="Total Paid">{{ invoice.total_paid|currency }}</td>
                        <td data-label="Balance Due">{{ invoice.balance_due|currency }}</td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="{% if invoice_type == 'overdue' %}4{% else %}3{% endif %}"><strong>Total</strong></td>
                        <td data-label="Total Amount">
                            <strong id="total-invoice-amount">{{ total_invoice_amount|currency }}</strong>
                        </td>
                        <td data-label="Total Paid">
                            <strong id="total-invoice-paid">$0.00</strong>
                        </td>
                        <td data-label="Balance Due">
                            <strong id="total-invoice-balance">$0.00</strong>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No invoices found for this customer.</p>
    {% endif %}

    {% if credit_entries %}
        <div class="mt-5">
            <h4>Customer Credits (Returns)</h4>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead class="thead-dark">
                        <tr>
                            <th>Date</th>
                            <th>Credit No</th>
                            <th>Memo</th>
                            <th>Returned Items</th>
                            <th>Total Credit</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in credit_entries %}
                        <tr>
                            <td data-label="Date">{{ entry.credit.date|date:"M d, Y" }}</td>
                            <td data-label="Credit No">
                                <a href="{% url 'accounts:customer_credit_detail' entry.credit.pk %}" class="btn btn-link">
                                    {{ entry.credit.credit_no }}
                                </a>
                            </td>
                            <td data-label="Memo">{{ entry.credit.memo|default:"-" }}</td>
                            <td data-label="Returned Items">
                                <ul class="list-unstyled mb-0">
                                    {% for item in entry.items %}
                                        <li>
                                            {{ item.qty }}x {{ item.description|default:item.part_no|default:"Item" }}
                                            {% if item.source_invoice %}
                                                (Invoice {{ item.source_invoice.invoice_number|default:item.source_invoice.id }})
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ul>
                            </td>
                            <td data-label="Total Credit">{{ entry.display_total|currency }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}
</div>

<!-- Date Range Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1" aria-labelledby="dateRangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="date-range-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dateRangeModalLabel">Select Date Range</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="start-date">Start Date</label>
            <input type="date" id="start-date" name="start_date" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="end-date">End Date</label>
            <input type="date" id="end-date" name="end_date" class="form-control" required>
          </div>
          <!-- Hidden fields to store the action and invoice type -->
          <input type="hidden" id="action-type" name="action_type" value="">
          <input type="hidden" id="invoice-type" name="invoice_type" value="{{ invoice_type }}">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Proceed</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Sending Progress Modal -->
<div class="modal fade" id="sendingModal" tabindex="-1" aria-labelledby="sendingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <h5 class="modal-title visually-hidden" id="sendingModalLabel">Sending</h5>
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Sending...</span>
        </div>
        <p class="mt-3">Sending email, please wait...</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate invoice totals from table rows
    let totalAmount = 0;
    let totalPaid = 0;
    let totalBalance = 0;
    const invoiceRows = document.querySelectorAll('#invoices-table tbody tr:not(:last-child)');
    invoiceRows.forEach(function(row) {
        const amount = parseFloat(
            row.querySelector('[data-label="Total Amount"]').textContent.replace(/[^0-9.-]+/g, '')
        ) || 0;
        const paid = parseFloat(
            row.querySelector('[data-label="Total Paid"]').textContent.replace(/[^0-9.-]+/g, '')
        ) || 0;
        const balance = parseFloat(
            row.querySelector('[data-label="Balance Due"]').textContent.replace(/[^0-9.-]+/g, '')
        ) || 0;
        totalAmount += amount;
        totalPaid += paid;
        totalBalance += balance;
    });
    document.getElementById('total-invoice-amount').textContent = formatCurrency(totalAmount);
    document.getElementById('total-invoice-paid').textContent = formatCurrency(totalPaid);
    document.getElementById('total-invoice-balance').textContent = formatCurrency(totalBalance);

    function formatCurrency(value) {
        return "$" + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // Action Button Logic
    let actionType = '';

    // Button triggers for download, print, email
    document.getElementById('download-btn').addEventListener('click', function() {
        actionType = 'download';
        openDateRangeModal();
    });

    document.getElementById('print-btn').addEventListener('click', function() {
        actionType = 'print';
        openDateRangeModal();
    });

    document.getElementById('email-btn').addEventListener('click', function() {
        actionType = 'email';
        openDateRangeModal();
    });

    const dateRangeModalEl = document.getElementById('dateRangeModal');
    const sendingModalEl = document.getElementById('sendingModal');
    const dateRangeModal = dateRangeModalEl ? new bootstrap.Modal(dateRangeModalEl) : null;
    const sendingModal = sendingModalEl
        ? bootstrap.Modal.getOrCreateInstance(sendingModalEl, { backdrop: 'static', keyboard: false })
        : null;

    function openDateRangeModal() {
        // Grab date values from invoice rows and prepopulate the modal's fields
        const dateCells = document.querySelectorAll('#invoices-table tbody tr:not(:last-child) td[data-label="Date"]');
        let dates = Array.from(dateCells).map(td => new Date(td.textContent));
        if (dates.length > 0) {
            const earliestDate = new Date(Math.min.apply(null, dates));
            const latestDate = new Date(Math.max.apply(null, dates));
            const formatDate = (date) => date.toISOString().split('T')[0];
            document.getElementById('start-date').value = formatDate(earliestDate);
            document.getElementById('end-date').value = formatDate(latestDate);
        }
        if (dateRangeModal) {
            dateRangeModal.show();
        }
    }

    // Submit date range form for the selected action
    document.getElementById('date-range-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const invoiceType = document.getElementById('invoice-type').value;
        let url = '';

        if (actionType === 'download') {
            url = "{% url 'accounts:download_invoice_pdf' customer.id %}";
            url += '?start_date=' + encodeURIComponent(startDate) +
                   '&end_date=' + encodeURIComponent(endDate) +
                   '&invoice_type=' + encodeURIComponent(invoiceType);
            window.location.href = url;
        } else if (actionType === 'print') {
            url = "{% url 'accounts:print_invoice_pdf' customer.id %}";
            url += '?start_date=' + encodeURIComponent(startDate) +
                   '&end_date=' + encodeURIComponent(endDate) +
                   '&invoice_type=' + encodeURIComponent(invoiceType);
            window.open(url, '_blank');
        } else if (actionType === 'email') {
            url = "{% url 'accounts:send_invoice_statement' customer.id %}";
            const csrftoken = getCookie('csrftoken');
            if (dateRangeModal) {
                dateRangeModal.hide();
            }
            if (sendingModal) {
                sendingModal.show();
            }
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    'start_date': startDate,
                    'end_date': endDate,
                    'invoice_type': invoiceType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (sendingModal) {
                    sendingModal.hide();
                }
                if (data.message) {
                    alert(data.message);
                } else if (data.error) {
                    alert(data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (sendingModal) {
                    sendingModal.hide();
                }
                alert('An error occurred while sending the email.');
            });
        }
    });

    // Function to retrieve CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
