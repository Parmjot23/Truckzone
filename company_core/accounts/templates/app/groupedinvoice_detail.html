{# templates/invoices/grouped_invoice_detail.html #}
{% extends "customer_portal_base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}Invoice Detail{% endblock %}
{% block body_class %}{% if portal_read_only %} accountant-portal{% endif %}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />

<style>
  /* ---------- MODERN LOOK & FEEL ---------- */
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    background-color: #f8f9fa;
    /* Lighter grey background */
    color: #212529;
    /* Bootstrap default text color */
    margin: 0;
    line-height: 1.6;
  }

  .invoice-container {
    background-color: #ffffff;
    padding: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    /* Softer shadow */
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  h2.page-title {
    color: #343a40;
    margin-bottom: 2rem;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.75rem;
  }

  h5.section-title {
    color: #495057;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    font-weight: 500;
  }

  /* Prevent page breaks in PDF */
  .card,
  .card-header,
  .card-body,
  .card-footer,
  .table,
  .table th,
  .table td,
  .subtotal-container,
  .invoice-header-details,
  .bill-to-card {
    page-break-inside: avoid;
    break-inside: avoid;
  }

  /* Layout Adjustments */
  .invoice-header-section {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 2rem;
    gap: 1rem;
    /* Gap between details and bill-to card */
  }

  .invoice-header-details {
    width: 100%;
    /* Default for mobile */
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem 1rem;
    /* Vertical and horizontal gap */
    padding: 1rem;
    background-color: #fdfdff;
    border: 1px solid #e9ecef;
    border-radius: 0.3rem;
  }

  .bill-to-card {
    width: 100%;
    /* Default for mobile */
    background-color: #f8f9fa;
    /* Light background for distinction */
    border: 1px solid #dee2e6;
    padding: 1.25rem;
    border-radius: 0.3rem;
  }

  .bill-to-card p {
    margin-bottom: 0.5rem;
  }

  .bill-to-card .bill-to-name {
    font-weight: bold;
    font-size: 1.1em;
  }

  .field-item {
    width: 100%;
    /* Mobile first */
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
  }

  .field-item strong {
    color: #495057;
  }

  /* Desktop layout for header section */
  @media (min-width: 768px) {
    .invoice-header-details {
      width: 60%;
    }

    .bill-to-card {
      width: 35%;
    }

    .field-item {
      width: calc(50% - 0.5rem);
      /* Adjust for gap */
    }

    .field-item:nth-child(odd) {
      padding-right: 0.5rem;
    }

    .field-item:nth-child(even) {
      padding-left: 0.5rem;
    }
  }


  /* Table Styling */
  .table {
    margin-bottom: 2rem;
    border: 1px solid #dee2e6;
    /* Add border to table */
  }

  .table thead {
    background-color: {
        {
        profile.invoice_header_color|default: "#343a40"
      }
    }

    ;
    /* Modern dark header, fallback if profile color not set */
    color: #ffffff;
  }

  .table th,
  .table td {
    padding: 0.85rem;
    vertical-align: middle;
  }

  .table tbody tr:hover {
    background-color: #f1f3f5;
  }

  .table tbody td {
    font-size: 0.9rem;
  }

  /* Subtotal/Total Section */
  .summary-section {
    font-size: 1.05rem;
    /* Slightly larger font */
  }

  .summary-section p {
    margin-bottom: 0.6rem;
  }

  .summary-section strong {
    color: #343a40;
  }

  .note-text {
    color: #dc3545;
    /* Bootstrap danger color for notes */
    font-weight: 500;
    background-color: #fbebee;
    /* Light red background for note - corrected typo */
    padding: 0.5rem;
    border-radius: 0.25rem;
    border-left: 3px solid #dc3545;
  }

  /* Invoice Activity Timeline (Horizontal) */
  .activity-timeline {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin-top: 2rem;
    margin-bottom: 3rem;
    padding: 0 1rem;
  }

  .activity-timeline::before {
    content: '';
    position: absolute;
    top: 15px;
    /* Half of marker height (30px) approx */
    left: 50px;
    /* Adjust based on first item width/padding */
    right: 50px;
    height: 3px;
    background-color: #e9ecef;
    z-index: 0;
  }

  .timeline-item {
    position: relative;
    z-index: 1;
    text-align: center;
    flex: 1;
    /* Remove vertical borders/paddings */
    padding: 0;
    border: none;
  }

  .timeline-marker {
    position: relative;
    /* Reset absolute positioning */
    left: auto;
    top: auto;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #28a745;
    border: 3px solid #fff;
    box-shadow: 0 0 0 2px #28a745;
    margin: 0 auto 10px;
    /* Center horizontally and add bottom margin */
    display: flex;
    /* Centering content if needed */
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 1;
  }

  .timeline-marker i {
    font-size: 0.8rem;
  }

  .timeline-marker.neutral {
    background-color: #adb5bd;
    box-shadow: 0 0 0 2px #adb5bd;
    color: #fff;
  }

  .timeline-content {
    position: relative;
    top: 0;
  }

  .timeline-title {
    font-weight: 700;
    font-size: 1rem;
    color: #343a40;
    margin-bottom: 0.25rem;
  }

  .timeline-text {
    font-size: 0.9rem;
    color: #495057;
    margin-bottom: 0;
  }

  .timeline-subtext {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.2rem;
  }

  /* Tooltip adjustments for centered items */
  .tooltip-content {
    left: 50%;
    transform: translateX(-50%);
    bottom: 125%;
    /* Position above marker/text */
  }

  /* Tooltip Styles */
  .tooltip-container {
    position: relative;
    display: inline-block;
    cursor: help;
    border-bottom: 1px dashed #999;
  }

  .tooltip-content {
    visibility: hidden;
    background-color: #343a40;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 10px;
    position: absolute;
    z-index: 1050;
    bottom: 130%;
    left: 50%;
    transform: translateX(-50%);
    width: max-content;
    max-width: 250px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    opacity: 0;
    transition: opacity 0.2s, visibility 0.2s;
    font-size: 0.8rem;
  }

  .tooltip-content::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -6px;
    border-width: 6px;
    border-style: solid;
    border-color: #343a40 transparent transparent transparent;
  }

  .tooltip-container:hover .tooltip-content {
    visibility: visible;
    opacity: 1;
  }

  .tooltip-list {
    margin: 0;
    padding-left: 1rem;
    max-height: 200px;
    overflow-y: auto;
  }

  .tooltip-list li {
    margin-bottom: 0.2rem;
  }

  /* Scrollbar for tooltip */
  .tooltip-list::-webkit-scrollbar {
    width: 4px;
  }

  .tooltip-list::-webkit-scrollbar-track {
    background: #495057;
    border-radius: 4px;
  }

  .tooltip-list::-webkit-scrollbar-thumb {
    background: #adb5bd;
    border-radius: 4px;
  }



  /* Button Group & Buttons */
  .button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    /* Space between buttons */
    justify-content: flex-start;
    /* Align buttons to the start */
    padding-top: 1rem;
    /* Space above buttons */
    border-top: 1px solid #dee2e6;
    margin-top: 1.5rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    border-radius: 0.25rem;
    transition: all 0.2s ease-in-out;
    text-decoration: none;
    /* Ensure links styled as buttons don't have underlines */
  }

  .btn i {
    margin-right: 0.5rem;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .btn-success {
    background-color: #198754;
    border-color: #198754;
    color: #fff;
  }

  .btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: #fff;
  }

  .btn-warning {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
  }

  /* Ensure text visibility */
  .btn-info {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: #000;
  }

  /* Ensure text visibility for info */
  .btn-outline-success {
    border-color: #198754;
    color: #198754;
  }

  .btn-outline-success:hover {
    background-color: #198754;
    color: #fff;
  }

  .btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
  }

  .btn-outline-secondary:hover {
    background-color: #6c757d;
    color: #fff;
  }


  /* FULL-SCREEN OVERLAY */
  #sending-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.65);
    /* Slightly darker overlay */
    z-index: 10000;
    /* Ensure it's on top */
  }

    {
    % if documentType=='estimate' %
  }

  .invoice-container {
    position: relative;
  }

  .invoice-container .estimate-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 160px;
    color: rgba(0, 0, 0, 0.05);
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 0.2em;
  }

    {
    % endif %
  }

  #sending-overlay .overlay-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #fff;
  }

  body.sending-lock {
    overflow: hidden;
  }

  /* UNIVERSAL BANNER */
  #status-banner {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 0.85rem 1.25rem;
    text-align: center;
    font-weight: 600;
    z-index: 10001;
    /* Above overlay */
    border-bottom: 3px solid transparent;
  }

  #status-banner.success {
    background-color: #d1e7dd;
    /* Lighter green */
    color: #0f5132;
    /* Darker green text */
    border-color: #badbcc;
  }

  #status-banner.error {
    background-color: #f8d7da;
    /* Lighter red */
    color: #842029;
    /* Darker red text */
    border-color: #f5c2c7;
  }

  #status-banner i {
    margin-right: 0.6rem;
  }
</style>

<div class="container mt-4 mb-4">
  <div class="invoice-container">
    {% if documentType == 'estimate' %}
    <div class="estimate-watermark">Estimate</div>
    {% endif %}
    <h2 class="page-title" id="invoice-detail-title">{% if documentType == 'estimate' %}Estimate Detail{% else %}Invoice
      Detail{% endif %}</h2>

    <div class="invoice-header-section">
      <div class="invoice-header-details">
        {% if object.po_number %}
        <div class="field-item"><strong>PO Number:</strong> {{ object.po_number }}</div>
        {% endif %}
        <div class="field-item">
          <strong>{% if documentType == 'estimate' %}Estimate{% else %}Invoice{% endif %} #:</strong>
          {% if documentType == 'estimate' %}
          {{ object.estimate_number }}
          {% else %}
          {{ object.invoice_number }}
          {% endif %}
        </div>
        <div class="field-item"><strong>Date:</strong> {{ object.date|date:"Y-m-d" }}</div> {# Added date formatting #}
        <div class="field-item"><strong>VIN No:</strong> {{ object.vin_no|default_if_none:"" }}</div>
        <div class="field-item"><strong>License Plate:</strong> {{ object.license_plate|default_if_none:"" }}</div>
        <div class="field-item"><strong>Mileage:</strong> {{ object.mileage|default_if_none:"" }}</div>
        <div class="field-item"><strong>Unit No:</strong> {{ object.unit_no|default_if_none:"" }}</div>
        <div class="field-item"><strong>Make/Model:</strong> {{ object.make_model|default_if_none:"" }}</div>
      </div>

      <div class="bill-to-card">
        <p><strong>Bill To:</strong></p>
        <p class="bill-to-name">{{ object.bill_to|default_if_none:"" }}</p>
        {% if object.bill_to_address %}
        <p>{{ object.bill_to_address|linebreaksbr }}</p>
        {% endif %}
        {% if object.bill_to_email %}
        <p><i class="fas fa-envelope me-2"></i>{{ object.bill_to_email }}</p>
        {% endif %}
      </div>
    </div>

    <h5 class="section-title">Jobs</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Job</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% if documentType == 'estimate' %}
          {% with records=object.estimate_records.all %}
          {% for job in records %}
          <tr>
            <td>{{ job.job|linebreaksbr }}</td>
            <td>{{ job.qty }}</td>
            <td>{{ job.rate|currency }}</td>
            <td>{{ job.amount|currency }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center">No jobs listed for this estimate.</td>
          </tr>
          {% endfor %}
          {% endwith %}
          {% else %}
          {% with records=object.income_records.all %}
          {% for job in records %}
          <tr>
            <td>{{ job.job|linebreaksbr }}</td>
            <td>{{ job.qty }}</td>
            <td>{{ job.rate|currency }}</td>
            <td>{{ job.amount|currency }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center">No jobs listed for this invoice.</td>
          </tr>
          {% endfor %}
          {% endwith %}
          {% endif %}
        </tbody>
      </table>
    </div>


    <div class="row mt-4">
      <div class="col-md-6 offset-md-6 text-end summary-section">
        <p><strong>Subtotal:</strong> {{ subtotal|currency }}</p>
        {% if show_tax %} {# Conditionally show tax based on context variable #}
        <p><strong>{{ profile.get_tax_name }}:</strong> {{ tax|currency }}</p>
        {% endif %}
        <hr>
        <p class="h5"><strong>Total:</strong> {{ total_amount|currency }}</p>
      </div>
    </div>
    {% if note %}
    <div class="mt-4">
      <p class="note-text"><strong>Note:</strong> {{ note }}</p>
    </div>
    {% endif %}

    {% if documentType == 'invoice' %}
    <div class="activity-panel" id="invoice-activity-panel">
      <h5 class="section-title">Invoice activity</h5>

      <div class="activity-timeline">
        <!-- Sent -->
        <div class="timeline-item">
          <div class="timeline-marker {% if invoice_activity.sent_count == 0 %}neutral{% endif %}">
            <i class="fas fa-paper-plane"></i>
          </div>
          <div class="timeline-content">
            <h6 class="timeline-title">Sent</h6>
            {% if invoice_activity.sent_count > 0 %}
            <div class="timeline-text">
              <span class="tooltip-container">
                Sent {{ invoice_activity.sent_count }} time{{ invoice_activity.sent_count|pluralize }}
                <div class="tooltip-content">
                  <ul class="tooltip-list">
                    {% for entry in invoice_activity.sent_entries %}
                    <li>{{ entry.created_at|date:"M d, Y, g:i a" }}</li>
                    {% endfor %}
                  </ul>
                </div>
              </span>
            </div>
            <div class="timeline-subtext">
              {{ invoice_activity.sent_entries.0.created_at|date:"M d, Y" }} <br>
              {{ invoice_activity.sent_entries.0.created_at|date:"g:i a" }}
            </div>
            {% else %}
            <p class="timeline-text text-muted">Not sent yet</p>
            {% endif %}
          </div>
        </div>

        <!-- Viewed (Consolidated) -->
        <div class="timeline-item">
          <!-- Green if EITHER opened OR viewed -->
          <div
            class="timeline-marker {% if invoice_activity.opened_count == 0 and invoice_activity.viewed_count == 0 %}neutral{% endif %}">
            <i class="fas fa-eye"></i>
          </div>
          <div class="timeline-content">
            <h6 class="timeline-title">Viewed</h6>
            {% if invoice_activity.opened_count > 0 or invoice_activity.viewed_count > 0 %}
            <div class="timeline-text">
              <span class="tooltip-container">
                Viewed Details
                <div class="tooltip-content" style="width: 300px; max-width: 300px;">
                  {% if invoice_activity.opened_count > 0 %}
                  <strong>Email Opened ({{ invoice_activity.opened_count }})</strong>
                  <ul class="tooltip-list mb-2">
                    {% for entry in invoice_activity.opened_entries %}
                    <li>{{ entry.created_at|date:"M d, Y, g:i a" }}</li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                  {% if invoice_activity.viewed_count > 0 %}
                  <div class="{% if invoice_activity.opened_count > 0 %}border-top pt-2 mt-2{% endif %}">
                    <strong>Portal Viewed ({{ invoice_activity.viewed_count }})</strong>
                    <ul class="tooltip-list">
                      {% for entry in invoice_activity.viewed_entries %}
                      <li>{{ entry.created_at|date:"M d, Y, g:i a" }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </span>
            </div>
            {% else %}
            <p class="timeline-text text-muted">Not viewed yet</p>
            {% endif %}
          </div>
        </div>

        <!-- Paid -->
        <div class="timeline-item">
          {% if object.payment_status == 'Paid' or object.payments.all %}
          <div class="timeline-marker">
            <i class="fas fa-check"></i>
          </div>
          <div class="timeline-content">
            <h6 class="timeline-title">Paid</h6>
            {% for payment in object.payments.all %}
            <div class="mb-2">
              <div class="timeline-text">
                <strong>{{ payment.amount|currency }}</strong>
              </div>
              <div class="timeline-subtext">
                {{ payment.payment_date|date:"M d, Y" }}
              </div>
            </div>
            {% empty %}
            {% if object.payment_status == 'Paid' %}
            <div class="timeline-text">Marked as Paid</div>
            {% if object.date_fully_paid %}
            <div class="timeline-subtext">{{ object.date_fully_paid|date:"M d, Y" }}</div>
            {% endif %}
            {% endif %}
            {% endfor %}
          </div>
          {% else %}
          <div class="timeline-marker neutral">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="timeline-content">
            <h6 class="timeline-title text-muted">Paid</h6>
            <p class="timeline-text text-muted">Waiting</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}


    {% url 'accounts:create_terminal_payment_intent' object.pk as terminal_intent_url %}
    {# This is the updated button group section from grouped_invoice_detail_html_final artifact #}
    <div class="card-footer bg-transparent px-0">
      <div class="button-group">
        {% if documentType == 'invoice' %}
        {% if not portal_read_only %}
        {# Conditionally show payment-related buttons if the GroupedInvoice is not 'Paid' #}
        {% if object.payment_status != 'Paid' %}
        {% if object.payment_link %}
        <a class="btn btn-success" href="{{ object.payment_link }}">
          <i class="fas fa-credit-card"></i> Pay Online
        </a>
        {% endif %}

        {% if show_inperson_btn %}
        <button id="pay-inperson-btn" class="btn btn-warning" type="button">
          <span id="inperson-spinner" class="spinner-border spinner-border-sm d-none me-1" role="status"></span>
          <i class="fas fa-cash-register"></i> Pay In-Person
        </button>
        {% endif %}

        {% if object.pending_invoice %}
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#manualPaymentModal"
          data-action-url="{% url 'accounts:mark_invoice_paid' object.pending_invoice.pk %}"
          data-invoice-number="{{ object.invoice_number }}" data-balance="{{ balance_due }}">
          <i class="fas fa-check-circle"></i> Mark as Paid
        </button>
        {% endif %}
        {% elif can_reverse_payment %}
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#reversePaymentModal">
          <i class="fas fa-undo"></i> Mark as Unpaid
        </button>
        {% endif %}

        <form id="send-email-form" class="d-inline" method="post" action="{% if object.payment_status == 'Paid' %}
                                {% url 'accounts:send_paid_invoice_email' object.pk %}
                                {% else %}
                                {% url 'accounts:send_grouped_invoice_email' object.pk %}
                                {% endif %}">
          {% csrf_token %}
          {% if object.work_order %}
          <div class="form-check mb-1">
            <input class="form-check-input" type="checkbox" id="includeWorkOrder" name="include_workorder">
            <label class="form-check-label" for="includeWorkOrder">Attach Work Order PDF</label>
          </div>
          {% endif %}
          <button id="send-email-btn" type="button"
            class="btn {% if object.payment_status == 'Paid' %}btn-outline-success{% else %}btn-primary{% endif %}">
            <span id="email-btn-spinner" class="spinner-border spinner-border-sm d-none me-1" role="status"></span>
            <i class="fas fa-envelope"></i>
            {% if object.payment_status == 'Paid' %}Email Receipt{% else %}Email Invoice{% endif %}
          </button>
        </form>
        {% endif %}

        <a class="btn {% if object.payment_status == 'Paid' %}btn-outline-success{% else %}btn-primary{% endif %}"
          id="btn-print" target="_blank" href="{% if object.payment_status == 'Paid' %}
                        {% url 'accounts:print_paid_invoice_pdf' object.pk %}
                        {% else %}
                        {% url 'accounts:print_grouped_invoice_pdf' object.pk %}
                        {% endif %}">
          <i class="fas fa-print"></i> Print
        </a>

        <a class="btn {% if object.payment_status == 'Paid' %}btn-outline-success{% else %}btn-primary{% endif %}"
          id="btn-download" href="{% if object.payment_status == 'Paid' %}
                        {% url 'accounts:generate_paid_invoice_pdf' object.pk %}
                        {% else %}
                        {% url 'accounts:generate_grouped_invoice_pdf' object.pk %}
                        {% endif %}">
          <i class="fas fa-download"></i> Download
        </a>
        {% if object.work_order %}
        <a href="{% url 'accounts:workorder_download' object.work_order.pk %}"
          class="btn btn-secondary mb-1 d-flex align-items-center justify-content-center">
          <i class="fas fa-file-pdf"></i> Work Order PDF
        </a>
        {% endif %}
        {% if not portal_read_only %}
        <a href="{% url 'accounts:groupedinvoice_edit' object.pk %}"
          class="btn btn-warning mb-1 d-flex align-items-center justify-content-center">
          <i class="fas fa-edit"></i> Edit
        </a>
        {% endif %}

        {% if stripe_invoice_pdf_url %}
        <a class="btn btn-outline-secondary" href="{{ stripe_invoice_pdf_url }}" target="_blank">
          <i class="fas fa-file-pdf"></i> Stripe Receipt PDF
        </a>
        {% endif %}
        {% else %}
        {% if not portal_read_only %}
        <form id="send-email-form" class="d-inline" method="post"
          action="{% url 'accounts:send_estimate_email' object.pk %}">
          {% csrf_token %}
          <button id="send-email-btn" type="button"
            class="btn btn-primary mb-1 d-flex align-items-center justify-content-center">
            <span id="email-btn-spinner" class="spinner-border spinner-border-sm d-none me-1" role="status"></span>
            <i class="fas fa-envelope"></i> Email Estimate
          </button>
        </form>
        {% endif %}
        <a class="btn btn-primary mb-1 d-flex align-items-center justify-content-center" id="btn-print" target="_blank"
          href="{% url 'accounts:print_estimate_pdf' object.pk %}">
          <i class="fas fa-print"></i> Print
        </a>
        <a class="btn btn-primary mb-1 d-flex align-items-center justify-content-center" id="btn-download"
          href="{% url 'accounts:generate_estimate_pdf' object.pk %}">
          <i class="fas fa-download"></i> Download
        </a>
        {% if not portal_read_only %}
        <a href="{% url 'accounts:convert_estimate_to_invoice' object.pk %}"
          class="btn btn-primary mb-1 d-flex align-items-center justify-content-center">
          <i class="fas fa-file-invoice-dollar"></i> Convert to Invoice
        </a>
        <a href="{% url 'accounts:estimate_edit' object.pk %}"
          class="btn btn-warning mb-1 d-flex align-items-center justify-content-center">
          <i class="fas fa-edit"></i> Edit
        </a>
        <a href="{% url 'accounts:estimate_delete' object.pk %}"
          class="btn btn-danger mb-1 d-flex align-items-center justify-content-center">
          <i class="fas fa-trash"></i> Delete
        </a>
        <a href="{% url 'accounts:estimate_list' %}"
          class="btn btn-secondary mb-1 d-flex align-items-center justify-content-center">
          <i class="fas fa-arrow-left"></i> Back to Estimates
        </a>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if not portal_read_only %}
<!-- Manual Payment Modal -->
<div class="modal fade" id="manualPaymentModal" tabindex="-1" aria-labelledby="manualPaymentModalLabel"
  aria-hidden="true" data-today="{% now 'Y-m-d' %}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="manualPaymentModalLabel">Record Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" id="manual-payment-form">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}">
        <div class="modal-body">
          <div class="alert alert-info">
            Add a payment with the amount, method, and date you received. Partial payments are supported.
          </div>
          <div class="mb-3">
            <label class="form-label" for="payment-amount">Amount</label>
            <input type="number" step="0.01" min="0" class="form-control" id="payment-amount" name="amount" required>
          </div>
          <div class="mb-3">
            <label class="form-label" for="payment-date">Payment Date</label>
            <input type="date" class="form-control" id="payment-date" name="payment_date">
          </div>
          <div class="mb-3">
            <label class="form-label" for="payment-method">Payment Method</label>
            <select class="form-select" id="payment-method" name="method">
              {% for method in payment_methods %}
              <option value="{{ method }}">{{ method }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="payment-notes">Notes</label>
            <textarea class="form-control" id="payment-notes" name="notes" rows="2"
              placeholder="e.g., Reference number or comment"></textarea>
          </div>
          <div class="text-muted small">Balance due: <span id="payment-balance-due">{{ balance_due|currency }}</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Payment</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Reverse Payment Modal -->
<div class="modal fade" id="reversePaymentModal" tabindex="-1" aria-labelledby="reversePaymentModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reversePaymentModalLabel">Undo Manual Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          Reversing will delete the recorded payment history shown below and restore the invoice balance.
        </div>
        {% include 'app/payment_history_table.html' with payments=object.payments.all %}
      </div>
      <div class="modal-footer">
        <form method="POST" action="{% url 'accounts:mark_invoice_unpaid' object.pk %}">
          {% csrf_token %}
          <input type="hidden" name="next" value="{{ request.get_full_path }}">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, delete payments</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div id="sending-overlay">
  <div class="overlay-content">
    <div class="spinner-border mb-3" role="status" style="width:3rem;height:3rem;"></div> {# Slightly smaller spinner #}
    <h5 id="overlay-message">Processing…</h5>
  </div>
</div>

<div id="status-banner"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{#
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script> #}
{# html2pdf.js is usually for client-side PDF generation. If your 'generate_..._pdf' views handle it server-side, this
might not be needed here. #}
<script src="https://js.stripe.com/terminal/v1/"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    /* Elements */
    const overlay = document.getElementById('sending-overlay');
    const overlayMsg = document.getElementById('overlay-message');
    const emailBtn = document.getElementById('send-email-btn');
    const emailForm = document.getElementById('send-email-form');
    const payBtn = document.getElementById('pay-inperson-btn');
    const paySpin = document.getElementById('inperson-spinner');
    const banner = document.getElementById('status-banner');
    const manualPaymentModal = document.getElementById('manualPaymentModal');
    const manualPaymentForm = document.getElementById('manual-payment-form');
    const manualPaymentLabel = document.getElementById('manualPaymentModalLabel');
    const paymentAmountInput = document.getElementById('payment-amount');
    const paymentDateInput = document.getElementById('payment-date');
    const paymentMethodInput = document.getElementById('payment-method');
    const paymentNotesInput = document.getElementById('payment-notes');
    const paymentBalanceText = document.getElementById('payment-balance-due');

    /* ---------- UI Helpers ---------- */
    function lockUI(msg, spinner, btn) {
      if (overlayMsg) overlayMsg.textContent = msg || 'Processing…';
      if (document.body) document.body.classList.add('sending-lock');
      if (overlay) overlay.style.display = 'flex';
      if (spinner) spinner.classList.remove('d-none');
      if (btn) btn.disabled = true;
    }

    function unlockUI(spinner, btn) {
      if (document.body) document.body.classList.remove('sending-lock');
      if (overlay) overlay.style.display = 'none';
      if (spinner) spinner.classList.add('d-none');
      if (btn) btn.disabled = false;
    }

    function showBanner(type, msg) {
      if (!banner) return;
      const icon = type === 'success'
        ? '<i class="fas fa-check-circle"></i>' // Changed icon
        : '<i class="fas fa-exclamation-triangle"></i>'; // Changed icon
      banner.className = type; // This will set 'success' or 'error' class
      banner.innerHTML = `${icon} ${msg}`;
      banner.style.display = 'block';
      /* Auto-hide after 4 s */
      setTimeout(() => { banner.style.display = 'none'; }, 4000);
    }

    /* ---------- Manual Payment Modal ---------- */
    if (manualPaymentModal && manualPaymentForm) {
      manualPaymentModal.addEventListener('show.bs.modal', event => {
        const trigger = event.relatedTarget;
        const actionUrl = trigger?.getAttribute('data-action-url');
        const balance = trigger?.getAttribute('data-balance') || '';
        const invoiceNumber = trigger?.getAttribute('data-invoice-number') || '';

        manualPaymentForm.action = actionUrl || manualPaymentForm.action;
        if (paymentAmountInput) paymentAmountInput.value = balance;
        if (paymentBalanceText) {
          paymentBalanceText.textContent = balance ? `$${parseFloat(balance).toFixed(2)}` : '';
        }

        if (paymentDateInput) {
          const today = manualPaymentModal.getAttribute('data-today');
          paymentDateInput.value = paymentDateInput.value || today;
        }

        if (paymentMethodInput) {
          paymentMethodInput.selectedIndex = 0;
        }

        if (paymentNotesInput) {
          paymentNotesInput.value = '';
        }

        if (manualPaymentLabel) {
          manualPaymentLabel.textContent = invoiceNumber
            ? `Record Payment for ${invoiceNumber}`
            : 'Record Payment';
        }
      });
    }

    /* ---------- Email Button ---------- */
    if (emailBtn && emailForm) {
      emailBtn.addEventListener('click', () => {
        const spinner = document.getElementById('email-btn-spinner');
        lockUI('Sending Email…', spinner, emailBtn);

        const formData = new FormData();
        const includeWO = document.getElementById('includeWorkOrder');
        formData.append('include_workorder', includeWO && includeWO.checked ? '1' : '0');

        fetch(emailForm.action, {
          method: 'POST',
          credentials: 'include', // or 'same-origin'
          headers: {
            'X-CSRFToken': emailForm.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        })
          .then(async resp => {
            const isJson = resp.headers.get('content-type')?.includes('application/json');
            const payload = isJson ? await resp.json().catch(() => null) : await resp.text();
            if (resp.ok) {
              return payload || {};
            }
            const msg = (payload && payload.error) ? payload.error : (typeof payload === 'string' && payload.trim() ? payload : `Server error: ${resp.status} ${resp.statusText}`);
            throw new Error(msg);
          })
          .then(data => {
            const msg = (data && data.message) ? data.message : 'Email sent successfully!';
            showBanner('success', msg);
          })
          .catch(err => showBanner('error', `Email failed: ${err.message}`))
          .finally(() => unlockUI(spinner, emailBtn));
      });
    }

    /* ---------- In-person payment handler ---------- */
    if (payBtn) {
      payBtn.addEventListener('click', () => {
        console.log('Pay In-Person button clicked');
        lockUI('Initializing Terminal…', paySpin, payBtn);
        let terminal; // Define terminal here to access it in catch/finally

        (async () => {
          let connectionSecret;
          let locationId;

          // 1) Fetch Connection Token (secret for the SDK)
          try {
            lockUI('Fetching connection details…', paySpin, payBtn);
            // Ensure CSRF token is available for this POST request if your view requires it
            const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

            const res = await fetch('{% url "accounts:create_connection_token" %}', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'X-CSRFToken': csrfToken, // Include CSRF token
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || `Connection token fetch failed (${res.status})`);
            connectionSecret = data.secret;
            locationId = data.location; // Assuming your endpoint returns locationId
            console.log('Connection secret and location ID fetched.');
          } catch (err) {
            console.error('Error fetching connection token:', err);
            throw new Error(`Could not get connection token: ${err.message}`);
          }

          // 2) Initialize SDK
          try {
            lockUI('Initializing Stripe Terminal SDK…', paySpin, payBtn);
            terminal = StripeTerminal.create({
              onFetchConnectionToken: async () => {
                console.log('SDK requesting connection secret');
                return connectionSecret;
              },
              onUnexpectedReaderDisconnect: () => {
                console.error('Reader unexpectedly disconnected.');
                showBanner('error', 'Reader disconnected unexpectedly. Please try again.');
                unlockUI(paySpin, payBtn);
              }
            });
            console.log('Stripe Terminal SDK initialized.');
          } catch (err) {
            console.error('SDK initialization error:', err);
            throw new Error(`Could not initialize Terminal SDK: ${err.message}`);
          }

          // 3) Discover Reader
          let discoveredReader;
          try {
            lockUI('Discovering reader…', paySpin, payBtn);
            const discoverConfig = { simulated: false }; // Set to true for simulator, false for real readers
            if (locationId) { // Pass locationId if available and required by your Stripe setup
              discoverConfig.location = locationId;
            }
            console.log('Discovering readers with config:', discoverConfig);

            const { discoveredReaders, error: discErr } = await terminal.discoverReaders(discoverConfig);

            if (discErr) throw discErr;
            if (!discoveredReaders || discoveredReaders.length === 0) {
              throw new Error('No readers found. Ensure reader is powered on, connected to the internet, and registered to the correct location.');
            }
            discoveredReader = discoveredReaders[0];
            console.log('Reader discovered:', discoveredReader.label || discoveredReader.id);
          } catch (err) {
            console.error('Reader discovery error:', err);
            if (terminal && terminal.getConnectionStatus() !== 'not_connected') {
              await terminal.disconnectReader().catch(e => console.warn('Error disconnecting reader during discovery failure:', e));
            }
            throw new Error(`Reader discovery failed: ${err.message}. Check reader power & connection.`);
          }

          // 4) Connect to Reader
          try {
            lockUI(`Connecting to reader: ${discoveredReader.label || discoveredReader.id}…`, paySpin, payBtn);
            const { error: connErr } = await terminal.connectReader(discoveredReader);
            if (connErr) throw connErr;
            console.log('Connected to reader.');
          } catch (err) {
            console.error('Reader connection error:', err);
            throw new Error(`Could not connect to reader: ${err.message}`);
          }

          // 5) Create PaymentIntent
          let clientSecretPI;
          try {
            lockUI('Creating payment intent…', paySpin, payBtn);
            const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

            const res = await fetch('{{ terminal_intent_url }}', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'X-CSRFToken': csrfToken, // Include CSRF token
                'X-Requested-With': 'XMLHttpRequest'
              }
            });
            const piData = await res.json();
            if (!res.ok || piData.error) {
              throw new Error(piData.error || `PaymentIntent creation failed (${res.status})`);
            }
            clientSecretPI = piData.client_secret;
            console.log('PaymentIntent created.');
          } catch (err) {
            console.error('PaymentIntent creation error:', err);
            throw err;
          }

          // 6) Collect Payment Method
          let paymentIntent;
          try {
            lockUI('Waiting for card presentation…', paySpin, payBtn);
            const { paymentIntent: collectedPI, error: collectErr } =
              await terminal.collectPaymentMethod(clientSecretPI);
            if (collectErr) throw collectErr;
            paymentIntent = collectedPI;
            console.log('Payment method collected.');
          } catch (err) {
            console.error('Collect payment method error:', err);
            await terminal.cancelCollectPaymentMethod().catch(e => console.error('Error cancelling collect payment method:', e));
            throw new Error(`Payment collection failed: ${err.message}`);
          }

          // 7) Process Payment
          try {
            lockUI('Processing payment…', paySpin, payBtn);
            const { paymentIntent: processedPI, error: procErr } = await terminal.processPayment(paymentIntent);
            if (procErr) throw procErr;
            paymentIntent = processedPI;
            console.log('Payment processed successfully:', paymentIntent.status);
          } catch (err) {
            console.error('Payment processing error:', err);
            throw new Error(`Payment processing failed: ${err.message}`);
          }

          // Success!
          showBanner('success', 'In-person payment successful!');
          unlockUI(paySpin, payBtn);
          setTimeout(() => location.reload(), 2500);
        })()
          .catch(err => {
            console.error('Terminal Payment Flow Error:', err);
            showBanner('error', err.message || 'An unknown terminal error occurred.');
            if (terminal && terminal.getConnectionStatus() !== 'not_connected') {
              terminal.disconnectReader().catch(e => console.warn('Cleanup disconnect error:', e));
            }
            unlockUI(paySpin, payBtn);
          });
      });
    }
  });
</script>

<!-- Inline tour when ?tour=1 to highlight print/download -->
<script>
  (function () {
    try {
      const params = new URLSearchParams(window.location.search);
      if (!params.has('tour')) return;
      const tour = new Shepherd.Tour({ defaultStepOptions: { cancelIcon: { enabled: true }, scrollTo: true } });
      tour.addStep({ title: 'Invoice Detail', text: 'Review invoice header and jobs.', attachTo: { element: '#invoice-detail-title', on: 'bottom' }, buttons: [{ text: 'Next', action: tour.next }] });
      tour.addStep({ title: 'Print', text: 'Print the invoice for records or customer.', attachTo: { element: '#btn-print', on: 'bottom' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Next', action: tour.next }] });
      tour.addStep({ title: 'Download', text: 'Download a PDF copy of the invoice.', attachTo: { element: '#btn-download', on: 'bottom' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Done', action: tour.complete }] });
      tour.start();
    } catch (e) { }
  })();
</script>

{% endblock %}