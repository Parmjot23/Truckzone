{% load custom_filters %}
<div class="invoice-table-wrapper">
    <table class="invoice-table">
        <thead>
            <tr>
                <th>
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=invoice_number&order={% if sort_by == 'invoice_number' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        Invoice Name
                        {% if sort_by == 'invoice_number' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=date&order={% if sort_by == 'date' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        Date
                        {% if sort_by == 'date' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=bill_to&order={% if sort_by == 'bill_to' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        Bill To
                        {% if sort_by == 'bill_to' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=vin_no&order={% if sort_by == 'vin_no' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        VIN
                        {% if sort_by == 'vin_no' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=unit_no&order={% if sort_by == 'unit_no' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        Unit #
                        {% if sort_by == 'unit_no' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th>
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=status&order={% if sort_by == 'status' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        Status
                        {% if sort_by == 'status' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="text-end">
                    <a class="table-sort-link js-sort-link" href="?{% if sort_query_string %}{{ sort_query_string }}&{% endif %}sort_by=total_amount&order={% if sort_by == 'total_amount' and order != 'desc' %}desc{% else %}asc{% endif %}">
                        Total Amount
                        {% if sort_by == 'total_amount' %}
                            <span class="sort-indicator">{% if order == 'desc' %}v{% else %}^{% endif %}</span>
                        {% endif %}
                    </a>
                </th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for invoice in object_list %}
            <tr class="invoice-row" data-amount="{{ invoice.total_amount }}">
                <td data-label="Invoice Number">
                    <a href="{% url 'accounts:groupedinvoice_detail' invoice.pk %}?source=all" class="btn btn-outline-primary btn-sm">
                        {{ invoice.invoice_number }}
                    </a>
                </td>
                <td data-label="Date">{{ invoice.date|date:"M d, Y" }}</td>
                <td data-label="Bill To">{{ invoice.bill_to }}</td>
                <td data-label="Vin no">{{ invoice.vin_no }}</td>
                <td data-label="Unit no">{{ invoice.unit_no }}</td>
                <td data-label="Status">
                    {% if invoice.status_label == 'Paid' %}
                        <button
                            type="button"
                            class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle invoice-status-pill js-invoice-status"
                            data-action="manage"
                            data-bs-toggle="modal"
                            data-bs-target="#managePaymentsModal"
                            data-invoice-id="{{ invoice.pk }}"
                            data-invoice-number="{{ invoice.invoice_number }}"
                            data-balance="{{ invoice.balance_due }}">
                            Paid
                        </button>
                    {% elif invoice.status_label == 'Partial' %}
                        <button
                            type="button"
                            class="badge rounded-pill bg-warning-subtle text-warning-emphasis border border-warning-subtle invoice-status-pill js-invoice-status"
                            data-action="manage"
                            data-bs-toggle="modal"
                            data-bs-target="#managePaymentsModal"
                            data-invoice-id="{{ invoice.pk }}"
                            data-invoice-number="{{ invoice.invoice_number }}"
                            data-balance="{{ invoice.balance_due }}">
                            Partial
                        </button>
                    {% else %}
                        <button
                            type="button"
                            class="badge rounded-pill bg-primary-subtle text-primary-emphasis border border-primary-subtle invoice-status-pill js-invoice-status"
                            data-action="record"
                            data-bs-toggle="modal"
                            data-bs-target="#invoicePaymentModal"
                            data-invoice-id="{{ invoice.pk }}"
                            data-invoice-number="{{ invoice.invoice_number }}"
                            data-balance="{{ invoice.balance_due }}">
                            Pending
                        </button>
                    {% endif %}
                </td>
                <td data-label="Total Amount" class="text-end">{{ invoice.total_amount|currency }}</td>
                <td data-label="Actions" class="text-center">
                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                        <a
                            class="btn btn-outline-secondary btn-sm"
                            href="{% url 'accounts:groupedinvoice_edit' invoice.pk %}"
                            aria-label="View or edit invoice {{ invoice.invoice_number }}">
                            <span class="visually-hidden">View or edit invoice {{ invoice.invoice_number }}</span>
                            <i class="fa-regular fa-pen-to-square" aria-hidden="true"></i>
                        </a>
                        <button
                            type="button"
                            class="btn {{ invoice.email_button_class|default:'btn-outline-primary' }} btn-sm js-send-invoice-email"
                            data-invoice-number="{{ invoice.invoice_number }}"
                            data-email-url="{% if invoice.status_label == 'Paid' %}{% url 'accounts:send_paid_invoice_email' invoice.pk %}{% else %}{% url 'accounts:send_grouped_invoice_email' invoice.pk %}{% endif %}"
                            data-bs-toggle="tooltip"
                            data-bs-title="{{ invoice.email_button_title|default:'Not sent yet.' }}"
                            data-bs-placement="top"
                            aria-label="{{ invoice.email_button_label|default:'Email Invoice' }}">
                            <span class="visually-hidden">{{ invoice.email_button_label|default:"Email Invoice" }}</span>
                            {% if invoice.email_button_label == "Email receipt" %}
                                <i class="fa-solid fa-receipt" aria-hidden="true"></i>
                            {% elif invoice.email_button_label == "Email sent and seen" %}
                                <i class="fa-solid fa-envelope-open-text" aria-hidden="true"></i>
                            {% elif invoice.email_button_label == "Email sent" %}
                                <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
                            {% else %}
                                <i class="fa-regular fa-envelope" aria-hidden="true"></i>
                            {% endif %}
                        </button>
                        <a
                            class="btn btn-outline-danger btn-sm"
                            href="{% url 'accounts:groupedinvoice_delete' invoice.pk %}"
                            aria-label="Delete invoice {{ invoice.invoice_number }}">
                            <span class="visually-hidden">Delete invoice {{ invoice.invoice_number }}</span>
                            <i class="fa-regular fa-trash-can" aria-hidden="true"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8">
                    <div class="empty-state">
                        <div class="icon"><i class="fa-regular fa-file-lines"></i></div>
                        <h5 class="mb-1">No invoices found.</h5>
                        <p class="text-muted mb-3">Create your first invoice to get started.</p>
                        <a href="{% url 'accounts:add_dailylog' %}" class="pill-primary"><i class="fa-solid fa-plus me-2"></i>Add New Invoice</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if page_obj.paginator.count %}
<nav class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3" aria-label="Invoice pagination">
    <div class="text-muted small">
        {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
    </div>
    <ul class="pagination mb-0">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page=1">First</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">First</span></li>
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.paginator.num_pages }}">Last</a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">Last</span></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
