{% extends 'customer_portal_base.html' %}
{% load static %}
{% block title %}Manage Services{% endblock %}

{% block content %}
<div class="page-shell">
    <div class="page-header">
        <div>
            <h2 class="mb-1">Service Library</h2>
            <p class="text-muted mb-0">Manage the descriptions that appear on invoices and estimates.</p>
        </div>
        <div class="page-toolbar">
            <a href="{% url 'accounts:services_export_template' %}" class="btn btn-outline-primary btn-sm">
                <i class="fa-solid fa-file-arrow-down me-1"></i> Download Excel
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importServicesModal">
                <i class="fa-solid fa-file-import me-1"></i> Import Excel
            </button>
            <a href="#addServiceCard" class="btn btn-primary btn-sm">
                <i class="fa-solid fa-plus me-1"></i> Add service
            </a>
        </div>
    </div>

    <div class="surface-card p-4" id="addServiceCard">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
            <div>
                <h2 class="h5 mb-1">Add a new service</h2>
                <p class="text-muted mb-0">Create reusable job descriptions for future invoices and estimates.</p>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-lg-3">
                <label for="newServiceJobName" class="form-label">Job name</label>
                <input type="text" class="form-control" id="newServiceJobName" placeholder="e.g. Inspection" list="job-name-options" autocomplete="off">
            </div>
            <div class="col-lg-3">
                <label for="newServiceName" class="form-label">Job description</label>
                <textarea class="form-control" id="newServiceName" rows="3" placeholder="Describe the job as it appears on invoices"></textarea>
            </div>
            <div class="col-lg-3">
                <label for="newServiceDescription" class="form-label">Internal notes <span class="text-muted">(optional)</span></label>
                <textarea class="form-control" id="newServiceDescription" rows="3" placeholder="Add supporting details"></textarea>
            </div>
            <div class="col-lg-1">
                <label for="newServiceFixedHours" class="form-label">Fixed hours <span class="text-muted">(optional)</span></label>
                <input type="number" class="form-control" id="newServiceFixedHours" placeholder="e.g. 2.5" min="0" step="0.25">
            </div>
            <div class="col-lg-1">
                <label for="newServiceFixedRate" class="form-label">Fixed rate <span class="text-muted">(optional)</span></label>
                <input type="number" class="form-control" id="newServiceFixedRate" placeholder="e.g. 125.00" min="0" step="0.01">
            </div>
            <div class="col-lg-1">
                <label for="newServiceDueKilometers" class="form-label">Due after (km)</label>
                <input type="number" class="form-control" id="newServiceDueKilometers" placeholder="e.g. 5000" min="0" step="1">
            </div>
            <div class="col-lg-1">
                <label for="newServiceDueMonths" class="form-label">Due after (months)</label>
                <input type="number" class="form-control" id="newServiceDueMonths" placeholder="e.g. 6" min="0" step="1">
            </div>
            <div class="col-lg-2">
                <label class="form-label">Portal column</label>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="newServicePortalColumn">
                    <label class="form-check-label" for="newServicePortalColumn">Show on customer vehicle list (max 4)</label>
                </div>
            </div>
        </div>
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3 mt-3">
            <button type="button" class="btn btn-primary" id="addServiceButton">Add to library</button>
            <div id="newServiceStatus" class="text-muted small">New entries save automatically when you add them.</div>
        </div>
    </div>

    <div class="surface-card p-4">
        <div class="row align-items-end gy-3 mb-2">
            <div class="col-md-7 col-lg-6">
                <label for="serviceSearchInput" class="form-label fw-semibold">Search services</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="search" class="form-control" id="serviceSearchInput" placeholder="Search by job name, description, or notes">
                </div>
                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                    <label for="serviceDateRange" class="text-muted small mb-0">Period:</label>
                    <select class="form-select form-select-sm" id="serviceDateRange" style="max-width: 220px;" data-select2-skip="true">
                        {% for value,label in date_range_options %}
                            <option value="{{ value }}"{% if current_date_range == value %} selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <div id="serviceCustomRange" class="date-range-custom{% if current_date_range == 'custom' %} show{% endif %}">
                        <input type="date" class="form-control form-control-sm" id="serviceStartDate" value="{{ selected_start_date|date:'Y-m-d' }}">
                        <span class="text-muted small">to</span>
                        <input type="date" class="form-control form-control-sm" id="serviceEndDate" value="{{ selected_end_date|date:'Y-m-d' }}">
                    </div>
                </div>
            </div>
            <div class="col-md-5 col-lg-4 ms-lg-auto">
                <div class="d-flex flex-column align-items-md-end gap-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" id="bulkDeleteButton" disabled>
                        <i class="fa-regular fa-trash-can me-1"></i> Delete selected
                    </button>
                    <div id="bulkDeleteStatus" class="small text-muted"></div>
                </div>
            </div>
        </div>

        <div id="serviceEmptyState" class="alert alert-info mt-4{% if services_count %} d-none{% endif %}">
            No services yet. Add job names, descriptions, and notes to build your library.
        </div>

        <div class="table-responsive mt-3{% if not services_count %} d-none{% endif %}" id="serviceTableWrapper">
            <table class="table table-striped align-middle" id="servicesTable"
                    data-save-url="{% url 'accounts:service_inline_save' %}"
                    data-delete-url-template="{% url 'accounts:delete_service' 0 %}">
                    <thead>
                        <tr>
                            <th scope="col" class="text-center" style="width: 4%;">
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" id="selectAllServices" aria-label="Select all services">
                                </div>
                            </th>
                            <th scope="col" style="width: 18%;">Job name</th>
                            <th scope="col" style="width: 24%;">Job description</th>
                            <th scope="col" style="width: 22%;">Internal notes</th>
                            <th scope="col" style="width: 9%;">Due after (km)</th>
                            <th scope="col" style="width: 9%;">Due after (months)</th>
                            <th scope="col" style="width: 9%;">Portal column</th>
                            <th scope="col" style="width: 9%;">Fixed hours</th>
                            <th scope="col" style="width: 9%;">Fixed rate</th>
                            <th scope="col" class="text-end" style="width: 9%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                        {% for group in grouped_services %}
                            {% for service in group.services %}
                            <tr class="service-row"
                                data-service-id="{{ service.id }}"
                                data-job-name-id="{{ group.job_name_id }}"
                                data-job-name="{{ group.job_name|default_if_none:''|escape }}"
                                data-service-name="{{ service.name|default_if_none:''|escape }}"
                                data-service-description="{{ service.description|default_if_none:''|escape }}"
                                data-service-fixed-hours="{{ service.fixed_hours|default_if_none:'' }}"
                                data-service-fixed-rate="{{ service.fixed_rate|default_if_none:'' }}"
                                data-service-due-kilometers="{{ service.due_after_kilometers|default_if_none:'' }}"
                                data-service-due-months="{{ service.due_after_months|default_if_none:'' }}"
                                data-service-portal-column="{% if service.show_on_customer_portal %}true{% else %}false{% endif %}"
                                data-updated-date="{{ service.updated_at|date:'Y-m-d' }}">
                                <td class="text-center align-top">
                                    <div class="form-check mb-0">
                                        <input type="checkbox" class="form-check-input service-select-checkbox" aria-label="Select service {{ service.name|default:'row' }}">
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-job-name-display fw-semibold">{{ group.job_name|default:"—" }}</div>
                                    <div class="service-edit d-none">
                                        <input type="text" class="form-control form-control-sm job-name-input" value="{{ group.job_name }}" list="job-name-options" autocomplete="off" placeholder="Job name">
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-name-display">{{ service.name|default:"—" }}</div>
                                    <div class="service-edit d-none">
                                        <textarea class="form-control form-control-sm service-name-input" rows="2" placeholder="Job description">{{ service.name }}</textarea>
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-description-display text-muted small">{{ service.description|default:"—" }}</div>
                                    <div class="service-edit d-none">
                                        <textarea class="form-control form-control-sm service-description-input" rows="2" placeholder="Internal notes (optional)">{{ service.description }}</textarea>
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-due-kilometers-display text-muted small"></div>
                                    <div class="service-edit d-none">
                                        <input type="number" class="form-control form-control-sm service-due-kilometers-input" min="0" step="1" placeholder="e.g. 5000">
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-due-months-display text-muted small"></div>
                                    <div class="service-edit d-none">
                                        <input type="number" class="form-control form-control-sm service-due-months-input" min="0" step="1" placeholder="e.g. 6">
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-portal-display text-muted small"></div>
                                    <div class="service-edit d-none">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input service-portal-input" id="servicePortal{{ service.id }}">
                                            <label class="form-check-label" for="servicePortal{{ service.id }}">Show</label>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-fixed-hours-display text-muted small"></div>
                                    <div class="service-edit d-none">
                                        <input type="number" class="form-control form-control-sm service-fixed-hours-input" min="0" step="0.25" placeholder="e.g. 2.5">
                                    </div>
                                </td>
                                <td>
                                    <div class="service-display service-fixed-rate-display text-muted small"></div>
                                    <div class="service-edit d-none">
                                        <input type="number" class="form-control form-control-sm service-fixed-rate-input" min="0" step="0.01" placeholder="e.g. 125.00">
                                    </div>
                                </td>
                                <td class="text-end align-top">
                                    <div class="btn-group btn-group-sm service-view-actions" role="group" aria-label="Service actions">
                                        <button type="button" class="btn btn-outline-secondary service-edit-btn">Edit</button>
                                        <button type="button" class="btn btn-outline-danger service-delete-btn">Delete</button>
                                    </div>
                                    <div class="btn-group btn-group-sm service-edit-actions d-none" role="group" aria-label="Edit actions">
                                        <button type="button" class="btn btn-primary service-save-btn">Save</button>
                                        <button type="button" class="btn btn-outline-secondary service-cancel-btn">Cancel</button>
                                    </div>
                                    <div class="row-status text-muted small mt-2" aria-live="polite"></div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div id="servicesNoResults" class="alert alert-secondary d-none mt-4 mb-0">
                No services match your search. Try a different term.
            </div>
    </div>
</div>

<datalist id="job-name-options">
    {% for option in job_name_choices %}
    <option value="{{ option }}"></option>
    {% endfor %}
</datalist>

<input type="hidden" id="inlineCsrfToken" value="{{ csrf_token }}">

<div class="modal fade" id="importServicesModal" tabindex="-1" aria-labelledby="importServicesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importServicesModalLabel">Import services from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'accounts:services_import' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="small text-muted">Upload the Excel template exported from this page. We'll create new services and update matches automatically.</p>
                    <div class="mb-3">
                        <label for="id_service_import_file" class="form-label fw-semibold">Excel file</label>
                        <input type="file" class="form-control" id="id_service_import_file" name="file" accept=".xlsx,.xls">
                        <small class="form-text text-muted">Supported format: .xlsx (Microsoft Excel).</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-import me-1"></i> Import services
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #servicesTable {
        min-width: 768px;
    }

    #servicesTable td {
        vertical-align: top;
    }

    #servicesTable .service-display {
        white-space: pre-wrap;
        word-break: break-word;
    }

    #servicesTable .service-edit textarea,
    #servicesTable .service-edit input {
        font-size: 0.95rem;
    }

    .status-saving {
        color: var(--bs-primary, #0d6efd) !important;
    }

    .status-error {
        color: var(--bs-danger, #dc3545) !important;
    }

    .status-success {
        color: var(--bs-success, #198754) !important;
    }

    .service-select-checkbox {
        cursor: pointer;
    }
    .date-range-custom {
        display: none;
        gap: 0.5rem;
        align-items: center;
        flex-wrap: wrap;
    }
    .date-range-custom.show { display: flex; }

    @media (max-width: 991.98px) {
        #servicesTable {
            min-width: 100%;
        }
    }
</style>

<script>
(function () {
    let selectAllCheckbox = null;
    let bulkDeleteButton = null;
    let bulkDeleteStatus = null;
    let serviceDateRangeSelect = null;
    let serviceCustomRange = null;
    let serviceStartDateInput = null;
    let serviceEndDateInput = null;

    function getTable() {
        return document.getElementById('servicesTable');
    }

    function getCsrfToken() {
        const inlineTokenInput = document.getElementById('inlineCsrfToken');
        if (inlineTokenInput && inlineTokenInput.value && inlineTokenInput.value !== 'NOTPROVIDED') {
            return inlineTokenInput.value;
        }
        const name = 'csrftoken';
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (let i = 0; i < cookies.length; i += 1) {
            const parts = cookies[i].split('=');
            const key = decodeURIComponent(parts[0]);
            if (key === name) {
                return decodeURIComponent(parts[1] || '');
            }
        }
        return '';
    }

    function buildUrl(template, id) {
        return template.replace(/\/0\//, '/' + id + '/');
    }

    function ensureJobNameOption(name) {
        if (!name) {
            return;
        }
        const datalist = document.getElementById('job-name-options');
        if (!datalist) {
            return;
        }
        const exists = Array.from(datalist.options).some(function (option) {
            return option.value.toLowerCase() === name.toLowerCase();
        });
        if (!exists) {
            const option = document.createElement('option');
            option.value = name;
            datalist.appendChild(option);
        }
    }

    function formatFixedHoursValue(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numeric = Number(value);
        if (!isFinite(numeric)) {
            return String(value);
        }
        const normalized = numeric.toFixed(2);
        return normalized.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
    }

    function formatFixedRateValue(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numeric = Number(value);
        if (!isFinite(numeric)) {
            return String(value);
        }
        const normalized = numeric.toFixed(2);
        return normalized.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
    }

    function formatIntervalValue(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numeric = Number(value);
        if (!isFinite(numeric) || numeric < 0) {
            return String(value || '');
        }
        return String(Math.trunc(numeric));
    }

    function parseDateValue(value) {
        if (!value) {
            return null;
        }
        const parts = value.split('-');
        if (parts.length !== 3) {
            return null;
        }
        const year = Number(parts[0]);
        const month = Number(parts[1]);
        const day = Number(parts[2]);
        if (!year || !month || !day) {
            return null;
        }
        return new Date(year, month - 1, day);
    }

    function resolveServiceDateRange() {
        const key = serviceDateRangeSelect ? serviceDateRangeSelect.value : 'all';
        const today = new Date();
        const localToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());

        if (key === 'custom') {
            const start = parseDateValue(serviceStartDateInput?.value);
            const end = parseDateValue(serviceEndDateInput?.value);
            return {
                startDate: start,
                endDate: end,
                isActive: !!(start || end),
            };
        }

        if (key === 'all') {
            return { startDate: null, endDate: null, isActive: false };
        }

        let start = null;
        let end = localToday;
        if (key === 'today') {
            start = localToday;
            end = localToday;
        } else if (key === 'yesterday') {
            start = new Date(localToday);
            start.setDate(start.getDate() - 1);
            end = new Date(start);
        } else if (key === 'week') {
            start = new Date(localToday);
            const day = (start.getDay() + 6) % 7;
            start.setDate(start.getDate() - day);
        } else if (key === 'month') {
            start = new Date(localToday.getFullYear(), localToday.getMonth(), 1);
        } else if (key === '6m') {
            start = new Date(localToday);
            start.setMonth(start.getMonth() - 6);
        } else if (key === 'year') {
            start = new Date(localToday.getFullYear(), 0, 1);
        } else if (key === '1y') {
            start = new Date(localToday);
            start.setFullYear(start.getFullYear() - 1);
        }
        return { startDate: start, endDate: end, isActive: true };
    }

    function matchesDateRange(value, range) {
        if (!range || (!range.startDate && !range.endDate)) {
            return true;
        }
        const rowDate = parseDateValue(value);
        if (!rowDate) {
            return true;
        }
        if (range.startDate && rowDate < range.startDate) {
            return false;
        }
        if (range.endDate && rowDate > range.endDate) {
            return false;
        }
        return true;
    }

    function toggleServiceDateRange() {
        if (!serviceCustomRange || !serviceDateRangeSelect) {
            return;
        }
        serviceCustomRange.classList.toggle('show', serviceDateRangeSelect.value === 'custom');
    }

    function showStatus(target, message, state) {
        if (!target) {
            return;
        }
        target.textContent = message || '';
        target.classList.remove('status-saving', 'status-error', 'status-success');
        if (state === 'saving') {
            target.classList.add('status-saving');
        } else if (state === 'error') {
            target.classList.add('status-error');
        } else if (state === 'success') {
            target.classList.add('status-success');
        }
    }

    function updateServiceCount() {
        const tbody = document.getElementById('servicesTableBody');
        if (!tbody) {
            return;
        }
        const count = tbody.querySelectorAll('.service-row').length;
        document.querySelectorAll('[data-service-count]').forEach(function (el) {
            const format = el.dataset.serviceCountFormat || 'total';
            if (format === 'number') {
                el.textContent = count.toString();
            } else {
                el.textContent = count + ' total';
            }
        });
    }

    function toggleEmptyState() {
        const tbody = document.getElementById('servicesTableBody');
        const emptyState = document.getElementById('serviceEmptyState');
        const wrapper = document.getElementById('serviceTableWrapper');
        if (!tbody || !emptyState || !wrapper) {
            return;
        }
        const hasRows = tbody.querySelectorAll('.service-row').length > 0;
        if (hasRows) {
            emptyState.classList.add('d-none');
            wrapper.classList.remove('d-none');
        } else {
            emptyState.classList.remove('d-none');
            wrapper.classList.add('d-none');
        }
        updateBulkSelectionUi();
    }

    function updateRowSearchText(row) {
        const jobName = (row.dataset.jobName || '').toLowerCase();
        const name = (row.dataset.serviceName || '').toLowerCase();
        const description = (row.dataset.serviceDescription || '').toLowerCase();
        const fixedHours = (row.dataset.serviceFixedHours || '').toLowerCase();
        const fixedRate = (row.dataset.serviceFixedRate || '').toLowerCase();
        const dueKilometers = (row.dataset.serviceDueKilometers || '').toLowerCase();
        const dueMonths = (row.dataset.serviceDueMonths || '').toLowerCase();
        row.dataset.searchText = [jobName, name, description, fixedHours, fixedRate, dueKilometers, dueMonths].join(' ').trim();
    }

    function getAllRowCheckboxes() {
        return Array.from(document.querySelectorAll('.service-row .service-select-checkbox'));
    }

    function getVisibleRowCheckboxes() {
        return Array.from(document.querySelectorAll('.service-row:not(.d-none) .service-select-checkbox'));
    }

    function getSelectedRows() {
        return getAllRowCheckboxes()
            .filter(function (checkbox) {
                return checkbox.checked;
            })
            .map(function (checkbox) {
                return checkbox.closest('.service-row');
            })
            .filter(function (row) {
                return !!row;
            });
    }

    function updateBulkSelectionUi() {
        const visibleCheckboxes = getVisibleRowCheckboxes();
        const allCheckboxes = getAllRowCheckboxes();
        const visibleTotal = visibleCheckboxes.length;
        const visibleChecked = visibleCheckboxes.filter(function (checkbox) {
            return checkbox.checked;
        }).length;
        const totalChecked = allCheckboxes.filter(function (checkbox) {
            return checkbox.checked;
        }).length;

        if (selectAllCheckbox) {
            if (visibleTotal === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.disabled = true;
            } else {
                selectAllCheckbox.disabled = false;
                selectAllCheckbox.checked = visibleChecked === visibleTotal && visibleTotal > 0;
                selectAllCheckbox.indeterminate = visibleChecked > 0 && visibleChecked < visibleTotal;
            }
        }

        if (bulkDeleteButton) {
            bulkDeleteButton.disabled = totalChecked === 0;
        }

        if (totalChecked === 0 && bulkDeleteStatus) {
            showStatus(bulkDeleteStatus, '', null);
        }
    }

    function applyServiceToRow(row, service) {
        if (!row) {
            return;
        }
        const jobNameData = service && service.job_name ? service.job_name : { id: service && service.job_name_id ? service.job_name_id : row.dataset.jobNameId, name: service && service.job_name ? service.job_name.name : row.dataset.jobName || '' };
        const jobName = jobNameData && jobNameData.name ? jobNameData.name : '';
        const jobNameId = jobNameData && jobNameData.id !== undefined && jobNameData.id !== null ? jobNameData.id : '';
        const serviceName = service && service.name ? service.name : '';
        const description = service && service.description ? service.description : '';

        row.dataset.jobName = jobName;
        row.dataset.jobNameId = jobNameId !== '' ? String(jobNameId) : '';
        row.dataset.serviceName = serviceName;
        row.dataset.serviceDescription = description;
        if (service && service.id) {
            row.dataset.serviceId = service.id;
        }

        const jobNameDisplay = row.querySelector('.service-job-name-display');
        if (jobNameDisplay) {
            jobNameDisplay.textContent = jobName || '—';
        }
        const jobNameInput = row.querySelector('.job-name-input');
        if (jobNameInput) {
            jobNameInput.value = jobName;
        }
        const nameDisplay = row.querySelector('.service-name-display');
        if (nameDisplay) {
            nameDisplay.textContent = serviceName || '—';
        }
        const nameInput = row.querySelector('.service-name-input');
        if (nameInput) {
            nameInput.value = serviceName;
        }
        const descriptionDisplay = row.querySelector('.service-description-display');
        if (descriptionDisplay) {
            if (description) {
                descriptionDisplay.textContent = description;
                descriptionDisplay.classList.remove('text-muted');
            } else {
                descriptionDisplay.textContent = '—';
                descriptionDisplay.classList.add('text-muted');
            }
        }
        const descriptionInput = row.querySelector('.service-description-input');
        if (descriptionInput) {
            descriptionInput.value = description;
        }

        const dueKilometersValue = formatIntervalValue(
            service && Object.prototype.hasOwnProperty.call(service, 'due_after_kilometers')
                ? service.due_after_kilometers
                : row.dataset.serviceDueKilometers
        );
        const dueMonthsValue = formatIntervalValue(
            service && Object.prototype.hasOwnProperty.call(service, 'due_after_months')
                ? service.due_after_months
                : row.dataset.serviceDueMonths
        );
        row.dataset.serviceDueKilometers = dueKilometersValue;
        row.dataset.serviceDueMonths = dueMonthsValue;

        const dueKilometersDisplay = row.querySelector('.service-due-kilometers-display');
        if (dueKilometersDisplay) {
            if (dueKilometersValue) {
                dueKilometersDisplay.textContent = dueKilometersValue;
                dueKilometersDisplay.classList.remove('text-muted');
            } else {
                dueKilometersDisplay.textContent = '—';
                dueKilometersDisplay.classList.add('text-muted');
            }
        }

        const dueKilometersInput = row.querySelector('.service-due-kilometers-input');
        if (dueKilometersInput) {
            dueKilometersInput.value = dueKilometersValue;
        }

        const dueMonthsDisplay = row.querySelector('.service-due-months-display');
        if (dueMonthsDisplay) {
            if (dueMonthsValue) {
                dueMonthsDisplay.textContent = dueMonthsValue;
                dueMonthsDisplay.classList.remove('text-muted');
            } else {
                dueMonthsDisplay.textContent = '—';
                dueMonthsDisplay.classList.add('text-muted');
            }
        }

        const dueMonthsInput = row.querySelector('.service-due-months-input');
        if (dueMonthsInput) {
            dueMonthsInput.value = dueMonthsValue;
        }

        let portalValue = false;
        if (service && Object.prototype.hasOwnProperty.call(service, 'show_on_customer_portal')) {
            portalValue = Boolean(service.show_on_customer_portal);
        } else if (row.dataset.servicePortalColumn !== undefined) {
            portalValue = row.dataset.servicePortalColumn === 'true';
        }
        row.dataset.servicePortalColumn = portalValue ? 'true' : 'false';

        const portalDisplay = row.querySelector('.service-portal-display');
        if (portalDisplay) {
            portalDisplay.textContent = portalValue ? 'Yes' : 'No';
            portalDisplay.classList.toggle('text-muted', !portalValue);
        }
        const portalInput = row.querySelector('.service-portal-input');
        if (portalInput) {
            portalInput.checked = portalValue;
        }

        let fixedHoursValue = '';
        if (service && Object.prototype.hasOwnProperty.call(service, 'fixed_hours')) {
            fixedHoursValue = service.fixed_hours;
        } else if (row.dataset.serviceFixedHours !== undefined) {
            fixedHoursValue = row.dataset.serviceFixedHours;
        }
        const formattedFixedHours = formatFixedHoursValue(fixedHoursValue);
        row.dataset.serviceFixedHours = formattedFixedHours;

        const fixedHoursDisplay = row.querySelector('.service-fixed-hours-display');
        if (fixedHoursDisplay) {
            if (formattedFixedHours) {
                fixedHoursDisplay.textContent = formattedFixedHours;
                fixedHoursDisplay.classList.remove('text-muted');
            } else {
                fixedHoursDisplay.textContent = '—';
                fixedHoursDisplay.classList.add('text-muted');
            }
        }
        const fixedHoursInput = row.querySelector('.service-fixed-hours-input');
        if (fixedHoursInput) {
            fixedHoursInput.value = formattedFixedHours;
        }

        let fixedRateValue = '';
        if (service && Object.prototype.hasOwnProperty.call(service, 'fixed_rate')) {
            fixedRateValue = service.fixed_rate;
        } else if (row.dataset.serviceFixedRate !== undefined) {
            fixedRateValue = row.dataset.serviceFixedRate;
        }
        const formattedFixedRate = formatFixedRateValue(fixedRateValue);
        row.dataset.serviceFixedRate = formattedFixedRate;

        const fixedRateDisplay = row.querySelector('.service-fixed-rate-display');
        if (fixedRateDisplay) {
            if (formattedFixedRate) {
                fixedRateDisplay.textContent = formattedFixedRate;
                fixedRateDisplay.classList.remove('text-muted');
            } else {
                fixedRateDisplay.textContent = 'ƒ?"';
                fixedRateDisplay.classList.add('text-muted');
            }
        }
        const fixedRateInput = row.querySelector('.service-fixed-rate-input');
        if (fixedRateInput) {
            fixedRateInput.value = formattedFixedRate;
        }

        updateRowSearchText(row);
        ensureJobNameOption(jobName);
    }

    function enterEditMode(row) {
        if (!row || row.classList.contains('is-editing')) {
            return;
        }
        row.classList.add('is-editing');
        row.querySelectorAll('.service-display').forEach(function (el) {
            el.classList.add('d-none');
        });
        row.querySelectorAll('.service-edit').forEach(function (el) {
            el.classList.remove('d-none');
        });
        const viewActions = row.querySelector('.service-view-actions');
        const editActions = row.querySelector('.service-edit-actions');
        if (viewActions) {
            viewActions.classList.add('d-none');
        }
        if (editActions) {
            editActions.classList.remove('d-none');
        }
        const statusTarget = row.querySelector('.row-status');
        showStatus(statusTarget, '', null);
        const jobNameInput = row.querySelector('.job-name-input');
        if (jobNameInput) {
            jobNameInput.focus();
            jobNameInput.select();
        }
    }

    function exitEditMode(row, revert) {
        if (!row) {
            return;
        }
        if (revert) {
        const jobName = row.dataset.jobName || '';
        const serviceName = row.dataset.serviceName || '';
        const description = row.dataset.serviceDescription || '';
        const fixedHours = row.dataset.serviceFixedHours || '';
        const fixedRate = row.dataset.serviceFixedRate || '';
        const dueKilometers = row.dataset.serviceDueKilometers || '';
        const dueMonths = row.dataset.serviceDueMonths || '';
        const jobNameInput = row.querySelector('.job-name-input');
        const nameInput = row.querySelector('.service-name-input');
        const descriptionInput = row.querySelector('.service-description-input');
        const fixedHoursInput = row.querySelector('.service-fixed-hours-input');
        const fixedRateInput = row.querySelector('.service-fixed-rate-input');
        const dueKilometersInput = row.querySelector('.service-due-kilometers-input');
        const dueMonthsInput = row.querySelector('.service-due-months-input');
        if (jobNameInput) {
            jobNameInput.value = jobName;
        }
        if (nameInput) {
            nameInput.value = serviceName;
        }
        if (descriptionInput) {
            descriptionInput.value = description;
        }
        if (fixedHoursInput) {
            fixedHoursInput.value = fixedHours;
        }
        if (fixedRateInput) {
            fixedRateInput.value = fixedRate;
        }
        if (dueKilometersInput) {
            dueKilometersInput.value = dueKilometers;
        }
        if (dueMonthsInput) {
            dueMonthsInput.value = dueMonths;
        }
    }
        row.classList.remove('is-editing');
        row.querySelectorAll('.service-display').forEach(function (el) {
            el.classList.remove('d-none');
        });
        row.querySelectorAll('.service-edit').forEach(function (el) {
            el.classList.add('d-none');
        });
        const viewActions = row.querySelector('.service-view-actions');
        const editActions = row.querySelector('.service-edit-actions');
        if (viewActions) {
            viewActions.classList.remove('d-none');
        }
        if (editActions) {
            editActions.classList.add('d-none');
        }
    }

    function saveRow(row) {
        if (!row) {
            return;
        }
        const table = getTable();
        if (!table) {
            return;
        }
        const jobNameInput = row.querySelector('.job-name-input');
        const nameInput = row.querySelector('.service-name-input');
        const descriptionInput = row.querySelector('.service-description-input');
        const fixedHoursInput = row.querySelector('.service-fixed-hours-input');
        const fixedRateInput = row.querySelector('.service-fixed-rate-input');
        const dueKilometersInput = row.querySelector('.service-due-kilometers-input');
        const dueMonthsInput = row.querySelector('.service-due-months-input');
        const portalInput = row.querySelector('.service-portal-input');
        const statusTarget = row.querySelector('.row-status');
        const payload = {
            id: row.dataset.serviceId || null,
            job_name: jobNameInput ? jobNameInput.value.trim() : '',
            name: nameInput ? nameInput.value.trim() : '',
            description: descriptionInput ? descriptionInput.value : '',
            fixed_hours: fixedHoursInput ? fixedHoursInput.value.trim() : '',
            fixed_rate: fixedRateInput ? fixedRateInput.value.trim() : '',
            due_after_kilometers: dueKilometersInput ? dueKilometersInput.value.trim() : '',
            due_after_months: dueMonthsInput ? dueMonthsInput.value.trim() : '',
            show_on_customer_portal: portalInput ? portalInput.checked : false,
        };
        if (!payload.job_name || !payload.name) {
            showStatus(statusTarget, 'Job name and description are required.', 'error');
            return;
        }
        if (payload.fixed_rate) {
            const numericRate = Number(payload.fixed_rate);
            if (!isFinite(numericRate) || numericRate < 0) {
                showStatus(statusTarget, 'Fixed rate must be a non-negative number.', 'error');
                if (fixedRateInput) {
                    fixedRateInput.focus();
                }
                return;
            }
        }
        const intervalChecks = [
            { value: payload.due_after_kilometers, label: 'Due after (km)', input: dueKilometersInput },
            { value: payload.due_after_months, label: 'Due after (months)', input: dueMonthsInput },
        ];
        for (let i = 0; i < intervalChecks.length; i += 1) {
            const check = intervalChecks[i];
            if (check.value) {
                const numeric = Number(check.value);
                if (!isFinite(numeric) || numeric < 0) {
                    showStatus(statusTarget, `${check.label} must be a non-negative number.`, 'error');
                    if (check.input) {
                        check.input.focus();
                    }
                    return;
                }
            }
        }
        showStatus(statusTarget, 'Saving…', 'saving');
        fetch(table.dataset.saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify(payload),
        })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        throw data;
                    });
                }
                return response.json();
            })
            .then(function (data) {
                applyServiceToRow(row, data.service);
                exitEditMode(row, false);
                showStatus(statusTarget, 'Saved', 'success');
            })
            .catch(function (errorData) {
                const message = errorData && errorData.errors ? Object.values(errorData.errors).flat().join(' ') : 'We could not save this service right now.';
                showStatus(statusTarget, message, 'error');
            });
    }

    function deleteRow(row, options) {
        if (!row) {
            return;
        }
        const table = getTable();
        if (!table) {
            return;
        }
        const serviceId = row.dataset.serviceId;
        const statusTarget = row.querySelector('.row-status');
        const opts = options || {};
        const shouldConfirm = opts.confirm !== false;
        const onSuccess = typeof opts.onSuccess === 'function' ? opts.onSuccess : null;
        const onError = typeof opts.onError === 'function' ? opts.onError : null;
        if (!serviceId) {
            row.remove();
            updateServiceCount();
            toggleEmptyState();
            filterServices(currentSearchQuery);
            updateBulkSelectionUi();
            if (onSuccess) {
                onSuccess();
            }
            return;
        }
        if (shouldConfirm && !confirm('Remove this service description?')) {
            return;
        }
        showStatus(statusTarget, 'Deleting…', 'saving');
        fetch(buildUrl(table.dataset.deleteUrlTemplate, serviceId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
        })
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('Failed to delete service.');
                }
                row.remove();
                updateServiceCount();
                toggleEmptyState();
                filterServices(currentSearchQuery);
                updateBulkSelectionUi();
                if (onSuccess) {
                    onSuccess();
                }
            })
            .catch(function () {
                showStatus(statusTarget, 'Could not delete this service. Try again.', 'error');
                updateBulkSelectionUi();
                if (onError) {
                    onError();
                }
            });
    }

    function attachRowEvents(row) {
        if (!row || row.dataset.initialized === 'true') {
            return;
        }
        row.dataset.initialized = 'true';
        const editButton = row.querySelector('.service-edit-btn');
        const cancelButton = row.querySelector('.service-cancel-btn');
        const saveButton = row.querySelector('.service-save-btn');
        const deleteButton = row.querySelector('.service-delete-btn');
        const selectCheckbox = row.querySelector('.service-select-checkbox');
        if (editButton) {
            editButton.addEventListener('click', function () {
                enterEditMode(row);
            });
        }
        if (cancelButton) {
            cancelButton.addEventListener('click', function () {
                exitEditMode(row, true);
                showStatus(row.querySelector('.row-status'), '', null);
            });
        }
        if (saveButton) {
            saveButton.addEventListener('click', function () {
                saveRow(row);
            });
        }
        if (deleteButton) {
            deleteButton.addEventListener('click', function () {
                deleteRow(row);
            });
        }
        if (selectCheckbox) {
            selectCheckbox.addEventListener('change', function () {
                updateBulkSelectionUi();
            });
        }
    }

    function createRowElement(service) {
        const row = document.createElement('tr');
        row.className = 'service-row';
        row.innerHTML = `
            <td class="text-center align-top">
                <div class="form-check mb-0">
                    <input type="checkbox" class="form-check-input service-select-checkbox" aria-label="Select service">
                </div>
            </td>
            <td>
                <div class="service-display service-job-name-display fw-semibold"></div>
                <div class="service-edit d-none">
                    <input type="text" class="form-control form-control-sm job-name-input" list="job-name-options" autocomplete="off" placeholder="Job name">
                </div>
            </td>
            <td>
                <div class="service-display service-name-display"></div>
                <div class="service-edit d-none">
                    <textarea class="form-control form-control-sm service-name-input" rows="2" placeholder="Job description"></textarea>
                </div>
            </td>
            <td>
                <div class="service-display service-description-display text-muted small"></div>
                <div class="service-edit d-none">
                    <textarea class="form-control form-control-sm service-description-input" rows="2" placeholder="Internal notes (optional)"></textarea>
                </div>
            </td>
            <td>
                <div class="service-display service-due-kilometers-display text-muted small"></div>
                <div class="service-edit d-none">
                    <input type="number" class="form-control form-control-sm service-due-kilometers-input" min="0" step="1" placeholder="e.g. 5000">
                </div>
            </td>
            <td>
                <div class="service-display service-due-months-display text-muted small"></div>
                <div class="service-edit d-none">
                    <input type="number" class="form-control form-control-sm service-due-months-input" min="0" step="1" placeholder="e.g. 6">
                </div>
            </td>
            <td>
                <div class="service-display service-portal-display text-muted small"></div>
                <div class="service-edit d-none">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input service-portal-input" id="servicePortal-${service.id || 'new'}">
                        <label class="form-check-label" for="servicePortal-${service.id || 'new'}">Show</label>
                    </div>
                </div>
            </td>
            <td>
                <div class="service-display service-fixed-hours-display text-muted small"></div>
                <div class="service-edit d-none">
                    <input type="number" class="form-control form-control-sm service-fixed-hours-input" min="0" step="0.25" placeholder="e.g. 2.5">
                </div>
            </td>
            <td>
                <div class="service-display service-fixed-rate-display text-muted small"></div>
                <div class="service-edit d-none">
                    <input type="number" class="form-control form-control-sm service-fixed-rate-input" min="0" step="0.01" placeholder="e.g. 125.00">
                </div>
            </td>
            <td class="text-end align-top">
                <div class="btn-group btn-group-sm service-view-actions" role="group" aria-label="Service actions">
                    <button type="button" class="btn btn-outline-primary service-edit-btn">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                    <button type="button" class="btn btn-outline-danger service-delete-btn">
                        <i class="fas fa-trash-alt me-1"></i>Delete
                    </button>
                </div>
                <div class="btn-group btn-group-sm service-edit-actions d-none" role="group" aria-label="Edit actions">
                    <button type="button" class="btn btn-primary service-save-btn">
                        <i class="fas fa-save me-1"></i>Save
                    </button>
                    <button type="button" class="btn btn-outline-secondary service-cancel-btn">Cancel</button>
                </div>
                <div class="row-status text-muted small mt-2" aria-live="polite"></div>
            </td>
        `;
        attachRowEvents(row);
        applyServiceToRow(row, service);
        return row;
    }

    function insertServiceRow(service) {
        const tbody = document.getElementById('servicesTableBody');
        if (!tbody) {
            return;
        }
        const row = createRowElement(service);
        tbody.insertBefore(row, tbody.firstChild);
        updateServiceCount();
        toggleEmptyState();
        filterServices(currentSearchQuery);
        updateBulkSelectionUi();
    }

    function filterServices(query) {
        const normalized = (query || '').trim().toLowerCase();
        const dateRange = resolveServiceDateRange();
        const rows = document.querySelectorAll('.service-row');
        let visibleCount = 0;
        rows.forEach(function (row) {
            const searchText = row.dataset.searchText || '';
            const matchesText = !normalized || searchText.includes(normalized);
            const matchesDate = matchesDateRange(row.dataset.updatedDate || '', dateRange);
            const match = matchesText && matchesDate;
            if (match) {
                row.classList.remove('d-none');
                visibleCount += 1;
            } else {
                row.classList.add('d-none');
            }
        });
        const noResults = document.getElementById('servicesNoResults');
        if (!noResults) {
            return;
        }
        const totalRows = rows.length;
        const hasFilters = normalized || dateRange.isActive;
        if (hasFilters && visibleCount === 0 && totalRows > 0) {
            noResults.classList.remove('d-none');
        } else {
            noResults.classList.add('d-none');
        }
        updateBulkSelectionUi();
    }

    function handleNewService() {
        const jobNameInput = document.getElementById('newServiceJobName');
        const nameInput = document.getElementById('newServiceName');
        const descriptionInput = document.getElementById('newServiceDescription');
        const fixedHoursInput = document.getElementById('newServiceFixedHours');
        const fixedRateInput = document.getElementById('newServiceFixedRate');
        const dueKilometersInput = document.getElementById('newServiceDueKilometers');
        const dueMonthsInput = document.getElementById('newServiceDueMonths');
        const portalInput = document.getElementById('newServicePortalColumn');
        const statusTarget = document.getElementById('newServiceStatus');
        const table = getTable();
        if (!jobNameInput || !nameInput || !descriptionInput || !statusTarget || !table) {
            return;
        }
        const jobName = jobNameInput.value.trim();
        const serviceName = nameInput.value.trim();
        const description = descriptionInput.value;
        const fixedHoursRaw = fixedHoursInput ? fixedHoursInput.value.trim() : '';
        const fixedRateRaw = fixedRateInput ? fixedRateInput.value.trim() : '';
        const dueKilometersRaw = dueKilometersInput ? dueKilometersInput.value.trim() : '';
        const dueMonthsRaw = dueMonthsInput ? dueMonthsInput.value.trim() : '';
        if (!jobName || !serviceName) {
            showStatus(statusTarget, 'Job name and description are required.', 'error');
            return;
        }
        if (fixedHoursRaw) {
            const numeric = Number(fixedHoursRaw);
            if (!isFinite(numeric) || numeric < 0) {
                showStatus(statusTarget, 'Fixed hours must be a non-negative number.', 'error');
                if (fixedHoursInput) {
                    fixedHoursInput.focus();
                }
                return;
            }
        }
        if (fixedRateRaw) {
            const numericRate = Number(fixedRateRaw);
            if (!isFinite(numericRate) || numericRate < 0) {
                showStatus(statusTarget, 'Fixed rate must be a non-negative number.', 'error');
                if (fixedRateInput) {
                    fixedRateInput.focus();
                }
                return;
            }
        }
        const intervalChecks = [
            { value: dueKilometersRaw, label: 'Due after (km)', input: dueKilometersInput },
            { value: dueMonthsRaw, label: 'Due after (months)', input: dueMonthsInput },
        ];
        for (let i = 0; i < intervalChecks.length; i += 1) {
            const check = intervalChecks[i];
            if (check.value) {
                const numeric = Number(check.value);
                if (!isFinite(numeric) || numeric < 0) {
                    showStatus(statusTarget, `${check.label} must be a non-negative number.`, 'error');
                    if (check.input) {
                        check.input.focus();
                    }
                    return;
                }
            }
        }
        showStatus(statusTarget, 'Saving…', 'saving');
        const payload = {
            job_name: jobName,
            name: serviceName,
            description: description,
            fixed_hours: fixedHoursRaw,
            fixed_rate: fixedRateRaw,
            due_after_kilometers: dueKilometersRaw,
            due_after_months: dueMonthsRaw,
            show_on_customer_portal: portalInput ? portalInput.checked : false,
        };
        fetch(table.dataset.saveUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify(payload),
        })
            .then(function (response) {
                if (!response.ok) {
                    return response.json().then(function (data) {
                        throw data;
                    });
                }
                return response.json();
            })
            .then(function (data) {
                insertServiceRow(data.service);
                ensureJobNameOption(data.service.job_name.name);
                nameInput.value = '';
                descriptionInput.value = '';
                if (fixedHoursInput) {
                    fixedHoursInput.value = '';
                }
                if (fixedRateInput) {
                    fixedRateInput.value = '';
                }
                if (dueKilometersInput) {
                    dueKilometersInput.value = '';
                }
                if (dueMonthsInput) {
                    dueMonthsInput.value = '';
                }
                if (portalInput) {
                    portalInput.checked = false;
                }
                nameInput.focus();
                showStatus(statusTarget, 'Saved — add another job when you\'re ready.', 'success');
            })
            .catch(function (errorData) {
                const message = errorData && errorData.errors ? Object.values(errorData.errors).flat().join(' ') : 'Could not save this service.';
                showStatus(statusTarget, message, 'error');
            });
    }

    function bulkDeleteSelectedRows() {
        const selectedRows = getSelectedRows();
        if (!selectedRows.length) {
            return;
        }
        const message = selectedRows.length === 1
            ? 'Remove the selected service description?'
            : 'Remove the ' + selectedRows.length + ' selected service descriptions?';
        if (!confirm(message)) {
            return;
        }
        if (bulkDeleteStatus) {
            showStatus(bulkDeleteStatus, 'Deleting…', 'saving');
        }
        let remaining = selectedRows.length;
        let errorCount = 0;

        function finalize(success) {
            remaining -= 1;
            if (!success) {
                errorCount += 1;
            }
            if (remaining === 0) {
                if (bulkDeleteStatus) {
                    if (errorCount === 0) {
                        showStatus(bulkDeleteStatus, 'Selected services deleted.', 'success');
                    } else if (errorCount === selectedRows.length) {
                        showStatus(bulkDeleteStatus, 'Could not delete the selected services. Try again.', 'error');
                    } else {
                        showStatus(bulkDeleteStatus, 'Some services could not be deleted. Try again.', 'error');
                    }
                }
                updateBulkSelectionUi();
            }
        }

        selectedRows.forEach(function (row) {
            deleteRow(row, {
                confirm: false,
                onSuccess: function () {
                    finalize(true);
                },
                onError: function () {
                    finalize(false);
                },
            });
        });
    }

    let currentSearchQuery = '';

    document.addEventListener('DOMContentLoaded', function () {
        selectAllCheckbox = document.getElementById('selectAllServices');
        bulkDeleteButton = document.getElementById('bulkDeleteButton');
        bulkDeleteStatus = document.getElementById('bulkDeleteStatus');
        serviceDateRangeSelect = document.getElementById('serviceDateRange');
        serviceCustomRange = document.getElementById('serviceCustomRange');
        serviceStartDateInput = document.getElementById('serviceStartDate');
        serviceEndDateInput = document.getElementById('serviceEndDate');

        const rows = document.querySelectorAll('.service-row');
        rows.forEach(function (row) {
            attachRowEvents(row);
            const initialService = {
                id: row.dataset.serviceId || null,
                job_name: {
                    id: row.dataset.jobNameId || null,
                    name: row.dataset.jobName || '',
                },
                name: row.dataset.serviceName || '',
                description: row.dataset.serviceDescription || '',
                fixed_hours: row.dataset.serviceFixedHours || '',
                due_after_kilometers: row.dataset.serviceDueKilometers || '',
                due_after_months: row.dataset.serviceDueMonths || '',
                show_on_customer_portal: row.dataset.servicePortalColumn === 'true',
            };
            applyServiceToRow(row, initialService);
        });
        updateServiceCount();
        toggleEmptyState();

        const searchInput = document.getElementById('serviceSearchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                currentSearchQuery = searchInput.value || '';
                filterServices(currentSearchQuery);
            });
        }

        if (serviceDateRangeSelect) {
            serviceDateRangeSelect.addEventListener('change', function () {
                toggleServiceDateRange();
                filterServices(currentSearchQuery);
            });
        }
        if (serviceStartDateInput) {
            serviceStartDateInput.addEventListener('change', function () {
                if (serviceDateRangeSelect?.value === 'custom') {
                    filterServices(currentSearchQuery);
                }
            });
        }
        if (serviceEndDateInput) {
            serviceEndDateInput.addEventListener('change', function () {
                if (serviceDateRangeSelect?.value === 'custom') {
                    filterServices(currentSearchQuery);
                }
            });
        }

        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function () {
                const visibleCheckboxes = getVisibleRowCheckboxes();
                visibleCheckboxes.forEach(function (checkbox) {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                updateBulkSelectionUi();
            });
        }

        if (bulkDeleteButton) {
            bulkDeleteButton.addEventListener('click', function () {
                bulkDeleteSelectedRows();
            });
        }

        const addButton = document.getElementById('addServiceButton');
        if (addButton) {
            addButton.addEventListener('click', function () {
                handleNewService();
            });
        }

        ['newServiceJobName', 'newServiceName', 'newServiceDescription', 'newServiceFixedHours', 'newServiceFixedRate', 'newServiceDueKilometers', 'newServiceDueMonths'].forEach(function (id) {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        handleNewService();
                    }
                });
            }
        });

        toggleServiceDateRange();
        filterServices(currentSearchQuery);
        updateBulkSelectionUi();
    });
})();
</script>
{% endblock %}
