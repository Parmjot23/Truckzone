{% extends 'customer_portal_base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Parts Store Dashboard{% endblock %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@500;600;700;800&display=swap');

    .parts-dashboard {
        --ink: #0b1220;
        --muted: #52637a;
        --accent: #2563eb;
        --accent-strong: #1d4ed8;
        --border: rgba(148,163,184,0.4);
        --wash-ice: linear-gradient(135deg, #f7f9fc 0%, #eef2f7 55%, #fdfdff 100%);
        --wash-sky: linear-gradient(135deg, #f3f8ff 0%, #e6f1ff 55%, #f8fbff 100%);
        --wash-mint: linear-gradient(135deg, #f1fff7 0%, #e4fbef 55%, #f8fffb 100%);
        --wash-sun: linear-gradient(135deg, #fff8ee 0%, #ffefdb 55%, #fff8ef 100%);
        --wash-peach: linear-gradient(135deg, #fff3ef 0%, #ffe7d7 55%, #fff7f2 100%);
        --panel-wash: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(246,248,252,0.92) 100%);
        padding: 1.1rem 1.1rem 2rem;
        border-radius: 24px;
        border: 1px solid rgba(148,163,184,0.4);
        background:
            radial-gradient(circle at 12% 0%, rgba(125,211,252,0.28), transparent 55%),
            radial-gradient(circle at 88% 8%, rgba(134,239,172,0.22), transparent 45%),
            linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
        box-shadow: 0 24px 60px rgba(15,23,42,0.08);
        font-family: 'Space Grotesk', 'Manrope', sans-serif;
    }
    .parts-dashboard * { box-sizing: border-box; }
    .parts-dashboard > * { position: relative; }
    .parts-hero {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem 1.1rem;
        border-radius: 20px;
        background: var(--wash-ice);
        border: 1px solid rgba(148,163,184,0.45);
        box-shadow: 0 18px 40px rgba(15,23,42,0.08);
    }
    .hero-eyebrow { text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.32em; color: #0ea5e9; font-weight: 700; }
    .hero-location { display: inline-flex; align-items: center; gap: 0.45rem; margin-top: 0.35rem; }
    .hero-location i { color: #0ea5e9; }
    .hero-location-label { text-transform: uppercase; letter-spacing: 0.2em; font-size: 0.6rem; color: #64748b; font-weight: 700; }
    .hero-location-value { font-size: 0.85rem; color: var(--ink); font-weight: 700; }
    .hero-title { font-size: 2rem; font-weight: 800; margin: 0.25rem 0; color: var(--ink); font-family: 'Manrope', 'Space Grotesk', sans-serif; letter-spacing: -0.02em; }
    .hero-sub { margin: 0; color: var(--muted); font-weight: 500; max-width: 480px; }
    .hero-actions { display: flex; flex-wrap: wrap; gap: 0.55rem; }
    .ghost-btn {
        border: 1px solid rgba(148,163,184,0.45);
        background: rgba(255,255,255,0.88);
        padding: 0.6rem 0.95rem;
        border-radius: 999px;
        color: var(--ink);
        font-weight: 600;
        box-shadow: 0 12px 26px rgba(15,23,42,0.08);
        text-decoration: none;
        transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }
    .ghost-btn:hover { border-color: #38bdf8; color: #0284c7; transform: translateY(-1px); }
    .primary-pill {
        background: linear-gradient(120deg, #2563eb 0%, #0ea5e9 100%);
        color: #fff;
        border: none;
        padding: 0.65rem 1.1rem;
        border-radius: 999px;
        box-shadow: 0 16px 34px rgba(14,165,233,0.32);
        font-weight: 700;
        text-decoration: none;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .primary-pill:hover { transform: translateY(-1px); box-shadow: 0 18px 36px rgba(14,165,233,0.4); }
    .primary-pill i { margin-right: 0.4rem; }
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.7rem;
        margin-bottom: 1rem;
        padding: 0.65rem;
        border-radius: 20px;
        background: var(--wash-mint);
        border: 1px solid rgba(148,163,184,0.35);
        box-shadow: 0 16px 40px rgba(15,23,42,0.06);
    }
    .summary-card {
        border-radius: 16px;
        border: 1px solid rgba(148,163,184,0.35);
        padding: 0.95rem;
        box-shadow: 0 10px 26px rgba(15,23,42,0.08);
        background: var(--panel-wash);
    }
    .summary-card:nth-child(1) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(219,234,254,0.6) 100%); }
    .summary-card:nth-child(2) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(220,252,231,0.6) 100%); }
    .summary-card:nth-child(3) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(254,243,199,0.6) 100%); }
    .summary-card:nth-child(4) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,228,214,0.6) 100%); }
    .summary-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.2em; color: var(--muted); font-weight: 700; }
    .summary-value { font-size: 1.55rem; font-weight: 800; color: var(--ink); margin-top: 0.25rem; }
    .summary-meta { color: var(--muted); font-size: 0.85rem; margin-top: 0.1rem; }
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 0.7rem;
        margin-bottom: 1rem;
        padding: 0.65rem;
        border-radius: 20px;
        background: var(--wash-sun);
        border: 1px solid rgba(148,163,184,0.35);
        box-shadow: 0 16px 40px rgba(15,23,42,0.06);
    }
    .action-card {
        border-radius: 16px;
        border: 1px solid rgba(148,163,184,0.35);
        padding: 0.95rem;
        text-decoration: none;
        color: inherit;
        transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease;
        box-shadow: 0 10px 24px rgba(15,23,42,0.08);
        background: var(--panel-wash);
    }
    .action-card:nth-child(3n + 1) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(219,234,254,0.55) 100%); }
    .action-card:nth-child(3n + 2) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(220,252,231,0.55) 100%); }
    .action-card:nth-child(3n + 3) { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(254,249,195,0.55) 100%); }
    .action-card:hover { transform: translateY(-3px); box-shadow: 0 18px 32px rgba(14,165,233,0.16); border-color: rgba(56,189,248,0.6); }
    .action-title { font-weight: 700; color: var(--ink); }
    .action-sub { color: var(--muted); font-size: 0.9rem; margin-top: 0.35rem; }
    .panel-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.75rem;
        margin-bottom: 0.9rem;
        padding: 0.65rem;
        border-radius: 20px;
        background: var(--wash-sky);
        border: 1px solid rgba(148,163,184,0.35);
        box-shadow: 0 16px 40px rgba(15,23,42,0.06);
    }
    .panel {
        background: var(--panel-wash);
        border-radius: 16px;
        border: 1px solid rgba(148,163,184,0.35);
        padding: 0.9rem;
        box-shadow: 0 10px 26px rgba(15,23,42,0.08);
    }
    .panel-meta { color: var(--muted); font-size: 0.85rem; }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.6rem; }
    .panel-title { font-weight: 700; color: var(--ink); }
    .panel-sub { color: var(--muted); font-size: 0.85rem; }
    .panel-link { color: var(--accent); font-weight: 600; text-decoration: none; }
    .panel-link:hover { text-decoration: underline; }
    .list-item { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.55rem 0; border-bottom: 1px solid rgba(148,163,184,0.2); }
    .list-item:last-child { border-bottom: none; padding-bottom: 0; }
    .item-title { font-weight: 600; color: var(--ink); }
    .item-sub { color: var(--muted); font-size: 0.85rem; }
    .item-meta { text-align: right; }
    .item-amount { font-weight: 700; color: var(--ink); }
    .status-pill { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.72rem; font-weight: 700; }
    .status-paid { background: #dcfce7; color: #166534; }
    .status-partial { background: #fef9c3; color: #854d0e; }
    .status-unpaid { background: #fee2e2; color: #991b1b; }
    .order-status-pill { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.72rem; font-weight: 700; }
    .order-status-new { background: #dbeafe; color: #1d4ed8; }
    .order-status-ready { background: #dcfce7; color: #166534; }
    .order-status-picked { background: #e2e8f0; color: #475569; }
    .order-row--new { background: rgba(59,130,246,0.08); }
    .order-row--new td { background: rgba(59,130,246,0.08); }
    .order-item-preview { color: var(--muted); font-size: 0.82rem; }
    .order-item-thumb {
        width: 46px;
        height: 46px;
        border-radius: 10px;
        border: 1px solid rgba(148,163,184,0.35);
        object-fit: cover;
        background: #f8fafc;
        position: relative;
        cursor: zoom-in;
        transform-origin: left center;
        transition: transform 0.16s ease, box-shadow 0.16s ease;
        z-index: 1;
    }
    @media (hover: hover) {
        .order-item-thumb:hover {
            transform: scale(2.8);
            box-shadow: 0 18px 40px rgba(15,23,42,0.28);
            z-index: 5;
        }
    }
    .order-item-thumb--empty {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }
    .empty-state { color: #8a97ab; font-size: 0.9rem; padding: 0.6rem 0; }
    .panel-grid-triple {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.75rem;
        margin-bottom: 0.9rem;
        padding: 0.65rem;
        border-radius: 20px;
        background: var(--wash-peach);
        border: 1px solid rgba(148,163,184,0.35);
        box-shadow: 0 16px 40px rgba(15,23,42,0.06);
    }
    .queue-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; background: rgba(255,255,255,0.9); border-radius: 14px; overflow: hidden; border: 1px solid rgba(148,163,184,0.3); }
    .queue-table th, .queue-table td { padding: 0.55rem 0.65rem; border-bottom: 1px solid rgba(148,163,184,0.25); vertical-align: middle; background: rgba(255,255,255,0.9); }
    .queue-table th { color: var(--muted); font-weight: 800; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; background: rgba(248,250,252,0.9); }
    .chart-panel { background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf3 50%, #fff7ed 100%); border-color: rgba(125,211,252,0.6); }
    .chart-grid { display: grid; grid-template-columns: minmax(180px, 0.9fr) minmax(0, 1.1fr); gap: 0.8rem; align-items: center; }
    .donut { width: 200px; height: 200px; border-radius: 50%; background: conic-gradient(#e2e8f0 0deg, #e2e8f0 360deg); position: relative; margin: 0 auto; box-shadow: 0 18px 42px rgba(15,23,42,0.12); }
    .donut-center { position: absolute; inset: 22%; background: rgba(255,255,255,0.95); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: inset 0 0 0 1px rgba(148,163,184,0.3); }
    .donut-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.16em; color: var(--muted); font-weight: 700; }
    .donut-value { font-size: 1.05rem; font-weight: 800; color: var(--ink); margin-top: 0.2rem; }
    .legend-list { display: flex; flex-direction: column; gap: 0.35rem; }
    .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; padding: 0.35rem 0; border-bottom: 1px solid rgba(148,163,184,0.2); }
    .legend-item:last-child { border-bottom: none; }
    .legend-dot { width: 10px; height: 10px; border-radius: 999px; background: var(--dot-color, #94a3b8); box-shadow: 0 0 0 4px rgba(15,23,42,0.06); flex-shrink: 0; }
    .legend-text { font-weight: 600; color: var(--ink); flex: 1; }
    .legend-meta { color: var(--muted); font-size: 0.82rem; text-align: right; }
    .chart-footer { margin-top: 0.4rem; color: #475569; font-size: 0.85rem; font-weight: 600; }

    /* POS terminal */
    .pos-terminal {
        --pos-ink: var(--ink);
        --pos-muted: var(--muted);
        --pos-accent: #0ea5e9;
        --pos-accent-strong: #2563eb;
        --pos-border: rgba(148,163,184,0.45);
        margin: 1rem 0 1.1rem;
        padding: 1rem;
        border-radius: 22px;
        border: 1px solid var(--pos-border);
        background:
            radial-gradient(circle at 8% 0%, rgba(14,165,233,0.18), transparent 55%),
            radial-gradient(circle at 90% 10%, rgba(59,130,246,0.16), transparent 48%),
            linear-gradient(180deg, #f8fbff 0%, #f0f5fb 100%);
        box-shadow: 0 22px 50px rgba(15,23,42,0.12);
    }
    .pos-head { display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; margin-bottom: 0.85rem; }
    .pos-eyebrow { text-transform: uppercase; letter-spacing: 0.3em; font-size: 0.65rem; font-weight: 800; color: var(--pos-accent); }
    .pos-title { font-size: 1.5rem; font-weight: 800; margin: 0.2rem 0 0.15rem; color: var(--pos-ink); }
    .pos-sub { color: var(--pos-muted); margin: 0; font-weight: 500; }
    .pos-mode-toggle { display: inline-flex; background: rgba(255,255,255,0.85); border: 1px solid var(--pos-border); border-radius: 999px; padding: 0.2rem; gap: 0.25rem; }
    .pos-mode-btn { border: none; background: transparent; padding: 0.4rem 0.85rem; border-radius: 999px; font-weight: 700; color: var(--pos-muted); text-decoration: none; transition: all 0.15s ease; }
    .pos-mode-btn.active { background: linear-gradient(120deg, var(--pos-accent-strong), var(--pos-accent)); color: #fff; box-shadow: 0 8px 18px rgba(37,99,235,0.25); }
    .pos-mode-btn:hover { color: var(--pos-accent-strong); }
    .pos-link { font-size: 0.85rem; font-weight: 700; color: var(--pos-accent-strong); text-decoration: none; }
    .pos-link:hover { text-decoration: underline; }
    .pos-grid { display: grid; grid-template-columns: minmax(0, 1.2fr) minmax(0, 0.8fr); gap: 0.9rem; align-items: start; }
    .pos-panel { background: rgba(255,255,255,0.95); border-radius: 18px; border: 1px solid var(--pos-border); box-shadow: 0 14px 34px rgba(15,23,42,0.08); padding: 0.85rem; }
    .pos-catalog-header { display: flex; flex-direction: column; gap: 0.65rem; }
    .pos-searchbar { display: flex; align-items: center; gap: 0.5rem; padding: 0.55rem 0.7rem; border-radius: 12px; background: #fff; border: 1px solid rgba(148,163,184,0.45); }
    .pos-searchbar i { color: var(--pos-accent); }
    .pos-searchbar input { border: none; outline: none; flex: 1; font-weight: 600; }
    .pos-search-clear { border: none; background: transparent; color: var(--pos-muted); font-weight: 700; }
    .pos-tabs { display: inline-flex; gap: 0.4rem; flex-wrap: wrap; }
    .pos-tab { border: 1px solid rgba(148,163,184,0.45); background: rgba(255,255,255,0.9); border-radius: 999px; padding: 0.35rem 0.85rem; font-size: 0.82rem; font-weight: 700; color: var(--pos-muted); }
    .pos-tab.active { background: #111827; color: #fff; border-color: #111827; box-shadow: 0 8px 18px rgba(15,23,42,0.2); }
    .pos-grid-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.65rem; margin-top: 0.7rem; }
    .pos-product-card, .pos-service-card { border: 1px solid rgba(148,163,184,0.45); border-radius: 14px; padding: 0.7rem; background: #fff; text-align: left; transition: transform 0.15s ease, box-shadow 0.15s ease; display: flex; flex-direction: column; gap: 0.35rem; min-height: 120px; }
    .pos-product-card:hover, .pos-service-card:hover { transform: translateY(-2px); box-shadow: 0 14px 30px rgba(15,23,42,0.12); }
    .pos-product-title { font-weight: 700; color: var(--pos-ink); }
    .pos-product-meta { color: var(--pos-muted); font-size: 0.78rem; }
    .pos-product-price { font-weight: 800; color: var(--pos-accent-strong); }
    .pos-add-badge { margin-top: auto; font-size: 0.78rem; font-weight: 700; color: #0f172a; display: inline-flex; align-items: center; gap: 0.35rem; }
    .pos-custom-entry { background: #fff; border: 1px dashed rgba(148,163,184,0.55); border-radius: 14px; padding: 0.8rem; margin-top: 0.7rem; }
    .pos-custom-entry .form-control { border-radius: 10px; }
    .pos-cart-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.6rem; }
    .pos-cart-title { font-weight: 800; font-size: 1rem; color: var(--pos-ink); }
    .pos-cart-sub { color: var(--pos-muted); font-size: 0.82rem; }
    .pos-cart-lines { display: flex; flex-direction: column; gap: 0.5rem; margin: 0.6rem 0; }
    .pos-cart-line { border: 1px solid rgba(148,163,184,0.35); border-radius: 12px; padding: 0.6rem; background: #fff; display: grid; grid-template-columns: minmax(0, 1fr) auto; gap: 0.5rem; align-items: center; }
    .pos-line-title { font-weight: 700; color: var(--pos-ink); }
    .pos-line-sub { font-size: 0.75rem; color: var(--pos-muted); }
    .pos-line-controls { display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap; justify-content: flex-end; }
    .pos-qty { display: inline-flex; align-items: center; gap: 0.25rem; border: 1px solid rgba(148,163,184,0.45); border-radius: 999px; padding: 0.2rem 0.4rem; }
    .pos-qty button { border: none; background: transparent; font-weight: 700; width: 24px; height: 24px; }
    .pos-qty input { width: 48px; border: none; text-align: center; font-weight: 700; }
    .pos-rate-input { width: 80px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.45); padding: 0.2rem 0.35rem; }
    .pos-line-total { font-weight: 700; color: var(--pos-ink); min-width: 70px; text-align: right; }
    .pos-remove { border: none; background: rgba(248,113,113,0.15); color: #b91c1c; font-weight: 700; border-radius: 8px; padding: 0.25rem 0.4rem; }
    .pos-summary { border-top: 1px dashed rgba(148,163,184,0.5); padding-top: 0.6rem; margin-top: 0.6rem; display: grid; gap: 0.35rem; }
    .pos-summary-row { display: flex; justify-content: space-between; font-weight: 600; color: var(--pos-muted); }
    .pos-summary-total { font-size: 1.1rem; color: var(--pos-ink); font-weight: 800; }
    .pos-payment { margin-top: 0.6rem; padding: 0.6rem; border-radius: 14px; background: #f8fafc; border: 1px solid rgba(148,163,184,0.3); }
    .pos-payment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .pos-methods { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-bottom: 0.5rem; }
    .pos-method-btn { border: 1px solid rgba(148,163,184,0.45); background: #fff; border-radius: 999px; padding: 0.3rem 0.75rem; font-weight: 700; font-size: 0.78rem; color: var(--pos-muted); }
    .pos-method-btn.active { background: linear-gradient(120deg, var(--pos-accent-strong), var(--pos-accent)); color: #fff; border-color: transparent; box-shadow: 0 8px 18px rgba(37,99,235,0.25); }
    .pos-amount-row { display: flex; align-items: flex-end; gap: 0.5rem; flex-wrap: wrap; }
    .pos-amount-row input { border-radius: 10px; border: 1px solid rgba(148,163,184,0.45); padding: 0.4rem 0.55rem; font-weight: 700; }
    .pos-pill-btn { border: none; background: rgba(59,130,246,0.14); color: #1d4ed8; font-weight: 700; border-radius: 999px; padding: 0.35rem 0.8rem; }
    .pos-change-row { display: flex; justify-content: space-between; font-size: 0.82rem; color: var(--pos-muted); margin-top: 0.4rem; }
    .pos-actions { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 0.5rem; margin-top: 0.7rem; }
    .pos-btn-ghost { border: 1px solid rgba(148,163,184,0.45); background: #fff; border-radius: 12px; padding: 0.55rem 0.6rem; font-weight: 700; }
    .pos-btn-outline { border: 1px solid rgba(37,99,235,0.4); background: rgba(37,99,235,0.08); color: #1d4ed8; border-radius: 12px; padding: 0.55rem 0.6rem; font-weight: 700; }
    .pos-btn-primary { border: none; background: linear-gradient(120deg, #1d4ed8, #0ea5e9); color: #fff; border-radius: 12px; padding: 0.6rem 0.6rem; font-weight: 800; box-shadow: 0 14px 30px rgba(14,165,233,0.25); }
    .pos-empty { color: var(--pos-muted); font-size: 0.85rem; padding: 0.8rem; border: 1px dashed rgba(148,163,184,0.5); border-radius: 12px; text-align: center; background: rgba(255,255,255,0.7); }
    .pos-helper { margin-top: 0.4rem; font-size: 0.78rem; color: var(--pos-muted); }
    .pos-switch { display: inline-flex; align-items: center; gap: 0.4rem; font-weight: 600; color: var(--pos-muted); }
    .pos-switch input { accent-color: #2563eb; }
    .pos-customer-block { display: grid; gap: 0.35rem; margin-bottom: 0.6rem; }
    .pos-customer-block .form-label { font-weight: 700; }
    .pos-date-input { max-width: 160px; border-radius: 10px; border: 1px solid rgba(148,163,184,0.45); padding: 0.35rem 0.45rem; font-weight: 600; }
    .pos-email-input { border-radius: 10px; border: 1px solid rgba(148,163,184,0.45); padding: 0.35rem 0.5rem; }
    .pos-cart-panel { position: sticky; top: 1rem; }
    @keyframes riseIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .parts-hero,
    .summary-card,
    .action-card,
    .panel,
    .pos-terminal { animation: riseIn 0.6s ease both; }
    .summary-card:nth-child(1) { animation-delay: 0.05s; }
    .summary-card:nth-child(2) { animation-delay: 0.1s; }
    .summary-card:nth-child(3) { animation-delay: 0.15s; }
    .summary-card:nth-child(4) { animation-delay: 0.2s; }
    .action-card:nth-child(1) { animation-delay: 0.12s; }
    .action-card:nth-child(2) { animation-delay: 0.16s; }
    .action-card:nth-child(3) { animation-delay: 0.2s; }
    .action-card:nth-child(4) { animation-delay: 0.24s; }
    .action-card:nth-child(5) { animation-delay: 0.28s; }
    .action-card:nth-child(6) { animation-delay: 0.32s; }
    .panel-grid-triple .panel:nth-child(1) { animation-delay: 0.14s; }
    .panel-grid-triple .panel:nth-child(2) { animation-delay: 0.18s; }
    .panel-grid-triple .panel:nth-child(3) { animation-delay: 0.22s; }
    .panel-grid .panel:nth-child(1) { animation-delay: 0.2s; }
    .panel-grid .panel:nth-child(2) { animation-delay: 0.24s; }
    @media (prefers-reduced-motion: reduce) {
        .parts-hero,
        .summary-card,
        .action-card,
        .panel { animation: none; }
    }
    @media (max-width: 1199.98px) {
        .panel-grid-triple { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
        .pos-grid { grid-template-columns: 1fr; }
        .pos-actions { grid-template-columns: 1fr; }
        .pos-cart-panel { position: static; }
    }
    @media (max-width: 767.98px) {
        .chart-grid { grid-template-columns: 1fr; }
        .donut { width: 170px; height: 170px; }
    }
    @media (max-width: 575.98px) {
        .parts-dashboard { padding: 0.9rem 0.9rem 1.6rem; }
        .hero-title { font-size: 1.6rem; }
        .summary-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    }
</style>

<div class="parts-dashboard">
    <div class="parts-hero">
        <div>
            <div class="hero-eyebrow">Parts Store</div>
            {% if storefront_selected_profile %}
            <div class="hero-location">
                <i class="fa-solid fa-location-dot"></i>
                <span class="hero-location-label">Location</span>
                <span class="hero-location-value">{{ storefront_selected_profile.storefront_label }}</span>
            </div>
            {% endif %}
            <div class="hero-title">{{ business_name|default:default_business_name }}</div>
            <p class="hero-sub">Manage inventory, pricing, and storefront activity in one place.</p>
        </div>
        <div class="hero-actions">
            <a class="primary-pill" href="{% url 'accounts:inventory_hub' %}">
                <i class="fa-solid fa-boxes-stacked"></i>Inventory Hub
            </a>
            <a class="ghost-btn" href="{% url 'accounts:store_hub' %}">
                <i class="fa-solid fa-store"></i>Storefront
            </a>
            <a class="ghost-btn" href="{% url 'accounts:store_product_list' %}" target="_blank" rel="noopener">
                <i class="fa-solid fa-arrow-up-right-from-square"></i>Public Store
            </a>
        </div>
    </div>

    <div class="pos-terminal" id="pos-terminal"
         data-payment-url-template="{% url 'accounts:mark_invoice_paid' 0 %}"
         data-add-customer-url="{% url 'accounts:add_customer' %}"
         data-add-vehicle-url="{% url 'accounts:add_vehicle' %}"
         data-tax-rate="{{ default_tax_rate }}">
        <div class="pos-head">
            <div>
                <div class="pos-eyebrow">Sales Console</div>
                <div class="pos-title">In-store POS</div>
                <p class="pos-sub">Ring up parts, take payment, and print invoices faster than the daily workslip.</p>
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <div class="pos-mode-toggle">
                    <a href="{% url 'accounts:store_hub' %}" class="pos-mode-btn">Online store</a>
                    <button type="button" class="pos-mode-btn active">In-store POS</button>
                </div>
                <a href="{% url 'accounts:add_dailylog' %}" class="pos-link">Open full invoice</a>
            </div>
        </div>
        <div class="pos-grid">
            <div class="pos-panel">
                <div class="pos-catalog-header">
                    <div class="pos-searchbar">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="pos-search-input" placeholder="Search parts, SKU, or service...">
                        <button type="button" class="pos-search-clear" id="pos-search-clear">Clear</button>
                    </div>
                    <div class="pos-tabs">
                        <button type="button" class="pos-tab active" data-pos-tab="products">Parts</button>
                        <button type="button" class="pos-tab" data-pos-tab="services">Services</button>
                        <button type="button" class="pos-tab" data-pos-tab="custom">Custom</button>
                    </div>
                </div>
                <div id="pos-product-grid" class="pos-grid-list"></div>
                <div id="pos-service-grid" class="pos-grid-list d-none"></div>
                <div id="pos-custom-entry" class="pos-custom-entry d-none">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-6">
                            <label class="form-label">Custom description</label>
                            <input type="text" class="form-control" id="pos-custom-name" placeholder="Labor, shop supply, misc...">
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label">Qty</label>
                            <input type="number" class="form-control" id="pos-custom-qty" value="1" min="0" step="0.01">
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label">Rate</label>
                            <input type="number" class="form-control" id="pos-custom-rate" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div class="col-12 d-flex justify-content-end">
                            <button type="button" class="btn btn-primary btn-sm" id="pos-custom-add">
                                <i class="fa-solid fa-plus me-1"></i>Add to cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pos-panel pos-cart-panel">
                <form id="pos-checkout-form" method="post" action="{% url 'accounts:quick_invoice_create' %}">
                    {% csrf_token %}
                    <div class="pos-cart-header">
                        <div>
                            <div class="pos-cart-title">Current sale</div>
                            <div class="pos-cart-sub">Tap items to add. Adjust qty/rate inline.</div>
                        </div>
                        <div>
                            <label class="form-label mb-1">Sale date</label>
                            <input type="date" class="pos-date-input" id="pos-sale-date" value="{{ today|date:'Y-m-d' }}">
                        </div>
                    </div>

                    <div class="pos-customer-block">
                        <label class="form-label">Customer</label>
                        <div class="input-group">
                            <div class="dropdown flex-grow-1">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button"
                                        id="pos-customer-picker" data-bs-toggle="dropdown" aria-expanded="false">
                                    Select customer
                                </button>
                                <div class="dropdown-menu p-2 w-100" aria-labelledby="pos-customer-picker" style="max-height: 280px; overflow: auto;">
                                    <input type="text" class="form-control form-control-sm mb-2" id="pos-customer-search" placeholder="Search name or email...">
                                    <div id="pos-customer-list"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-secondary" id="pos-add-customer" title="Add new customer">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <input type="hidden" name="customer" id="pos-customer" value="">
                    </div>

                    <div class="pos-customer-block">
                        <label class="form-label">Vehicle (optional)</label>
                        <div class="input-group">
                            <div class="dropdown flex-grow-1">
                                <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button"
                                        id="pos-vehicle-picker" data-bs-toggle="dropdown" aria-expanded="false">
                                    Select vehicle
                                </button>
                                <div class="dropdown-menu p-2 w-100" aria-labelledby="pos-vehicle-picker" style="max-height: 280px; overflow: auto;">
                                    <input type="text" class="form-control form-control-sm mb-2" id="pos-vehicle-search" placeholder="Search vehicle...">
                                    <div class="small text-muted mb-2" id="pos-vehicle-hint">Select a customer to see vehicles.</div>
                                    <div id="pos-vehicle-list"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-secondary d-none" id="pos-add-vehicle" title="Add new vehicle for selected customer">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                        <input type="hidden" name="vehicle" id="pos-vehicle" value="">
                    </div>

                    <div id="pos-cart-lines" class="pos-cart-lines"></div>

                    <div class="pos-summary">
                        <div class="pos-summary-row">
                            <span>Subtotal</span>
                            <span id="pos-subtotal">$0.00</span>
                        </div>
                        <div class="pos-summary-row">
                            <span>Tax (<span id="pos-tax-rate-label">0%</span>)</span>
                            <span id="pos-tax">$0.00</span>
                        </div>
                        <label class="pos-switch">
                            <input type="checkbox" id="pos-tax-exempt">
                            <span>Tax exempt</span>
                        </label>
                        <div class="pos-summary-row pos-summary-total">
                            <span>Total</span>
                            <span id="pos-total">$0.00</span>
                        </div>
                    </div>

                    <div class="pos-payment">
                        <div class="pos-payment-header">
                            <div class="fw-semibold">Payment</div>
                            <label class="pos-switch">
                                <input type="checkbox" id="pos-record-payment" checked>
                                <span>Record now</span>
                            </label>
                        </div>
                        <div class="pos-methods" id="pos-methods">
                            {% for method in payment_methods %}
                            <button type="button" class="pos-method-btn" data-method="{{ method }}">{{ method }}</button>
                            {% endfor %}
                        </div>
                        <div class="pos-amount-row">
                            <div>
                                <label class="form-label mb-1">Amount</label>
                                <input type="number" step="0.01" min="0" id="pos-payment-amount" class="form-control" placeholder="0.00">
                            </div>
                            <button type="button" class="pos-pill-btn" id="pos-pay-full">Pay full</button>
                        </div>
                        <div class="pos-change-row">
                            <span>Change due</span>
                            <span id="pos-change-due">$0.00</span>
                        </div>
                        <div class="mt-2">
                            <label class="form-label mb-1">Email receipt (optional)</label>
                            <input type="email" class="pos-email-input w-100" id="pos-email" placeholder="customer@example.com">
                        </div>
                        <div class="mt-2">
                            <label class="pos-switch">
                                <input type="checkbox" id="pos-open-invoice" checked>
                                <span>Open invoice after checkout</span>
                            </label>
                        </div>
                    </div>

                    <div class="pos-actions">
                        <button type="button" class="pos-btn-ghost" id="pos-clear-cart">Clear</button>
                        <button type="button" class="pos-btn-outline" id="pos-save-sale">Save (no payment)</button>
                        <button type="button" class="pos-btn-primary" id="pos-checkout-btn">
                            <i class="fa-solid fa-bolt me-1"></i>Checkout
                        </button>
                    </div>
                    <div class="pos-helper">Tip: use the custom tab for labor, discounts, or special parts.</div>
                </form>
            </div>
        </div>
    </div>

    <div class="panel-grid">
        <section class="panel" id="online-orders-panel"
                 data-feed-url="{% url 'accounts:parts_store_dashboard_feed' %}"
                 data-status-url-template="{% url 'accounts:parts_store_order_status' 0 %}"
                 data-cancel-url-template="{% url 'accounts:parts_store_order_cancel' 0 %}"
                 data-invoice-detail-url-template="{% url 'accounts:groupedinvoice_detail' 0 %}">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Online orders</div>
                    <div class="panel-sub"><span id="online-orders-count">{{ online_orders_count|default:0 }}</span> active orders</div>
                </div>
                <a class="panel-link" href="{% url 'accounts:groupedinvoice_list' %}?order_source=online">View all</a>
            </div>
            <div class="table-responsive">
                <table class="queue-table{% if not online_orders %} d-none{% endif %}" id="online-orders-table">
                    <thead>
                        <tr>
                            <th>Order</th>
                            <th>Items</th>
                            <th>Placed</th>
                            <th>Status</th>
                            <th class="text-end">Total</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="online-orders-tbody">
                        {% if online_orders %}
                            {% for order in online_orders %}
                            <tr class="{% if order.online_order_status == 'new' or not order.online_order_status %}order-row--new{% endif %}">
                                <td>
                                    <a class="item-title text-decoration-none" href="{% url 'accounts:groupedinvoice_detail' order.pk %}">#{{ order.invoice_number }}</a>
                                    <div class="item-sub">{{ order.customer.name|default:order.bill_to|default:"Customer" }}</div>
                                </td>
                                <td>
                                    {% with records=order.income_records.all %}
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <div class="order-item-preview">
                                                {{ records|length }} item{{ records|length|pluralize }}
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary js-online-order-items"
                                                data-order-id="{{ order.pk }}">
                                                View items
                                            </button>
                                        </div>
                                    {% endwith %}
                                </td>
                                <td>{{ order.created_at|date:"M d, Y g:i a" }}</td>
                                <td>
                                    {% if order.online_order_status == 'ready' %}
                                        <span class="order-status-pill order-status-ready">Ready</span>
                                    {% elif order.online_order_status == 'picked' %}
                                        <span class="order-status-pill order-status-picked">Picked</span>
                                    {% else %}
                                        <span class="order-status-pill order-status-new">New</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ order.total_amount|currency }}</td>
                                <td class="text-end">
                                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                                        <a class="btn btn-sm btn-outline-secondary order-action-btn" href="{% url 'accounts:groupedinvoice_detail' order.pk %}" target="_blank" rel="noopener">View</a>
                                        <button type="button" class="btn btn-sm btn-outline-danger order-action-btn js-online-order-cancel"
                                            data-order-id="{{ order.pk }}">Cancel</button>
                                        {% if order.online_order_status == 'ready' %}
                                            <button type="button" class="btn btn-sm btn-outline-success order-action-btn js-online-order-action"
                                                data-order-id="{{ order.pk }}" data-next-status="picked">Mark picked</button>
                                        {% elif order.online_order_status == 'picked' %}
                                            <span class="text-muted small">Picked</span>
                                        {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-primary order-action-btn js-online-order-action"
                                                data-order-id="{{ order.pk }}" data-next-status="ready">Mark ready</button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <div class="empty-state{% if online_orders %} d-none{% endif %}" id="online-orders-empty">No online orders yet.</div>
        </section>
    </div>

    <div class="panel-grid-triple">
        <section class="panel h-100" id="overdue-customers-panel"
                 data-reminder-url-template="{% url 'accounts:trigger_overdue_reminder' 0 %}"
                 data-record-payment-url-template="{% url 'accounts:record_customer_payment' 0 %}"
                 data-followup-url-template="{% url 'accounts:update_overdue_followup' 0 %}"
                 data-invoice-detail-url-template="{% url 'accounts:groupedinvoice_detail' 0 %}">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div>
                    <div class="panel-title">Overdue Customers</div>
                    <div class="panel-meta">
                        <strong>{{ overdue_customers_count|default:0 }}</strong> customers &bull;
                        Total overdue: <strong>{{ overdue_customers_total|default:0|currency }}</strong>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="overdue-search" placeholder="Search customer..." style="min-width: 180px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="overdue-expand-btn">
                        <i class="fa-solid fa-up-right-and-down-left-from-center me-1"></i>Expand
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="queue-table" id="overdue-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Last statement</th>
                            <th class="text-end">Balance Due</th>
                            <th class="text-end">Payment</th>
                            <th class="text-end">Reminder</th>
                        </tr>
                    </thead>
                    <tbody id="overdue-tbody">
                        <tr><td colspan="6" class="text-muted text-center py-3">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2 gap-2 flex-wrap">
                <div class="small text-muted" id="overdue-page-info"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-first">First</button>
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-prev">Previous</button>
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-next">Next</button>
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-last">Last</button>
                </div>
            </div>
        </section>

        <section class="panel" id="customer-approvals">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Customer approvals</div>
                    <div class="panel-sub"><span id="customer-approvals-count">{{ pending_customer_approvals_count|default:0 }}</span> pending requests</div>
                </div>
                <a class="panel-link" href="{% url 'accounts:customer_list' %}">View customers</a>
            </div>
            <div id="customer-approvals-list">
                {% if pending_customer_approvals %}
                    {% for customer in pending_customer_approvals %}
                    <div class="list-item">
                        <div>
                            <div class="item-title">{{ customer.name }}</div>
                            <div class="item-sub">{{ customer.email|default:"No email on file" }}</div>
                            <div class="item-sub">Requested {{ customer.portal_user.date_joined|date:"M d, Y" }}</div>
                        </div>
                        <div class="item-meta">
                            <form method="post" action="{% url 'accounts:approve_customer_signup' customer.id %}" class="js-approval-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-success">Approve</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="empty-state{% if pending_customer_approvals %} d-none{% endif %}" id="customer-approvals-empty">No pending customer approvals.</div>
        </section>

    </div>
</div>
<div class="alert d-none" id="form-status" role="alert"></div>

{{ overdue_customers_json|default:"[]"|json_script:"parts-overdue-customers-data" }}
{{ online_orders_payload|default:"[]"|json_script:"parts-online-orders-data" }}
{{ pending_customer_approvals_payload|default:"[]"|json_script:"parts-customer-approvals-data" }}
{{ inventory_products_data|default:"[]"|json_script:"parts-pos-products" }}
{{ quick_customers_json|default:"[]"|json_script:"parts-pos-customers" }}
{{ quick_vehicles_json|default:"[]"|json_script:"parts-pos-vehicles" }}
{{ quick_service_catalog_json|default:"[]"|json_script:"parts-pos-services" }}

<!-- POS: Quick add modals -->
<div class="modal fade" id="quickInvoiceAddCustomerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="quick-add-customer-name" placeholder="Customer name">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="quick-add-customer-email" placeholder="customer@example.com">
                    </div>
                    <div class="col-12">
                        <label class="form-label">CC emails</label>
                        <input type="text" class="form-control" id="quick-add-customer-cc" placeholder="cc1@example.com, cc2@example.com">
                        <div class="form-text">Optional: comma-separated billing emails.</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="quick-add-customer-address" rows="2" placeholder="Optional"></textarea>
                    </div>
                </div>
                <div class="alert alert-danger d-none mt-3" id="quick-add-customer-error" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="quick-add-customer-save">
                    <i class="fa-solid fa-plus me-1"></i>Save customer
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quickInvoiceAddVehicleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add vehicle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-2">This vehicle will be added under the selected customer.</div>
                <div class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Unit number</label>
                        <input type="text" class="form-control" id="quick-add-vehicle-unit" placeholder="Unit #">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Make / Model</label>
                        <input type="text" class="form-control" id="quick-add-vehicle-make-model" placeholder="e.g. Freightliner Cascadia">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Year</label>
                        <input type="number" class="form-control" id="quick-add-vehicle-year" placeholder="Year" min="0" step="1">
                    </div>
                    <div class="col-12">
                        <label class="form-label">License plate</label>
                        <input type="text" class="form-control" id="quick-add-vehicle-plate" placeholder="Plate">
                    </div>
                    <div class="col-12">
                        <label class="form-label">VIN</label>
                        <input type="text" class="form-control" id="quick-add-vehicle-vin" placeholder="VIN">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Current mileage</label>
                        <input type="number" class="form-control" id="quick-add-vehicle-mileage" placeholder="0" min="0" step="1">
                    </div>
                </div>
                <div class="alert alert-danger d-none mt-3" id="quick-add-vehicle-error" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="quick-add-vehicle-save">
                    <i class="fa-solid fa-plus me-1"></i>Save vehicle
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="onlineOrderItemsModal" tabindex="-1" aria-labelledby="onlineOrderItemsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="onlineOrderItemsModalLabel">Order items</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted small mb-2" id="online-order-items-meta"></div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 70px;">Image</th>
                                <th class="text-end" style="width: 90px;">Qty</th>
                                <th>Item</th>
                                <th style="width: 160px;">Location</th>
                                <th class="text-end" style="width: 130px;">Stock left after</th>
                            </tr>
                        </thead>
                        <tbody id="online-order-items-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Customer Payment Modal (Overdue Customers grid) -->
<div class="modal fade" id="customerPaymentModal" tabindex="-1" aria-labelledby="customerPaymentModalLabel" aria-hidden="true" data-today="{% now 'Y-m-d' %}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerPaymentModalLabel">Record Customer Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="customer-payment-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="customer_id" id="customer-payment-customer-id" value="">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        Record a payment and automatically apply it to invoices from oldest to newest.
                    </div>
                    <div class="mb-2">
                        <div class="fw-semibold" id="customer-payment-customer-name"></div>
                        <div class="text-muted small">Outstanding balance: <span id="customer-payment-outstanding"></span></div>
                    </div>
                    <div class="mb-3">
                        <label for="customer-payment-amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="customer-payment-amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer-payment-date" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="customer-payment-date" name="payment_date">
                    </div>
                    <div class="mb-3">
                        <label for="customer-payment-method" class="form-label">Payment Method</label>
                        <select class="form-select" id="customer-payment-method" name="method">
                            {% for method in payment_methods %}
                                <option value="{{ method }}">{{ method }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-0">
                        <label for="customer-payment-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="customer-payment-notes" name="notes" rows="2" placeholder="Optional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="customer-payment-submit">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Customer Payment Success Modal -->
<div class="modal fade" id="customerPaymentSuccessModal" tabindex="-1" aria-labelledby="customerPaymentSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerPaymentSuccessModalLabel">Payment recorded</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success" id="customer-payment-success-message"></div>
                <div class="mb-3">
                    <div class="small text-muted mb-2">Allocation (oldest to newest)</div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Invoice #</th>
                                    <th class="text-end">Applied</th>
                                    <th>Status</th>
                                    <th class="text-end">Remaining</th>
                                </tr>
                            </thead>
                            <tbody id="customer-payment-success-rows"></tbody>
                        </table>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2" id="customer-payment-statement-buttons"></div>
                <div class="small text-muted mt-2">Download, print, or email statements for paid, pending, all, or overdue invoices.</div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/parts_store_dashboard.js' %}"></script>

{% endblock %}
