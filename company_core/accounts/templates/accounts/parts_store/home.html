{% extends 'customer_portal_base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Parts Store Dashboard{% endblock %}

{% block content %}
<style>
    .parts-dashboard { padding: 0.9rem 0.9rem 1.6rem; }
    .parts-hero { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; }
    .hero-eyebrow { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.2em; color: #64748b; font-weight: 700; }
    .hero-title { font-size: 1.8rem; font-weight: 800; margin: 0.2rem 0; color: #0f172a; }
    .hero-sub { margin: 0; color: #64748b; font-weight: 500; }
    .hero-actions { display: flex; flex-wrap: wrap; gap: 0.55rem; }
    .ghost-btn { border: 1px solid #e2e8f0; background: #fff; padding: 0.55rem 0.9rem; border-radius: 12px; color: #0f172a; font-weight: 600; box-shadow: 0 8px 22px rgba(15,23,42,0.08); text-decoration: none; }
    .ghost-btn:hover { border-color: #2563eb; color: #2563eb; }
    .primary-pill { background: linear-gradient(120deg, #2563eb, #1d4ed8); color: #fff; border: none; padding: 0.6rem 1.05rem; border-radius: 12px; box-shadow: 0 12px 30px rgba(37,99,235,0.25); font-weight: 700; text-decoration: none; }
    .primary-pill i { margin-right: 0.4rem; }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.7rem; margin-bottom: 1rem; }
    .summary-card { background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; padding: 0.9rem; box-shadow: 0 10px 26px rgba(15,23,42,0.08); }
    .summary-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.18em; color: #64748b; font-weight: 700; }
    .summary-value { font-size: 1.45rem; font-weight: 800; color: #0f172a; margin-top: 0.25rem; }
    .summary-meta { color: #64748b; font-size: 0.85rem; margin-top: 0.1rem; }
    .action-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 0.7rem; margin-bottom: 1rem; }
    .action-card { background: #f8fafc; border-radius: 14px; border: 1px dashed #dbeafe; padding: 0.85rem; text-decoration: none; color: inherit; transition: transform 0.15s ease, box-shadow 0.15s ease; }
    .action-card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(37,99,235,0.12); border-color: #93c5fd; }
    .action-title { font-weight: 700; color: #0f172a; }
    .action-sub { color: #64748b; font-size: 0.9rem; margin-top: 0.35rem; }
    .panel-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.75rem; margin-bottom: 0.75rem; }
    .panel { background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; padding: 0.85rem; box-shadow: 0 10px 26px rgba(15,23,42,0.08); }
    .panel-meta { color: #64748b; font-size: 0.85rem; }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin-bottom: 0.6rem; }
    .panel-title { font-weight: 700; color: #0f172a; }
    .panel-sub { color: #64748b; font-size: 0.85rem; }
    .panel-link { color: #2563eb; font-weight: 600; text-decoration: none; }
    .panel-link:hover { text-decoration: underline; }
    .list-item { display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; padding: 0.55rem 0; border-bottom: 1px solid #f1f5f9; }
    .list-item:last-child { border-bottom: none; padding-bottom: 0; }
    .item-title { font-weight: 600; color: #0f172a; }
    .item-sub { color: #64748b; font-size: 0.85rem; }
    .item-meta { text-align: right; }
    .item-amount { font-weight: 700; color: #0f172a; }
    .status-pill { display: inline-flex; align-items: center; padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.72rem; font-weight: 700; }
    .status-paid { background: #dcfce7; color: #166534; }
    .status-partial { background: #fef9c3; color: #854d0e; }
    .status-unpaid { background: #fee2e2; color: #991b1b; }
    .empty-state { color: #94a3b8; font-size: 0.9rem; padding: 0.6rem 0; }
    .panel-grid-triple { display: grid; grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr) minmax(0, 1fr); gap: 0.75rem; margin-bottom: 0.75rem; }
    .queue-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .queue-table th, .queue-table td { padding: 0.55rem 0.65rem; border-bottom: 1px solid #e5e7eb; vertical-align: middle; background: #fff; }
    .queue-table th { color: #64748b; font-weight: 800; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.08em; }
    .chart-panel { background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%); border-color: #dbeafe; }
    .chart-grid { display: grid; grid-template-columns: minmax(180px, 0.9fr) minmax(0, 1.1fr); gap: 0.8rem; align-items: center; }
    .donut { width: 200px; height: 200px; border-radius: 50%; background: conic-gradient(#e2e8f0 0deg, #e2e8f0 360deg); position: relative; margin: 0 auto; box-shadow: 0 16px 40px rgba(15,23,42,0.12); }
    .donut-center { position: absolute; inset: 22%; background: #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: inset 0 0 0 1px #e2e8f0; }
    .donut-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.16em; color: #64748b; font-weight: 700; }
    .donut-value { font-size: 1.05rem; font-weight: 800; color: #0f172a; margin-top: 0.2rem; }
    .legend-list { display: flex; flex-direction: column; gap: 0.35rem; }
    .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 0.6rem; padding: 0.35rem 0; border-bottom: 1px solid rgba(148,163,184,0.2); }
    .legend-item:last-child { border-bottom: none; }
    .legend-dot { width: 10px; height: 10px; border-radius: 999px; background: var(--dot-color, #94a3b8); box-shadow: 0 0 0 4px rgba(15,23,42,0.06); flex-shrink: 0; }
    .legend-text { font-weight: 600; color: #0f172a; flex: 1; }
    .legend-meta { color: #64748b; font-size: 0.82rem; text-align: right; }
    .chart-footer { margin-top: 0.4rem; color: #475569; font-size: 0.85rem; font-weight: 600; }
    @media (max-width: 1199.98px) {
        .panel-grid-triple { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    }
    @media (max-width: 767.98px) {
        .chart-grid { grid-template-columns: 1fr; }
        .donut { width: 170px; height: 170px; }
    }
    @media (max-width: 575.98px) {
        .hero-title { font-size: 1.5rem; }
        .summary-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
    }
</style>

<div class="parts-dashboard">
    <div class="parts-hero">
        <div>
            <div class="hero-eyebrow">Parts Store</div>
            <div class="hero-title">{{ business_name|default:default_business_name }}</div>
            <p class="hero-sub">Manage inventory, pricing, and storefront activity in one place.</p>
        </div>
        <div class="hero-actions">
            <a class="primary-pill" href="{% url 'accounts:inventory_hub' %}">
                <i class="fa-solid fa-boxes-stacked"></i>Inventory Hub
            </a>
            <a class="ghost-btn" href="{% url 'accounts:store_hub' %}">
                <i class="fa-solid fa-store"></i>Storefront
            </a>
            <a class="ghost-btn" href="{% url 'accounts:store_product_list' %}" target="_blank" rel="noopener">
                <i class="fa-solid fa-arrow-up-right-from-square"></i>Public Store
            </a>
        </div>
    </div>

    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Inventory items</div>
            <div class="summary-value">{{ inventory_products_data|length|intcomma }}</div>
            <div class="summary-meta">Products ready to sell</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Pending invoices</div>
            <div class="summary-value">{{ pending_invoices_count|intcomma }}</div>
            <div class="summary-meta">Awaiting payment</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Pending balance</div>
            <div class="summary-value">{{ pending_invoices_total|currency }}</div>
            <div class="summary-meta">Total outstanding</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Overdue balance</div>
            <div class="summary-value">{{ overdue_balance_last_365_days|currency }}</div>
            <div class="summary-meta">Past due (365 days)</div>
        </div>
    </div>

    <div class="action-grid">
        <a class="action-card" href="{% url 'accounts:inventory_products' %}">
            <div class="action-title">Products</div>
            <div class="action-sub">Add SKUs, pricing, and stock data.</div>
        </a>
        <a class="action-card" href="{% url 'accounts:inventory_category_groups' %}">
            <div class="action-title">Category groups</div>
            <div class="action-sub">Organize parts into storefront groups.</div>
        </a>
        <a class="action-card" href="{% url 'accounts:inventory_categories' %}">
            <div class="action-title">Categories</div>
            <div class="action-sub">Curate the catalog and collections.</div>
        </a>
        <a class="action-card" href="{% url 'accounts:customer_list' %}">
            <div class="action-title">Customers</div>
            <div class="action-sub">Review accounts and contact details.</div>
        </a>
        <a class="action-card" href="{% url 'accounts:supplier_list' %}">
            <div class="action-title">Suppliers</div>
            <div class="action-sub">Manage vendor records and lead times.</div>
        </a>
        <a class="action-card" href="{% url 'accounts:groupedinvoice_list' %}">
            <div class="action-title">Invoices</div>
            <div class="action-sub">Track billing and payment progress.</div>
        </a>
    </div>

    <div class="panel-grid-triple">
        <section class="panel h-100" id="overdue-customers-panel"
                 data-reminder-url-template="{% url 'accounts:trigger_overdue_reminder' 0 %}"
                 data-record-payment-url-template="{% url 'accounts:record_customer_payment' 0 %}"
                 data-followup-url-template="{% url 'accounts:update_overdue_followup' 0 %}"
                 data-invoice-detail-url-template="{% url 'accounts:groupedinvoice_detail' 0 %}">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div>
                    <div class="panel-title">Overdue Customers</div>
                    <div class="panel-meta">
                        <strong>{{ overdue_customers_count|default:0 }}</strong> customers &bull;
                        Total overdue: <strong>{{ overdue_customers_total|default:0|currency }}</strong>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="overdue-search" placeholder="Search customer..." style="min-width: 180px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="overdue-expand-btn">
                        <i class="fa-solid fa-up-right-and-down-left-from-center me-1"></i>Expand
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="queue-table" id="overdue-table">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>Phone</th>
                            <th>Last statement</th>
                            <th class="text-end">Balance Due</th>
                            <th class="text-end">Payment</th>
                            <th class="text-end">Reminder</th>
                        </tr>
                    </thead>
                    <tbody id="overdue-tbody">
                        <tr><td colspan="6" class="text-muted text-center py-3">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-2 gap-2 flex-wrap">
                <div class="small text-muted" id="overdue-page-info"></div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-first">First</button>
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-prev">Previous</button>
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-next">Next</button>
                    <button class="btn btn-outline-secondary btn-sm" id="overdue-last">Last</button>
                </div>
            </div>
        </section>

        <section class="panel" id="customer-approvals">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Customer approvals</div>
                    <div class="panel-sub">{{ pending_customer_approvals_count|default:0 }} pending requests</div>
                </div>
                <a class="panel-link" href="{% url 'accounts:customer_list' %}">View customers</a>
            </div>
            {% if pending_customer_approvals %}
                {% for customer in pending_customer_approvals %}
                <div class="list-item">
                    <div>
                        <div class="item-title">{{ customer.name }}</div>
                        <div class="item-sub">{{ customer.email|default:"No email on file" }}</div>
                        <div class="item-sub">Requested {{ customer.portal_user.date_joined|date:"M d, Y" }}</div>
                    </div>
                    <div class="item-meta">
                        <form method="post" action="{% url 'accounts:approve_customer_signup' customer.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success">Approve</button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">No pending customer approvals.</div>
            {% endif %}
        </section>

        <section class="panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Suppliers</div>
                    <div class="panel-sub">Inventory value on hand</div>
                </div>
                <a class="panel-link" href="{% url 'accounts:supplier_list' %}">View all</a>
            </div>
            {% if top_suppliers %}
                {% for supplier in top_suppliers %}
                <div class="list-item">
                    <div class="item-title">{{ supplier.name }}</div>
                    <div class="item-meta">
                        <div class="item-amount">{{ supplier.total_inventory_value|default:0|currency }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">No suppliers on file.</div>
            {% endif %}
        </section>
    </div>

    <div class="panel-grid">
        <section class="panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Recent invoices</div>
                    <div class="panel-sub">Latest billing activity</div>
                </div>
                <a class="panel-link" href="{% url 'accounts:groupedinvoice_list' %}">View all</a>
            </div>
            {% if recent_invoices %}
                {% for invoice in recent_invoices|slice:":5" %}
                <div class="list-item">
                    <div>
                        <div class="item-title">Invoice #{{ invoice.invoice_number }}</div>
                        <div class="item-sub">{{ invoice.customer.name|default:"Customer" }}</div>
                    </div>
                    <div class="item-meta">
                        <div class="item-amount">{{ invoice.total_amount|currency }}</div>
                        {% if invoice.display_status == 'Paid' %}
                            <span class="status-pill status-paid">Paid</span>
                        {% elif invoice.display_status == 'Partially Paid' %}
                            <span class="status-pill status-partial">Partial</span>
                        {% else %}
                            <span class="status-pill status-unpaid">Unpaid</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="empty-state">No invoices yet. Start billing when orders are ready.</div>
            {% endif %}
        </section>

        <section class="panel h-100 chart-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Sales mix by category group</div>
                    <div class="panel-sub">Inventory sold in the last 30 days</div>
                </div>
                <div class="panel-meta" id="categorySalesTotalDisplay">{{ category_group_sales_total|default:0|currency }}</div>
            </div>
            <div class="chart-grid" id="categorySalesChart">
                <div class="donut" id="categorySalesDonut">
                    <div class="donut-center">
                        <div class="donut-label">Total</div>
                        <div class="donut-value" id="categorySalesTotal">{{ category_group_sales_total|default:0|currency }}</div>
                    </div>
                </div>
                <div class="legend-list" id="categorySalesLegend"></div>
            </div>
            <div class="empty-state d-none" id="categorySalesEmpty">No inventory sales recorded in the last 30 days.</div>
            <div class="chart-footer" id="categorySalesHighlight"></div>
        </section>
    </div>
</div>
<div class="alert d-none" id="form-status" role="alert"></div>

{{ overdue_customers_json|default:"[]"|json_script:"parts-overdue-customers-data" }}
{{ category_group_sales|default:"[]"|json_script:"parts-category-sales-data" }}

<!-- Customer Payment Modal (Overdue Customers grid) -->
<div class="modal fade" id="customerPaymentModal" tabindex="-1" aria-labelledby="customerPaymentModalLabel" aria-hidden="true" data-today="{% now 'Y-m-d' %}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerPaymentModalLabel">Record Customer Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="customer-payment-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="customer_id" id="customer-payment-customer-id" value="">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        Record a payment and automatically apply it to invoices from oldest to newest.
                    </div>
                    <div class="mb-2">
                        <div class="fw-semibold" id="customer-payment-customer-name"></div>
                        <div class="text-muted small">Outstanding balance: <span id="customer-payment-outstanding"></span></div>
                    </div>
                    <div class="mb-3">
                        <label for="customer-payment-amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="customer-payment-amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="customer-payment-date" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="customer-payment-date" name="payment_date">
                    </div>
                    <div class="mb-3">
                        <label for="customer-payment-method" class="form-label">Payment Method</label>
                        <select class="form-select" id="customer-payment-method" name="method">
                            {% for method in payment_methods %}
                                <option value="{{ method }}">{{ method }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-0">
                        <label for="customer-payment-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="customer-payment-notes" name="notes" rows="2" placeholder="Optional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="customer-payment-submit">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Customer Payment Success Modal -->
<div class="modal fade" id="customerPaymentSuccessModal" tabindex="-1" aria-labelledby="customerPaymentSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerPaymentSuccessModalLabel">Payment recorded</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success" id="customer-payment-success-message"></div>
                <div class="mb-3">
                    <div class="small text-muted mb-2">Allocation (oldest to newest)</div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Invoice #</th>
                                    <th class="text-end">Applied</th>
                                    <th>Status</th>
                                    <th class="text-end">Remaining</th>
                                </tr>
                            </thead>
                            <tbody id="customer-payment-success-rows"></tbody>
                        </table>
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2" id="customer-payment-statement-buttons"></div>
                <div class="small text-muted mt-2">Download, print, or email statements for paid, pending, all, or overdue invoices.</div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'js/parts_store_dashboard.js' %}"></script>

{% endblock %}
