{% extends 'accounts/mach/mach_portal_base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
Add {% if documentType == 'estimate' %}Estimate{% else %}Mechanic Job Log{% endif %}
{% endblock %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css"
    rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
    :root {
        --ink: #111827;
        --muted: #6b7280;
        --border: #d6dbe1;
        --panel: #ffffff;
        --bg: #f3f4f6;
        --accent: #2563eb;
        --accent-strong: #1d4ed8;
        --soft: #f8fafb;
        --shadow: 0 8px 18px rgba(17, 24, 39, 0.08);
    }

    body {
        font-family: 'Source Sans 3', 'Segoe UI', sans-serif;
        background: var(--bg);
        color: var(--ink);
    }

    a {
        color: var(--accent);
    }

    .page-shell {
        max-width: none;
        width: 100%;
        margin: 0;
        padding: 1.25rem clamp(1rem, 2vw, 2rem) 5rem;
        overflow: visible;
    }

    .page-header {
        display: none;
    }

    .qb-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1.5rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
    }

    .qb-title-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .qb-title {
        font-size: clamp(1.6rem, 2.4vw, 2.1rem);
        font-weight: 700;
        color: var(--ink);
        margin: 0;
    }

    .qb-doc-pill {
        background: #eef2f7;
        color: #4b5563;
        font-weight: 600;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.85rem;
    }

    .qb-doc-number {
        color: #1f2937;
        font-weight: 600;
    }

    .qb-subtitle {
        color: var(--muted);
        font-size: 0.95rem;
        margin-top: 0.25rem;
    }

    .qb-header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-left: auto;
    }

    .qb-balance {
        text-align: right;
        min-width: 140px;
    }

    .qb-balance span {
        display: block;
        color: var(--muted);
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .qb-balance strong {
        display: block;
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--ink);
    }

    .qb-paid-status {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.2rem;
        margin-top: 0.4rem;
    }

    .qb-paid-label {
        color: var(--muted);
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .qb-paid-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        background: #dcfce7;
        color: #15803d;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .qb-payment-toggle {
        border: none;
        background: transparent;
        color: #1d4ed8;
        font-weight: 600;
        font-size: 0.85rem;
        text-decoration: underline;
        padding: 0;
        cursor: pointer;
    }

    .qb-payment-history {
        margin-top: 0.5rem;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 0.65rem 0.75rem;
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.08);
        min-width: 240px;
    }

    .qb-payment-history-head {
        display: grid;
        grid-template-columns: 1.1fr 1fr 1fr;
        gap: 0.5rem;
        color: var(--muted);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.72rem;
        border-bottom: 1px solid var(--border);
        padding-bottom: 0.35rem;
        margin-bottom: 0.35rem;
    }

    .qb-payment-history-row {
        display: grid;
        grid-template-columns: 1.1fr 1fr 1fr;
        gap: 0.5rem;
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--ink);
        padding: 0.2rem 0;
    }

    .qb-payment-history-row span:last-child {
        color: var(--muted);
        font-weight: 600;
    }

    .qb-switch {
        display: inline-flex;
        background: #e5e7eb;
        padding: 0.15rem;
        border-radius: 999px;
    }

    .qb-switch a {
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        font-weight: 600;
        color: #4b5563;
        text-decoration: none;
        font-size: 0.9rem;
    }

    .qb-switch a.active {
        background: #fff;
        color: var(--ink);
        box-shadow: 0 1px 4px rgba(17, 24, 39, 0.12);
    }

    .pill-switch {
        display: inline-flex;
        background: #e5e7eb;
        padding: 0.2rem;
        border-radius: 999px;
    }

    .pill-switch a {
        padding: 0.45rem 0.95rem;
        border-radius: 999px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #4b5563;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .pill-switch a.active {
        background: #fff;
        color: var(--ink);
        box-shadow: 0 1px 4px rgba(17, 24, 39, 0.12);
    }

    .pill-switch a:hover {
        color: var(--ink);
    }

    .ghost-btn {
        border: 1px solid var(--border);
        background: #fff;
        color: #374151;
        border-radius: 6px;
        padding: 0.5rem 0.85rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .ghost-btn:hover {
        color: var(--ink);
        border-color: #c0c7d2;
        box-shadow: none;
    }

    .ghost-btn.slim {
        padding: 0.45rem 0.75rem;
        font-size: 0.85rem;
    }

    .panel,
    .qb-card,
    .totals-card {
        background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
        border: 1px solid #d7dde5;
        border-top: 3px solid #e2e8f0;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
    }

    .panel {
        padding: 1rem 1.2rem;
    }

    .panel+.panel {
        margin-top: 1rem;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.85rem;
        padding: 0.55rem 0.75rem;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }

    .section-customer {
        background: linear-gradient(180deg, #ffffff 0%, #f3f7ff 100%);
        border-top-color: #c7d2fe;
    }

    .section-message {
        background: linear-gradient(180deg, #ffffff 0%, #fff7ed 100%);
        border-top-color: #fed7aa;
    }

    .section-line-items {
        background: linear-gradient(180deg, #ffffff 0%, #f3f6ff 100%);
        border-top-color: #c7d2fe;
    }

    .section-adjustments {
        background: linear-gradient(180deg, #ffffff 0%, #fefce8 100%);
        border-top-color: #fde68a;
    }

    .section-totals {
        background:
            radial-gradient(circle at top right, rgba(59, 130, 246, 0.16), transparent 55%),
            linear-gradient(160deg, #f8fafc 0%, #e2e8f0 100%);
        border: 1px solid #cbd5e1;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        border-top-color: #94a3b8;
    }

    .panel-title {
        font-weight: 700;
        color: var(--ink);
        font-size: 1rem;
    }

    .panel-subtle {
        color: var(--muted);
        font-size: 0.9rem;
    }

    .pill-tag {
        background: #eef2f7;
        border: 1px solid var(--border);
        color: #4b5563;
        border-radius: 999px;
        padding: 0.25rem 0.65rem;
        font-weight: 600;
        letter-spacing: 0.01em;
        font-size: 0.85rem;
    }

    .qb-card {
        padding: 1rem 1.25rem;
    }

    .qb-top-grid {
        display: grid;
        grid-template-columns: minmax(320px, 1.2fr) minmax(280px, 1fr);
        gap: 1.25rem;
    }

    .qb-field-row {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: flex-end;
    }

    .qb-field-row .flex-1 {
        min-width: 180px;
    }

    .qb-inline-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
    }

    .qb-divider {
        border-top: 1px solid var(--border);
        margin: 1rem 0;
    }

    .vehicle-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.85rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .vehicle-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 0.75rem;
    }

    .vehicle-select {
        grid-column: 1 / -1;
    }

    .extra-fields-wrap {
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: flex-end;
    }

    .extra-fields-trigger {
        white-space: nowrap;
    }

    .extra-fields-panel {
        position: absolute;
        right: 0;
        top: calc(100% + 0.4rem);
        width: min(320px, 80vw);
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 0.85rem;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 20;
    }

    .extra-fields-panel .panel-title {
        margin-bottom: 0.4rem;
    }

    .extra-fields-wrap.is-open .extra-fields-panel {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
    }

    .top-grid,
    .two-col {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 0.85rem;
    }

    .field-stack {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
    }

    .field-pair {
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .field-pair.align-start {
        align-items: flex-start;
    }

    .flex-1 {
        flex: 1;
    }

    label {
        display: block;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.35rem;
        font-size: 0.97rem;
        letter-spacing: 0.01em;
    }

    .form-control,
    select.form-control,
    textarea.form-control,
    input.form-control {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0.55rem 0.7rem;
        background: #fff;
        color: var(--ink);
        font-size: 0.95rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .form-control:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
        outline: none;
    }

    .form-control[readonly],
    .form-control:disabled {
        background: #f8fafc;
        color: #64748b;
    }

    .inline-actions {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .inline-actions.wrap {
        flex-wrap: wrap;
    }

    .btn {
        border: 1px solid transparent;
        border-radius: 6px;
        padding: 0.6rem 0.95rem;
        font-weight: 600;
        transition: all 0.2s ease;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .btn-primary {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }

    .btn-primary:hover {
        background: var(--accent-strong);
        border-color: var(--accent-strong);
    }

    .btn-info {
        background: #f3f4f6;
        color: #1f2937;
        border-color: var(--border);
    }

    .btn-info:hover {
        background: #e5e7eb;
    }

    .btn-success {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
    }

    .btn-outline-primary {
        background: #fff;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 0.55rem 0.85rem;
        font-weight: 600;
    }

    .btn-outline-primary:hover {
        background: rgba(37, 99, 235, 0.12);
    }

    .btn-outline-secondary {
        background: #fff;
        border: 1px solid var(--border);
        color: #4b5563;
        padding: 0.55rem 0.85rem;
        font-weight: 600;
    }

    .btn-outline-secondary:hover {
        border-color: #c0c7d2;
        color: var(--ink);
    }

    .btn-link {
        color: var(--accent);
        background: transparent;
        padding: 0;
        border: none;
        font-weight: 700;
        text-decoration: none;
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 0.45rem;
    }

    .form-check-input {
        width: 1.1rem;
        height: 1.1rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        accent-color: var(--accent);
    }

    .form-check-label {
        color: var(--muted);
        font-weight: 700;
    }

    .hidden-delete-checkbox {
        display: none;
    }

    .muted-box {
        background: var(--soft);
        border: 1px dashed var(--border);
        border-radius: 6px;
        padding: 0.8rem 0.9rem;
    }

    .hint-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.35rem;
        margin-top: 0.4rem;
        color: var(--muted);
        font-size: 0.9rem;
    }

    .job-table {
        border: 1px solid #d7dde5;
        border-radius: 10px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
    }

    .job-head {
        display: grid;
        grid-template-columns: 36px 36px minmax(180px, 1.2fr) minmax(220px, 2fr) 90px 110px 120px 40px;
        align-items: center;
        background: #eef2f7;
        color: #4b5563;
        font-weight: 700;
        border-bottom: 1px solid var(--border);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .job-head span {
        padding: 0.55rem 0.6rem;
    }

    .job-head .qb-add-line {
        justify-self: center;
    }

    .job-entry-row {
        display: grid;
        grid-template-columns: 36px 36px minmax(180px, 1.2fr) minmax(220px, 2fr) 90px 110px 120px 40px;
        align-items: center;
        background: #fff;
        border-top: 1px solid var(--border);
    }

    .job-entry-row label {
        font-size: 0.75rem;
        color: #6b7280;
    }

    .qb-cell {
        padding: 0.35rem 0.5rem;
    }

    .qb-cell input.form-control,
    .qb-cell textarea.form-control,
    .qb-cell select.form-control {
        font-size: 0.9rem;
        padding: 0.45rem 0.55rem;
    }

    .qb-desc-input {
        resize: vertical;
        min-height: 40px;
    }

    .qb-row-number {
        font-weight: 600;
        color: #6b7280;
        text-align: center;
    }

    .qb-drag-handle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
        border-radius: 6px;
        color: #9ca3af;
        cursor: grab;
        border: 1px solid transparent;
        background: transparent;
    }

    .qb-drag-handle:hover {
        background: #f8fafc;
        border-color: var(--border);
    }

    .qb-add-line {
        width: 26px;
        height: 26px;
        border-radius: 6px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--accent);
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .qb-add-line:hover {
        border-color: var(--accent);
        background: rgba(37, 99, 235, 0.12);
    }

    .qb-amount-cell .entry-amount {
        text-align: right;
        font-weight: 600;
    }

    .qb-tax-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #374151;
        background: #f3f4f6;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 0.15rem 0.55rem;
    }

    .qb-remove-row {
        background: transparent;
        border: none;
        color: #9ca3af;
        width: 26px;
        height: 26px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .qb-remove-row:hover {
        color: #ef4444;
        background: #fef2f2;
    }

    .qb-line-actions {
        display: flex;
        gap: 0.6rem;
        margin-top: 0.75rem;
        flex-wrap: wrap;
    }

    .qb-line-action-btn {
        border: 1px solid var(--border);
        background: #fff;
        color: #374151;
        border-radius: 6px;
        padding: 0.4rem 0.75rem;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .qb-line-action-btn:hover {
        border-color: #c0c7d2;
        color: var(--ink);
    }

    .qb-line-toolbar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .qb-line-toolbar label {
        margin: 0;
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
    }

    .qb-amounts-select {
        width: 180px;
    }

    .qb-item-type-grid {
        display: grid;
        gap: 0.75rem;
    }

    .qb-item-type-card {
        display: flex;
        align-items: center;
        gap: 0.85rem;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem;
        width: 100%;
        background: #fff;
        text-align: left;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .qb-item-type-card:hover {
        border-color: var(--accent);
        box-shadow: 0 4px 10px rgba(17, 24, 39, 0.08);
    }

    .qb-item-type-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--accent);
        color: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .qb-mobile-label {
        display: none;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #9ca3af;
        margin-bottom: 0.2rem;
    }

    .qb-drag-ghost {
        background: #f8fafc;
        opacity: 0.8;
    }

    .qb-drag-chosen {
        background: #f9fafb;
    }

    .jobs-empty {
        background: #fff;
        border: 1px dashed var(--border);
        color: var(--muted);
        padding: 1rem;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
        margin: 0.75rem;
    }

    @media (max-width: 900px) {
        .qb-top-grid {
            grid-template-columns: 1fr;
        }

        .qb-header {
            align-items: flex-start;
        }

        .qb-header-actions {
            width: 100%;
            justify-content: space-between;
        }

        .qb-balance {
            text-align: left;
        }

        .job-head {
            display: none;
        }

        .job-entry-row {
            grid-template-columns: 1fr;
            gap: 0.35rem;
        }

        .qb-cell {
            padding: 0.45rem 0.6rem;
        }

        .qb-mobile-label {
            display: block;
        }

        .qb-drag-handle,
        .qb-row-number {
            display: none;
        }
    }

    .adjustment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem;
    }

    .adjust-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.85rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
    }

    .adjust-card h4 {
        margin: 0 0 0.35rem;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--ink);
    }

    .summary-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }

    @media (max-width: 1024px) {
        .summary-grid {
            grid-template-columns: 1fr;
        }
    }

    .totals-card {
        padding: 1.1rem 1.2rem;
        color: #0f172a;
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.6);
        border-radius: 14px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .totals-card .line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0.35rem 0;
        font-weight: 700;
    }

    .totals-card .muted {
        color: #475569;
        font-weight: 700;
    }

    .totals-card .accent {
        color: #1d4ed8;
    }

    .totals-card .grand {
        font-size: 1.28rem;
        color: #0f172a;
        font-weight: 800;
    }

    .totals-card hr {
        border-color: rgba(148, 163, 184, 0.5);
        margin: 0.6rem 0;
    }

    .save-wrap {
        display: none;
    }

    .qb-footer {
        position: sticky;
        bottom: 0;
        background: #fff;
        border-top: 1px solid var(--border);
        padding: 0.75rem 1.25rem;
        margin-top: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        box-shadow: 0 -6px 16px rgba(17, 24, 39, 0.06);
        z-index: 100;
        pointer-events: auto;
        overflow: visible;
    }

    .qb-footer-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .qb-footer .btn {
        padding: 0.5rem 0.85rem;
        font-size: 0.9rem;
    }

    .qb-footer .btn-primary {
        padding: 0.6rem 1rem;
    }

    .qb-footer-link {
        background: transparent;
        border: none;
        color: #374151;
        font-weight: 600;
        cursor: pointer;
    }

    .qb-footer-link:hover {
        color: var(--ink);
    }

    .qb-action-btn {
        border: 1px solid var(--border);
        background: #fff;
        color: #374151;
    }

    .qb-action-btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .qb-toast {
        padding: 0.65rem 0.9rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        display: none;
    }

    .qb-toast.is-success {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1d4ed8;
    }

    .qb-balance .btn {
        margin-top: 0.5rem;
    }

    .qb-toast.is-error {
        background: #fef2f2;
        border: 1px solid #fecdd3;
        color: #b91c1c;
    }

    .qb-split-group {
        display: inline-flex;
        align-items: stretch;
        position: relative;
    }

    .qb-split-main {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .qb-split-toggle {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        padding: 0 0.7rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .qb-split-toggle i {
        font-size: 0.7rem;
    }

    .qb-split-menu {
        position: absolute;
        right: 0;
        bottom: calc(100% + 0.45rem);
        min-width: 180px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 0.35rem 0;
        display: none;
        opacity: 0;
        pointer-events: none;
        transform: translateY(6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 80;
    }

    .qb-split-menu .qb-split-item {
        width: 100%;
        text-align: left;
        background: transparent;
        border: none;
        padding: 0.55rem 0.9rem;
        font-weight: 600;
        color: #374151;
    }

    .qb-split-menu .qb-split-item:hover {
        background: #f3f4f6;
        color: var(--ink);
    }

    .qb-split-group.is-open .qb-split-menu {
        display: block;
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
    }

    .alert-inline {
        background: #fef2f2;
        border: 1px solid #fecdd3;
        color: #b91c1c;
        border-radius: 12px;
        padding: 0.9rem 1rem;
        font-weight: 700;
    }

    /* Select2 polished look */
    .select2-container--bootstrap4 .select2-selection--single {
        height: 44px !important;
        padding: 0.55rem 0.75rem !important;
        border-radius: 6px !important;
        border: 1px solid var(--border) !important;
        background: #fff !important;
    }

    .select2-container--bootstrap4 .select2-selection__rendered {
        line-height: 1.2rem !important;
        color: var(--ink) !important;
    }

    .select2-container--bootstrap4 .select2-selection--single .select2-selection__arrow {
        height: 42px !important;
    }

    .select2-container--bootstrap4 .select2-results__option--highlighted,
    .select2-container--bootstrap4 .select2-results__option--selectable:hover,
    .select2-container--bootstrap4 .select2-results__option--selectable:focus {
        background: var(--accent) !important;
        color: #fff !important;
    }

    .select2-container--bootstrap4 .select2-results__option--highlighted .qb-select2-title,
    .select2-container--bootstrap4 .select2-results__option--selectable:hover .qb-select2-title,
    .select2-container--bootstrap4 .select2-results__option--selectable:focus .qb-select2-title {
        color: #fff !important;
    }

    .select2-container--bootstrap4 .select2-results__option--highlighted .qb-select2-desc,
    .select2-container--bootstrap4 .select2-results__option--selectable:hover .qb-select2-desc,
    .select2-container--bootstrap4 .select2-results__option--selectable:focus .qb-select2-desc {
        color: #e0f2fe !important;
    }

    .select2-container--bootstrap4 .select2-results__option--selected {
        background: #e8efff !important;
        color: var(--ink) !important;
    }

    .select2-container--bootstrap4 .select2-results__option--selected .qb-select2-title {
        color: var(--ink) !important;
    }

    .select2-container--bootstrap4 .select2-results__option--selected .qb-select2-desc {
        color: var(--muted) !important;
    }

    /* Select2 dropdown options - Fixed overlapping issue */
    .select2-results__options {
        max-height: 350px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }

    /* Target the li elements directly - this is critical */
    .select2-container--bootstrap4 .select2-results>.select2-results__options>li,
    .select2-results__option,
    li.select2-results__option {
        display: block !important;
        float: none !important;
        clear: both !important;
        position: relative !important;
        padding: 12px 14px !important;
        margin: 0 !important;
        font-size: 0.95rem !important;
        min-height: auto !important;
        height: auto !important;
        line-height: normal !important;
        white-space: normal !important;
        overflow: visible !important;
        word-break: break-word;
        overflow-wrap: anywhere;
        box-sizing: border-box !important;
        border-bottom: 1px solid #eee;
        background: #fff;
    }

    .select2-results__option:last-child,
    li.select2-results__option:last-child {
        border-bottom: none;
    }

    /* Override any fixed heights from Bootstrap4 theme */
    .select2-container--bootstrap4 .select2-results__option[role="option"],
    .select2-container--bootstrap4 .select2-results__option[role="treeitem"] {
        height: auto !important;
        min-height: auto !important;
        line-height: normal !important;
        padding: 12px 14px !important;
    }

    /* Ensure the inner container displays properly */
    .select2-results__option .qb-select2-option {
        display: flex !important;
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 6px !important;
        width: 100% !important;
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: anywhere !important;
        position: relative !important;
    }

    .select2-results__option .qb-select2-title,
    .qb-select2-title {
        display: block !important;
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: anywhere !important;
        font-weight: 600;
        font-size: 0.95rem;
        line-height: 1.4;
        color: #1f2937;
        margin-bottom: 3px;
    }

    .select2-results__option .qb-select2-desc,
    .qb-select2-desc {
        display: block !important;
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: anywhere !important;
        font-size: 0.8rem;
        line-height: 1.4;
        color: #6b7280;
    }

    .select2-results__group {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6b7280;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
    }

    .select2-container--bootstrap4 .select2-dropdown {
        border-radius: 8px !important;
        border: 1px solid var(--border) !important;
        overflow: hidden !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .qb-select2-option {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        width: 100%;
    }

    .qb-quick-add-error {
        border-left: 3px solid #ef4444;
        background: #fff5f5;
    }

    .qb-quick-add-invalid {
        border-color: #fca5a5 !important;
    }

    .modal-content {
        border-radius: 8px;
        box-shadow: var(--shadow);
    }

    .modal-header {
        background: var(--soft);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .modal-header .close {
        margin-left: auto;
        padding: 0.5rem;
        line-height: 1;
    }

    .modal-footer {
        background: #f9fafb;
        border-top: 1px solid var(--border);
    }

    button[data-bs-target="#addVehicleModal"]:disabled,
    #btnOpenAddVehicleModal:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>


<div class="page-shell" data-document-id="{{ grouped_invoice_form.instance.pk|default:'' }}"
    data-document-type="{{ documentType }}"
    data-total-paid="{% if documentType == 'invoice' and grouped_invoice_form.instance.pk %}{{ invoice_total_paid_amount|default:0|floatformat:2 }}{% else %}0.00{% endif %}"
    data-balance-due="{% if documentType == 'invoice' and grouped_invoice_form.instance.pk %}{{ invoice_balance_due_amount|default:0|floatformat:2 }}{% else %}0.00{% endif %}">
    <header class="qb-header">
        <div>
            <div class="qb-title-row">
                <h1 class="qb-title">{{ documentType|title }}</h1>
                <span class="qb-doc-pill">{% if grouped_invoice_form.instance.pk %}Saved{% else %}Draft{% endif %}</span>
                <span class="qb-doc-number" data-default="{{ generated_invoice_number }}">#{{ grouped_invoice_form.invoice_number.value|default:generated_invoice_number }}</span>
            </div>
            <div class="qb-subtitle">{% if grouped_invoice_form.instance.pk %}Editing{% else %}New{% endif %} {{ documentType|title }}</div>
        </div>
        <div class="qb-header-actions">
            <div class="qb-switch" role="group">
                <a href="{% url 'accounts:add_dailylog' %}?type=invoice"
                    class="{% if documentType == 'invoice' %}active{% endif %}" id="invoice-tab">Invoice</a>
                <a href="{% url 'accounts:add_dailylog' %}?type=estimate"
                    class="{% if documentType == 'estimate' %}active{% endif %}">Estimate</a>
            </div>
            <div class="qb-balance">
                <span>Balance due</span>
                <strong id="balance-due-amount">
                    {% if documentType == 'invoice' and grouped_invoice_form.instance.pk %}
                    ${{ invoice_balance_due_amount|default:0|floatformat:2 }}
                    {% else %}
                    $0.00
                    {% endif %}
                </strong>
                {% if documentType == 'invoice' %}
                {% if invoice_is_paid %}
                <div class="qb-paid-status">
                    <span class="qb-paid-label">Payment status</span>
                    <span class="qb-paid-pill">Paid</span>
                    {% if payment_history_count %}
                    <button type="button" class="qb-payment-toggle" id="qb-payment-history-toggle"
                        aria-expanded="false">
                        {{ payment_history_count }} payment{{ payment_history_count|pluralize }} made{% if payment_history_last_date %} on {{ payment_history_last_date|date:'d/m/Y' }}{% endif %}
                    </button>
                    {% endif %}
                </div>
                {% if payment_history_count %}
                <div class="qb-payment-history" id="qb-payment-history" style="display:none;">
                    <div class="qb-payment-history-head">
                        <span>Date</span>
                        <span>Amount applied</span>
                        <span>Payment no.</span>
                    </div>
                    {% for payment in payment_history %}
                    <div class="qb-payment-history-row">
                        <span>{{ payment.date|date:'d/m/Y' }}</span>
                        <span>${{ payment.amount|floatformat:2 }}</span>
                        <span>{{ payment.id }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% else %}
                <button type="button" class="btn btn-outline-primary btn-sm" id="qb-receive-payment-btn"
                    data-bs-toggle="modal" data-bs-target="#invoicePaymentModal"
                    data-action-url="{% if grouped_invoice_form.instance.pk %}{% url 'accounts:mark_invoice_paid' grouped_invoice_form.instance.pk %}{% endif %}"
                    data-invoice-number="{{ grouped_invoice_form.instance.invoice_number|default:generated_invoice_number }}"
                    data-balance="{% if grouped_invoice_form.instance.pk %}{{ invoice_balance_due_amount|default:0|floatformat:2 }}{% else %}0.00{% endif %}"
                    {% if not grouped_invoice_form.instance.pk %}disabled title="Save to enable" {% endif %}>
                    Receive payment
                </button>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </header>

    <form method="post" novalidate id="grouped-invoice-form" class="space-y-6">
        {% csrf_token %}
        <input type="hidden" name="redirect_dashboard" id="redirect-dashboard" value="">
        <input type="hidden" name="save_send" id="qb-save-send-flag" value="">
        {% for hidden in grouped_invoice_form.hidden_fields %}
        {{ hidden }}
        {% endfor %}

        {% if grouped_invoice_form.non_field_errors %}
        <div class="alert-inline">
            {{ grouped_invoice_form.non_field_errors }}
        </div>
        {% endif %}

        <section class="qb-card section-customer">
            <div class="qb-top-grid">
                <div class="qb-top-left">
                    {% if 'date' in grouped_invoice_form.fields %}
                    <div class="qb-field-row">
                        <div class="flex-1 crispy-field">{{ grouped_invoice_form.date|as_crispy_field }}</div>
                    </div>
                    {% endif %}
                    {% if 'customer' in grouped_invoice_form.fields %}
                    <div class="qb-field-row">
                        <div class="flex-1 crispy-field">{{ grouped_invoice_form.customer|as_crispy_field }}</div>
                        <button type="button" class="ghost-btn slim" data-bs-toggle="modal"
                            data-bs-target="#addCustomerModal">+ New</button>
                    </div>
                    {% endif %}
                    <div class="qb-field-row">
                        <div class="flex-1">
                            <label for="id_bill_to_email">Customer email</label>
                            <input type="email" id="id_bill_to_email" class="form-control" readonly>
                        </div>
                        <div class="flex-1">
                            <label for="id_bill_to">Bill to</label>
                            <input type="text" id="id_bill_to" class="form-control" readonly>
                        </div>
                    </div>
                    <div>
                        <label for="id_bill_to_address">Billing address</label>
                        <textarea id="id_bill_to_address" class="form-control" rows="3" readonly></textarea>
                    </div>
                    {% if show_vehicle_details %}
                    <div class="muted-box mt-3">
                        <div class="inline-actions wrap">
                            <button type="button" class="btn btn-outline-primary text-sm" id="vehicle-history-button"
                                data-bs-toggle="modal" data-bs-target="#vehicleHistoryModal" disabled>
                                View Vehicle History
                            </button>
                            <button type="button" class="btn btn-outline-secondary text-sm"
                                id="vehicle-maintenance-button" data-bs-toggle="modal"
                                data-bs-target="#vehicleMaintenanceModal" disabled>
                                View Maintenance Reminders
                            </button>
                        </div>
                        <div class="hint-grid">
                            <span id="vehicle-history-hint">Select a vehicle to view history.</span>
                            <span id="vehicle-maintenance-hint">Select a vehicle to review maintenance reminders.</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="qb-top-right">
                    <div class="qb-inline-grid">
                        <div>
                            <label for="invoice-number">{{ documentType|title }} no.</label>
                            <input type="text" id="invoice-number" name="invoice_number"
                                class="form-control{% if grouped_invoice_form.invoice_number.errors %} is-invalid{% endif %}"
                                value="{{ grouped_invoice_form.invoice_number.value|default:generated_invoice_number }}"
                                maxlength="20">
                            {% if grouped_invoice_form.invoice_number.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in grouped_invoice_form.invoice_number.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% if 'po_number' in grouped_invoice_form.fields %}
                        <div class="extra-fields-wrap">
                            <button type="button" class="ghost-btn slim extra-fields-trigger">Extra fields</button>
                            <div class="extra-fields-panel">
                                <div class="panel-title">Extra fields</div>
                                <div class="crispy-field">{{ grouped_invoice_form.po_number|as_crispy_field }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% if show_vehicle_details %}
                    <div class="vehicle-card">
                        <div class="panel-header">
                            <div class="panel-title">Vehicle details</div>
                        </div>
                        <div class="vehicle-grid">
                            <div class="vehicle-select">
                                <label for="id_vehicle">Vehicle</label>
                                {% if 'vehicle' in grouped_invoice_form.fields %}
                                <select id="id_vehicle" name="{{ grouped_invoice_form.vehicle.html_name }}"
                                    class="form-control" disabled>
                                    {% else %}
                                    <select id="id_vehicle" name="vehicle" class="form-control" disabled>
                                        {% endif %}
                                        <option value="">- Select vehicle -</option>
                                    </select>
                                    <button type="button" class="ghost-btn slim mt-2" data-bs-toggle="modal"
                                        data-bs-target="#addVehicleModal" id="btnOpenAddVehicleModal" disabled>+
                                        New</button>
                            </div>
                            {% if 'unit_no' in grouped_invoice_form.fields %}
                            <div class="crispy-field">{{ grouped_invoice_form.unit_no|as_crispy_field }}</div>
                            {% endif %}
                            {% if 'vin_no' in grouped_invoice_form.fields %}
                            <div class="crispy-field">{{ grouped_invoice_form.vin_no|as_crispy_field }}</div>
                            {% endif %}
                            {% if 'license_plate' in grouped_invoice_form.fields %}
                            <div class="crispy-field">{{ grouped_invoice_form.license_plate|as_crispy_field }}</div>
                            {% endif %}
                            {% if 'mileage' in grouped_invoice_form.fields %}
                            <div class="crispy-field">{{ grouped_invoice_form.mileage|as_crispy_field }}</div>
                            {% endif %}
                            {% if 'make_model' in grouped_invoice_form.fields %}
                            <div class="crispy-field">{{ grouped_invoice_form.make_model|as_crispy_field }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="panel section-line-items">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Line items</div>
                    <div class="panel-subtle">Add products or services to this {{ documentType }}</div>
                </div>
            </div>

            <div class="job-table">
                <div class="job-head">
                    <button type="button" class="qb-add-line" id="qb-add-line-btn" aria-label="Add line">+</button>
                    <span>#</span>
                    <span>Product/Service</span>
                    <span>Description</span>
                    <span>Qty</span>
                    <span>Rate</span>
                    <span>Amount</span>
                    <span></span>
                </div>

                <div id="jobs">
                    {{ formset.management_form }}
                    <div class="jobs-empty" id="no-jobs-message">No lines added yet. Use <strong>Add lines</strong> to
                        add your first entry.</div>
                    {% for form in formset %}
                    {% if form.is_bound or form.instance.pk or form.initial.job or form.initial.qty or form.initial.rate %}
                    <div class="grid job-entry-row qb-line-row">
                        {% for hidden_field in form.hidden_fields %}
                        {{ hidden_field }}
                        {% endfor %}
                        <div class="qb-cell qb-drag-cell">
                            <button type="button" class="qb-drag-handle" aria-label="Reorder line">
                                <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                                    <circle cx="5" cy="4" r="1.2"></circle>
                                    <circle cx="11" cy="4" r="1.2"></circle>
                                    <circle cx="5" cy="8" r="1.2"></circle>
                                    <circle cx="11" cy="8" r="1.2"></circle>
                                    <circle cx="5" cy="12" r="1.2"></circle>
                                    <circle cx="11" cy="12" r="1.2"></circle>
                                </svg>
                            </button>
                        </div>
                        <div class="qb-cell qb-row-number">1</div>
                        <div class="qb-cell qb-item-cell">
                            <span class="qb-mobile-label">Product/Service</span>
                            <select class="form-control qb-item-select" data-row-prefix="{{ form.prefix }}"></select>
                        </div>
                        <div class="qb-cell qb-desc-cell">
                            <span class="qb-mobile-label">Description</span>
                            {{ form.job|add_class:"form-control qb-desc-input"|attr:"rows:1"|attr:"placeholder:Description" }}
                            {% if form.job.errors %}
                            <div class="invalid-feedback d-block">{{ form.job.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <div class="qb-cell qb-qty-cell">
                            <span class="qb-mobile-label">Qty</span>
                            {{ form.qty|add_class:"form-control qb-qty-input"|attr:"placeholder:0"|attr:"step:any" }}
                            {% if form.qty.errors %}
                            <div class="invalid-feedback d-block">{{ form.qty.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <div class="qb-cell qb-rate-cell">
                            <span class="qb-mobile-label">Rate</span>
                            {{ form.rate|add_class:"form-control qb-rate-input"|attr:"placeholder:0.00"|attr:"step:0.01" }}
                            {% if form.rate.errors %}
                            <div class="invalid-feedback d-block">{{ form.rate.errors|striptags }}</div>
                            {% endif %}
                        </div>
                        <div class="qb-cell qb-amount-cell">
                            <span class="qb-mobile-label">Amount</span>
                            <input type="text" name="{{ form.prefix }}-amount" class="form-control entry-amount"
                                id="id_{{ form.prefix }}-amount"
                                value="{% if form.instance.pk %}{{ form.instance.amount|floatformat:2 }}{% else %}0.00{% endif %}"
                                readonly>
                        </div>
                        <div class="qb-cell qb-remove-cell">
                            <button type="button" class="qb-remove-row" aria-label="Remove line">
                                <i class="fas fa-trash"></i>
                            </button>
                            {{ form.DELETE|add_class:"hidden-delete-checkbox" }}
                        </div>
                        <input type="hidden" name="{{ form.prefix }}-service_id" id="id_{{ form.prefix }}-service_id">
                        <input type="hidden" name="{{ form.prefix }}-service_due_months"
                            id="id_{{ form.prefix }}-service_due_months">
                        <input type="hidden" name="{{ form.prefix }}-service_due_kilometers"
                            id="id_{{ form.prefix }}-service_due_kilometers">
                        <input type="hidden" name="{{ form.prefix }}-skip_maintenance"
                            id="id_{{ form.prefix }}-skip_maintenance">
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="qb-line-actions">
                <button type="button" class="qb-line-action-btn" id="qb-add-lines">Add lines</button>
                <button type="button" class="qb-line-action-btn" id="qb-clear-lines">Clear all lines</button>
            </div>
        </section>

        <div class="summary-grid">
            <section class="panel section-adjustments">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">Adjustments &amp; Fees</div>
                        <div class="panel-subtle">Optional shop supplies, discounts, or interest</div>
                    </div>
                </div>
                <div class="adjustment-grid">
                    <div class="adjust-card">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="toggle-shop-supply">
                            <label class="form-check-label" for="toggle-shop-supply">Add Shop Supply</label>
                        </div>
                        <div id="shop-supply-section" style="display: none;" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Shop Supply Type:</label>
                                <div class="flex space-x-4">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="shop_supply_type"
                                            id="shop_supply_percentage" value="percentage" checked>
                                        <label class="form-check-label" for="shop_supply_percentage">Percentage</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="shop_supply_type"
                                            id="shop_supply_fixed" value="fixed">
                                        <label class="form-check-label" for="shop_supply_fixed">Fixed Amount</label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label for="shop-supply-value"
                                    class="text-sm font-medium text-gray-700 whitespace-nowrap">Value:</label>
                                <input type="number" id="shop-supply-value" class="form-control w-24" value="3" min="0"
                                    step="any">
                            </div>
                            <div>
                                <label for="shop-supply-reason" class="block text-sm font-medium text-gray-700">Reason
                                    (optional):</label>
                                <input type="text" id="shop-supply-reason" class="form-control mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="adjust-card">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="toggle-discount">
                            <label class="form-check-label" for="toggle-discount">Apply Discount</label>
                        </div>
                        <div id="discount-section" style="display: none;" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Discount Type:</label>
                                <div class="flex space-x-4">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="discount_type"
                                            id="discount_fixed" value="fixed" checked>
                                        <label class="form-check-label" for="discount_fixed">Fixed Amount</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="discount_type"
                                            id="discount_percentage" value="percentage">
                                        <label class="form-check-label" for="discount_percentage">Percentage</label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label for="discount-value"
                                    class="text-sm font-medium text-gray-700 whitespace-nowrap">Value:</label>
                                <input type="number" id="discount-value" class="form-control w-24" value="0" min="0">
                            </div>
                            <div>
                                <label for="discount-reason" class="block text-sm font-medium text-gray-700">Reason
                                    (optional):</label>
                                <input type="text" id="discount-reason" class="form-control mt-1">
                            </div>
                        </div>
                    </div>

                    <div class="adjust-card">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="toggle-interest">
                            <label class="form-check-label" for="toggle-interest">Add Interest</label>
                        </div>
                        <div id="interest-section" style="display: none;" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Interest Type:</label>
                                <div class="flex space-x-4">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="interest_type"
                                            id="interest_fixed" value="fixed" checked>
                                        <label class="form-check-label" for="interest_fixed">Fixed Amount</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="interest_type"
                                            id="interest_percentage" value="percentage">
                                        <label class="form-check-label" for="interest_percentage">Percentage</label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label for="interest-value"
                                    class="text-sm font-medium text-gray-700 whitespace-nowrap">Value:</label>
                                <input type="number" id="interest-value" class="form-control w-24" value="0" min="0">
                            </div>
                            <div>
                                <label for="interest-reason" class="block text-sm font-medium text-gray-700">Reason
                                    (optional):</label>
                                <input type="text" id="interest-reason" class="form-control mt-1">
                            </div>
                        </div>
                    </div>
                    {% if 'tax_exempt' in grouped_invoice_form.fields or 'tax_exempt_reason' in grouped_invoice_form.fields %}
                    <div class="adjust-card">
                        <h4>Tax exemption</h4>
                        {% if 'tax_exempt' in grouped_invoice_form.fields %}
                        <div class="crispy-field">{{ grouped_invoice_form.tax_exempt|as_crispy_field }}</div>
                        {% endif %}
                        {% if 'tax_exempt_reason' in grouped_invoice_form.fields %}
                        <div class="crispy-field" id="tax-exempt-reason-container" style="display:none;">
                            {{ grouped_invoice_form.tax_exempt_reason|as_crispy_field }}
                            <datalist id="tax-exemption-reasons">
                                {% for reason in exemption_reasons %}
                                <option value="{{ reason }}"></option>
                                {% endfor %}
                            </datalist>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </section>

            <section class="totals-card section-totals">
                <div class="line">
                    <span class="muted">Subtotal (Jobs/Parts)</span>
                    <span id="base-subtotal-amount" class="accent">${{ base_subtotal_amount|default:0|floatformat:2 }}</span>
                </div>
                <div class="line" id="shop-supply-total-line" style="display: none;">
                    <span class="muted">Shop Supply</span>
                    <span id="shop-supply-total-amount">${{ shop_supply_total_amount|default:0|floatformat:2 }}</span>
                </div>
                <div class="line" id="discount-total-line" style="display: none;">
                    <span class="muted">Discount</span>
                    <span id="discount-total-amount" class="text-red-200">${{ discount_total_amount|default:0|floatformat:2 }}</span>
                </div>
                <div class="line" id="interest-total-line" style="display: none;">
                    <span class="muted">Interest</span>
                    <span id="interest-total-amount">${{ interest_total_amount|default:0|floatformat:2 }}</span>
                </div>
                <div class="line" id="subtotal-after-interest-line" style="display: none;">
                    <span class="muted">Subtotal</span>
                    <span id="subtotal-after-interest-amount">${{ subtotal_after_interest_amount|default:0|floatformat:2 }}</span>
                </div>
                <hr id="pre-tax-separator" style="display: none;">
                <div class="line" id="taxable-amount-line" style="display: none;">
                    <span class="muted">Total Before Tax</span>
                    <span id="taxable-total-amount">${{ pre_tax_subtotal_amount|default:0|floatformat:2 }}</span>
                </div>
                <div class="line">
                    <span id="tax-name-display" class="muted">{{ tax_name|default:"Tax" }}</span>
                    <span id="tax-amount">${{ tax_total_amount|default:0|floatformat:2 }}</span>
                </div>
                <hr>
                <div class="line">
                    <span class="grand">Grand Total</span>
                    <span id="grand-total-amount" class="grand">${{ grand_total_amount|default:0|floatformat:2 }}</span>
                </div>
                <div class="save-wrap" aria-hidden="true"></div>
            </section>
        </div>
        {% if 'notes' in grouped_invoice_form.fields %}
        <section class="panel section-message">
            <div class="panel-header">
                <div>
                    <div class="panel-title">Message on invoice</div>
                    <div class="panel-subtle">Shown to the customer on the PDF</div>
                </div>
            </div>
            <div class="field-stack">
                <div class="crispy-field">{{ grouped_invoice_form.notes|as_crispy_field }}</div>
            </div>
        </section>
        {% endif %}
        <div id="qb-send-toast" class="qb-toast" role="status" aria-live="polite"></div>
        <div class="qb-footer">
            <div class="qb-footer-group">
                <button type="button" class="qb-footer-link" id="qb-cancel-btn"
                    onclick="if (window.handleCancelClick) { return window.handleCancelClick(event); } event.preventDefault(); window.location.href='{% if documentType == 'invoice' %}{% url 'accounts:groupedinvoice_list' %}{% else %}{% url 'accounts:estimate_list' %}{% endif %}'; return false;">Cancel</button>
                <button type="button" class="qb-footer-link" id="qb-clear-btn"
                    onclick="if (window.handleClearClick) { return window.handleClearClick(event); } event.preventDefault(); if (window.confirm('Clear unsaved changes?')) { window.location.reload(); } return false;">Clear</button>
            </div>
            <div class="qb-footer-group">
                {% if grouped_invoice_form.instance.pk %}
                {% if documentType == 'estimate' %}
                <a class="btn qb-action-btn" id="qb-print-btn" target="_blank"
                    href="{% url 'accounts:print_estimate_pdf' grouped_invoice_form.instance.pk %}">Print or Preview</a>
                <a class="btn qb-action-btn" id="qb-download-btn"
                    href="{% url 'accounts:generate_estimate_pdf' grouped_invoice_form.instance.pk %}">Download</a>
                {% else %}
                <a class="btn qb-action-btn" id="qb-print-btn" target="_blank"
                    href="{% url 'accounts:print_grouped_invoice_pdf' grouped_invoice_form.instance.pk %}">Print or
                    Preview</a>
                <a class="btn qb-action-btn" id="qb-download-btn"
                    href="{% url 'accounts:generate_grouped_invoice_pdf' grouped_invoice_form.instance.pk %}">Download</a>
                {% endif %}
                {% else %}
                <button type="button" class="btn qb-action-btn" disabled title="Save to enable">Print or
                    Preview</button>
                <button type="button" class="btn qb-action-btn" disabled title="Save to enable">Download</button>
                {% endif %}
            </div>
            <div class="qb-footer-group">
                <button type="submit" name="save_stay" value="1" class="btn btn-outline-secondary"
                    id="qb-save-btn">Save</button>
                <div class="qb-split-group" id="qb-save-send-group">
                    <button type="submit" name="save_send" value="1" class="btn btn-primary qb-split-main"
                        id="qb-save-send-btn">Save and send</button>
                    <button type="button" class="btn btn-primary qb-split-toggle" id="qb-save-send-toggle"
                        aria-haspopup="true" aria-expanded="false"
                        onclick="event.preventDefault(); event.stopPropagation(); var group=document.getElementById('qb-save-send-group'); if (!group) { return; } var isOpen=group.classList.toggle('is-open'); var menu=group.querySelector('.qb-split-menu'); if (menu) { menu.style.display = isOpen ? 'block' : 'none'; }">
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </button>
                    <div class="qb-split-menu" role="menu" aria-label="Save and send options">
                        <button type="submit" name="save_continue" value="1" class="qb-split-item" role="menuitem">Save
                            and new</button>
                        <button type="submit" name="submit_income" value="1" class="qb-split-item" role="menuitem"
                            id="qb-save-close-btn">Save and close</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% if documentType == 'invoice' %}
<div class="modal fade" id="invoicePaymentModal" tabindex="-1" role="dialog" aria-labelledby="invoicePaymentModalLabel"
    aria-hidden="true" data-today="{% now 'Y-m-d' %}">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoicePaymentModalLabel">Record Payment</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" id="invoice-payment-form"
                action="{% if grouped_invoice_form.instance.pk %}{% url 'accounts:mark_invoice_paid' grouped_invoice_form.instance.pk %}{% endif %}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <div class="modal-body">
                    <div class="alert alert-info mb-3">Record a full or partial payment for this invoice.</div>
                    <div class="mb-3">
                        <label for="invoice-payment-amount" class="form-label">Amount</label>
                        <input type="number" step="0.01" min="0" class="form-control" id="invoice-payment-amount"
                            name="amount"
                            value="{% if documentType == 'invoice' and grouped_invoice_form.instance.pk %}{{ invoice_balance_due_amount|default:0|floatformat:2 }}{% else %}0.00{% endif %}"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="invoice-payment-date" class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="invoice-payment-date" name="payment_date">
                    </div>
                    <div class="mb-3">
                        <label for="invoice-payment-method" class="form-label">Payment Method</label>
                        <select class="form-control" id="invoice-payment-method" name="method">
                            {% for method in payment_methods %}
                            <option value="{{ method }}">{{ method }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="invoice-payment-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="invoice-payment-notes" name="notes" rows="2"
                            placeholder="Optional notes"></textarea>
                    </div>
                    <div class="text-muted small">Balance due: <span id="invoice-payment-balance"></span></div>
                    <div class="alert alert-danger mt-3 d-none" id="invoice-payment-error"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{# Add Service Modal #}
<div class="modal fade" id="addJobModal" tabindex="-1" role="dialog" aria-labelledby="addJobModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addJobModalLabel">Add Service</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted small mb-0">Pick a saved job or create a new service without leaving this page.
                    </p>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="openMachServiceFormBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="form-group">
                    <label for="jobNameSelect" class="font-weight-semibold">Job name</label>
                    <select id="jobNameSelect" class="form-control" required>
                        <option value="">Select job name</option>
                    </select>
                    <div class="invalid-feedback">Please select a job name.</div>
                </div>
                <div class="form-group mb-0">
                    <label for="jobDescriptionInput" class="font-weight-semibold">Job description</label>
                    <textarea id="jobDescriptionInput" class="form-control" rows="3"
                        placeholder="Description will be selected automatically"></textarea>
                    <div class="invalid-feedback">No description found for this job.</div>
                    <input type="hidden" id="jobDescriptionSelect">
                    <div id="jobDescriptionNotes" class="small text-muted mt-2" style="display:none;"></div>
                </div>
                <div class="form-group mt-3">
                    <label for="jobFixedHoursInput" class="font-weight-semibold">Fixed hours <span
                            class="text-muted">(optional)</span></label>
                    <input type="number" id="jobFixedHoursInput" class="form-control" placeholder="e.g. 2.5" min="0"
                        step="0.25">
                </div>
                <div class="form-group mt-3">
                    <label for="jobFixedRateInput" class="font-weight-semibold">Fixed rate <span
                            class="text-muted">(optional)</span></label>
                    <input type="number" id="jobFixedRateInput" class="form-control" placeholder="e.g. 125.00" min="0"
                        step="0.01">
                </div>
                <div class="form-group mt-3">
                    <label for="jobDueMonthsInput" class="font-weight-semibold">Due after (months) <span
                            class="text-muted">(optional)</span></label>
                    <input type="number" id="jobDueMonthsInput" class="form-control" placeholder="e.g. 6" min="0"
                        step="1">
                </div>
                <div class="form-group mt-3">
                    <label for="jobDueKilometersInput" class="font-weight-semibold">Due after (km) <span
                            class="text-muted">(optional)</span></label>
                    <input type="number" id="jobDueKilometersInput" class="form-control" placeholder="e.g. 8000" min="0"
                        step="1">
                    <small id="jobMaintenanceHint" class="form-text text-muted mt-1">We'll create a maintenance reminder
                        using these values when this invoice is saved.</small>
                </div>
                <div id="jobModalError" class="alert alert-danger mt-3 d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-link text-decoration-none" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddJobButton">
                    <i class="fas fa-plus-circle mr-1"></i> Update &amp; add service
                </button>
            </div>
        </div>
    </div>
</div>

{# New Service Modal (Mach) #}
<div class="modal fade" id="machNewServiceModal" tabindex="-1" role="dialog" aria-labelledby="machNewServiceModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form id="mach-service-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="machNewServiceModalLabel">Add Service</h5>
                    <button type="button" class="close text-2xl font-semibold leading-none hover:text-red-600"
                        data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="machServiceError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="machServiceSuccess" class="alert alert-success d-none" role="alert"></div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700" for="mach_service_job_name">Job
                            name</label>
                        <input type="text" id="mach_service_job_name" name="job_name" class="form-control mt-1"
                            placeholder="e.g. PM Inspection" required>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700"
                            for="mach_service_description">Description</label>
                        <textarea id="mach_service_description" name="description" class="form-control" rows="3"
                            placeholder="Service description" required></textarea>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_service_notes">Notes
                            (optional)</label>
                        <textarea id="mach_service_notes" name="notes" class="form-control" rows="2"
                            placeholder="Internal notes"></textarea>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_service_fixed_hours">Fixed
                            hours <span class="text-muted">(optional)</span></label>
                        <input type="number" id="mach_service_fixed_hours" name="fixed_hours" class="form-control"
                            placeholder="e.g. 2.5" min="0" step="0.25">
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_service_fixed_rate">Fixed rate
                            <span class="text-muted">(optional)</span></label>
                        <input type="number" id="mach_service_fixed_rate" name="fixed_rate" class="form-control"
                            placeholder="e.g. 125.00" min="0" step="0.01">
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="block text-sm font-medium text-gray-700" for="mach_service_due_months">Due
                                after (months)</label>
                            <input type="number" id="mach_service_due_months" name="due_after_months"
                                class="form-control" placeholder="6" min="0" step="1">
                        </div>
                        <div class="col-md-6">
                            <label class="block text-sm font-medium text-gray-700" for="mach_service_due_km">Due after
                                (km)</label>
                            <input type="number" id="mach_service_due_km" name="due_after_kilometers"
                                class="form-control" placeholder="8000" min="0" step="1">
                        </div>
                    </div>
                    <small class="form-text text-muted mt-2">New services are saved to your catalog and pre-filled
                        here.</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="machSaveServiceBtn">
                        <i class="fas fa-save mr-1"></i> Save Service
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Product/Service Type Modal #}
<div class="modal fade" id="itemTypeModal" tabindex="-1" role="dialog" aria-labelledby="itemTypeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemTypeModalLabel">Add new</h5>
                <button type="button" class="close text-2xl font-semibold leading-none hover:text-red-600"
                    data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="qb-item-type-grid">
                    <button type="button" class="qb-item-type-card" data-item-type="inventory">
                        <span class="qb-item-type-icon"><i class="fas fa-box-open"></i></span>
                        <span>
                            <strong>Inventory</strong>
                            <span class="text-muted d-block small">Track quantities on hand.</span>
                        </span>
                    </button>
                    <button type="button" class="qb-item-type-card" data-item-type="non_inventory">
                        <span class="qb-item-type-icon"><i class="fas fa-cube"></i></span>
                        <span>
                            <strong>Non-inventory</strong>
                            <span class="text-muted d-block small">Items you sell without tracking stock.</span>
                        </span>
                    </button>
                    <button type="button" class="qb-item-type-card" data-item-type="service">
                        <span class="qb-item-type-icon"><i class="fas fa-wrench"></i></span>
                        <span>
                            <strong>Service</strong>
                            <span class="text-muted d-block small">Services provided to customers.</span>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{# Add Part Modal #}
<div class="modal fade" id="sellProductModal" tabindex="-1" role="dialog" aria-labelledby="sellProductModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <form id="sell-product-form-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sellProductModalLabel">{% if documentType == 'estimate' %}Estimate
                        Part{% else %}Add Part{% endif %}</h5>
                    <button type="button" class="close text-2xl font-semibold leading-none hover:text-red-600"
                        data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p class="text-muted small mb-0">Pick an inventory product or create one without leaving this
                            page.</p>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="openMachProductFormBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="sell_product" class="block text-sm font-medium text-gray-700">Product</label>
                        <select id="sell_product" class="form-control mt-1">
                            <option value="">Select a product</option>
                            {% for product in products %}
                            <option value="{{ product.id }}">{% if product.sku %}{{ product.name }} ({{ product.sku }}){% else %}{{ product.name }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sell_price" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="sell_price" class="form-control mt-1" min="0" step="0.01"
                            placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="sell_quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="sell_quantity" class="form-control mt-1" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="add-sell-product" class="btn btn-primary">Add {% if documentType == 'estimate' %}Part Estimate{% else %}Part{% endif %} Entry</button>
                </div>
            </div>
        </form>
    </div>
</div>

{# New Product Modal (Mach) #}
<div class="modal fade" id="machNewProductModal" tabindex="-1" role="dialog" aria-labelledby="machNewProductModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form id="mach-product-form">
                <div class="modal-header">
                    <h5 class="modal-title" id="machNewProductModalLabel">Add Product</h5>
                    <button type="button" class="close text-2xl font-semibold leading-none hover:text-red-600"
                        data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="machProductError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="machProductSuccess" class="alert alert-success d-none" role="alert"></div>
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700" for="mach_product_name">Name <span
                                class="text-danger">*</span></label>
                        <input type="text" id="mach_product_name" name="name" class="form-control"
                            placeholder="Product name" required>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_product_sku">SKU / Part
                            #</label>
                        <input type="text" id="mach_product_sku" name="sku" class="form-control" placeholder="Optional">
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700"
                            for="mach_product_description">Description</label>
                        <textarea id="mach_product_description" name="description" class="form-control" rows="3"
                            placeholder="Optional details"></textarea>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_product_item_type">Item
                            type</label>
                        <select id="mach_product_item_type" name="item_type" class="form-control">
                            <option value="inventory">Inventory</option>
                            <option value="non_inventory">Non-inventory</option>
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700"
                            for="mach_product_category">Category</label>
                        <select id="mach_product_category" name="category" class="form-control">
                            <option value="">Select a category (optional)</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_product_sale_price">Sale
                            price</label>
                        <input type="number" step="0.01" min="0" id="mach_product_sale_price" name="sale_price"
                            class="form-control" placeholder="0.00">
                    </div>
                    <div class="form-group mt-3">
                        <label class="block text-sm font-medium text-gray-700" for="mach_product_cost_price">Cost price
                            <span class="text-danger">*</span></label>
                        <input type="number" step="0.01" min="0" id="mach_product_cost_price" name="cost_price"
                            class="form-control" placeholder="0.00" required>
                    </div>
                    <div class="form-group mt-3" id="mach_product_stock_group">
                        <label class="block text-sm font-medium text-gray-700" for="mach_product_stock">Stock in
                            quantity</label>
                        <input type="number" step="1" min="0" id="mach_product_stock" name="quantity_in_stock"
                            class="form-control" placeholder="e.g. 10">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="machSaveProductBtn">Save Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Add Customer Modal #}
<div class="modal fade" id="addCustomerModal" tabindex="-1" role="dialog" aria-labelledby="addCustomerModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <form id="add-customer-form"> {# Ensure form has an ID #}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
                    <button type="button" class="close text-2xl font-semibold leading-none hover:text-red-600"
                        data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    {# This will render the form fields. Styling will be applied via JS/CSS #}
                    {{ customer_form.as_p }}
                    <div id="customer-form-errors" class="text-red-500 text-sm mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-customer-button">Save Customer</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if show_vehicle_details %}
{# Add Vehicle Modal #}
<div class="modal fade" id="addVehicleModal" tabindex="-1" role="dialog" aria-labelledby="addVehicleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <form id="add-vehicle-form">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addVehicleModalLabel">Add New Vehicle</h5>
                    <button type="button" class="close text-2xl font-semibold leading-none hover:text-red-600"
                        data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <label for="{{ vehicle_form.unit_number.id_for_label }}">Unit Number</label>
                        <input type="text" name="{{ vehicle_form.unit_number.html_name }}"
                            id="{{ vehicle_form.unit_number.id_for_label }}" class="form-control"
                            value="{{ vehicle_form.unit_number.value|default_if_none:'' }}">
                        {% if vehicle_form.unit_number.errors %}
                        <div class="invalid-feedback d-block">{{ vehicle_form.unit_number.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ vehicle_form.vin_number.id_for_label }}">VIN Number</label>
                        <input type="text" name="{{ vehicle_form.vin_number.html_name }}"
                            id="{{ vehicle_form.vin_number.id_for_label }}" class="form-control"
                            value="{{ vehicle_form.vin_number.value|default_if_none:'' }}">
                        {% if vehicle_form.vin_number.errors %}
                        <div class="invalid-feedback d-block">{{ vehicle_form.vin_number.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ vehicle_form.license_plate.id_for_label }}">License Plate</label>
                        <input type="text" name="{{ vehicle_form.license_plate.html_name }}"
                            id="{{ vehicle_form.license_plate.id_for_label }}" class="form-control"
                            value="{{ vehicle_form.license_plate.value|default_if_none:'' }}">
                        {% if vehicle_form.license_plate.errors %}
                        <div class="invalid-feedback d-block">{{ vehicle_form.license_plate.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ vehicle_form.make_model.id_for_label }}">Make / Model</label>
                        <input type="text" name="{{ vehicle_form.make_model.html_name }}"
                            id="{{ vehicle_form.make_model.id_for_label }}" class="form-control"
                            value="{{ vehicle_form.make_model.value|default_if_none:'' }}">
                        {% if vehicle_form.make_model.errors %}
                        <div class="invalid-feedback d-block">{{ vehicle_form.make_model.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group mb-3">
                        <label for="{{ vehicle_form.year.id_for_label }}">Year</label>
                        <input type="number" name="{{ vehicle_form.year.html_name }}"
                            id="{{ vehicle_form.year.id_for_label }}" class="form-control"
                            value="{{ vehicle_form.year.value|default_if_none:'' }}">
                        {% if vehicle_form.year.errors %}
                        <div class="invalid-feedback d-block">{{ vehicle_form.year.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group mb-1">
                        <label for="{{ vehicle_form.current_mileage.id_for_label }}">Current Mileage</label>
                        <input type="number" name="{{ vehicle_form.current_mileage.html_name }}"
                            id="{{ vehicle_form.current_mileage.id_for_label }}" class="form-control" step="any"
                            value="{{ vehicle_form.current_mileage.value|default_if_none:'' }}">
                        {% if vehicle_form.current_mileage.errors %}
                        <div class="invalid-feedback d-block">{{ vehicle_form.current_mileage.errors|striptags }}</div>
                        {% endif %}
                    </div>
                    <div id="vehicle-form-errors" class="text-red-500 text-sm mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-vehicle-button">Save Vehicle</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Vehicle History Modal -->
<div class="modal fade" id="vehicleHistoryModal" tabindex="-1" role="dialog" aria-labelledby="vehicleHistoryModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleHistoryModalLabel">Vehicle History</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="vehicle-history-status" class="alert alert-info mb-3">
                    Select a vehicle to view its recent history.
                </div>
                <div id="vehicle-history-sections" style="display:none;">
                    <p class="text-muted mb-3" id="vehicle-history-vehicle-label"></p>
                    <div class="mb-4">
                        <h6 class="font-semibold">Recent Jobs</h6>
                        <div class="list-group" id="vehicle-history-jobs"></div>
                        <div class="text-muted text-sm" id="vehicle-history-jobs-empty" style="display:none;">
                            No recent labor entries recorded for this vehicle.
                        </div>
                    </div>
                    <div>
                        <h6 class="font-semibold">Parts Used</h6>
                        <div class="list-group" id="vehicle-history-parts"></div>
                        <div class="text-muted text-sm" id="vehicle-history-parts-empty" style="display:none;">
                            No recent parts usage recorded for this vehicle.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Maintenance Modal -->
<div class="modal fade" id="vehicleMaintenanceModal" tabindex="-1" role="dialog"
    aria-labelledby="vehicleMaintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleMaintenanceModalLabel">Maintenance Reminders</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="vehicle-maintenance-status" class="alert alert-info mb-3">
                    Select a vehicle to review upcoming maintenance reminders.
                </div>
                <div id="vehicle-maintenance-sections" style="display:none;">
                    <p class="text-muted mb-2" id="vehicle-maintenance-vehicle-label"></p>
                    <div class="small text-muted mb-3" id="vehicle-maintenance-stats" style="display:none;"></div>
                    <div class="list-group" id="vehicle-maintenance-list"></div>
                    <div class="text-muted text-sm" id="vehicle-maintenance-empty" style="display:none;">
                        No active maintenance reminders for this vehicle.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

{{ job_catalog_json|json_script:"job-catalog-data" }}
<script>
    // Global scope variables
    let customerSelect, vehicleSelect;
    let pageShell = null;
    let customerData = {};
    let selectedRate = "";
    let productSalePrices = {};
    let currentDocumentType = "";
    const rawTaxComponents = {{ tax_components_json|default:"[]"|safe }};
    const defaultTaxRate = parseFloat("{{ tax_rate|default:0.0 }}");
    function normalizeTaxComponents(components) {
        if (!Array.isArray(components)) {
            return [];
        }
        return components
            .map((rate) => parseFloat(rate))
            .filter((rate) => !isNaN(rate) && rate !== 0);
    }
    function sumTaxComponents(components) {
        if (!Array.isArray(components)) {
            return 0;
        }
        return components.reduce((sum, rate) => sum + (parseFloat(rate) || 0), 0);
    }
    const defaultTaxComponents = normalizeTaxComponents(rawTaxComponents);
    if (!defaultTaxComponents.length && !isNaN(defaultTaxRate) && defaultTaxRate > 0) {
        defaultTaxComponents.push(defaultTaxRate);
    }
    let currentTaxComponents = defaultTaxComponents.slice();
    let currentTaxRate = sumTaxComponents(currentTaxComponents);
    let currentTaxName = "Tax";
    let invoiceTotalPaid = 0;
    let latestGrandTotal = 0;
    let receivePaymentBtn = null;
    let currentDocumentId = "";
    let serverBalanceDue = 0;
    let promptedVehicleCustomerId = "";
    let pendingVehicleModalCustomerId = "";
    let preserveVehicleFieldsOnLoad = false;
    let isVehicleLoading = false;

    function getBsModal(id) {
        if (!window.bootstrap) { return null; }
        const el = document.getElementById(id);
        if (!el) { return null; }
        return bootstrap.Modal.getOrCreateInstance(el);
    }

    function showModal(id) {
        const modal = getBsModal(id);
        if (modal) { modal.show(); }
    }

    function hideModal(id) {
        const modal = getBsModal(id);
        if (modal) { modal.hide(); }
    }

    /*--------------------------------------------------------------------
     Global Helper and Event Functions (Your existing functions: updateRowAmount, formatCurrency, etc.)
    --------------------------------------------------------------------*/
    function updateRowAmount(row) {
        const qtyInput = row.find('input[name$="-qty"]');
        const rateInput = row.find('input[name$="-rate"]');
        const amountOutput = row.find('.entry-amount');
        if (!qtyInput.length || !rateInput.length || !amountOutput.length) {
            return;
        }
        const qtyRaw = (qtyInput.val() || '').toString().trim();
        const rateRaw = (rateInput.val() || '').toString().trim();
        if (!qtyRaw && !rateRaw) {
            return;
        }
        const q = parseMoneyValue(qtyRaw);
        const r = parseMoneyValue(rateRaw);
        amountOutput.val((q * r).toFixed(2));
    }

    function updateAllRegularRowAmounts() {
        $('#jobs .job-entry-row').not('.special-entry').each(function () {
            updateRowAmount($(this));
        });
    }

    function formatCurrency(value) {
        const numValue = parseFloat(value);
        if (isNaN(numValue)) {
            return "$0.00";
        }
        return numValue.toLocaleString('en-CA', {
            style: 'currency',
            currency: 'CAD',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function parseMoneyValue(value) {
        const cleaned = (value || '').toString().replace(/[^0-9.-]+/g, '');
        const parsed = parseFloat(cleaned);
        return isNaN(parsed) ? 0 : parsed;
    }

    function roundCurrency(value) {
        const numValue = parseFloat(value) || 0;
        const sign = numValue < 0 ? -1 : 1;
        const rounded = Math.round((Math.abs(numValue) + Number.EPSILON) * 100) / 100;
        return sign * rounded;
    }

    function getJobFieldValue(row) {
        const jobField = row.find('input[name$="-job"], textarea[name$="-job"]').first();
        return jobField.length ? (jobField.val() || '').toString().trim() : '';
    }

    function detectAdjustmentKind(jobValue) {
        const normalized = (jobValue || '').toString().trim().toLowerCase();
        if (normalized.startsWith('shop supply')) {
            return 'shop-supply';
        }
        if (normalized.startsWith('discount')) {
            return 'discount';
        }
        if (normalized.startsWith('interest')) {
            return 'interest';
        }
        return '';
    }

    function parseAdjustmentDescriptor(jobValue) {
        const details = { valueType: '', value: null, reason: '' };
        if (!jobValue) {
            return details;
        }
        let base = jobValue;
        const reasonIndex = jobValue.indexOf(' - ');
        if (reasonIndex !== -1) {
            details.reason = jobValue.slice(reasonIndex + 3).trim();
            base = jobValue.slice(0, reasonIndex).trim();
        }
        const match = base.match(/\(([^)]+)\)/);
        if (!match) {
            return details;
        }
        const token = match[1].trim();
        if (token.includes('%')) {
            details.valueType = 'percentage';
            details.value = parseMoneyValue(token);
        } else {
            details.valueType = 'fixed';
            details.value = parseMoneyValue(token);
        }
        if (isNaN(details.value)) {
            details.value = null;
        }
        return details;
    }

    function getRowRateValue(row) {
        const rateField = row.find('input[name$="-rate"]').first();
        return rateField.length ? parseMoneyValue(rateField.val()) : 0;
    }

    function applyAdjustmentInputs(kind, row) {
        const jobValue = getJobFieldValue(row);
        const details = parseAdjustmentDescriptor(jobValue);
        let valueType = details.valueType;
        let value = details.value;
        const rateValue = Math.abs(getRowRateValue(row));
        if (!valueType && rateValue) {
            valueType = 'fixed';
            value = rateValue;
        }

        if (kind === 'shop-supply') {
            if (valueType) {
                $(`input[name="shop_supply_type"][value="${valueType}"]`).prop('checked', true);
            }
            if (value !== null) {
                $('#shop-supply-value').val(value);
            }
            if (details.reason) {
                $('#shop-supply-reason').val(details.reason);
            }
        } else if (kind === 'discount') {
            if (valueType) {
                $(`input[name="discount_type"][value="${valueType}"]`).prop('checked', true);
            }
            if (value !== null) {
                $('#discount-value').val(value);
            }
            if (details.reason) {
                $('#discount-reason').val(details.reason);
            }
        } else if (kind === 'interest') {
            if (valueType) {
                $(`input[name="interest_type"][value="${valueType}"]`).prop('checked', true);
            }
            if (value !== null) {
                $('#interest-value').val(value);
            }
            if (details.reason) {
                $('#interest-reason').val(details.reason);
            }
        }
    }

    function initializeAdjustmentRowsFromExistingEntries() {
        const seen = {
            'shop-supply': null,
            'discount': null,
            'interest': null,
        };
        $('#jobs .job-entry-row').each(function () {
            const row = $(this);
            const jobValue = getJobFieldValue(row);
            const kind = detectAdjustmentKind(jobValue);
            if (!kind) {
                return;
            }
            row.addClass('special-entry').addClass(kind);
            row.find('.qb-row-number').text('');
            const deleteCheckbox = row.find('input[name$="-DELETE"]');
            if (deleteCheckbox.length && deleteCheckbox.is(':checked')) {
                return;
            }
            if (!seen[kind]) {
                seen[kind] = row;
            }
        });

        Object.keys(seen).forEach(function (kind) {
            const row = seen[kind];
            if (row) {
                applyAdjustmentInputs(kind, row);
            }
        });
    }

    function calculateBaseSubtotal() {
        let total = 0;
        $('#jobs .job-entry-row').not('.special-entry').each(function () {
            const row = $(this);
            const deleteCheckbox = row.find('input[name$="-DELETE"]');
            if (!deleteCheckbox.length || !deleteCheckbox.is(':checked')) {
                total += parseFloat(row.find('.entry-amount').val()) || 0;
            }
        });
        return total;
    }

    function calculateLineTaxTotal() {
        if (!currentTaxComponents.length) {
            return 0;
        }
        let total = 0;
        $('#jobs .job-entry-row').each(function () {
            const row = $(this);
            const deleteCheckbox = row.find('input[name$="-DELETE"]');
            if (deleteCheckbox.length && deleteCheckbox.is(':checked')) {
                return;
            }
            if (row.hasClass('interest')) {
                return;
            }
            const jobValue = (row.find('input[name$="-job"]').val() || '').toString().trim().toLowerCase();
            if (jobValue.startsWith('interest')) {
                return;
            }
            const lineAmount = parseFloat(row.find('.entry-amount').val()) || 0;
            let lineTax = 0;
            currentTaxComponents.forEach((rate) => {
                lineTax += roundCurrency(lineAmount * rate);
            });
            total += lineTax;
        });
        return roundCurrency(total);
    }

    function updateShopSupplyRowValues() {
        const row = $('.shop-supply').first();
        if (row.length && !row.find('input[name$="-DELETE"]').is(':checked')) {
            const supplyType = $('input[name="shop_supply_type"]:checked').val() || 'percentage';
            const value = parseFloat($('#shop-supply-value').val()) || 0;
            const baseSubtotal = calculateBaseSubtotal();
            let amount = 0;
            let description = 'Shop Supply';
            if (supplyType === 'fixed') {
                amount = value;
                description += ` (${formatCurrency(value)})`;
            } else {
                amount = (baseSubtotal * value) / 100;
                description += ` (${value}%)`;
            }
            const reason = $('#shop-supply-reason').val();
            if (reason) description += ` - ${reason}`;
            row.find('input[name$="-job"]').val(description);
            row.find('input[name$="-rate"]').val(amount.toFixed(2));
            row.find('input[name$="-qty"]').val(1);
            updateRowAmount(row);
        }
    }

    function updateDiscountRowValues() {
        const row = $('.discount').first();
        if (row.length && !row.find('input[name$="-DELETE"]').is(':checked')) {
            const discountValueInput = parseFloat($('#discount-value').val()) || 0;
            const discountType = $('input[name="discount_type"]:checked').val();
            let baseForDiscount = calculateBaseSubtotal();

            if ($('#toggle-shop-supply').is(':checked')) {
                const shopSupplyRow = $('.shop-supply').first();
                if (shopSupplyRow.length && !shopSupplyRow.find('input[name$="-DELETE"]').is(':checked')) {
                    updateShopSupplyRowValues();
                    baseForDiscount += parseFloat(shopSupplyRow.find('.entry-amount').val()) || 0;
                }
            }

            let calculatedDiscount = 0;
            if (discountType === 'fixed') {
                calculatedDiscount = discountValueInput;
            } else { // percentage
                calculatedDiscount = baseForDiscount * discountValueInput / 100;
            }
            calculatedDiscount = -Math.abs(calculatedDiscount);

            let description = "Discount";
            if (discountType === 'fixed') {
                description += ` (${formatCurrency(discountValueInput)})`;
            } else {
                description += ` (${discountValueInput}%)`;
            }
            const reason = $('#discount-reason').val();
            if (reason) description += ` - ${reason}`;

            row.find('input[name$="-job"]').val(description);
            row.find('input[name$="-rate"]').val(calculatedDiscount.toFixed(2));
            row.find('input[name$="-qty"]').val(1);
            updateRowAmount(row);
        }
    }

    function updateInterestRowValues(baseAmount) {
        const row = $('.interest').first();
        if (row.length && !row.find('input[name$="-DELETE"]').is(':checked')) {
            const interestValueInput = parseFloat($('#interest-value').val()) || 0;
            const interestType = $('input[name="interest_type"]:checked').val();
            let calculatedInterest = 0;
            if (interestType === 'fixed') {
                calculatedInterest = interestValueInput;
            } else {
                calculatedInterest = baseAmount * interestValueInput / 100;
            }
            let description = interestType === 'fixed'
                ? `Interest (${formatCurrency(interestValueInput)})`
                : `Interest (${interestValueInput}%)`;
            const reason = $('#interest-reason').val();
            if (reason) description += ` - ${reason}`;
            row.find('input[name$="-job"]').val(description);
            row.find('input[name$="-rate"]').val(calculatedInterest.toFixed(2));
            row.find('input[name$="-qty"]').val(1);
            updateRowAmount(row);
        }
    }

    function calculateTotal() {
        updateAllRegularRowAmounts();
        const baseSubtotal = calculateBaseSubtotal();
        $('#base-subtotal-amount').text(formatCurrency(baseSubtotal));

        let shopSupplyDisplayAmount = 0;
        const shopSupplyRow = $('.shop-supply').first();
        if ($('#toggle-shop-supply').is(':checked')) {
            updateShopSupplyRowValues();
            if (shopSupplyRow.length && !shopSupplyRow.find('input[name$="-DELETE"]').is(':checked')) {
                shopSupplyDisplayAmount = parseFloat(shopSupplyRow.find('.entry-amount').val()) || 0;
            }
            $('#shop-supply-total-line').show();
            $('#shop-supply-total-amount').text(formatCurrency(shopSupplyDisplayAmount));
        } else {
            $('#shop-supply-total-line').hide();
            if (shopSupplyRow.length) { shopSupplyRow.find('input[name$="-rate"], .entry-amount').val("0.00"); }
        }

        let discountDisplayAmount = 0;
        const discountRow = $('.discount').first();
        if ($('#toggle-discount').is(':checked')) {
            updateDiscountRowValues();
            if (discountRow.length && !discountRow.find('input[name$="-DELETE"]').is(':checked')) {
                discountDisplayAmount = parseFloat(discountRow.find('.entry-amount').val()) || 0;
            }
            $('#discount-total-line').show();
            $('#discount-total-amount').text(formatCurrency(-discountDisplayAmount));
        } else {
            $('#discount-total-line').hide();
            if (discountRow.length) { discountRow.find('input[name$="-rate"], .entry-amount').val("0.00"); }
        }

        const preTaxSubtotal = baseSubtotal + shopSupplyDisplayAmount + discountDisplayAmount;

        let interestDisplayAmount = 0;
        const interestRow = $('.interest').first();
        if ($('#toggle-interest').is(':checked')) {
            updateInterestRowValues(preTaxSubtotal);
            if (interestRow.length && !interestRow.find('input[name$="-DELETE"]').is(':checked')) {
                interestDisplayAmount = parseFloat(interestRow.find('.entry-amount').val()) || 0;
            }
            $('#interest-total-line').show();
            $('#interest-total-amount').text(formatCurrency(interestDisplayAmount));
        } else {
            $('#interest-total-line').hide();
            if (interestRow.length) { interestRow.find('input[name$="-rate"], .entry-amount').val("0.00"); }
        }

        const subtotalAfterInterest = preTaxSubtotal + interestDisplayAmount;
        if (interestDisplayAmount !== 0) {
            $('#subtotal-after-interest-line').show();
            $('#subtotal-after-interest-amount').text(formatCurrency(subtotalAfterInterest));
        } else {
            $('#subtotal-after-interest-line').hide();
        }

        const taxableAmount = preTaxSubtotal; // Interest is not taxable

        if ($('#toggle-shop-supply').is(':checked') || $('#toggle-discount').is(':checked') || $('#toggle-interest').is(':checked')) {
            $('#taxable-total-amount').text(formatCurrency(taxableAmount));
            $('#taxable-amount-line').show();
            $('#pre-tax-separator').show();
        } else {
            $('#taxable-amount-line').hide();
            $('#pre-tax-separator').hide();
        }

        const taxAmount = calculateLineTaxTotal();
        const grandTotal = roundCurrency(taxableAmount + taxAmount + interestDisplayAmount);
        latestGrandTotal = grandTotal;
        const totalPaidValue = isNaN(invoiceTotalPaid) ? 0 : invoiceTotalPaid;

        let balanceDue = currentDocumentType === 'invoice'
            ? grandTotal - totalPaidValue
            : grandTotal;

        if (balanceDue < 0) {
            balanceDue = 0;
        }

        $('#tax-amount').text(formatCurrency(taxAmount));
        $('#grand-total-amount').text(formatCurrency(grandTotal));
        if (currentDocumentType === 'invoice' && currentDocumentId) {
            $('#balance-due-amount').text(formatCurrency(serverBalanceDue));
            if (receivePaymentBtn) {
                receivePaymentBtn.setAttribute('data-balance', serverBalanceDue.toFixed(2));
            }
        } else {
            $('#balance-due-amount').text(formatCurrency(balanceDue));
            if (receivePaymentBtn) {
                receivePaymentBtn.setAttribute('data-balance', balanceDue.toFixed(2));
            }
        }

        let taxDisplayString = currentTaxName || "Tax";
        if (currentTaxRate > 0) {
            let percentageString = (currentTaxRate * 100).toFixed(3).replace(/\.?0+$/, "");

        }
        $('#tax-name-display').text(taxDisplayString + ":");
        updateTaxIndicators();
    }

    function handleRateEdit(element) {
        const row = $(element).closest('.grid');
        if ($(element).attr('name').endsWith('-rate')) {
            row.find('input[name$="-rate"]').removeAttr('data-auto-rate');
        }
        updateRowAmount(row);
        calculateTotal();
    }

    function addShopSupplyForm() {
        const activeRow = $('.shop-supply:not(:has(input[name$="-DELETE"]:checked))');
        if (activeRow.length > 0) return activeRow;
        const hiddenRow = $('.shop-supply:has(input[name$="-DELETE"]:checked)').first();
        if (hiddenRow.length > 0) return hiddenRow;

        const totalFormsElement = $('#id_income_records-TOTAL_FORMS');
        if (!totalFormsElement.length) { console.error("TOTAL_FORMS not found!"); return null; }
        const newIndex = parseInt(totalFormsElement.val(), 10);
        const formHtml = `
    <div class="grid job-entry-row grid-cols-1 md:grid-cols-12 gap-x-2 md:gap-x-4 gap-y-3 items-end p-3 rounded-md border shop-supply special-entry" style="display:none;">
      <div class="col-span-1 md:col-span-4"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Item</label><input type="text" name="income_records-${newIndex}-job" value="Shop Supply" class="form-control bg-gray-100" readonly></div>
      <div class="col-span-1 md:col-span-2"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Qty</label><input type="number" name="income_records-${newIndex}-qty" value="1" class="form-control bg-gray-100" readonly></div>
      <div class="col-span-1 md:col-span-2"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Rate</label><input type="number" name="income_records-${newIndex}-rate" value="0.00" class="form-control bg-gray-100" readonly step="0.01"></div>
      <div class="col-span-1 md:col-span-2"><label class="block mb-1 text-sm font-medium text-gray-700">Amount</label><input type="text" name="income_records-${newIndex}-amount" class="form-control entry-amount bg-gray-100" id="id_income_records-${newIndex}-amount" value="0.00" readonly></div>
      <div class="col-span-1 md:col-span-1 flex items-center md:justify-center pt-2 md:pt-0 md:pb-2"><div class="form-check w-full md:w-auto"><input type="checkbox" name="income_records-${newIndex}-DELETE" id="id_income_records-${newIndex}-DELETE" class="form-check-input hidden-delete-checkbox mt-1" style="display:none;" onchange="calculateTotal();"><span class="text-xs text-gray-500 ml-1">Auto</span></div></div>
      <input type="hidden" name="income_records-${newIndex}-id" id="id_income_records-${newIndex}-id">
      <input type="hidden" name="income_records-${newIndex}-line_order" id="id_income_records-${newIndex}-line_order" value="${newIndex + 1}">
    </div>`;
        $('#jobs').append(formHtml);
        totalFormsElement.val(newIndex + 1);
        return $('.shop-supply').last();
    }
    function showShopSupplyForm() {
        let row = addShopSupplyForm();
        if (row && row.length) {
            row.find('input[name$="-DELETE"]').prop('checked', false);
            row.slideDown();
            updateShopSupplyRowValues();
            updateLineRowNumbers();
            calculateTotal();
        }
    }
    function hideShopSupplyForm() {
        const row = $('.shop-supply').first();
        if (row.length) {
            row.find('input[name$="-DELETE"]').prop('checked', true);
            row.slideUp();
            row.find('input[name$="-rate"], .entry-amount').val("0.00");
        }
        updateLineRowNumbers();
        calculateTotal();
    }

    function addDiscountForm() {
        const activeRow = $('.discount:not(:has(input[name$="-DELETE"]:checked))');
        if (activeRow.length > 0) return activeRow;
        const hiddenRow = $('.discount:has(input[name$="-DELETE"]:checked)').first();
        if (hiddenRow.length > 0) return hiddenRow;

        const totalFormsElement = $('#id_income_records-TOTAL_FORMS');
        if (!totalFormsElement.length) { console.error("TOTAL_FORMS not found!"); return null; }
        const newIndex = parseInt(totalFormsElement.val(), 10);
        const formHtml = `
    <div class="grid job-entry-row grid-cols-1 md:grid-cols-12 gap-x-2 md:gap-x-4 gap-y-3 items-end p-3 rounded-md border discount special-entry" style="display:none;">
      <div class="col-span-1 md:col-span-4"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Item</label><input type="text" name="income_records-${newIndex}-job" value="Discount" class="form-control bg-gray-100" readonly></div>
      <div class="col-span-1 md:col-span-2"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Qty</label><input type="number" name="income_records-${newIndex}-qty" value="1" class="form-control bg-gray-100" readonly></div>
      <div class="col-span-1 md:col-span-2"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Rate</label><input type="number" name="income_records-${newIndex}-rate" value="0.00" class="form-control bg-gray-100" readonly step="0.01"></div>
      <div class="col-span-1 md:col-span-2"><label class="block mb-1 text-sm font-medium text-gray-700">Amount</label><input type="text" name="income_records-${newIndex}-amount" class="form-control entry-amount bg-gray-100" value="0.00" readonly></div>
      <div class="col-span-1 md:col-span-1 flex items-center md:justify-center pt-2 md:pt-0 md:pb-2"><div class="form-check w-full md:w-auto"><input type="checkbox" name="income_records-${newIndex}-DELETE" id="id_income_records-${newIndex}-DELETE" class="form-check-input hidden-delete-checkbox mt-1" style="display:none;" onchange="calculateTotal();"><span class="text-xs text-gray-500 ml-1">Auto</span></div></div>
      <input type="hidden" name="income_records-${newIndex}-id" id="id_income_records-${newIndex}-id">
      <input type="hidden" name="income_records-${newIndex}-line_order" id="id_income_records-${newIndex}-line_order" value="${newIndex + 1}">
    </div>`;
        $('#jobs').append(formHtml);
        totalFormsElement.val(newIndex + 1);
        return $('.discount').last();
    }
    function showDiscountForm() {
        let row = addDiscountForm();
        if (row && row.length) {
            row.find('input[name$="-DELETE"]').prop('checked', false);
            row.slideDown();
            updateDiscountRowValues();
            updateLineRowNumbers();
            calculateTotal();
        }
    }
    function hideDiscountForm() {
        const row = $('.discount').first();
        if (row.length) {
            row.find('input[name$="-DELETE"]').prop('checked', true);
            row.slideUp();
            row.find('input[name$="-rate"], .entry-amount').val("0.00");
        }
        updateLineRowNumbers();
        calculateTotal();
    }

    function addInterestForm() {
        const activeRow = $('.interest:not(:has(input[name$="-DELETE"]:checked))');
        if (activeRow.length > 0) return activeRow;
        const hiddenRow = $('.interest:has(input[name$="-DELETE"]:checked)').first();
        if (hiddenRow.length > 0) return hiddenRow;

        const totalFormsElement = $('#id_income_records-TOTAL_FORMS');
        if (!totalFormsElement.length) { console.error("TOTAL_FORMS not found!"); return null; }
        const newIndex = parseInt(totalFormsElement.val(), 10);
        const formHtml = `
    <div class="grid job-entry-row grid-cols-1 md:grid-cols-12 gap-x-2 md:gap-x-4 gap-y-3 items-end p-3 rounded-md border interest special-entry" style="display:none;">
      <div class="col-span-1 md:col-span-4"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Item</label><input type="text" name="income_records-${newIndex}-job" value="Interest" class="form-control bg-gray-100" readonly></div>
      <div class="col-span-1 md:col-span-2"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Qty</label><input type="number" name="income_records-${newIndex}-qty" value="1" class="form-control bg-gray-100" readonly></div>
      <div class="col-span-1 md:col-span-2"><label class="block sm:hidden mb-1 text-xs font-medium text-gray-600">Rate</label><input type="number" name="income_records-${newIndex}-rate" value="0.00" class="form-control bg-gray-100" readonly step="0.01"></div>
      <div class="col-span-1 md:col-span-2"><label class="block mb-1 text-sm font-medium text-gray-700">Amount</label><input type="text" name="income_records-${newIndex}-amount" class="form-control entry-amount bg-gray-100" value="0.00" readonly></div>
      <div class="col-span-1 md:col-span-1 flex items-center md:justify-center pt-2 md:pt-0 md:pb-2"><div class="form-check w-full md:w-auto"><input type="checkbox" name="income_records-${newIndex}-DELETE" id="id_income_records-${newIndex}-DELETE" class="form-check-input hidden-delete-checkbox mt-1" style="display:none;" onchange="calculateTotal();"><span class="text-xs text-gray-500 ml-1">Auto</span></div></div>
      <input type="hidden" name="income_records-${newIndex}-id" id="id_income_records-${newIndex}-id">
      <input type="hidden" name="income_records-${newIndex}-line_order" id="id_income_records-${newIndex}-line_order" value="${newIndex + 1}">
    </div>`;
        $('#jobs').append(formHtml);
        totalFormsElement.val(newIndex + 1);
        return $('.interest').last();
    }

    function showInterestForm() {
        let row = addInterestForm();
        if (row && row.length) {
            row.find('input[name$="-DELETE"]').prop('checked', false);
            row.slideDown();
            updateLineRowNumbers();
            calculateTotal();
        }
    }

    function hideInterestForm() {
        const row = $('.interest').first();
        if (row.length) {
            row.find('input[name$="-DELETE"]').prop('checked', true);
            row.slideUp();
            row.find('input[name$="-rate"], .entry-amount').val("0.00");
        }
        updateLineRowNumbers();
        calculateTotal();
    }


    /*--------------------------------------------------------------------
      Document ready
    --------------------------------------------------------------------*/
    $(document).ready(function () {
        currentDocumentType = "{{ documentType }}";
        pageShell = document.querySelector('.page-shell');
        receivePaymentBtn = document.getElementById('qb-receive-payment-btn');
        currentDocumentId = pageShell ? (pageShell.dataset.documentId || '') : '';
        invoiceTotalPaid = pageShell ? parseMoneyValue(pageShell.dataset.totalPaid) : 0;
        serverBalanceDue = pageShell ? parseMoneyValue(pageShell.dataset.balanceDue) : 0;

        if (currentDocumentId) {
            $('#balance-due-amount').text(formatCurrency(serverBalanceDue));
            if (receivePaymentBtn) {
                receivePaymentBtn.setAttribute('data-balance', serverBalanceDue.toFixed(2));
            }
        }
        try {
            productSalePrices = JSON.parse('{{ product_data_json|escapejs }}');
        } catch (error) {
            console.error('productSalePrices could not be parsed:', error);
            productSalePrices = {};
        }
        if (typeof productSalePrices !== 'object' || productSalePrices === null) {
            console.error("productSalePrices was not initialized correctly.");
            productSalePrices = {};
        }
        const sellPriceInput = $('#sell_price');
        const addPartButton = $('#add-sell-product');

        function normalizeProductInfo(raw) {
            if (!raw) {
                return { price: '0.00', name: '', sku: '', description: '', item_type: 'inventory' };
            }
            if (typeof raw === 'object') {
                return {
                    price: raw.price !== undefined && raw.price !== null ? String(raw.price) : '0.00',
                    name: raw.name || '',
                    sku: raw.sku || '',
                    description: raw.description || '',
                    item_type: raw.item_type || 'inventory',
                };
            }
            return { price: String(raw), name: '', sku: '', description: '', item_type: 'inventory' };
        }

        function setPartButtonLabel(productId) {
            const info = normalizeProductInfo(productSalePrices[productId]);
            const currentPrice = (sellPriceInput.val() || '').trim();
            if (currentPrice && info.price && currentPrice !== info.price) {
                addPartButton.text('Update & Add Part Entry');
            } else {
                addPartButton.text('{% if documentType == "estimate" %}Add Part Estimate Entry{% else %}Add Part Entry{% endif %}');
            }
        }
        currentTaxComponents = defaultTaxComponents.slice();
        currentTaxRate = sumTaxComponents(currentTaxComponents);
        currentTaxName = "{{ tax_name|escapejs|default:'Tax' }}";
        selectedRate = "";

        function setupCustomerPortalFields(form) {
            if (!form || form.dataset.portalReady === '1') {
                return;
            }
            const toggle = form.querySelector('#id_register_portal');
            if (!toggle) {
                return;
            }
            const usernameWrapper = form.querySelector('#div_id_portal_username') || (form.querySelector('#id_portal_username') ? form.querySelector('#id_portal_username').closest('p') : null);
            const passwordWrapper = form.querySelector('#div_id_portal_password') || (form.querySelector('#id_portal_password') ? form.querySelector('#id_portal_password').closest('p') : null);
            const passwordInput = form.querySelector('#id_portal_password');

            function toggleVisibility() {
                const show = toggle.checked;
                if (usernameWrapper) {
                    usernameWrapper.style.display = show ? '' : 'none';
                }
                if (passwordWrapper) {
                    passwordWrapper.style.display = show ? '' : 'none';
                }
                if (!show && passwordInput) {
                    passwordInput.value = '';
                }
            }

            toggleVisibility();
            toggle.addEventListener('change', toggleVisibility);
            form.dataset.portalReady = '1';
        }

        const addCustomerFormElement = document.getElementById('add-customer-form');
        setupCustomerPortalFields(addCustomerFormElement);

        if ($('#id_tax_exempt').length && $('#id_tax_exempt').is(':checked')) {
            $('#tax-exempt-reason-container').show();
            currentTaxComponents = [];
            currentTaxRate = 0.0;
            currentTaxName = $('#id_tax_exempt_reason').val();
        }

        $('#id_tax_exempt').change(function () {
            if ($(this).is(':checked')) {
                $('#tax-exempt-reason-container').show();
                currentTaxComponents = [];
                currentTaxRate = 0.0;
                currentTaxName = $('#id_tax_exempt_reason').val();
            } else {
                $('#tax-exempt-reason-container').hide();
                currentTaxComponents = defaultTaxComponents.slice();
                currentTaxRate = sumTaxComponents(currentTaxComponents);
                currentTaxName = "{{ tax_name|escapejs|default:'Tax' }}";
            }
            calculateTotal();
        });

        $('#id_tax_exempt_reason').on('input', function () {
            if ($('#id_tax_exempt').is(':checked')) {
                currentTaxName = $(this).val();
                $('#tax-name-display').text(currentTaxName + ':');
                calculateTotal();
            }
        });

        const customerElement = $('#id_customer');
        const vehicleElement = $('#id_vehicle');
        const sellProductElement = $('#sell_product');
        const addCustomerModalElement = document.getElementById('addCustomerModal');
        const addVehicleModalElement = document.getElementById('addVehicleModal');

        function setCustomerModalPrefillName(name) {
            if (!addCustomerModalElement) { return; }
            const trimmed = (name || '').toString().trim();
            if (trimmed) {
                addCustomerModalElement.setAttribute('data-prefill-name', trimmed);
            } else {
                addCustomerModalElement.removeAttribute('data-prefill-name');
            }
        }

        function applyCustomerModalPrefill(modalElement) {
            if (!modalElement) { return; }
            const prefill = (modalElement.getAttribute('data-prefill-name') || '').toString().trim();
            if (!prefill) { return; }
            const nameInput = modalElement.querySelector('#id_name');
            if (nameInput) {
                nameInput.value = prefill;
                nameInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
            modalElement.removeAttribute('data-prefill-name');
        }

        function openAddCustomerModalWithName(name) {
            setCustomerModalPrefillName(name);
            showModal('addCustomerModal');
        }

        function closeCustomerModal() {
            hideModal('addCustomerModal');
            if (window.jQuery && typeof window.jQuery.fn.modal === 'function') {
                $('#addCustomerModal').modal('hide');
            }
        }

        function isAddCustomerModalOpen() {
            return !!(addCustomerModalElement && addCustomerModalElement.classList.contains('show'));
        }

        function isAddVehicleModalOpen() {
            return !!(addVehicleModalElement && addVehicleModalElement.classList.contains('show'));
        }

        function queueAddVehicleModal(customerId) {
            if (isAddVehicleModalOpen()) {
                return;
            }
            const nextId = customerId ? String(customerId) : '';
            if (isAddCustomerModalOpen()) {
                pendingVehicleModalCustomerId = nextId;
                return;
            }
            showModal('addVehicleModal');
        }

        function flushPendingVehicleModal() {
            if (!pendingVehicleModalCustomerId) {
                return;
            }
            const currentId = customerSelect && customerSelect.length ? String(customerSelect.val() || '') : '';
            if (currentId && currentId === pendingVehicleModalCustomerId) {
                showModal('addVehicleModal');
            }
            pendingVehicleModalCustomerId = '';
        }

        function decodeCustomerPrefillName(encoded) {
            if (!encoded) { return ''; }
            try {
                return decodeURIComponent(encoded);
            } catch (error) {
                return encoded;
            }
        }

        function buildCustomerNoResultsMarkup(term) {
            const rawTerm = (term || '').toString().trim();
            if (!rawTerm) {
                return 'No customers found';
            }
            const safeTerm = escapeHtml(rawTerm);
            const encodedTerm = encodeURIComponent(rawTerm);
            return `<div class="select2-add-new-customer" data-customer-name="${encodedTerm}">+ Add "${safeTerm}"</div>`;
        }

        function initCustomerSelect2() {
            if (!customerElement.length || !$.fn.select2) {
                return false;
            }
            const currentValue = customerElement.val();
            if (customerElement.data('select2')) {
                customerElement.select2('destroy');
            }
            customerSelect = customerElement.select2({
                theme: 'bootstrap4',
                placeholder: 'Search and select a customer',
                width: '100%',
                closeOnSelect: true,
                language: {
                    noResults: function (params) {
                        return buildCustomerNoResultsMarkup(params && params.term ? params.term : '');
                    }
                },
                escapeMarkup: function (markup) {
                    if (typeof markup === 'string' && markup.indexOf('select2-add-new-customer') !== -1) {
                        return markup;
                    }
                    return escapeHtml(markup);
                }
            });
            if (currentValue) {
                customerElement.val(currentValue).trigger('change.select2');
            }
            return true;
        }

        if (!initCustomerSelect2()) {
            if (customerElement.length) {
                let select2Attempts = 0;
                const select2Timer = setInterval(function () {
                    select2Attempts += 1;
                    if (initCustomerSelect2() || select2Attempts >= 25) {
                        clearInterval(select2Timer);
                        if (!customerElement.data('select2')) {
                            console.warn('Select2 library not available  falling back to native customer dropdown.');
                            customerSelect = customerElement;
                        }
                    }
                }, 200);
            } else {
                customerSelect = customerElement; // Empty jQuery set (defensive)
            }
        }

        if (vehicleElement.length) {
            if ($.fn.select2) {
                vehicleSelect = vehicleElement.select2({
                    theme: 'bootstrap4',
                    placeholder: 'Search and select a vehicle',
                    width: '100%',
                    closeOnSelect: true
                });
            } else {
                console.warn('Select2 library not available  falling back to native vehicle dropdown.');
                vehicleSelect = vehicleElement;
            }
        } else {
            vehicleSelect = vehicleElement; // Empty jQuery set (defensive)
        }

        $(document).on('click', '.select2-add-new-customer', function (event) {
            event.preventDefault();
            event.stopPropagation();
            const encoded = $(this).attr('data-customer-name') || '';
            const name = decodeCustomerPrefillName(encoded).trim();
            openAddCustomerModalWithName(name);
            closeSelect2Dropdown(customerElement);
        });

        function refreshCustomerAddNewOption() {
            const select2 = customerElement.data('select2');
            if (!select2 || !select2.$dropdown) {
                return;
            }
            const results = select2.$dropdown.find('.select2-results__options');
            if (!results.length) {
                return;
            }
            const hasSelectable = results.find('.select2-results__option[aria-selected]').length > 0;
            if (hasSelectable) {
                return;
            }
            const searchField = select2.$dropdown.find('.select2-search__field');
            const term = searchField.length ? searchField.val().trim() : '';
            const markup = buildCustomerNoResultsMarkup(term);
            results.html(`<li class="select2-results__option select2-results__message" role="alert" aria-live="assertive">${markup}</li>`);
        }

        function wireCustomerAddNewHandlers() {
            const select2 = customerElement.data('select2');
            if (!select2 || !select2.$dropdown) {
                return;
            }
            const searchField = select2.$dropdown.find('.select2-search__field');
            if (!searchField.length || searchField.data('addNewReady')) {
                return;
            }
            searchField.data('addNewReady', true);
            searchField.on('input', function () {
                setTimeout(refreshCustomerAddNewOption, 0);
            });
            setTimeout(refreshCustomerAddNewOption, 0);
        }

        customerElement.on('select2:open', function () {
            wireCustomerAddNewHandlers();
        });

        function vehicleOptionsEmpty() {
            if (!vehicleSelect || !vehicleSelect.length) { return true; }
            const opts = vehicleSelect.find('option');
            return opts.length <= 1;
        }

        function openAddVehicleModalIfEmpty(event) {
            if (vehicleOptionsEmpty()) {
                if (event && event.preventDefault) {
                    event.preventDefault();
                }
                showModal('addVehicleModal');
                return false;
            }
            return true;
        }

        if (vehicleSelect && vehicleSelect.length) {
            vehicleSelect.on('select2:opening', function (e) {
                if (!openAddVehicleModalIfEmpty(e)) {
                    e.preventDefault();
                }
            });
            vehicleSelect.on('click', function (e) {
                openAddVehicleModalIfEmpty(e);
            });
        }

        if (sellProductElement.length) {
            if ($.fn.select2) {
                sellProductElement.select2({
                    theme: 'bootstrap4',
                    placeholder: 'Select a product',
                    width: '100%',
                    closeOnSelect: true,
                    dropdownParent: $('#sellProductModal')
                });
            } else {
                console.warn('Select2 library not available  product dropdown will use native controls.');
            }

            sellProductElement.on('change', function () {
                const productId = $(this).val();
                const info = normalizeProductInfo(productSalePrices[productId]);
                if (sellPriceInput.length) {
                    sellPriceInput.val(info.price || '0.00');
                }
                setPartButtonLabel(productId);
                closeSelect2Dropdown(sellProductElement);
            });
        }

        if (sellPriceInput.length) {
            sellPriceInput.on('input', function () {
                setPartButtonLabel(sellProductElement.val());
            });
        }

        const vehicleHistoryButton = $('#vehicle-history-button');
        const vehicleHistoryHint = $('#vehicle-history-hint');
        const vehicleHistoryModal = $('#vehicleHistoryModal');
        const vehicleHistoryStatus = $('#vehicle-history-status');
        const vehicleHistorySections = $('#vehicle-history-sections');
        const vehicleHistoryVehicleLabel = $('#vehicle-history-vehicle-label');
        const vehicleHistoryJobs = $('#vehicle-history-jobs');
        const vehicleHistoryJobsEmpty = $('#vehicle-history-jobs-empty');
        const vehicleHistoryParts = $('#vehicle-history-parts');
        const vehicleHistoryPartsEmpty = $('#vehicle-history-parts-empty');
        const vehicleMaintenanceButton = $('#vehicle-maintenance-button');
        const vehicleMaintenanceHint = $('#vehicle-maintenance-hint');
        const vehicleMaintenanceModal = $('#vehicleMaintenanceModal');
        const vehicleMaintenanceStatus = $('#vehicle-maintenance-status');
        const vehicleMaintenanceSections = $('#vehicle-maintenance-sections');
        const vehicleMaintenanceVehicleLabel = $('#vehicle-maintenance-vehicle-label');
        const vehicleMaintenanceList = $('#vehicle-maintenance-list');
        const vehicleMaintenanceEmpty = $('#vehicle-maintenance-empty');
        const vehicleMaintenanceStats = $('#vehicle-maintenance-stats');
        const vehicleHistoryApi = '{{ vehicle_history_api|default:""|escapejs }}';
        const vehicleMaintenanceApi = '{{ vehicle_maintenance_api|default:""|escapejs }}';
        let vehicleHistoryState = {};
        let vehicleHistoryLoading = false;
        let initialVehicleHistory = {};
        let initialVehicleHistoryConsumed = false;
        let vehicleMaintenanceState = {};
        let vehicleMaintenanceLoading = false;
        let initialVehicleMaintenance = {};
        let initialVehicleMaintenanceConsumed = false;

        function getSelectedVehicleLabelById(id) {
            if (!id || !vehicleSelect || !vehicleSelect.length) { return ''; }
            const opt = vehicleSelect.find(`option[value="${id}"]`);
            return opt.length ? opt.text() : '';
        }

        try {
            initialVehicleHistory = JSON.parse('{{ vehicle_history_json|default:"{}"|escapejs }}');
        } catch (error) {
            initialVehicleHistory = {};
        }

        try {
            initialVehicleMaintenance = JSON.parse('{{ vehicle_maintenance_json|default:"{}"|escapejs }}');
        } catch (error) {
            initialVehicleMaintenance = {};
        }

        function normalizeHistory(rawState) {
            const state = rawState && typeof rawState === 'object' ? rawState : {};
            const jobs = Array.isArray(state.jobs) ? state.jobs : [];
            const parts = Array.isArray(state.parts) ? state.parts : [];
            const vehicle = state.vehicle && typeof state.vehicle === 'object' ? state.vehicle : null;
            const normalizedVehicle = vehicle ? Object.assign({}, vehicle) : null;
            if (normalizedVehicle && !normalizedVehicle.label) {
                const fallbackLabel = getSelectedVehicleLabelById(String(normalizedVehicle.id || ''));
                if (fallbackLabel) {
                    normalizedVehicle.label = fallbackLabel;
                }
            }
            const hasHistory = Boolean(state.has_history || jobs.length || parts.length);
            return {
                vehicle: normalizedVehicle,
                jobs,
                parts,
                has_history: hasHistory,
            };
        }

        function normalizeMaintenance(rawState) {
            const state = rawState && typeof rawState === 'object' ? rawState : {};
            const tasks = Array.isArray(state.tasks) ? state.tasks : [];
            const vehicle = state.vehicle && typeof state.vehicle === 'object' ? state.vehicle : null;
            const normalizedVehicle = vehicle ? Object.assign({}, vehicle) : null;
            if (normalizedVehicle && !normalizedVehicle.label) {
                const fallbackLabel = getSelectedVehicleLabelById(String(normalizedVehicle.id || ''));
                if (fallbackLabel) {
                    normalizedVehicle.label = fallbackLabel;
                }
            }
            return {
                vehicle: normalizedVehicle,
                tasks,
                has_tasks: Boolean(state.has_tasks || tasks.length),
                active_count: typeof state.active_count === 'number' ? state.active_count : tasks.length,
                overdue_count: typeof state.overdue_count === 'number' ? state.overdue_count : 0,
            };
        }

        function showVehicleHistoryStatus(message, variant) {
            if (!vehicleHistoryStatus.length) { return; }
            vehicleHistoryStatus.removeClass('alert-info alert-danger alert-success');
            if (variant) {
                vehicleHistoryStatus.addClass(`alert-${variant}`);
            }
            vehicleHistoryStatus.text(message || '');
            vehicleHistoryStatus.show();
        }

        function showVehicleMaintenanceStatus(message, variant) {
            if (!vehicleMaintenanceStatus.length) { return; }
            vehicleMaintenanceStatus.removeClass('alert-info alert-danger alert-success');
            if (variant) {
                vehicleMaintenanceStatus.addClass(`alert-${variant}`);
            }
            vehicleMaintenanceStatus.text(message || '');
            vehicleMaintenanceStatus.show();
        }

        function renderVehicleHistory(state) {
            if (!vehicleHistorySections.length) { return; }
            const vehicleLabel = state.vehicle && state.vehicle.label
                ? state.vehicle.label
                : getSelectedVehicleLabelById(state.vehicle ? String(state.vehicle.id || '') : '');
            vehicleHistoryVehicleLabel.text(vehicleLabel ? `History for ${vehicleLabel}` : '');
            const jobs = Array.isArray(state.jobs) ? state.jobs : [];
            const parts = Array.isArray(state.parts) ? state.parts : [];
            const hasJobs = jobs.length > 0;
            const hasParts = parts.length > 0;

            vehicleHistoryJobs.empty();
            jobs.forEach(function (job) {
                const row = $('<div class="list-group-item"></div>');
                row.append($('<div class="font-weight-bold"></div>').text(job.description || 'Job'));
                const meta = $('<div class="d-flex justify-content-between align-items-center small text-muted"></div>');
                meta.append($('<span></span>').text(job.date || ''));
                if (job.cost) {
                    meta.append($('<span class="text-primary font-weight-bold"></span>').text(job.cost));
                }
                row.append(meta);
                if (job.notes) {
                    row.append($('<div class="small mt-2 text-muted"></div>').text(job.notes));
                }
                vehicleHistoryJobs.append(row);
            });
            vehicleHistoryJobs.toggle(hasJobs);
            vehicleHistoryJobsEmpty.toggle(!hasJobs);

            vehicleHistoryParts.empty();
            parts.forEach(function (part) {
                const row = $('<div class="list-group-item"></div>');
                row.append($('<div class="font-weight-bold mb-1"></div>').text(part.description || 'Part'));
                const meta = $('<div class="d-flex justify-content-between align-items-center small text-muted"></div>');
                meta.append($('<span></span>').text(part.date || ''));
                if (part.quantity) {
                    meta.append($('<span class="badge badge-light"></span>').text(`Qty ${part.quantity}`));
                }
                row.append(meta);
                vehicleHistoryParts.append(row);
            });
            vehicleHistoryParts.toggle(hasParts);
            vehicleHistoryPartsEmpty.toggle(!hasParts);

            vehicleHistorySections.show();
            if (hasJobs || hasParts) {
                vehicleHistoryStatus.hide();
            } else {
                showVehicleHistoryStatus('No previous work recorded for this vehicle yet.', 'info');
            }
        }

        function renderVehicleMaintenance(state) {
            if (!vehicleMaintenanceSections.length) { return; }
            const vehicleLabel = state.vehicle && state.vehicle.label
                ? state.vehicle.label
                : getSelectedVehicleLabelById(state.vehicle ? String(state.vehicle.id || '') : '');
            vehicleMaintenanceVehicleLabel.text(vehicleLabel ? `Reminders for ${vehicleLabel}` : '');
            const tasks = Array.isArray(state.tasks) ? state.tasks : [];
            const hasTasks = tasks.length > 0;

            vehicleMaintenanceList.empty();
            tasks.forEach(function (task) {
                const row = $('<div class="list-group-item"></div>');
                const header = $('<div class="d-flex justify-content-between align-items-center"></div>');
                header.append($('<div class="font-weight-bold"></div>').text(task.title || 'Maintenance reminder'));
                const badgeWrap = $('<div class="d-flex flex-wrap align-items-center"></div>');
                if (task.priority_label) {
                    badgeWrap.append($('<span class="badge badge-light mr-1 mb-1"></span>').text(task.priority_label));
                }
                const statusBadge = $('<span class="badge mr-1 mb-1"></span>');
                if (task.is_overdue) {
                    statusBadge.addClass('badge-danger').text(task.status_label || 'Overdue');
                } else {
                    statusBadge.addClass('badge-info').text(task.status_label || 'Scheduled');
                }
                badgeWrap.append(statusBadge);
                header.append(badgeWrap);
                row.append(header);
                if (task.due_display) {
                    const due = $('<div class="small mt-2"></div>').text(task.due_display);
                    if (task.is_overdue) {
                        due.addClass('text-danger font-weight-bold');
                    } else {
                        due.addClass('text-muted');
                    }
                    row.append(due);
                }
                if (task.description) {
                    row.append($('<div class="small text-muted mt-2"></div>').text(task.description));
                }
                vehicleMaintenanceList.append(row);
            });

            if (vehicleMaintenanceStats.length) {
                if (state.active_count || state.overdue_count) {
                    const parts = [];
                    if (state.active_count) {
                        parts.push(`${state.active_count} active reminder${state.active_count === 1 ? '' : 's'}`);
                    }
                    if (state.overdue_count) {
                        parts.push(`${state.overdue_count} overdue`);
                    }
                    vehicleMaintenanceStats.text(parts.join('  '));
                    vehicleMaintenanceStats.show();
                } else {
                    vehicleMaintenanceStats.hide().text('');
                }
            }

            vehicleMaintenanceList.toggle(hasTasks);
            vehicleMaintenanceEmpty.toggle(!hasTasks);
            vehicleMaintenanceSections.show();
            if (hasTasks) {
                vehicleMaintenanceStatus.hide();
            } else {
                showVehicleMaintenanceStatus('No upcoming maintenance scheduled for this vehicle yet.', 'info');
            }
        }

        function assignVehicleHistory(rawState) {
            vehicleHistoryState = normalizeHistory(rawState);
            const hasVehicle = Boolean(vehicleHistoryState.vehicle && vehicleHistoryState.vehicle.id);
            if (vehicleHistoryButton.length) {
                vehicleHistoryButton.prop('disabled', !hasVehicle || vehicleHistoryLoading || !vehicleHistoryApi);
            }
            if (vehicleHistoryHint.length) {
                if (!hasVehicle) {
                    vehicleHistoryHint.text('Select a vehicle to view history.');
                } else if (!vehicleHistoryState.has_history) {
                    vehicleHistoryHint.text('No previous history recorded for this vehicle yet.');
                } else {
                    vehicleHistoryHint.text('Vehicle history ready to view.');
                }
            }
            renderVehicleHistory(vehicleHistoryState);
        }

        function assignVehicleMaintenance(rawState) {
            vehicleMaintenanceState = normalizeMaintenance(rawState);
            const hasVehicle = Boolean(vehicleMaintenanceState.vehicle && vehicleMaintenanceState.vehicle.id);
            if (vehicleMaintenanceButton.length) {
                vehicleMaintenanceButton.prop('disabled', !hasVehicle || vehicleMaintenanceLoading || !vehicleMaintenanceApi);
            }
            if (vehicleMaintenanceHint.length) {
                if (!hasVehicle) {
                    vehicleMaintenanceHint.text('Select a vehicle to review maintenance reminders.');
                } else if (!vehicleMaintenanceState.has_tasks) {
                    vehicleMaintenanceHint.text('No active maintenance reminders for this vehicle yet.');
                } else {
                    vehicleMaintenanceHint.text('Maintenance reminders ready to view.');
                }
            }
            renderVehicleMaintenance(vehicleMaintenanceState);
        }

        function handleVehicleHistoryError(vehicleId) {
            vehicleHistoryLoading = false;
            if (vehicleHistoryButton.length) {
                vehicleHistoryButton.prop('disabled', false);
            }
            if (vehicleHistoryHint.length) {
                vehicleHistoryHint.text('Unable to load vehicle history. Try again.');
            }
            showVehicleHistoryStatus('Unable to load vehicle history right now. Please try again.', 'danger');
            if (vehicleHistorySections.length) {
                vehicleHistorySections.hide();
            }
            vehicleHistoryState = normalizeHistory({
                vehicle: vehicleId ? { id: vehicleId, label: getSelectedVehicleLabelById(vehicleId) } : null,
                jobs: [],
                parts: [],
                has_history: false,
            });
        }

        function handleVehicleMaintenanceError(vehicleId) {
            vehicleMaintenanceLoading = false;
            if (vehicleMaintenanceButton.length) {
                vehicleMaintenanceButton.prop('disabled', false);
            }
            if (vehicleMaintenanceHint.length) {
                vehicleMaintenanceHint.text('Unable to load maintenance reminders. Try again.');
            }
            showVehicleMaintenanceStatus('Unable to load maintenance reminders right now. Please try again.', 'danger');
            if (vehicleMaintenanceSections.length) {
                vehicleMaintenanceSections.hide();
            }
            vehicleMaintenanceState = normalizeMaintenance({
                vehicle: vehicleId ? { id: vehicleId, label: getSelectedVehicleLabelById(vehicleId) } : null,
                tasks: [],
                has_tasks: false,
            });
        }

        function fetchVehicleHistory(vehicleId) {
            if (!vehicleHistoryApi || !vehicleId) {
                assignVehicleHistory({});
                return;
            }
            vehicleHistoryLoading = true;
            if (vehicleHistoryButton.length) {
                vehicleHistoryButton.prop('disabled', true);
            }
            if (vehicleHistoryHint.length) {
                vehicleHistoryHint.text('Loading vehicle history');
            }
            showVehicleHistoryStatus('Loading vehicle history', 'info');
            if (vehicleHistorySections.length) {
                vehicleHistorySections.hide();
            }
            fetch(`${vehicleHistoryApi}?vehicle_id=${encodeURIComponent(vehicleId)}`)
                .then(response => response.json().then(json => ({ status: response.status, json })).catch(() => ({ status: response.status, json: null })))
                .then(({ status, json }) => {
                    if (status >= 200 && status < 300 && json) {
                        assignVehicleHistory(json);
                    } else {
                        handleVehicleHistoryError(String(vehicleId));
                    }
                })
                .catch(() => handleVehicleHistoryError(String(vehicleId)))
                .finally(() => {
                    vehicleHistoryLoading = false;
                    const hasVehicle = Boolean(vehicleHistoryState.vehicle && vehicleHistoryState.vehicle.id);
                    if (vehicleHistoryButton.length) {
                        vehicleHistoryButton.prop('disabled', !hasVehicle || !vehicleHistoryApi);
                    }
                });
        }

        function fetchVehicleMaintenance(vehicleId) {
            if (!vehicleMaintenanceApi || !vehicleId) {
                assignVehicleMaintenance({});
                return;
            }
            vehicleMaintenanceLoading = true;
            if (vehicleMaintenanceButton.length) {
                vehicleMaintenanceButton.prop('disabled', true);
            }
            if (vehicleMaintenanceHint.length) {
                vehicleMaintenanceHint.text('Loading maintenance reminders');
            }
            showVehicleMaintenanceStatus('Loading maintenance reminders', 'info');
            if (vehicleMaintenanceSections.length) {
                vehicleMaintenanceSections.hide();
            }
            fetch(`${vehicleMaintenanceApi}?vehicle_id=${encodeURIComponent(vehicleId)}`)
                .then(response => response.json().then(json => ({ status: response.status, json })).catch(() => ({ status: response.status, json: null })))
                .then(({ status, json }) => {
                    if (status >= 200 && status < 300 && json) {
                        assignVehicleMaintenance(json);
                    } else {
                        handleVehicleMaintenanceError(String(vehicleId));
                    }
                })
                .catch(() => handleVehicleMaintenanceError(String(vehicleId)))
                .finally(() => {
                    vehicleMaintenanceLoading = false;
                    const hasVehicle = Boolean(vehicleMaintenanceState.vehicle && vehicleMaintenanceState.vehicle.id);
                    if (vehicleMaintenanceButton.length) {
                        vehicleMaintenanceButton.prop('disabled', !hasVehicle || !vehicleMaintenanceApi);
                    }
                });
        }

        function handleVehicleHistoryChange(rawId) {
            const vehicleId = rawId ? String(rawId) : '';
            if (!vehicleId) {
                assignVehicleHistory({});
                return;
            }
            if (!initialVehicleHistoryConsumed) {
                const initialId = initialVehicleHistory && initialVehicleHistory.vehicle ? String(initialVehicleHistory.vehicle.id || '') : '';
                if (initialId && initialId === vehicleId) {
                    initialVehicleHistoryConsumed = true;
                    assignVehicleHistory(initialVehicleHistory);
                    return;
                }
            }
            initialVehicleHistoryConsumed = true;
            fetchVehicleHistory(vehicleId);
        }

        function handleVehicleMaintenanceChange(rawId) {
            const vehicleId = rawId ? String(rawId) : '';
            if (!vehicleId) {
                assignVehicleMaintenance({});
                return;
            }
            if (!initialVehicleMaintenanceConsumed) {
                const initialId = initialVehicleMaintenance && initialVehicleMaintenance.vehicle ? String(initialVehicleMaintenance.vehicle.id || '') : '';
                if (initialId && initialId === vehicleId) {
                    initialVehicleMaintenanceConsumed = true;
                    assignVehicleMaintenance(initialVehicleMaintenance);
                    return;
                }
            }
            initialVehicleMaintenanceConsumed = true;
            fetchVehicleMaintenance(vehicleId);
        }

        if (vehicleHistoryModal.length) {
            vehicleHistoryModal.on('show.bs.modal', function () {
                renderVehicleHistory(vehicleHistoryState);
            });
        }

        if (vehicleMaintenanceModal.length) {
            vehicleMaintenanceModal.on('show.bs.modal', function () {
                renderVehicleMaintenance(vehicleMaintenanceState);
            });
        }

        assignVehicleHistory(initialVehicleHistory);
        assignVehicleMaintenance(initialVehicleMaintenance);

        customerData = {
        {% for c in customers %}
        '{{ c.id }}': {
            name: '{{ c.name|escapejs }}',
                email: '{{ c.email|default_if_none:""|escapejs }}',
                    address: '{{ c.address|default_if_none:""|escapejs }}',
                        rate: '{{ c.charge_rate|default:""|floatformat:2 }}'
        },
        {% endfor %}
    };

    $('#addCustomerModal').on('show.bs.modal', function () {
        if (addCustomerFormElement) {
            addCustomerFormElement.reset();
            setupCustomerPortalFields(addCustomerFormElement);
            const toggle = addCustomerFormElement.querySelector('#id_register_portal');
            if (toggle) {
                toggle.checked = false;
                toggle.dispatchEvent(new Event('change'));
            }
        }
        applyCustomerModalPrefill(this);
        $('#customer-form-errors').empty().removeClass('p-3 bg-red-100 border border-red-300 rounded-md');
    });
    if (addCustomerModalElement) {
        addCustomerModalElement.addEventListener('hidden.bs.modal', function () {
            flushPendingVehicleModal();
        });
    }

    $('#addCustomerModal .modal-body p > input[type="text"], #addCustomerModal .modal-body p > input[type="email"], #addCustomerModal .modal-body p > input[type="number"], #addCustomerModal .modal-body p > textarea, #addCustomerModal .modal-body p > select').addClass('form-control');
    $('#addVehicleModal .modal-body p > input[type="text"], #addVehicleModal .modal-body p > input[type="number"], #addVehicleModal .modal-body p > textarea, #addVehicleModal .modal-body p > select').addClass('form-control');

    function handleDailyLogCustomerSuccess(customer, formElement, errorElement) {
        if (!customer || typeof customer.id === 'undefined' || customer.id === null) {
            return;
        }
        try {
            closeCustomerModal();
            const customerId = String(customer.id);
            customerData[customerId] = {
                name: customer.name || '',
                email: customer.email || '',
                address: customer.address || '',
                rate: customer.charge_rate ? parseFloat(customer.charge_rate).toFixed(2) : ''
            };

            const displayName = customer.name || customer.email || 'Customer';
            const newOption = new Option(displayName, customerId, true, true);
            const dropdownTarget = (customerSelect && customerSelect.length && typeof customerSelect.append === 'function')
                ? customerSelect
                : (customerElement && customerElement.length ? customerElement : null);

            if (dropdownTarget && typeof dropdownTarget.append === 'function') {
                dropdownTarget.append(newOption);
                if (typeof dropdownTarget.trigger === 'function') {
                    dropdownTarget.trigger('change');
                }
            }

            if (formElement) {
                formElement.reset();
                setupCustomerPortalFields(formElement);
                const toggle = formElement.querySelector('#id_register_portal');
                if (toggle) {
                    toggle.checked = false;
                    toggle.dispatchEvent(new Event('change'));
                }
            }

            if (errorElement) {
                errorElement.empty().removeClass('p-3 bg-red-100 border border-red-300 rounded-md');
            }
        } catch (uiError) {
            console.error('Error updating UI after saving customer:', uiError);
        }
    }

    initializeAdjustmentRowsFromExistingEntries();

    $('#jobs .job-entry-row:not(.special-entry) input[name$="-rate"]:not([readonly])').attr('data-auto-rate', '1');

    // --- Function to copy vehicle details to form fields (MODIFIED) ---
    function copyVehicleFields() {
        const selectedOption = vehicleSelect.find('option:selected');
        const hasSelection = selectedOption && selectedOption.length > 0 && selectedOption.val() !== "";
        // Check if the form fields for VIN, Unit No, Make/Model exist in the current form
        const hasVinField = $('#id_vin_no').length > 0;
        const hasUnitNoField = $('#id_unit_no').length > 0;
        const hasMakeModelField = $('#id_make_model').length > 0;
        const hasLicenseField = $('#id_license_plate').length > 0;

        if (hasSelection) {
            if (preserveVehicleFieldsOnLoad && isVehicleLoading) {
                return;
            }
            preserveVehicleFieldsOnLoad = false;
            const unit = selectedOption.data('unit');
            const vin = selectedOption.data('vin');
            const make = selectedOption.data('make');
            const license = selectedOption.data('license');

            if (hasVinField) { $('#id_vin_no').val(vin !== undefined && vin !== null ? vin : ''); }
            if (hasUnitNoField) { $('#id_unit_no').val(unit !== undefined && unit !== null ? unit : ''); }
            if (hasMakeModelField) { $('#id_make_model').val(make !== undefined && make !== null ? make : ''); }
            if (hasLicenseField) { $('#id_license_plate').val(license !== undefined && license !== null ? license : ''); }
            // Mileage is typically specific to the invoice and should not be overwritten here
            // unless it's a specific feature that mileage is also sourced from the vehicle.
        } else {
            if (preserveVehicleFieldsOnLoad && isVehicleLoading) {
                return;
            }
            // Clear fields only if they exist in the current form
            if (hasVinField) { $('#id_vin_no').val(''); }
            if (hasUnitNoField) { $('#id_unit_no').val(''); }
            if (hasMakeModelField) { $('#id_make_model').val(''); }
            if (hasLicenseField) { $('#id_license_plate').val(''); }
        }
    }
    vehicleSelect.on('change select2:select', function () {
        copyVehicleFields();
        handleVehicleHistoryChange($(this).val());
        handleVehicleMaintenanceChange($(this).val());
        closeSelect2Dropdown(vehicleElement);
        closeAllSelect2Dropdowns();
    });


    // --- Function to load vehicles for a selected customer (MODIFIED) ---
    function loadVehicles(customerId, vehicleToSelectId, options) {
        const opts = options || {};
        const autoPromptEmpty = Boolean(opts.autoPromptEmpty);
        const addVehicleButton = $('#btnOpenAddVehicleModal');
        if (!customerId) {
            vehicleSelect.html('<option value=""> Select vehicle </option>').prop('disabled', true).val(null).trigger('change');
            addVehicleButton.prop('disabled', true);
            handleVehicleHistoryChange('');
            handleVehicleMaintenanceChange('');
            return;
        }
        isVehicleLoading = true;
        vehicleSelect.prop('disabled', true).html('<option value="">Loading</option>').trigger('change');
        addVehicleButton.prop('disabled', true); // Disable while loading

        fetch(`/api/customer/${customerId}/vehicles/`)
            .then(response => {
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                return response.json();
            })
            .then(data => {
                let optionsHtml = '<option value=""> Select vehicle </option>';
                let vehicleCount = 0;
                if (data && data.vehicles && Array.isArray(data.vehicles)) {
                    vehicleCount = data.vehicles.length;
                    optionsHtml += data.vehicles.map(v => {
                        const unitNo = v.unit_no || '';
                        const vinNo = v.vin_no || '';
                        const makeModel = v.make_model || '';
                        const licensePlate = v.license_plate || '';
                        let displayText = unitNo ? `Unit: ${unitNo}` : (makeModel || (vinNo ? `VIN: ${vinNo}` : `Vehicle ID ${v.id}`));
                        if (makeModel && unitNo) displayText = `Unit: ${unitNo} (${makeModel})`;
                        return `<option value="${v.id}" data-unit="${unitNo}" data-vin="${vinNo}" data-make="${makeModel}" data-license="${licensePlate}">${displayText}</option>`;
                    }).join('');
                } else {
                    console.error("loadVehicles - Invalid data structure from API:", data);
                }
                const hasVehicles = vehicleCount > 0;
                vehicleSelect.html(optionsHtml).prop('disabled', false).toggleClass('vehicle-empty', !hasVehicles);

                // Always enable "Add New Vehicle" button for a selected customer
                addVehicleButton.prop('disabled', false);

                if (vehicleCount === 0 && autoPromptEmpty && promptedVehicleCustomerId !== String(customerId)) {
                    promptedVehicleCustomerId = String(customerId);
                    queueAddVehicleModal(customerId);
                }

                if (vehicleToSelectId) {
                    vehicleSelect.val(vehicleToSelectId.toString()).trigger('change'); // This will also trigger copyVehicleFields
                } else if (vehicleCount === 1 && data.vehicles[0].id) {
                    vehicleSelect.val(data.vehicles[0].id.toString()).trigger('change');
                } else {
                    vehicleSelect.val(null).trigger('change'); // No specific vehicle, ensure 'change' triggers to clear fields
                }
            })
            .catch((error) => {
                console.error("loadVehicles - Error fetching vehicles:", error);
                vehicleSelect.html('<option value="">Error loading vehicles</option>').prop('disabled', true).val(null).trigger('change');
                addVehicleButton.prop('disabled', false); // Re-enable button even on error, user might want to add new
            })
            .finally(() => {
                isVehicleLoading = false;
                preserveVehicleFieldsOnLoad = false;
            });
    }

    // --- Event listener for customer selection change (MODIFIED) ---
    customerSelect.on('change', function () {
        const customerId = $(this).val();
        const customer = customerData[customerId];
        const addVehicleButton = $('#btnOpenAddVehicleModal');

        if (customer && customerId) {
            $('#id_bill_to').val(customer.name);
            $('#id_bill_to_email').val(customer.email);
            $('#id_bill_to_address').val(customer.address);
            selectedRate = customer.rate;

            if (selectedRate) {
                $('#jobs .job-entry-row:not(.special-entry) input[name$="-rate"][data-auto-rate="1"]:not([readonly])').each(function () {
                    $(this).val(selectedRate);
                    updateRowAmount($(this).closest('.grid'));
                });
            }
            // When customer changes, load their vehicles. Don't pre-select a specific one unless it's the initial load.
            loadVehicles(customerId, null, { autoPromptEmpty: true });
            addVehicleButton.prop('disabled', false); // Enable add vehicle button
        } else {
            addVehicleButton.prop('disabled', true);
            $('#id_bill_to, #id_bill_to_email, #id_bill_to_address').val('');
            selectedRate = '';
            vehicleSelect.html('<option value=""> Select vehicle </option>').prop('disabled', true).val(null).trigger('change');
            // copyVehicleFields will be triggered by vehicleSelect's change event to clear fields.
        }
        calculateTotal();
        closeSelect2Dropdown(customerElement);
        closeAllSelect2Dropdowns();
    });

    // --- Function to add a new standard job/income record form ---
    function addJobForm(options) {
        options = options || {};
        const totalFormsElement = $('#id_income_records-TOTAL_FORMS');
        if (!totalFormsElement.length) {
            console.error("Management form TOTAL_FORMS not found!");
            alert("Error: Cannot add new item. Form configuration missing.");
            return;
        }
        const newIndex = parseInt(totalFormsElement.val(), 10);
        const prefix = "{{ formset.prefix }}"; // Corrected to use formset.prefix
        const formHtml = `
            <div class="grid job-entry-row qb-line-row">
                <input type="hidden" name="${prefix}-${newIndex}-id" id="id_${prefix}-${newIndex}-id">
                <input type="hidden" name="${prefix}-${newIndex}-product" id="id_${prefix}-${newIndex}-product">
                <input type="hidden" name="${prefix}-${newIndex}-line_order" id="id_${prefix}-${newIndex}-line_order" value="${newIndex + 1}">
                <div class="qb-cell qb-drag-cell">
                  <button type="button" class="qb-drag-handle" aria-label="Reorder line">
                    <svg width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                      <circle cx="5" cy="4" r="1.2"></circle>
                      <circle cx="11" cy="4" r="1.2"></circle>
                      <circle cx="5" cy="8" r="1.2"></circle>
                      <circle cx="11" cy="8" r="1.2"></circle>
                      <circle cx="5" cy="12" r="1.2"></circle>
                      <circle cx="11" cy="12" r="1.2"></circle>
                    </svg>
                  </button>
                </div>
                <div class="qb-cell qb-row-number">1</div>
                <div class="qb-cell qb-item-cell">
                  <span class="qb-mobile-label">Product/Service</span>
                  <select class="form-control qb-item-select" data-row-prefix="${prefix}-${newIndex}"></select>
                </div>
                <div class="qb-cell qb-desc-cell">
                  <span class="qb-mobile-label">Description</span>
                  <textarea name="${prefix}-${newIndex}-job" placeholder="Description" class="form-control qb-desc-input" id="id_${prefix}-${newIndex}-job" rows="1"></textarea>
                </div>
                <div class="qb-cell qb-qty-cell">
                  <span class="qb-mobile-label">Qty</span>
                  <input type="number" name="${prefix}-${newIndex}-qty" placeholder="0" class="form-control qb-qty-input" id="id_${prefix}-${newIndex}-qty" oninput="handleRateEdit(this);" step="any">
                </div>
                <div class="qb-cell qb-rate-cell">
                  <span class="qb-mobile-label">Rate</span>
                  <input type="number" name="${prefix}-${newIndex}-rate" placeholder="0.00" class="form-control qb-rate-input" data-auto-rate="1" id="id_${prefix}-${newIndex}-rate" oninput="handleRateEdit(this);" step="0.01">
                </div>
                <div class="qb-cell qb-amount-cell">
                  <span class="qb-mobile-label">Amount</span>
                  <input type="text" name="${prefix}-${newIndex}-amount" class="form-control entry-amount" id="id_${prefix}-${newIndex}-amount" value="0.00" readonly>
                </div>
                <div class="qb-cell qb-remove-cell">
                  <button type="button" class="qb-remove-row" aria-label="Remove line">
                    <i class="fas fa-trash"></i>
                  </button>
                  <input type="checkbox" name="${prefix}-${newIndex}-DELETE" class="hidden-delete-checkbox" id="id_${prefix}-${newIndex}-DELETE" onchange="calculateTotal();">
                </div>
                <input type="hidden" name="${prefix}-${newIndex}-service_id" id="id_${prefix}-${newIndex}-service_id">
                <input type="hidden" name="${prefix}-${newIndex}-service_due_months" id="id_${prefix}-${newIndex}-service_due_months">
                <input type="hidden" name="${prefix}-${newIndex}-service_due_kilometers" id="id_${prefix}-${newIndex}-service_due_kilometers">
                <input type="hidden" name="${prefix}-${newIndex}-skip_maintenance" id="id_${prefix}-${newIndex}-skip_maintenance">
            </div>`;
        $('#jobs').append(formHtml);
        const row = $('#jobs .job-entry-row').last();
        initializeLineItemSelect(row.find('.qb-item-select'));
        applyLineItemOptions(row, options);
        if (selectedRate) {
            const newRateField = row.find('input[name$="-rate"]');
            newRateField.val(selectedRate);
            updateRowAmount(row);
        }
        totalFormsElement.val(newIndex + 1);
        updateLineRowNumbers();
        calculateTotal();
        toggleNoJobsMessage();
        return row;
    }

    function toggleNoJobsMessage() {
        if (!noJobsMessage || !noJobsMessage.length) {
            return;
        }
        const hasJobRows = $('#jobs .job-entry-row').not('.special-entry').filter(function () {
            const row = $(this);
            const deleteCheckbox = row.find('input[name$="-DELETE"]');
            return !(deleteCheckbox.length && deleteCheckbox.is(':checked'));
        }).length > 0;
        noJobsMessage.toggle(!hasJobRows);
    }

    function transformExistingJobInputsToTextareas(scope) {
        const $scope = scope ? $(scope) : $(document);
        $scope.find('#jobs input[name$="-job"]').each(function () {
            const $input = $(this);
            if ($input.prop('readonly')) {
                return;
            }

            const $textarea = $('<textarea></textarea>');
            $.each(this.attributes, function () {
                if (!this || !this.specified) {
                    return;
                }
                if (this.name === 'type' || this.name === 'value') {
                    return;
                }
                $textarea.attr(this.name, this.value);
            });

            if (!$textarea.attr('rows')) {
                $textarea.attr('rows', 3);
            }

            if (!$textarea.hasClass('form-control')) {
                $textarea.addClass('form-control');
            }

            $textarea.val($input.val());
            $input.replaceWith($textarea);
        });
    }

    transformExistingJobInputsToTextareas(document);

    const jobCatalogDataElement = document.getElementById('job-catalog-data');
    let jobCatalog = [];
    if (jobCatalogDataElement) {
        try {
            const parsed = JSON.parse(jobCatalogDataElement.textContent || '[]');
            if (Array.isArray(parsed)) {
                jobCatalog = parsed;
            }
        } catch (error) {
            console.error('Unable to parse saved job catalog data:', error);
        }
    }

    const QUICK_ADD_LABOUR_VALUE = '__quick_labour__';
    const QUICK_ADD_PRODUCT_VALUE = '__quick_product__';
    let lineItemOptionsHtml = '';

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function buildLineItemOptions() {
        const inventoryOptions = [];
        const nonInventoryOptions = [];
        const serviceOptions = [];

        Object.entries(productSalePrices || {}).forEach(function ([id, raw]) {
            const info = normalizeProductInfo(raw);
            const itemType = raw && raw.item_type ? String(raw.item_type) : 'inventory';
            const name = info.name || '';
            const sku = info.sku || '';
            const description = info.description || '';
            const price = info.price || '0.00';
            if (!name) {
                return;
            }
            const displayName = sku ? `${name} (${sku})` : name;
            const option = `<option value="product:${escapeHtml(id)}" data-kind="product" data-product-id="${escapeHtml(id)}" data-item-type="${escapeHtml(itemType)}" data-price="${escapeHtml(price)}" data-name="${escapeHtml(name)}" data-sku="${escapeHtml(sku)}" data-description="${escapeHtml(description)}">${escapeHtml(displayName)}</option>`;
            if (itemType === 'non_inventory') {
                nonInventoryOptions.push(option);
            } else {
                inventoryOptions.push(option);
            }
        });

        if (Array.isArray(jobCatalog)) {
            jobCatalog.forEach(function (job) {
                if (!job || !Array.isArray(job.descriptions)) {
                    return;
                }
                job.descriptions.forEach(function (desc) {
                    if (!desc || !desc.text) {
                        return;
                    }
                    serviceOptions.push(
                        `<option value="service:${escapeHtml(desc.id || desc.text)}" data-kind="service" data-service-id="${escapeHtml(desc.id || '')}" data-fixed-hours="${escapeHtml(desc.fixed_hours || '')}" data-fixed-rate="${escapeHtml(desc.fixed_rate || '')}" data-due-months="${escapeHtml(desc.due_after_months || '')}" data-due-kilometers="${escapeHtml(desc.due_after_kilometers || '')}" data-notes="${escapeHtml(desc.notes || '')}" data-job-name="${escapeHtml(job.name || '')}">${escapeHtml(desc.text)}</option>`
                    );
                });
            });
        }

        const options = [];
        options.push('<option value="">Select a product/service</option>');
        options.push('<option value="__add__">+ Add new</option>');
        options.push('<optgroup label="Quick add">');
        options.push(`<option value="${QUICK_ADD_LABOUR_VALUE}" data-kind="quick" data-quick-type="labour">Labour</option>`);
        options.push(`<option value="${QUICK_ADD_PRODUCT_VALUE}" data-kind="quick" data-quick-type="product">Product</option>`);
        options.push('</optgroup>');

        if (inventoryOptions.length) {
            options.push('<optgroup label="Inventory">');
            options.push(...inventoryOptions.sort());
            options.push('</optgroup>');
        }
        if (nonInventoryOptions.length) {
            options.push('<optgroup label="Non-inventory">');
            options.push(...nonInventoryOptions.sort());
            options.push('</optgroup>');
        }
        if (serviceOptions.length) {
            options.push('<optgroup label="Services">');
            options.push(...serviceOptions.sort());
            options.push('</optgroup>');
        }

        return options.join('');
    }

    function optionMatchesLineItemTerm(optionElement, term) {
        if (!optionElement || !term) {
            return false;
        }
        const value = optionElement.value;
        if (!value || value === '__add__' || value === QUICK_ADD_LABOUR_VALUE || value === QUICK_ADD_PRODUCT_VALUE) {
            return false;
        }
        const $option = $(optionElement);
        const optionText = (optionElement.text || '').toString().toLowerCase();
        const name = ($option.data('name') || '').toString().toLowerCase();
        const sku = ($option.data('sku') || '').toString().toLowerCase();
        const description = ($option.data('description') || $option.data('notes') || '').toString().toLowerCase();
        const jobName = ($option.data('jobName') || '').toString().toLowerCase();
        return (
            optionText.indexOf(term) > -1 ||
            name.indexOf(term) > -1 ||
            sku.indexOf(term) > -1 ||
            description.indexOf(term) > -1 ||
            jobName.indexOf(term) > -1
        );
    }

    function hasLineItemMatch(term, selectElement) {
        if (!term || !selectElement) {
            return false;
        }
        let found = false;
        $(selectElement).find('option').each(function () {
            if (optionMatchesLineItemTerm(this, term)) {
                found = true;
                return false;
            }
            return true;
        });
        return found;
    }

    function getLineItemSearchTerm($select) {
        if (!$select || !$select.length) {
            return '';
        }
        const select2 = $select.data('select2');
        if (select2 && select2.$dropdown) {
            const searchField = select2.$dropdown.find('.select2-search__field');
            if (searchField.length) {
                const value = (searchField.val() || '').toString().trim();
                if (value) {
                    return value;
                }
            }
        }
        return ($select.data('lastSearchTerm') || '').toString().trim();
    }

    function lineItemSelectMatcher(params, data) {
        const rawTerm = (params.term || '').trim();
        const term = rawTerm.toLowerCase();
        const $select = data.element ? $(data.element).closest('select') : null;
        if ($select && $select.length) {
            $select.data('lastSearchTerm', rawTerm);
        }

        const elementValue = data.element ? data.element.value : data.id;
        if (elementValue === '__add__' || elementValue === QUICK_ADD_LABOUR_VALUE || elementValue === QUICK_ADD_PRODUCT_VALUE) {
            if (!rawTerm) {
                return null;
            }
            const hasMatch = $select && $select.length ? hasLineItemMatch(term, $select[0]) : false;
            return hasMatch ? null : data;
        }

        if (data.children && data.children.length) {
            const filteredChildren = [];
            data.children.forEach(function (child) {
                const match = lineItemSelectMatcher(params, child);
                if (match) {
                    filteredChildren.push(match);
                }
            });
            if (filteredChildren.length) {
                const cloned = $.extend(true, {}, data);
                cloned.children = filteredChildren;
                return cloned;
            }
            return null;
        }

        if (!term) {
            return data;
        }

        if (data.element && optionMatchesLineItemTerm(data.element, term)) {
            return data;
        }
        return null;
    }

    function formatLineItemOption(data) {
        if (!data.id) {
            return data.text;
        }
        if (data.children && data.children.length) {
            return data.text;
        }
        const element = data.element;
        if (!element) {
            return data.text;
        }
        const value = element.value;
        if (value === '__add__' || value === QUICK_ADD_LABOUR_VALUE || value === QUICK_ADD_PRODUCT_VALUE) {
            return data.text;
        }

        const $element = $(element);
        const kind = $element.data('kind');
        const title = kind === 'product' ? ($element.data('name') || data.text || '') : (data.text || '');
        let description = '';
        if (kind === 'product') {
            description = $element.data('description') || '';
            if (!description) {
                const sku = $element.data('sku') || '';
                if (sku) {
                    description = `SKU: ${sku}`;
                }
            }
        } else if (kind === 'service') {
            description = $element.data('notes') || '';
            if (!description) {
                description = $element.data('jobName') || '';
            }
        }

        const container = $('<div class="qb-select2-option"></div>');
        container.append($('<div class="qb-select2-title"></div>').text(title));
        if (description) {
            container.append($('<div class="qb-select2-desc"></div>').text(description));
        }
        return container;
    }

    function formatLineItemSelection(data) {
        if (!data.id) {
            return data.text;
        }
        const element = data.element;
        if (!element) {
            return data.text;
        }
        const value = element.value;
        if (value === '__add__' || value === QUICK_ADD_LABOUR_VALUE || value === QUICK_ADD_PRODUCT_VALUE) {
            return data.text;
        }
        return data.text || '';
    }

    function initializeLineItemSelect($select) {
        if (!$select || !$select.length) {
            return;
        }
        const currentValue = $select.val() || '';
        $select.html(lineItemOptionsHtml);
        if ($.fn.select2) {
            if ($select.data('select2')) {
                $select.select2('destroy');
            }
            $select.select2({
                theme: 'bootstrap4',
                width: '100%',
                dropdownAutoWidth: false,
                closeOnSelect: true,
                matcher: lineItemSelectMatcher,
                templateResult: formatLineItemOption,
                templateSelection: formatLineItemSelection,
            });
            $select.off('select2:select.closeItemSelect').on('select2:select.closeItemSelect', function () {
                const $current = $(this);
                setTimeout(function () {
                    closeSelect2Dropdown($current);
                }, 0);
            });
        }
        if (currentValue) {
            $select.val(currentValue).trigger('change.select2');
        }
    }

    function refreshLineItemSelectOptions() {
        lineItemOptionsHtml = buildLineItemOptions();
        $('.qb-item-select').each(function () {
            initializeLineItemSelect($(this));
            syncLineItemSelect($(this).closest('.job-entry-row'));
        });
    }

    function syncLineItemSelect(row) {
        if (!row || !row.length) {
            return;
        }
        const productId = row.find('input[name$="-product"]').val();
        const serviceId = row.find('input[name$="-service_id"]').val();
        const select = row.find('.qb-item-select');
        if (!select.length) {
            return;
        }
        let targetValue = '';
        if (productId) {
            targetValue = `product:${productId}`;
        } else if (serviceId) {
            targetValue = `service:${serviceId}`;
        }
        if (targetValue) {
            select.val(targetValue).trigger('change.select2');
        }
        if (productId || serviceId) {
            ensureDefaultQty(row);
        }
    }

    function setRowDescription(row, value) {
        const descInput = row.find('textarea[name$="-job"]');
        if (!descInput.length) {
            return;
        }
        descInput.val(value || '');
    }

    function setRowQty(row, value) {
        const qtyInput = row.find('input[name$="-qty"]');
        if (!qtyInput.length) {
            return;
        }
        qtyInput.val(value || '');
    }

    function setRowRate(row, value) {
        const rateInput = row.find('input[name$="-rate"]');
        if (!rateInput.length) {
            return;
        }
        rateInput.val(value || '');
    }

    function ensureDefaultQty(row) {
        const qtyInput = row.find('input[name$="-qty"]');
        if (!qtyInput.length) {
            return;
        }
        const rawValue = (qtyInput.val() || '').toString().trim();
        const numericValue = Number(rawValue);
        if (!rawValue || !isFinite(numericValue) || numericValue <= 0) {
            qtyInput.val('1');
        }
    }

    function applyProductSelection(row, option) {
        const productId = option.data('productId') || '';
        const price = option.data('price');
        const name = option.data('name') || option.text() || '';
        row.find('input[name$="-product"]').val(productId);
        row.find('input[name$="-service_id"]').val('');
        row.find('input[name$="-service_due_months"]').val('');
        row.find('input[name$="-service_due_kilometers"]').val('');
        row.find('input[name$="-skip_maintenance"]').val('');
        setRowDescription(row, name);

        ensureDefaultQty(row);

        const rateInput = row.find('input[name$="-rate"]');
        if (rateInput.length && rateInput.attr('data-auto-rate') !== undefined) {
            if (price !== undefined && price !== null && price !== '') {
                rateInput.val(price);
            }
        }
        updateRowAmount(row);
        calculateTotal();
    }

    function applyServiceSelection(row, option) {
        const serviceId = option.data('serviceId') || '';
        const fixedHours = option.data('fixedHours');
        const fixedRate = option.data('fixedRate');
        const dueMonths = option.data('dueMonths');
        const dueKilometers = option.data('dueKilometers');
        const description = option.text() || '';

        row.find('input[name$="-product"]').val('');
        row.find('input[name$="-service_id"]').val(serviceId);
        row.find('input[name$="-service_due_months"]').val(dueMonths || '');
        row.find('input[name$="-service_due_kilometers"]').val(dueKilometers || '');
        row.find('input[name$="-skip_maintenance"]').val(!dueMonths && !dueKilometers ? '1' : '');
        setRowDescription(row, description);

        const qtyInput = row.find('input[name$="-qty"]');
        if (fixedHours !== undefined && fixedHours !== null && String(fixedHours) !== '') {
            qtyInput.val(fixedHours);
        } else if (fixedRate !== undefined && fixedRate !== null && String(fixedRate) !== '' && !qtyInput.val()) {
            qtyInput.val('1');
        }
        ensureDefaultQty(row);

        const rateInput = row.find('input[name$="-rate"]');
        if (rateInput.length && rateInput.attr('data-auto-rate') !== undefined) {
            if (fixedRate !== undefined && fixedRate !== null && String(fixedRate) !== '') {
                rateInput.val(fixedRate);
            }
        }
        updateRowAmount(row);
        calculateTotal();
    }

    function applyLineItemOptions(row, options) {
        if (!row || !row.length || !options) {
            return;
        }
        if (options.jobDescription) {
            setRowDescription(row, options.jobDescription);
        }
        if (options.qty !== undefined && options.qty !== null && options.qty !== '') {
            setRowQty(row, options.qty);
        }
        if (options.rate !== undefined && options.rate !== null && options.rate !== '') {
            setRowRate(row, options.rate);
        }
        const hasFixedHours = options.fixedHours !== undefined && options.fixedHours !== null && options.fixedHours !== '';
        const hasFixedRate = options.fixedRate !== undefined && options.fixedRate !== null && options.fixedRate !== '';
        if (hasFixedHours) {
            setRowQty(row, options.fixedHours);
        } else if (hasFixedRate) {
            setRowQty(row, '1');
        }
        if (hasFixedRate) {
            setRowRate(row, options.fixedRate);
        }
        if (options.productId !== undefined) {
            row.find('input[name$="-product"]').val(options.productId || '');
        }
        if (options.serviceId !== undefined) {
            row.find('input[name$="-service_id"]').val(options.serviceId || '');
        }
        if (options.dueAfterMonths !== undefined) {
            row.find('input[name$="-service_due_months"]').val(options.dueAfterMonths || '');
        }
        if (options.dueAfterKilometers !== undefined) {
            row.find('input[name$="-service_due_kilometers"]').val(options.dueAfterKilometers || '');
        }
        if (options.serviceSkipMaintenance !== undefined) {
            row.find('input[name$="-skip_maintenance"]').val(options.serviceSkipMaintenance ? '1' : '');
        }
        const select = row.find('.qb-item-select');
        if (select.length) {
            if ((options.itemKind === 'product' || options.productId) && options.productId) {
                select.val(`product:${options.productId}`).trigger('change.select2');
            }
            if ((options.itemKind === 'service' || options.serviceId) && options.serviceId) {
                select.val(`service:${options.serviceId}`).trigger('change.select2');
            }
        }
        const hasPrefill = (
            options.productId ||
            options.serviceId ||
            options.itemKind === 'product' ||
            options.itemKind === 'service' ||
            (options.qty !== undefined && options.qty !== null && options.qty !== '') ||
            (options.rate !== undefined && options.rate !== null && options.rate !== '') ||
            (options.fixedHours !== undefined && options.fixedHours !== null && options.fixedHours !== '') ||
            (options.fixedRate !== undefined && options.fixedRate !== null && options.fixedRate !== '')
        );
        if (hasPrefill) {
            ensureDefaultQty(row);
        }
    }

    function updateLineOrderInputs() {
        let counter = 1;
        $('#jobs').children().each(function () {
            const row = $(this);
            const orderInput = row.find('input[name$="-line_order"]');
            if (!orderInput.length) {
                return;
            }
            const isDeleted = row.find('input[name$="-DELETE"]').is(':checked');
            if (!isDeleted) {
                orderInput.val(counter);
                counter += 1;
            }
        });
    }

    function updateLineRowNumbers() {
        let counter = 1;
        $('#jobs .job-entry-row').not('.special-entry').each(function () {
            const row = $(this);
            const isDeleted = row.find('input[name$="-DELETE"]').is(':checked');
            if (!isDeleted) {
                row.find('.qb-row-number').text(counter);
                counter += 1;
            }
        });
        updateLineOrderInputs();
    }

    function updateTaxIndicators() {
        const label = currentTaxRate > 0 ? 'Tax' : 'Exempt';
        $('#jobs [data-tax-indicator]').text(label);
    }

    lineItemOptionsHtml = buildLineItemOptions();
    $('.qb-item-select').each(function () {
        initializeLineItemSelect($(this));
        syncLineItemSelect($(this).closest('.job-entry-row'));
    });
    updateLineRowNumbers();
    updateTaxIndicators();

    const jobsContainer = document.getElementById('jobs');
    if (jobsContainer && window.Sortable) {
        new Sortable(jobsContainer, {
            animation: 150,
            handle: '.qb-drag-handle',
            draggable: '.job-entry-row',
            ghostClass: 'qb-drag-ghost',
            chosenClass: 'qb-drag-chosen',
            filter: '.jobs-empty',
            onEnd: function () {
                updateLineRowNumbers();
            }
        });
    }

    let activeLineItemRow = null;

    function focusLineItemSelect(row) {
        if (!row || !row.length) {
            return;
        }
        const select = row.find('.qb-item-select');
        if ($.fn.select2 && select.data('select2')) {
            select.select2('open');
        } else {
            select.trigger('focus');
        }
    }

    function openItemTypeModal(row) {
        activeLineItemRow = row || null;
        showModal('itemTypeModal');
    }

    function removeLineRow(row) {
        if (!row || !row.length) {
            return;
        }
        row.find('input[name$="-DELETE"]').prop('checked', true);
        row.find('input[name$="-product"]').val('');
        row.find('input[name$="-service_id"]').val('');
        row.find('input[name$="-service_due_months"]').val('');
        row.find('input[name$="-service_due_kilometers"]').val('');
        row.find('input[name$="-skip_maintenance"]').val('');
        row.find('textarea[name$="-job"]').val('');
        row.find('input[name$="-qty"]').val('');
        row.find('input[name$="-rate"]').val('');
        row.find('.entry-amount').val('0.00');
        clearQuickAddState(row);
        const select = row.find('.qb-item-select');
        if (select.length) {
            select.val('').trigger('change.select2');
        }
        row.hide();
        updateLineRowNumbers();
        calculateTotal();
        toggleNoJobsMessage();
    }

    function closeSelect2Dropdown($element) {
        if (!$element || !$element.length) {
            return;
        }
        const element = $element[0];
        const jq = window.jQuery || $;
        if (!jq || !jq.fn || !jq.fn.select2) {
            return;
        }
        const $jqElement = jq(element);
        const instance = $jqElement.data('select2');
        if (instance && typeof instance.close === 'function') {
            instance.close();
        } else {
            $jqElement.select2('close');
        }
        setTimeout(function () {
            const activeInstance = $jqElement.data('select2');
            if (activeInstance && activeInstance.$container && activeInstance.$container.hasClass('select2-container--open')) {
                activeInstance.$container.removeClass('select2-container--open');
                if (activeInstance.$dropdown) {
                    activeInstance.$dropdown.hide();
                }
            }
        }, 0);
    }

    function closeAllSelect2Dropdowns() {
        $('.select2-container--open').each(function () {
            const select = $(this).prev('select.select2-hidden-accessible');
            closeSelect2Dropdown(select);
        });
        $('.select2-hidden-accessible').each(function () {
            closeSelect2Dropdown($(this));
        });
    }

    function setQuickAddState(row, type) {
        if (!row || !row.length) {
            return;
        }
        row.data('quickAddType', type);
        row.data('quickAddSaved', false);
    }

    function clearQuickAddState(row) {
        if (!row || !row.length) {
            return;
        }
        row.removeData('quickAddType');
        row.removeData('quickAddSaved');
        row.removeData('quickAddSaving');
        row.removeClass('qb-quick-add-error');
        row.find('.qb-quick-add-invalid').removeClass('qb-quick-add-invalid');
    }

    function getQuickAddType(row) {
        return row && row.length ? (row.data('quickAddType') || '') : '';
    }

    function showQuickAddError(message, focusElement) {
        if (typeof showToast === 'function') {
            showToast(message, 'is-error');
        } else {
            alert(message);
        }
        if (focusElement && focusElement.length) {
            focusElement.trigger('focus');
        }
    }

    async function persistQuickAddRows() {
        let anySaved = false;
        try {
            const rows = $('#jobs .job-entry-row').not('.special-entry').filter(function () {
                return !!$(this).data('quickAddType');
            });
            if (!rows.length) {
                return true;
            }

            const rowElements = rows.toArray();
            for (let i = 0; i < rowElements.length; i += 1) {
                const row = $(rowElements[i]);
                const result = await persistQuickAddRow(row);
                if (!result.success) {
                    if (anySaved) {
                        try {
                            refreshLineItemSelectOptions();
                        } catch (refreshError) {
                            console.error('Line item refresh failed:', refreshError);
                        }
                    }
                    return false;
                }
                if (result.created) {
                    anySaved = true;
                }
            }
        } catch (error) {
            showQuickAddError('We could not save quick add rows. Please try again.');
            console.error('Quick add save failed:', error);
            return false;
        }
        if (anySaved) {
            try {
                refreshLineItemSelectOptions();
            } catch (refreshError) {
                console.error('Line item refresh failed:', refreshError);
            }
        }
        return true;
    }

    async function persistQuickAddRow(row) {
        const quickType = getQuickAddType(row);
        if (!quickType || row.data('quickAddSaved') || row.data('quickAddSaving')) {
            return { success: true, created: false };
        }
        row.removeClass('qb-quick-add-error');
        row.find('.qb-quick-add-invalid').removeClass('qb-quick-add-invalid');

        const descriptionInput = row.find('textarea[name$="-job"]');
        const description = (descriptionInput.val() || '').trim();
        if (!description) {
            row.addClass('qb-quick-add-error');
            descriptionInput.addClass('qb-quick-add-invalid');
            showQuickAddError('Add a description before adding another line.', descriptionInput);
            return { success: false };
        }

        const rateInput = row.find('input[name$="-rate"]');
        const rateRaw = (rateInput.val() || '').trim();
        const rateNumber = Number(rateRaw);
        if (rateRaw === '' || !isFinite(rateNumber) || rateNumber < 0) {
            row.addClass('qb-quick-add-error');
            rateInput.addClass('qb-quick-add-invalid');
            showQuickAddError('Enter a valid rate before adding another line.', rateInput);
            return { success: false };
        }
        const rateString = rateNumber.toFixed(2);
        rateInput.val(rateString);

        ensureDefaultQty(row);
        const qtyInput = row.find('input[name$="-qty"]');
        const qtyRaw = (qtyInput.val() || '').trim();
        const qtyNumber = Number(qtyRaw);
        const qtyString = isFinite(qtyNumber) && qtyNumber > 0 ? qtyRaw : '1';
        qtyInput.val(qtyString);

        row.data('quickAddSaving', true);

        try {
            if (quickType === 'product') {
                const formData = new FormData();
                formData.set('name', description);
                formData.set('description', description);
                formData.set('sale_price', rateString);
                formData.set('cost_price', rateString);
                formData.set('item_type', 'inventory');

                const response = await fetch("{% url 'accounts:quick_create_inventory_product' %}", {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.success) {
                    const errors = data && data.errors ? Object.values(data.errors).flat().join(' ') : '';
                    const message = errors || data.error || 'Could not save product.';
                    throw new Error(message);
                }
                const product = data.product || {};
                const productId = product.id !== undefined && product.id !== null ? String(product.id) : '';
                if (!productId) {
                    throw new Error('Could not save product.');
                }
                productSalePrices[productId] = {
                    name: product.name || description,
                    sku: product.sku || '',
                    description: product.description || description,
                    price: String(product.sale_price || rateString),
                    item_type: product.item_type || 'inventory'
                };
                const displayName = product.display_name
                    || (product.sku ? `${product.name} (${product.sku})` : (product.name || description));
                const sellProductSelect = $('#sell_product');
                if (sellProductSelect.length) {
                    const newOption = new Option(displayName, productId, false, false);
                    sellProductSelect.append(newOption);
                }
                row.find('input[name$="-product"]').val(productId);
                row.find('input[name$="-service_id"]').val('');
                row.find('input[name$="-service_due_months"]').val('');
                row.find('input[name$="-service_due_kilometers"]').val('');
                row.find('input[name$="-skip_maintenance"]').val('');
            } else {
                if (!createServiceUrl) {
                    throw new Error('We could not save that labour entry.');
                }
                const labourJob = findJobInCatalog('', 'Labour') || findJobInCatalog('', 'Labor');
                const labourJobId = labourJob && labourJob.id !== undefined && labourJob.id !== null
                    ? String(labourJob.id)
                    : '';
                const labourJobName = labourJob && labourJob.name ? labourJob.name : 'Labour';
                const payload = {
                    job_name_id: labourJobId,
                    job_name: labourJobName,
                    description: description,
                    fixed_rate: rateString,
                    fixed_hours: qtyString,
                };
                const response = await fetch(createServiceUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: JSON.stringify(payload),
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'We could not save that labour entry.');
                }
                const serviceData = data.service || {};
                const serviceId = serviceData.id !== undefined && serviceData.id !== null ? String(serviceData.id) : '';
                if (!serviceId) {
                    throw new Error('We could not save that labour entry.');
                }
                const jobData = serviceData.job_name || { id: labourJobId, name: labourJobName };
                const descriptionData = {
                    id: serviceId,
                    text: serviceData.description || description,
                    notes: serviceData.notes || '',
                    fixed_hours: serviceData.fixed_hours || qtyString,
                    fixed_rate: serviceData.fixed_rate || rateString,
                    due_after_kilometers: serviceData.due_after_kilometers !== undefined && serviceData.due_after_kilometers !== null
                        ? String(serviceData.due_after_kilometers)
                        : '',
                    due_after_months: serviceData.due_after_months !== undefined && serviceData.due_after_months !== null
                        ? String(serviceData.due_after_months)
                        : '',
                };
                upsertJobCatalogEntry(jobData, descriptionData);
                row.find('input[name$="-product"]').val('');
                row.find('input[name$="-service_id"]').val(serviceId);
                row.find('input[name$="-service_due_months"]').val('');
                row.find('input[name$="-service_due_kilometers"]').val('');
                row.find('input[name$="-skip_maintenance"]').val('1');
            }

            row.data('quickAddSaved', true);
            row.removeData('quickAddType');
            row.removeClass('qb-quick-add-error');
            row.find('.qb-quick-add-invalid').removeClass('qb-quick-add-invalid');
            formIsDirty = true;
            return { success: true, created: true };
        } catch (error) {
            showQuickAddError(error.message || 'Could not save quick add item.', rateInput);
            return { success: false };
        } finally {
            row.removeData('quickAddSaving');
        }
    }

    $('#jobs').on('change', '.qb-item-select', function () {
        const select = $(this);
        const row = select.closest('.job-entry-row');
        const value = select.val();
        if (!value) {
            row.find('input[name$="-product"]').val('');
            row.find('input[name$="-service_id"]').val('');
            clearQuickAddState(row);
            closeSelect2Dropdown(select);
            return;
        }
        if (value === '__add__') {
            clearQuickAddState(row);
            openItemTypeModal(row);
            select.val('').trigger('change.select2');
            closeSelect2Dropdown(select);
            return;
        }
        if (value === QUICK_ADD_LABOUR_VALUE || value === QUICK_ADD_PRODUCT_VALUE) {
            const quickType = value === QUICK_ADD_LABOUR_VALUE ? 'labour' : 'product';
            setQuickAddState(row, quickType);
            row.find('input[name$="-product"]').val('');
            row.find('input[name$="-service_id"]').val('');
            row.find('input[name$="-service_due_months"]').val('');
            row.find('input[name$="-service_due_kilometers"]').val('');
            row.find('input[name$="-skip_maintenance"]').val('');
            const searchTerm = getLineItemSearchTerm(select);
            if (searchTerm) {
                const descInput = row.find('textarea[name$="-job"]');
                if (descInput.length && !descInput.val().trim()) {
                    descInput.val(searchTerm);
                }
            }
            ensureDefaultQty(row);
            closeSelect2Dropdown(select);
            closeAllSelect2Dropdowns();
            return;
        }
        clearQuickAddState(row);
        const option = select.find('option:selected');
        const kind = option.data('kind');
        if (kind === 'product') {
            applyProductSelection(row, option);
        } else if (kind === 'service') {
            applyServiceSelection(row, option);
        }
        closeSelect2Dropdown(select);
        closeAllSelect2Dropdowns();
    });

    $('#jobs').on('click', '.qb-remove-row', function () {
        removeLineRow($(this).closest('.job-entry-row'));
    });

    $(document).on('select2:select select2:unselect', '.select2-hidden-accessible', function () {
        closeAllSelect2Dropdowns();
    });

    $(document).on('select2:opening', '.qb-item-select', function () {
        const openingSelect = $(this);
        $('.select2-hidden-accessible').not(openingSelect).each(function () {
            closeSelect2Dropdown($(this));
        });
    });

    $(document).on('select2:select', '.qb-item-select', function () {
        const select = $(this);
        setTimeout(function () {
            closeSelect2Dropdown(select);
            closeAllSelect2Dropdowns();
        }, 0);
    });

    $(document).on('mouseup', '.select2-results__option--selectable', function () {
        setTimeout(function () {
            const openContainer = $('.select2-container--open').first();
            const select = openContainer.prev('select.select2-hidden-accessible');
            closeSelect2Dropdown(select);
        }, 0);
    });


    $('#qb-add-lines, #qb-add-line-btn').on('click', async function (event) {
        event.preventDefault();
        const addButtons = $('#qb-add-lines, #qb-add-line-btn');
        addButtons.prop('disabled', true);
        try {
            const savedOk = await persistQuickAddRows();
            if (!savedOk) {
                return;
            }
            const row = addJobForm();
            focusLineItemSelect(row);
        } catch (error) {
            showQuickAddError('Unable to add a new line. Please try again.');
            console.error('Add line failed:', error);
        } finally {
            addButtons.prop('disabled', false);
        }
    });

    function clearAllLineRows() {
        const rows = $('#jobs .job-entry-row').not('.special-entry').toArray();
        if (!rows.length) { return; }
        rows.forEach(function (rowEl) {
            removeLineRow($(rowEl));
        });
        // Re-run key calculations once after bulk clear to avoid skipping rows mid-loop.
        updateLineRowNumbers();
        calculateTotal();
        toggleNoJobsMessage();
        formIsDirty = true;
    }

    $('#qb-clear-lines').on('click', function (event) {
        event.preventDefault();
        clearAllLineRows();
    });

    $('#itemTypeModal').on('click', '.qb-item-type-card', function () {
        const itemType = $(this).data('itemType');
        hideModal('itemTypeModal');
        if (itemType === 'service') {
            resetMachServiceModal();
            showModal('machNewServiceModal');
            return;
        }
        resetMachProductModal();
        $('#mach_product_item_type').val(itemType || 'inventory').trigger('change');
        showModal('machNewProductModal');
    });

    $('#itemTypeModal').on('hidden.bs.modal', function () {
        if (!$('#machNewProductModal').hasClass('show') && !$('#machNewServiceModal').hasClass('show')) {
            activeLineItemRow = null;
        }
    });

    const addJobModal = $('#addJobModal');
    const jobNameSelect = $('#jobNameSelect');
    const jobDescriptionSelect = $('#jobDescriptionSelect');
    const jobDescriptionInput = $('#jobDescriptionInput');
    const jobDescriptionNotes = $('#jobDescriptionNotes');
    const jobDueMonthsInput = $('#jobDueMonthsInput');
    const jobDueKilometersInput = $('#jobDueKilometersInput');
    const noJobsMessage = $('#no-jobs-message');
    const jobModalError = $('#jobModalError');
    const jobFixedHoursInput = $('#jobFixedHoursInput');
    const jobFixedRateInput = $('#jobFixedRateInput');
    const createServiceUrl = "{% url 'accounts:create_service_description' %}";
    const invoiceNumberInput = $('#invoice-number');
    const invoiceNumberDisplay = $('.qb-doc-number');

    const jobModalDropdownParent = $('#addJobModal .modal-body').length ? $('#addJobModal .modal-body') : (addJobModal.length ? addJobModal : undefined);

    if (invoiceNumberInput.length && invoiceNumberDisplay.length) {
        invoiceNumberInput.on('input', function () {
            const value = $(this).val().trim();
            const fallback = invoiceNumberDisplay.data('default') || '';
            const displayValue = value || fallback;
            invoiceNumberDisplay.text(displayValue ? `#${displayValue}` : '#');
        });
    }

    function initializeSelect2Dropdown($element, options, unavailableMessage) {
        if (!$element || !$element.length) {
            return;
        }
        if ($.fn.select2) {
            if (!$element.data('select2')) {
                $element.select2(Object.assign({
                    theme: 'bootstrap4',
                    width: '100%',
                    dropdownAutoWidth: false,
                    closeOnSelect: true,
                    dropdownParent: jobModalDropdownParent,
                }, options || {}));
            }
        } else if (unavailableMessage) {
            console.warn(unavailableMessage);
        }
    }

    function resetSelectElement($element) {
        if (!$element || !$element.length) {
            return;
        }
        $element.val('');
        if ($.fn.select2 && $element.data('select2')) {
            $element.val(null).trigger('change.select2');
        } else {
            $element.trigger('change');
        }
    }

    function setSelectDisabled($element, disabled) {
        if (!$element || !$element.length) {
            return;
        }
        const isDisabled = !!disabled;
        $element.prop('disabled', isDisabled);
        if ($.fn.select2 && $element.data('select2')) {
            $element.trigger('change.select2');
        } else {
            $element.trigger('change');
        }
    }

    function focusJobNameSelect() {
        if (!jobNameSelect.length) {
            return;
        }
        if ($.fn.select2 && jobNameSelect.data('select2')) {
            jobNameSelect.select2('open');
        } else {
            jobNameSelect.trigger('focus');
        }
    }

    initializeSelect2Dropdown(jobNameSelect, {
        placeholder: 'Search job names',
    }, 'Select2 library not available  job dropdown will use native controls.');
    // description dropdown removed; handled automatically

    function getCsrfToken() {
        const field = $('input[name="csrfmiddlewaretoken"]').first();
        return field.length ? field.val() : '';
    }

    function clearJobModalError() {
        if (jobModalError.length) {
            jobModalError.addClass('d-none').text('');
        }
    }

    function showJobModalError(message) {
        if (jobModalError.length) {
            jobModalError.removeClass('d-none').text(message);
        } else {
            alert(message);
        }
    }

    function normalizeString(value) {
        return (value || '').toString();
    }

    function formatFixedHoursDisplay(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numeric = Number(value);
        if (!isFinite(numeric)) {
            return String(value);
        }
        const normalized = numeric.toFixed(2);
        return normalized.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
    }

    function formatFixedRateDisplay(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const numeric = Number(value);
        if (!isFinite(numeric)) {
            return String(value);
        }
        const normalized = numeric.toFixed(2);
        return normalized.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
    }

    function normalizeDueInputValue(rawValue) {
        const trimmed = (rawValue ?? '').toString().trim();
        if (!trimmed) {
            return '';
        }
        const numeric = Number(trimmed);
        if (!Number.isFinite(numeric) || numeric < 0) {
            return null;
        }
        return String(Math.floor(numeric));
    }

    function formatDueSummaryDisplay(monthsValue, kilometersValue) {
        const parts = [];
        const normalizedMonths = normalizeDueInputValue(monthsValue);
        if (normalizedMonths !== null && normalizedMonths !== '') {
            const monthsNumber = Number(normalizedMonths);
            parts.push(`${monthsNumber} month${monthsNumber === 1 ? '' : 's'}`);
        }
        const normalizedKilometers = normalizeDueInputValue(kilometersValue);
        if (normalizedKilometers !== null && normalizedKilometers !== '') {
            const kmNumber = Number(normalizedKilometers);
            parts.push(`${kmNumber.toLocaleString()} km`);
        }
        if (!parts.length) {
            return '';
        }
        return `Next due in ${parts.join(' or ')}`;
    }

    function findJobInCatalog(jobId, jobName) {
        const normalizedId = jobId !== undefined && jobId !== null && jobId !== '' ? String(jobId) : '';
        const normalizedName = normalizeString(jobName);
        return jobCatalog.find(function (job) {
            if (!job) {
                return false;
            }
            if (normalizedId && job.id !== undefined && job.id !== null) {
                return String(job.id) === normalizedId;
            }
            if (normalizedName) {
                return normalizeString(job.name) === normalizedName;
            }
            return false;
        }) || null;
    }

    function upsertJobCatalogEntry(jobNameData, descriptionData) {
        if (!jobNameData || !descriptionData) {
            return;
        }

        const jobIdValue = jobNameData.id !== undefined && jobNameData.id !== null ? jobNameData.id : '';
        const jobNameValue = normalizeString(jobNameData.name);

        let jobEntry = findJobInCatalog(jobIdValue, jobNameValue);
        if (!jobEntry) {
            jobEntry = {
                id: jobIdValue,
                name: jobNameValue,
                descriptions: [],
            };
            jobCatalog.push(jobEntry);
        }

        if (!Array.isArray(jobEntry.descriptions)) {
            jobEntry.descriptions = [];
        }

        const descriptionIdValue = descriptionData.id !== undefined && descriptionData.id !== null ? descriptionData.id : '';
        const descriptionTextValue = normalizeString(descriptionData.text);
        const descriptionNotesValue = normalizeString(descriptionData.notes);
        const descriptionFixedHoursValue = normalizeString(descriptionData.fixed_hours);
        const descriptionFixedRateValue = normalizeString(descriptionData.fixed_rate);

        let existingDescription = null;
        if (descriptionIdValue !== '') {
            existingDescription = jobEntry.descriptions.find(function (item) {
                return item && item.id !== undefined && item.id !== null && String(item.id) === String(descriptionIdValue);
            }) || null;
        }

        if (!existingDescription) {
            existingDescription = jobEntry.descriptions.find(function (item) {
                return item && normalizeString(item.text).toLowerCase() === descriptionTextValue.toLowerCase();
            }) || null;
        }

        if (existingDescription) {
            existingDescription.id = descriptionIdValue;
            existingDescription.text = descriptionTextValue;
            existingDescription.notes = descriptionNotesValue;
            existingDescription.fixed_hours = descriptionFixedHoursValue;
            existingDescription.fixed_rate = descriptionFixedRateValue;
            existingDescription.due_after_months = descriptionData.due_after_months !== undefined && descriptionData.due_after_months !== null
                ? descriptionData.due_after_months
                : '';
            existingDescription.due_after_kilometers = descriptionData.due_after_kilometers !== undefined && descriptionData.due_after_kilometers !== null
                ? descriptionData.due_after_kilometers
                : '';
        } else {
            jobEntry.descriptions.push({
                id: descriptionIdValue,
                text: descriptionTextValue,
                notes: descriptionNotesValue,
                fixed_hours: descriptionFixedHoursValue,
                fixed_rate: descriptionFixedRateValue,
                due_after_months: descriptionData.due_after_months !== undefined && descriptionData.due_after_months !== null
                    ? descriptionData.due_after_months
                    : '',
                due_after_kilometers: descriptionData.due_after_kilometers !== undefined && descriptionData.due_after_kilometers !== null
                    ? descriptionData.due_after_kilometers
                    : '',
            });
        }

        jobEntry.descriptions.sort(function (a, b) {
            return normalizeString(a && a.text).localeCompare(normalizeString(b && b.text), undefined, { sensitivity: 'base' });
        });

        jobCatalog.sort(function (a, b) {
            return normalizeString(a && a.name).localeCompare(normalizeString(b && b.name), undefined, { sensitivity: 'base' });
        });
    }

    function refreshJobNameOptions() {
        jobNameSelect.empty();
        jobNameSelect.append('<option value="">Select job name</option>');
        if (!Array.isArray(jobCatalog) || jobCatalog.length === 0) {
            setSelectDisabled(jobNameSelect, true);
            resetSelectElement(jobNameSelect);
            jobDescriptionInput.val('').data('selectedServiceId', '').data('serviceEdited', false).removeData('dueMonths').removeData('dueKilometers').removeData('notes');
            return;
        }

        const sortedJobs = [...jobCatalog].sort(function (a, b) {
            return normalizeString(a && a.name).localeCompare(normalizeString(b && b.name), undefined, { sensitivity: 'base' });
        });

        sortedJobs.forEach(function (job) {
            if (job && job.name) {
                const option = $('<option></option>');
                if (job.id !== undefined && job.id !== null && job.id !== '') {
                    option.val(String(job.id));
                    option.attr('data-job-id', String(job.id));
                } else {
                    option.val(job.name);
                }
                option.attr('data-job-name', job.name);
                option.text(job.name);
                jobNameSelect.append(option);
            }
        });
        setSelectDisabled(jobNameSelect, false);
        resetSelectElement(jobNameSelect);
        jobDescriptionInput.val('').data('selectedServiceId', '').data('serviceEdited', false).removeData('dueMonths').removeData('dueKilometers').removeData('notes');
    }

    function refreshJobDescriptionOptions(jobId, jobName) {
        const matchedJob = findJobInCatalog(jobId, jobName);
        jobDescriptionNotes.hide().text('');
        jobDescriptionInput.data('selectedServiceId', '').data('serviceEdited', false);
        if (jobDueMonthsInput.length) {
            jobDueMonthsInput.val('');
        }
        if (jobDueKilometersInput.length) {
            jobDueKilometersInput.val('');
        }

        if (matchedJob && Array.isArray(matchedJob.descriptions) && matchedJob.descriptions.length) {
            const sortedDescriptions = [...matchedJob.descriptions].sort(function (a, b) {
                return normalizeString(a && a.text).localeCompare(normalizeString(b && b.text), undefined, { sensitivity: 'base' });
            });
            const desc = sortedDescriptions[0];
            if (desc && desc.text) {
                jobDescriptionInput.val(desc.text);
                jobDescriptionInput.data('selectedServiceId', desc.id ? String(desc.id) : '').data('serviceEdited', false);
                jobDescriptionInput.data('dueMonths', desc.due_after_months !== undefined && desc.due_after_months !== null ? String(desc.due_after_months) : '');
                jobDescriptionInput.data('dueKilometers', desc.due_after_kilometers !== undefined && desc.due_after_kilometers !== null ? String(desc.due_after_kilometers) : '');
                jobDescriptionInput.data('notes', desc.notes || '');
                jobDescriptionInput.data('fixedRate', desc.fixed_rate !== undefined && desc.fixed_rate !== null ? String(desc.fixed_rate) : '');
                if (jobFixedHoursInput.length) {
                    const hasFixedHours = desc.fixed_hours !== undefined && desc.fixed_hours !== null && String(desc.fixed_hours) !== '';
                    const hasFixedRate = desc.fixed_rate !== undefined && desc.fixed_rate !== null && String(desc.fixed_rate) !== '';
                    const resolvedFixedHours = hasFixedHours ? desc.fixed_hours : (hasFixedRate ? 1 : '');
                    jobFixedHoursInput.val(formatFixedHoursDisplay(resolvedFixedHours));
                    jobFixedHoursInput.data('autoFixedHours', !hasFixedHours && hasFixedRate);
                    jobFixedHoursInput.data('userEdited', false);
                }
                if (jobFixedRateInput.length) {
                    jobFixedRateInput.val(formatFixedRateDisplay(desc.fixed_rate));
                }
                if (jobDueMonthsInput.length && desc.due_after_months) {
                    jobDueMonthsInput.val(desc.due_after_months);
                }
                if (jobDueKilometersInput.length && desc.due_after_kilometers) {
                    jobDueKilometersInput.val(desc.due_after_kilometers);
                }
                const details = [];
                if (desc.notes) {
                    details.push(desc.notes);
                }
                const dueSummary = formatDueSummaryDisplay(desc.due_after_months, desc.due_after_kilometers);
                if (dueSummary) {
                    details.push(dueSummary);
                }
                if (desc.fixed_rate !== undefined && desc.fixed_rate !== null && String(desc.fixed_rate) !== '') {
                    details.push(`Fixed rate: ${formatFixedRateDisplay(desc.fixed_rate)}`);
                }
                if (details.length) {
                    jobDescriptionNotes.text(details.join('  ')).show();
                }
            }
        } else {
            jobDescriptionInput.val('').data('selectedServiceId', '').data('serviceEdited', false).removeData('dueMonths').removeData('dueKilometers').removeData('notes').removeData('fixedRate');
            jobDescriptionNotes.hide().text('');
            if (jobFixedHoursInput.length) {
                jobFixedHoursInput.val('');
                jobFixedHoursInput.data('autoFixedHours', false).data('userEdited', false);
            }
            if (jobFixedRateInput.length) {
                jobFixedRateInput.val('');
            }
        }
    }

    jobNameSelect.on('change', function () {
        const selectedOption = $(this).find('option:selected');
        if (!selectedOption || !selectedOption.length) {
            jobDescriptionInput.data('selectedServiceId', '').data('serviceEdited', false);
            jobDescriptionNotes.hide().text('');
            if (jobFixedHoursInput.length) {
                jobFixedHoursInput.val('');
                jobFixedHoursInput.data('autoFixedHours', false).data('userEdited', false);
            }
            if (jobFixedRateInput.length) {
                jobFixedRateInput.val('');
            }
            if (jobDueMonthsInput.length) {
                jobDueMonthsInput.val('');
            }
            if (jobDueKilometersInput.length) {
                jobDueKilometersInput.val('');
            }
            return;
        }
        const selectedJobId = selectedOption.data('jobId') || selectedOption.val() || '';
        const selectedJobName = selectedOption.data('jobName') || selectedOption.text() || '';
        jobNameSelect.removeClass('is-invalid');
        clearJobModalError();
        refreshJobDescriptionOptions(selectedJobId, selectedJobName);
    });

    jobDescriptionSelect.on('change', function () {
        const selectedOption = $(this).find('option:selected');
        if (!selectedOption || !selectedOption.length) {
            jobDescriptionInput.data('selectedServiceId', '').data('serviceEdited', false);
            jobDescriptionInput.removeData('fixedRate');
            jobDescriptionNotes.hide().text('');
            if (jobFixedHoursInput.length) {
                jobFixedHoursInput.val('');
                jobFixedHoursInput.data('autoFixedHours', false).data('userEdited', false);
            }
            if (jobFixedRateInput.length) {
                jobFixedRateInput.val('');
            }
            if (jobDueMonthsInput.length) {
                jobDueMonthsInput.val('');
            }
            if (jobDueKilometersInput.length) {
                jobDueKilometersInput.val('');
            }
            return;
        }

        const serviceId = selectedOption.data('serviceId') || '';
        const optionValue = selectedOption.val();
        const storedDescription = selectedOption.data('description');
        const descriptionText = storedDescription || ((serviceId || optionValue) ? (selectedOption.text() || '') : '');
        const hasSelection = !!(serviceId || storedDescription || optionValue);

        if (hasSelection) {
            jobDescriptionInput.val(descriptionText).removeClass('is-invalid');
            jobDescriptionInput.data('selectedServiceId', serviceId).data('serviceEdited', false);
        } else {
            jobDescriptionInput.data('selectedServiceId', '').data('serviceEdited', false);
        }

        const notes = selectedOption.data('notes');
        const fixedHoursValue = selectedOption.data('fixedHours');
        const fixedRateValue = selectedOption.data('fixedRate');
        if (jobFixedHoursInput.length) {
            const hasFixedHours = fixedHoursValue !== undefined && fixedHoursValue !== null && String(fixedHoursValue) !== '';
            const hasFixedRate = fixedRateValue !== undefined && fixedRateValue !== null && String(fixedRateValue) !== '';
            const resolvedFixedHours = hasFixedHours ? fixedHoursValue : (hasFixedRate ? 1 : '');
            jobFixedHoursInput.val(formatFixedHoursDisplay(resolvedFixedHours));
            jobFixedHoursInput.data('autoFixedHours', !hasFixedHours && hasFixedRate);
            jobFixedHoursInput.data('userEdited', false);
        }
        if (jobFixedRateInput.length) {
            jobFixedRateInput.val(formatFixedRateDisplay(fixedRateValue));
        }
        jobDescriptionInput.data('fixedRate', fixedRateValue !== undefined && fixedRateValue !== null ? fixedRateValue : '');
        const dueMonthsValue = selectedOption.data('dueMonths');
        const dueKilometersValue = selectedOption.data('dueKilometers');
        if (jobDueMonthsInput.length) {
            jobDueMonthsInput.val(
                dueMonthsValue !== undefined && dueMonthsValue !== null && String(dueMonthsValue) !== ''
                    ? dueMonthsValue
                    : ''
            );
        }
        if (jobDueKilometersInput.length) {
            jobDueKilometersInput.val(
                dueKilometersValue !== undefined && dueKilometersValue !== null && String(dueKilometersValue) !== ''
                    ? dueKilometersValue
                    : ''
            );
        }
        if (hasSelection) {
            const details = [];
            if (notes) {
                details.push(notes);
            }
            if (fixedHoursValue !== undefined && fixedHoursValue !== null && String(fixedHoursValue) !== '') {
                details.push(`Fixed hours: ${formatFixedHoursDisplay(fixedHoursValue)}`);
            }
            if (fixedRateValue !== undefined && fixedRateValue !== null && String(fixedRateValue) !== '') {
                details.push(`Fixed rate: ${formatFixedRateDisplay(fixedRateValue)}`);
            }
            const dueSummary = formatDueSummaryDisplay(dueMonthsValue, dueKilometersValue);
            if (dueSummary) {
                details.push(dueSummary);
            }
            if (details.length) {
                jobDescriptionNotes.text(details.join(' - ')).show();
            } else {
                jobDescriptionNotes.hide().text('');
            }
        } else {
            jobDescriptionNotes.hide().text('');
        }
    });

    if ($.fn.select2) {
        jobDescriptionSelect.on('select2:open', function () {
            const select2Instance = $(this).data('select2');
            if (select2Instance && select2Instance.$dropdown) {
                select2Instance.$dropdown.css('word-break', 'break-word');
            }
        });
    }

    jobDescriptionInput.on('input', function () {
        const value = $(this).val().trim();
        if (value) {
            $(this).removeClass('is-invalid');
            $(this).data('serviceEdited', true);
            return;
        }
        $(this).data('selectedServiceId', '').data('serviceEdited', false);
        jobDescriptionNotes.hide().text('');
        if (jobFixedHoursInput.length) {
            jobFixedHoursInput.val('');
            jobFixedHoursInput.data('autoFixedHours', false).data('userEdited', false);
        }
        if (jobFixedRateInput.length) {
            jobFixedRateInput.val('');
        }
        if (jobDueMonthsInput.length) {
            jobDueMonthsInput.val('');
        }
        if (jobDueKilometersInput.length) {
            jobDueKilometersInput.val('');
        }
    });

    if (jobFixedHoursInput.length) {
        jobFixedHoursInput.on('input', function () {
            jobDescriptionInput.data('serviceEdited', true);
            jobFixedHoursInput.data('userEdited', true).data('autoFixedHours', false);
        });
    }
    if (jobFixedRateInput.length) {
        jobFixedRateInput.on('input', function () {
            jobDescriptionInput.data('serviceEdited', true);
        });
    }
    if (jobDueMonthsInput.length) {
        jobDueMonthsInput.on('input', function () {
            jobDescriptionInput.data('serviceEdited', true);
        });
    }
    if (jobDueKilometersInput.length) {
        jobDueKilometersInput.on('input', function () {
            jobDescriptionInput.data('serviceEdited', true);
        });
    }

    $('.add-job-btn').on('click', function () {
        refreshJobNameOptions();
        clearJobModalError();
        resetSelectElement(jobDescriptionSelect);
        if (!Array.isArray(jobCatalog) || jobCatalog.length === 0) {
            setSelectDisabled(jobDescriptionSelect, true);
        }
        jobDescriptionInput.val('').removeClass('is-invalid').data('selectedServiceId', '').data('serviceEdited', false);
        jobNameSelect.removeClass('is-invalid');
        jobDescriptionNotes.hide().text('');
        if (jobFixedHoursInput.length) {
            jobFixedHoursInput.val('');
            jobFixedHoursInput.data('autoFixedHours', false).data('userEdited', false);
        }
        if (jobFixedRateInput.length) {
            jobFixedRateInput.val('');
        }
        showModal('addJobModal');
        setTimeout(function () {
            if (jobNameSelect.length && !jobNameSelect.prop('disabled')) {
                focusJobNameSelect();
            } else {
                jobDescriptionInput.trigger('focus');
            }
        }, 200);
    });

    $('#confirmAddJobButton').on('click', async function () {
        clearJobModalError();
        if (jobNameSelect.prop('disabled')) {
            jobNameSelect.addClass('is-invalid');
            focusJobNameSelect();
            return;
        }

        const selectedOption = jobNameSelect.find('option:selected');
        const selectedJobId = selectedOption.data('jobId') || selectedOption.val() || '';
        const selectedJobName = selectedOption.data('jobName') || selectedOption.text() || '';
        let descriptionOption = null;

        if (!selectedJobId && !selectedJobName) {
            jobNameSelect.addClass('is-invalid');
            focusJobNameSelect();
            return;
        }

        const descriptionText = jobDescriptionInput.val().trim();
        if (!descriptionText) {
            jobDescriptionInput.addClass('is-invalid').trigger('focus');
            return;
        }

        const fixedHoursRaw = jobFixedHoursInput.length ? jobFixedHoursInput.val().trim() : '';
        if (fixedHoursRaw) {
            const numericFixedHours = Number(fixedHoursRaw);
            if (!isFinite(numericFixedHours) || numericFixedHours < 0) {
                showJobModalError('Fixed hours must be a non-negative number.');
                if (jobFixedHoursInput.length) {
                    jobFixedHoursInput.trigger('focus');
                }
                return;
            }
        }
        const fixedRateRaw = jobFixedRateInput.length ? jobFixedRateInput.val().trim() : '';
        if (fixedRateRaw) {
            const numericFixedRate = Number(fixedRateRaw);
            if (!isFinite(numericFixedRate) || numericFixedRate < 0) {
                showJobModalError('Fixed rate must be a non-negative number.');
                if (jobFixedRateInput.length) {
                    jobFixedRateInput.trigger('focus');
                }
                return;
            }
        }

        const dueMonthsRaw = jobDueMonthsInput.length ? jobDueMonthsInput.val() : '';
        const dueKilometersRaw = jobDueKilometersInput.length ? jobDueKilometersInput.val() : '';
        const normalizedDueMonths = jobDueMonthsInput.length ? normalizeDueInputValue(dueMonthsRaw) : '';
        if (normalizedDueMonths === null) {
            showJobModalError('Due after (months) must be a whole number.');
            if (jobDueMonthsInput.length) {
                jobDueMonthsInput.trigger('focus');
            }
            return;
        }
        const normalizedDueKilometers = jobDueKilometersInput.length ? normalizeDueInputValue(dueKilometersRaw) : '';
        if (normalizedDueKilometers === null) {
            showJobModalError('Due after (km) must be a whole number.');
            if (jobDueKilometersInput.length) {
                jobDueKilometersInput.trigger('focus');
            }
            return;
        }

        let selectedServiceId = jobDescriptionInput.data('selectedServiceId') || '';
        let catalogDueMonths = '';
        let catalogDueKilometers = '';

        if (!selectedServiceId) {
            const jobEntry = findJobInCatalog(selectedJobId, selectedJobName);
            if (jobEntry && Array.isArray(jobEntry.descriptions)) {
                const existingMatch = jobEntry.descriptions.find(function (desc) {
                    return desc && normalizeString(desc.text).toLowerCase() === descriptionText.toLowerCase();
                });
                if (existingMatch && existingMatch.id !== undefined && existingMatch.id !== null && existingMatch.id !== '') {
                    selectedServiceId = String(existingMatch.id);
                    catalogDueMonths = existingMatch.due_after_months !== undefined && existingMatch.due_after_months !== null
                        ? String(existingMatch.due_after_months)
                        : '';
                    catalogDueKilometers = existingMatch.due_after_kilometers !== undefined && existingMatch.due_after_kilometers !== null
                        ? String(existingMatch.due_after_kilometers)
                        : '';
                }
            }
        }

        const serviceEdited = !!jobDescriptionInput.data('serviceEdited');
        const shouldPersistService = serviceEdited || !selectedServiceId;

        if (shouldPersistService) {
            const $button = $(this);

            if (!createServiceUrl) {
                showJobModalError('We could not save that job description.');
                return;
            }

            const requestBody = {
                job_name_id: selectedOption.data('jobId') || selectedOption.val() || '',
                job_name: selectedJobName,
                description: descriptionText,
                fixed_rate: fixedRateRaw,
                due_after_kilometers: normalizedDueKilometers || '',
                due_after_months: normalizedDueMonths || '',
            };
            const autoFixedHours = jobFixedHoursInput.length
                ? jobFixedHoursInput.data('autoFixedHours') === true
                : false;
            const fixedHoursEdited = jobFixedHoursInput.length
                ? jobFixedHoursInput.data('userEdited') === true
                : false;
            if (!selectedServiceId || !autoFixedHours || fixedHoursEdited) {
                requestBody.fixed_hours = fixedHoursRaw;
            }
            if (serviceEdited && selectedServiceId) {
                requestBody.service_id = selectedServiceId;
            }

            const csrfToken = getCsrfToken();
            $button.prop('disabled', true).data('loading', true);

            try {
                const response = await fetch(createServiceUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(requestBody),
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'We could not save that job description.');
                }

                const serviceData = data.service || {};
                const jobData = serviceData.job_name || { id: selectedJobId, name: selectedJobName };
                const descriptionData = {
                    id: serviceData.id,
                    text: serviceData.description || descriptionText,
                    notes: serviceData.notes || '',
                    fixed_hours: serviceData.fixed_hours || '',
                    fixed_rate: serviceData.fixed_rate || '',
                    due_after_kilometers: serviceData.due_after_kilometers !== undefined && serviceData.due_after_kilometers !== null
                        ? String(serviceData.due_after_kilometers)
                        : '',
                    due_after_months: serviceData.due_after_months !== undefined && serviceData.due_after_months !== null
                        ? String(serviceData.due_after_months)
                        : '',
                };

                upsertJobCatalogEntry(jobData, descriptionData);
                refreshLineItemSelectOptions();
                refreshJobDescriptionOptions(jobData.id !== undefined && jobData.id !== null && jobData.id !== '' ? String(jobData.id) : jobData.name, jobData.name);

                jobDescriptionSelect.val(descriptionData.id ? String(descriptionData.id) : '');
                jobDescriptionInput.val(descriptionData.text).data('selectedServiceId', descriptionData.id ? String(descriptionData.id) : '').data('serviceEdited', false);
                jobDescriptionSelect.trigger('change');
                descriptionOption = jobDescriptionSelect.find('option:selected');
                selectedServiceId = jobDescriptionInput.data('selectedServiceId') || selectedServiceId;
            } catch (error) {
                showJobModalError(error.message || 'We could not save that job description.');
                jobDescriptionInput.trigger('focus');
                return;
            } finally {
                $button.prop('disabled', false).removeData('loading');
            }
        }

        const dropdownDueMonths = jobDescriptionInput.data('dueMonths') || '';
        const dropdownDueKilometers = jobDescriptionInput.data('dueKilometers') || '';
        const existingDueMonths = dropdownDueMonths || catalogDueMonths || '';
        const existingDueKilometers = dropdownDueKilometers || catalogDueKilometers || '';

        const resolvedDueMonths = normalizedDueMonths || '';
        const resolvedDueKilometers = normalizedDueKilometers || '';

        const skipMaintenance = !resolvedDueMonths && !resolvedDueKilometers;

        addJobForm({
            jobDescription: descriptionText,
            fixedHours: fixedHoursRaw,
            fixedRate: fixedRateRaw,
            serviceId: selectedServiceId,
            dueAfterMonths: resolvedDueMonths,
            dueAfterKilometers: resolvedDueKilometers,
            serviceSkipMaintenance: skipMaintenance,
        });
        hideModal('addJobModal');
    });

    addJobModal.on('hidden.bs.modal', function () {
        jobDescriptionInput.removeClass('is-invalid').data('selectedServiceId', '').data('serviceEdited', false);
        jobNameSelect.removeClass('is-invalid');
        clearJobModalError();
        if (jobFixedHoursInput.length) {
            jobFixedHoursInput.val('');
            jobFixedHoursInput.data('autoFixedHours', false).data('userEdited', false);
        }
        if (jobFixedRateInput.length) {
            jobFixedRateInput.val('');
        }
        if (jobDueMonthsInput.length) {
            jobDueMonthsInput.val('');
        }
        if (jobDueKilometersInput.length) {
            jobDueKilometersInput.val('');
        }
    });


    // --- Save New Customer ---
    $('#save-customer-button').on('click', function (e) {
        e.preventDefault();
        const customerFormElement = document.getElementById('add-customer-form');
        const formData = new FormData(customerFormElement);
        const errorDiv = $('#customer-form-errors');
        errorDiv.empty().removeClass('p-3 bg-red-100 border border-red-300 rounded-md');
        const saveButton = $(this);
        saveButton.prop('disabled', true).text('Saving...');

        fetch("{% url 'accounts:add_customer' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.success && body.customer) {
                    handleDailyLogCustomerSuccess(body.customer, customerFormElement, errorDiv);
                } else {
                    let htmlErrors = '<ul class="list-disc list-inside">';
                    if (body.errors && typeof body.errors === 'object') {
                        Object.entries(body.errors).forEach(([field, errorMessages]) => {
                            errorMessages.forEach(err => { // Changed 'e' to 'err' to avoid conflict
                                htmlErrors += `<li>${field !== '__all__' ? (body.errors[field].label || field) + ': ' : ''}${err.message || err}</li>`;
                            });
                        });
                    } else if (body.message) {
                        htmlErrors += `<li>${body.message}</li>`;
                    } else {
                        htmlErrors += `<li>An unknown error occurred (Status: ${status}).</li>`;
                    }
                    htmlErrors += '</ul>';
                    errorDiv.html(htmlErrors).addClass('p-3 bg-red-100 border border-red-300 rounded-md');
                }
            })
            .catch(error => {
                console.error('Error saving customer:', error);
                errorDiv.html('<p>A network or unexpected error occurred. Please try again.</p>')
                    .addClass('p-3 bg-red-100 border border-red-300 rounded-md');
            })
            .finally(() => {
                saveButton.prop('disabled', false).text('Save Customer');
            });
    });


    // --- Save New Vehicle ---
    $('#save-vehicle-button').on('click', function (e) {
        e.preventDefault();
        const vehicleFormElement = document.getElementById('add-vehicle-form');
        const formData = new FormData(vehicleFormElement);
        const customerId = customerSelect.val();
        const errorDiv = $('#vehicle-form-errors');
        errorDiv.empty().removeClass('p-3 bg-red-100 border border-red-300 rounded-md');
        const saveButton = $(this);

        if (!customerId) {
            errorDiv.html('<p>A customer must be selected before adding a vehicle.</p>')
                .addClass('p-3 bg-red-100 border border-red-300 rounded-md');
            return;
        }
        formData.set('customer', customerId);
        saveButton.prop('disabled', true).text('Saving...');

        fetch("{% url 'accounts:add_vehicle' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200 && body.success && body.vehicle) {
                    const v = body.vehicle;
                    const unitNo = v.unit_no || '';
                    const vinNo = v.vin_no || '';
                    const makeModel = v.make_model || '';
                    let label = unitNo ? `Unit: ${unitNo}` : (makeModel || (vinNo ? `VIN: ${vinNo}` : `Vehicle ID ${v.id}`));
                    if (makeModel && unitNo) label = `Unit: ${unitNo} (${makeModel})`;

                    const newOption = new Option(label, v.id.toString(), true, true);
                    $(newOption).attr('data-unit', unitNo);
                    $(newOption).attr('data-vin', vinNo);
                    $(newOption).attr('data-make', makeModel);
                    $(newOption).attr('data-license', v.license_plate || '');

                    vehicleSelect.prop('disabled', false);
                    vehicleSelect.append(newOption).trigger('change');
                    hideModal('addVehicleModal');
                    vehicleFormElement.reset();
                    errorDiv.empty();
                } else {
                    let htmlErrors = '<ul class="list-disc list-inside">';
                    if (body.errors && typeof body.errors === 'object') {
                        Object.entries(body.errors).forEach(([field, errorMessages]) =>
                            errorMessages.forEach(err => htmlErrors += `<li>${field !== '__all__' ? (body.errors[field].label || field) + ': ' : ''}${err.message || err}</li>`)
                        );
                    } else if (body.message) {
                        htmlErrors += `<li>${body.message}</li>`;
                    } else {
                        htmlErrors += `<li>An unknown error occurred (Status: ${status}).</li>`;
                    }
                    htmlErrors += '</ul>';
                    errorDiv.html(htmlErrors).addClass('p-3 bg-red-100 border border-red-300 rounded-md');
                }
            }).catch(error => {
                console.error('Error saving vehicle:', error);
                errorDiv.html('<p>A network or unexpected error occurred. Please try again.</p>')
                    .addClass('p-3 bg-red-100 border border-red-300 rounded-md');
            })
            .finally(() => {
                saveButton.prop('disabled', false).text('Save Vehicle');
            });
    });


    // --- Add Part Button & Modal Logic ---
    $('.sell-product-btn').on('click', function () {
        const sellProductForm = document.getElementById('sell-product-form-modal');
        if (sellProductForm) {
            sellProductForm.reset();
        }

        if (sellProductElement.length) {
            if ($.fn.select2 && sellProductElement.data('select2')) {
                sellProductElement.val(null).trigger('change.select2');
            } else {
                sellProductElement.val('');
                sellProductElement.trigger('change');
            }
        }
        if (sellPriceInput.length) {
            sellPriceInput.val('');
        }
        setPartButtonLabel(sellProductElement.val());
        showModal('sellProductModal');
    });

    $('#sellProductModal, #machNewProductModal, #machNewServiceModal, #itemTypeModal').on('click', '[data-bs-dismiss="modal"]', function (e) {
        e.preventDefault();
        const modalEl = $(this).closest('.modal')[0];
        if (modalEl && modalEl.id) {
            hideModal(modalEl.id);
        }
    });

    const machServiceForm = document.getElementById('mach-service-form');
    const machProductForm = document.getElementById('mach-product-form');

    function resetMachServiceModal() {
        if (machServiceForm) {
            machServiceForm.reset();
        }
        $('#machServiceError').addClass('d-none').text('');
        $('#machServiceSuccess').addClass('d-none').text('');
    }

    function resetMachProductModal() {
        if (machProductForm) {
            machProductForm.reset();
        }
        $('#machProductError').addClass('d-none').text('');
        $('#machProductSuccess').addClass('d-none').text('');
        const itemTypeSelect = $('#mach_product_item_type');
        if (itemTypeSelect.length) {
            itemTypeSelect.val('inventory');
            toggleProductStockFields(itemTypeSelect.val());
        }
    }

    function toggleProductStockFields(itemType) {
        const stockGroup = $('#mach_product_stock_group');
        if (!stockGroup.length) {
            return;
        }
        if (itemType === 'non_inventory') {
            stockGroup.hide();
            stockGroup.find('input').val('');
        } else {
            stockGroup.show();
        }
    }

    $('#mach_product_item_type').on('change', function () {
        toggleProductStockFields($(this).val());
    });

    $('#openMachServiceFormBtn').on('click', function (e) {
        e.preventDefault();
        resetMachServiceModal();
        showModal('machNewServiceModal');
    });

    $('#machSaveServiceBtn').on('click', async function () {
        const errorBox = $('#machServiceError');
        const successBox = $('#machServiceSuccess');
        errorBox.addClass('d-none').text('');
        successBox.addClass('d-none').text('');

        const formData = machServiceForm ? new FormData(machServiceForm) : new FormData();
        const jobNameVal = (formData.get('job_name') || '').trim();
        const descriptionVal = (formData.get('description') || '').trim();
        const notesVal = (formData.get('notes') || '').trim();
        const fixedHoursVal = (formData.get('fixed_hours') || '').trim();
        const fixedRateVal = (formData.get('fixed_rate') || '').trim();
        const dueMonthsVal = (formData.get('due_after_months') || '').trim();
        const dueKmVal = (formData.get('due_after_kilometers') || '').trim();

        if (!jobNameVal) {
            errorBox.removeClass('d-none').text('Job name is required.');
            $('#mach_service_job_name').trigger('focus');
            return;
        }
        if (!descriptionVal) {
            errorBox.removeClass('d-none').text('Description is required.');
            $('#mach_service_description').trigger('focus');
            return;
        }
        if (fixedRateVal) {
            const numericRate = Number(fixedRateVal);
            if (!isFinite(numericRate) || numericRate < 0) {
                errorBox.removeClass('d-none').text('Fixed rate must be a non-negative number.');
                $('#mach_service_fixed_rate').trigger('focus');
                return;
            }
        }

        const btn = $(this);
        btn.prop('disabled', true).text('Saving...');

        try {
            const response = await fetch(createServiceUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify({
                    job_name_id: '',
                    job_name: jobNameVal,
                    description: descriptionVal,
                    notes: notesVal,
                    fixed_hours: fixedHoursVal,
                    fixed_rate: fixedRateVal,
                    due_after_kilometers: dueKmVal || '',
                    due_after_months: dueMonthsVal || '',
                }),
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                throw new Error(data.error || 'Could not save service.');
            }

            const serviceData = data.service || {};
            const jobData = serviceData.job_name || { id: '', name: jobNameVal };
            const descriptionData = {
                id: serviceData.id,
                text: serviceData.description || descriptionVal,
                notes: serviceData.notes || notesVal,
                fixed_hours: serviceData.fixed_hours !== undefined && serviceData.fixed_hours !== null
                    ? String(serviceData.fixed_hours)
                    : (fixedHoursVal || ''),
                fixed_rate: serviceData.fixed_rate !== undefined && serviceData.fixed_rate !== null
                    ? String(serviceData.fixed_rate)
                    : (fixedRateVal || ''),
                due_after_kilometers: serviceData.due_after_kilometers !== undefined && serviceData.due_after_kilometers !== null
                    ? String(serviceData.due_after_kilometers)
                    : (dueKmVal || ''),
                due_after_months: serviceData.due_after_months !== undefined && serviceData.due_after_months !== null
                    ? String(serviceData.due_after_months)
                    : (dueMonthsVal || ''),
            };

            upsertJobCatalogEntry(jobData, descriptionData);
            refreshJobNameOptions();

            const resolvedJobId = jobData.id !== undefined && jobData.id !== null && jobData.id !== '' ? String(jobData.id) : jobData.name;
            jobNameSelect.val(resolvedJobId).trigger('change');
            jobNameSelect.removeClass('is-invalid');

            jobDescriptionInput.val(descriptionData.text).data('selectedServiceId', descriptionData.id ? String(descriptionData.id) : '').data('serviceEdited', false);
            jobDescriptionInput.data('dueMonths', descriptionData.due_after_months || '');
            jobDescriptionInput.data('dueKilometers', descriptionData.due_after_kilometers || '');
            jobDescriptionInput.data('notes', descriptionData.notes || '');
            jobDescriptionInput.removeClass('is-invalid');
            if (jobFixedHoursInput.length) {
                jobFixedHoursInput.val(formatFixedHoursDisplay(descriptionData.fixed_hours));
                const hasFixedHours = descriptionData.fixed_hours !== undefined && descriptionData.fixed_hours !== null && String(descriptionData.fixed_hours) !== '';
                const hasFixedRate = descriptionData.fixed_rate !== undefined && descriptionData.fixed_rate !== null && String(descriptionData.fixed_rate) !== '';
                jobFixedHoursInput.data('autoFixedHours', !hasFixedHours && hasFixedRate);
                jobFixedHoursInput.data('userEdited', false);
            }
            if (jobDueMonthsInput.length) {
                jobDueMonthsInput.val(descriptionData.due_after_months || '');
            }
            if (jobDueKilometersInput.length) {
                jobDueKilometersInput.val(descriptionData.due_after_kilometers || '');
            }

            if (jobDescriptionSelect.length && jobDescriptionSelect.is('select')) {
                const valueToUse = descriptionData.id ? String(descriptionData.id) : descriptionData.text;
                let existingOption = jobDescriptionSelect.find(`option[value="${valueToUse}"]`);
                if (!existingOption.length && valueToUse) {
                    const opt = new Option(descriptionData.text || valueToUse, valueToUse, true, true);
                    jobDescriptionSelect.append(opt);
                }
                jobDescriptionSelect.val(valueToUse || '');
                jobDescriptionSelect.trigger('change');
            }

            const details = [];
            if (descriptionData.notes) {
                details.push(descriptionData.notes);
            }
            const dueSummary = formatDueSummaryDisplay(descriptionData.due_after_months, descriptionData.due_after_kilometers);
            if (dueSummary) {
                details.push(dueSummary);
            }
            if (details.length) {
                jobDescriptionNotes.text(details.join(' - ')).show();
            } else {
                jobDescriptionNotes.hide().text('');
            }

            refreshLineItemSelectOptions();
            if (activeLineItemRow && activeLineItemRow.length) {
                const newServiceId = String(serviceData.id || '');
                if (newServiceId) {
                    const select = activeLineItemRow.find('.qb-item-select');
                    select.val(`service:${newServiceId}`).trigger('change.select2');
                }
                activeLineItemRow = null;
            }
            successBox.removeClass('d-none').text('Service saved.');
            hideModal('machNewServiceModal');
        } catch (err) {
            errorBox.removeClass('d-none').text(err.message || 'Could not save service.');
        } finally {
            btn.prop('disabled', false).text('Save Service');
        }
    });

    $('#openMachProductFormBtn').on('click', function (e) {
        e.preventDefault();
        resetMachProductModal();
        showModal('machNewProductModal');
    });

    $('#machSaveProductBtn').on('click', async function () {
        const errorBox = $('#machProductError');
        const successBox = $('#machProductSuccess');
        errorBox.addClass('d-none').text('');
        successBox.addClass('d-none').text('');

        const formData = machProductForm ? new FormData(machProductForm) : new FormData();
        const nameVal = (formData.get('name') || '').trim();
        const costVal = (formData.get('cost_price') || '').trim();
        const saleVal = (formData.get('sale_price') || '').trim();
        const stockVal = (formData.get('quantity_in_stock') || '').trim();
        const categoryVal = (formData.get('category') || '').trim();
        const skuVal = (formData.get('sku') || '').trim();
        const descriptionVal = (formData.get('description') || '').trim();
        const itemTypeVal = (formData.get('item_type') || 'inventory').toString();

        if (!nameVal) {
            errorBox.removeClass('d-none').text('Name is required.');
            $('#mach_product_name').trigger('focus');
            return;
        }

        formData.set('name', nameVal);
        formData.set('cost_price', costVal || '0');
        formData.set('sale_price', saleVal || '0');
        formData.set('sku', skuVal);
        formData.set('description', descriptionVal);
        formData.set('item_type', itemTypeVal);

        if (categoryVal) {
            formData.set('category', categoryVal);
        } else {
            formData.delete('category');
        }

        if (itemTypeVal === 'non_inventory') {
            formData.delete('quantity_in_stock');
        } else if (stockVal === '') {
            formData.delete('quantity_in_stock');
        } else {
            formData.set('quantity_in_stock', stockVal);
        }

        const btn = $(this);
        btn.prop('disabled', true).text('Saving...');
        try {
            const response = await fetch("{% url 'accounts:quick_create_inventory_product' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                const errors = data && data.errors ? data.errors : {};
                const msg = Object.values(errors).flat().join(' ') || data.error || 'Could not save product.';
                throw new Error(msg);
            }
            // add to select and select it
            const newOpt = new Option(data.product.display_name || data.product.name, data.product.id, true, true);
            $('#sell_product').append(newOpt).trigger('change');
            const newProductKey = String(data.product.id);
            productSalePrices[newProductKey] = {
                name: data.product.name || '',
                sku: data.product.sku || '',
                description: data.product.description || descriptionVal || '',
                price: String(data.product.sale_price || '0'),
                item_type: data.product.item_type || itemTypeVal || 'inventory'
            };
            refreshLineItemSelectOptions();
            if (activeLineItemRow && activeLineItemRow.length) {
                const select = activeLineItemRow.find('.qb-item-select');
                select.val(`product:${newProductKey}`).trigger('change.select2');
                activeLineItemRow = null;
            }
            successBox.removeClass('d-none').text('Product saved.');
            hideModal('machNewProductModal');
        } catch (err) {
            errorBox.removeClass('d-none').text(err.message || 'Could not save product.');
        } finally {
            btn.prop('disabled', false).text('Save Product');
        }
    });

    async function maybeUpdateProductPrice(productId, name, priceValue) {
        const info = normalizeProductInfo(productSalePrices[productId]);
        if (!productId || priceValue === '' || priceValue === undefined || priceValue === null) {
            return info.price;
        }
        const normalizedPrice = parseFloat(priceValue);
        if (!isFinite(normalizedPrice) || normalizedPrice < 0) {
            throw new Error('Enter a valid price for the part.');
        }
        const priceString = normalizedPrice.toFixed(2);
        if (info.price && priceString === info.price) {
            return priceString;
        }

        const payload = new FormData();
        payload.set('product_id', productId);
        payload.set('name', name || 'Updated Product');
        payload.set('sale_price', priceString);
        payload.set('cost_price', priceString);

        const response = await fetch("{% url 'accounts:quick_create_inventory_product' %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' },
            body: payload
        });
        const data = await response.json().catch(() => ({}));
        if (!response.ok || !data.success) {
            const errors = data && data.errors ? Object.values(data.errors).flat().join(' ') : (data.error || 'Could not update part price.');
            throw new Error(errors);
        }
        const updated = data.product || {};
        const existing = normalizeProductInfo(productSalePrices[productId]);
        productSalePrices[productId] = {
            name: updated.name || name || '',
            sku: updated.sku || existing.sku || '',
            description: updated.description || existing.description || '',
            price: String(updated.sale_price || priceString),
            item_type: updated.item_type || existing.item_type || 'inventory'
        };
        return productSalePrices[productId].price;
    }

    $('#add-sell-product').on('click', async function () {
        const productId = $('#sell_product').val();
        const quantityInput = $('#sell_quantity');
        const quantity = parseInt(quantityInput.val(), 10);
        const productInfo = productSalePrices[productId];
        const priceInputValue = sellPriceInput.length ? sellPriceInput.val() : '';

        if (!productId) { alert("Please select a product."); return; }
        if (isNaN(quantity) || quantity <= 0) {
            alert("Please enter a valid quantity.");
            quantityInput.focus(); return;
        }
        if (!productInfo) {
            alert("Error: Could not retrieve product details.");
            console.error("Missing productInfo for ID:", productId, "in:", productSalePrices); return;
        }

        let rate = priceInputValue || productInfo.price || '0.00';
        try {
            rate = await maybeUpdateProductPrice(productId, productInfo.name, rate);
        } catch (error) {
            alert(error.message || 'Could not update part price.');
            return;
        }

        addJobForm({
            itemKind: 'product',
            productId: productId,
            jobDescription: productInfo.name,
            qty: quantity,
            rate: parseFloat(rate).toFixed(2),
        });
        calculateTotal();
        hideModal('sellProductModal');
    });


    // --- Event handlers for toggles and inputs that affect totals ---
    $(document).on('change', '#toggle-shop-supply', function () {
        if ($(this).is(':checked')) {
            $('#shop-supply-section').slideDown();
            showShopSupplyForm();
        } else {
            $('#shop-supply-section').slideUp();
            hideShopSupplyForm();
        }
    });
    $(document).on('input change', '#shop-supply-value, input[name="shop_supply_type"], #shop-supply-reason', function () {
        if ($('#toggle-shop-supply').is(':checked')) {
            updateShopSupplyRowValues();
            calculateTotal();
        }
    });
    $(document).on('change', '#toggle-interest', function () {
        if ($(this).is(':checked')) {
            $('#interest-section').slideDown();
            showInterestForm();
        } else {
            $('#interest-section').slideUp();
            hideInterestForm();
        }
    });
    $(document).on('input change', '#interest-value, input[name="interest_type"], #interest-reason', function () {
        if ($('#toggle-interest').is(':checked')) {
            calculateTotal();
        }
    });
    $(document).on('change', '#toggle-discount', function () {
        if ($(this).is(':checked')) {
            $('#discount-section').slideDown();
            showDiscountForm();
        } else {
            $('#discount-section').slideUp();
            hideDiscountForm();
        }
    });
    $(document).on('input change', '#discount-value, input[name="discount_type"], #discount-reason', function () {
        if ($('#toggle-discount').is(':checked')) {
            updateDiscountRowValues();
            calculateTotal();
        }
    });

    $('#jobs').on('input', '.job-entry-row:not(.special-entry) input[name$="-qty"], .job-entry-row:not(.special-entry) input[name$="-rate"]', function () {
        handleRateEdit(this);
    });
    $('#jobs').on('change', 'input[name$="-DELETE"]', function () {
        calculateTotal();
    });


    // --- Initial setup on page load (MODIFIED) ---
    const initialCustomerId = customerSelect.val(); // Get ID of pre-selected customer (if any)
    // Get the initially selected vehicle ID from the Django form (if editing)
    // This assumes your Django form renders the 'vehicle' field with its current value.
    const initialVehicleId = "{{ grouped_invoice_form.vehicle.value|default:''|escapejs }}";
    const initialMileage = $('#id_mileage').length ? "{{ grouped_invoice_form.mileage.value|default:''|escapejs }}" : null;
    const initialVehicleFieldValues = [
        $('#id_vin_no').val(),
        $('#id_unit_no').val(),
        $('#id_make_model').val(),
        $('#id_license_plate').val(),
    ];
    preserveVehicleFieldsOnLoad = initialVehicleFieldValues.some(function (value) {
        return value !== null && value !== undefined && value.toString().trim() !== '';
    });


    if (initialCustomerId) {
        // Customer is pre-selected (edit mode or form reload with error)
        const customer = customerData[initialCustomerId];
        if (customer) { // Populate customer details
            $('#id_bill_to').val(customer.name);
            $('#id_bill_to_email').val(customer.email);
            $('#id_bill_to_address').val(customer.address);
            selectedRate = customer.rate;
            if (selectedRate) {
                $('#jobs .job-entry-row:not(.special-entry) input[name$="-rate"][data-auto-rate="1"]:not([readonly])').each(function () {
                    if (!$(this).val() || $(this).val() === "0.00") { // Apply only if not already set or 0
                        $(this).val(selectedRate);
                        // updateRowAmount is called by calculateTotal later or handleRateEdit
                    }
                });
            }
        }
        // Load vehicles for this customer and try to select the initialVehicleId
        loadVehicles(initialCustomerId, initialVehicleId, { autoPromptEmpty: false });
        $('#btnOpenAddVehicleModal').prop('disabled', false); // Enable add vehicle button
    } else {
        // No customer pre-selected (new form)
        $('#btnOpenAddVehicleModal').prop('disabled', true);
        vehicleSelect.html('<option value=""> Select vehicle </option>').prop('disabled', true).val(null).trigger('change');
    }

    // Restore mileage if it was set by Django form (important for edit view)
    if ($('#id_mileage').length && initialMileage !== null && initialMileage !== '') {
        $('#id_mileage').val(initialMileage);
    }

    // Pre-check toggles based on existing special rows (your existing logic)
    const initialShopSupplyRow = $('.shop-supply').first();
    if (initialShopSupplyRow.length > 0 && !initialShopSupplyRow.find('input[name$="-DELETE"]').first().is(':checked')) {
        $('#toggle-shop-supply').prop('checked', true); $('#shop-supply-section').show();
    } else { hideShopSupplyForm(); }

    const initialDiscountRow = $('.discount').first();
    if (initialDiscountRow.length > 0 && !initialDiscountRow.find('input[name$="-DELETE"]').first().is(':checked')) {
        $('#toggle-discount').prop('checked', true); $('#discount-section').show();
    } else { hideDiscountForm(); }

    const initialInterestRow = $('.interest').first();
    if (initialInterestRow.length > 0 && !initialInterestRow.find('input[name$="-DELETE"]').first().is(':checked')) {
        $('#toggle-interest').prop('checked', true); $('#interest-section').show();
    } else { hideInterestForm(); }

    const documentId = currentDocumentId;
    const sendBtn = document.getElementById('qb-send-btn');
    const saveBtn = document.getElementById('qb-save-btn');
    const saveSendBtn = document.getElementById('qb-save-send-btn');
    const cancelBtn = document.getElementById('qb-cancel-btn');
    const clearBtn = document.getElementById('qb-clear-btn');
    const toast = document.getElementById('qb-send-toast');
    const paymentHistoryToggle = document.getElementById('qb-payment-history-toggle');
    const paymentHistoryPanel = document.getElementById('qb-payment-history');
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    const emailInput = document.getElementById('id_bill_to_email');
    const dashboardUrl = "{% if documentType == 'invoice' %}{% url 'accounts:groupedinvoice_list' %}{% else %}{% url 'accounts:estimate_list' %}{% endif %}";
    const formElement = document.getElementById('grouped-invoice-form');
    const redirectDashboardInput = document.getElementById('redirect-dashboard');
    const saveSendFlag = document.getElementById('qb-save-send-flag');
    const newDocumentUrl = "{% url 'accounts:add_dailylog' %}?type={{ documentType }}";
    let formIsDirty = false;
    let quickAddSubmitInProgress = false;

    function getDisplayBalanceDue() {
        if (currentDocumentType === 'invoice' && currentDocumentId) {
            return serverBalanceDue;
        }
        const totalPaidValue = isNaN(invoiceTotalPaid) ? 0 : invoiceTotalPaid;
        const computed = latestGrandTotal - totalPaidValue;
        return computed > 0 ? computed : 0;
    }

    if (formElement) {
        formElement.addEventListener('submit', function () {
            updateLineRowNumbers();
        }, true);
        formElement.addEventListener('change', function () { formIsDirty = true; }, true);
        formElement.addEventListener('input', function () { formIsDirty = true; }, true);
        formElement.addEventListener('submit', function (event) {
            if (!saveSendFlag) { return; }
            const submitter = event.submitter;
            const isSaveSend = submitter && submitter.id === 'qb-save-send-btn';
            saveSendFlag.value = isSaveSend ? '1' : '';
            if (!isSaveSend) {
                sessionStorage.removeItem('qb_auto_send');
            }
        });
        formElement.addEventListener('submit', async function (event) {
            if (quickAddSubmitInProgress) {
                quickAddSubmitInProgress = false;
                return;
            }
            const quickAddRows = $('#jobs .job-entry-row').not('.special-entry').filter(function () {
                return !!$(this).data('quickAddType');
            });
            if (!quickAddRows.length) {
                return;
            }
            event.preventDefault();
            event.stopImmediatePropagation();
            quickAddSubmitInProgress = true;
            const submitter = event.submitter;
            const savedOk = await persistQuickAddRows();
            if (!savedOk) {
                quickAddSubmitInProgress = false;
                return;
            }
            if (formElement.requestSubmit) {
                if (submitter) {
                    formElement.requestSubmit(submitter);
                } else {
                    formElement.requestSubmit();
                }
            } else if (submitter && typeof submitter.click === 'function') {
                submitter.click();
            } else {
                formElement.submit();
            }
        }, true);
    }

    window.handleCancelClick = function (event) {
        if (event) {
            event.preventDefault();
        }
        if (formIsDirty) {
            const wantsSave = window.confirm('You have unsaved changes. Save before leaving?');
            if (wantsSave) {
                if (redirectDashboardInput) {
                    redirectDashboardInput.value = '1';
                }
                if (formElement) {
                    if (formElement.requestSubmit && saveBtn) {
                        formElement.requestSubmit(saveBtn);
                    } else {
                        formElement.submit();
                    }
                }
                return false;
            }
        }
        window.location.href = dashboardUrl;
        return false;
    };

    window.handleClearClick = function (event) {
        if (event) {
            event.preventDefault();
        }
        if (window.confirm('Clear unsaved changes?')) {
            window.location.reload();
        }
        return false;
    };

    function showToast(message, type) {
        if (!toast) { return; }
        toast.textContent = message;
        toast.classList.remove('is-success', 'is-error');
        if (type) { toast.classList.add(type); }
        toast.style.display = 'block';
        setTimeout(function () {
            toast.style.display = 'none';
        }, 4200);
    }

    async function sendDocumentEmail() {
        if (!sendBtn) { return false; }
        const sendUrl = sendBtn.dataset.sendUrl;
        if (!sendUrl) {
            showToast('Save this {{ documentType|title|lower }} first to enable sending.', 'is-error');
            return false;
        }
        const recipient = emailInput ? (emailInput.value || '').trim() : '';
        if (!recipient) {
            showToast('Add a customer email before sending.', 'is-error');
            return false;
        }
        sendBtn.disabled = true;
        const originalText = sendBtn.textContent;
        sendBtn.textContent = 'Sending...';
        try {
            let iframe = document.getElementById('qb-email-target');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'qb-email-target';
                iframe.name = 'qb-email-target';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }

            const formEl = document.createElement('form');
            formEl.method = 'POST';
            formEl.action = sendUrl;
            formEl.target = 'qb-email-target';
            formEl.style.display = 'none';

            const csrfValue = csrfToken ? csrfToken.value : '';
            if (!csrfValue) {
                throw new Error('Missing CSRF token');
            }

            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfValue;
            formEl.appendChild(csrfInput);

            const includeInput = document.createElement('input');
            includeInput.type = 'hidden';
            includeInput.name = 'include_workorder';
            includeInput.value = '0';
            formEl.appendChild(includeInput);

            document.body.appendChild(formEl);
            formEl.submit();
            formEl.remove();

            showToast('{{ documentType|title }} email sent.', 'is-success');
            return true;
        } catch (err) {
            showToast('Email could not be sent. Check the email address and try again.', 'is-error');
            return false;
        } finally {
            setTimeout(() => {
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
            }, 900);
        }
    }

    if (sendBtn) {
        sendBtn.addEventListener('click', function () {
            sendDocumentEmail();
        });
    }

    if (paymentHistoryToggle && paymentHistoryPanel) {
        paymentHistoryToggle.addEventListener('click', function (event) {
            event.preventDefault();
            const isVisible = paymentHistoryPanel.style.display === 'block';
            paymentHistoryPanel.style.display = isVisible ? 'none' : 'block';
            paymentHistoryToggle.setAttribute('aria-expanded', (!isVisible).toString());
        });

        document.addEventListener('click', function (event) {
            if (!paymentHistoryPanel.contains(event.target) && event.target !== paymentHistoryToggle) {
                paymentHistoryPanel.style.display = 'none';
                paymentHistoryToggle.setAttribute('aria-expanded', 'false');
            }
        });
    }

    const invoicePaymentModal = document.getElementById('invoicePaymentModal');
    const invoicePaymentForm = document.getElementById('invoice-payment-form');
    const invoicePaymentAmount = document.getElementById('invoice-payment-amount');
    const invoicePaymentDate = document.getElementById('invoice-payment-date');
    const invoicePaymentMethod = document.getElementById('invoice-payment-method');
    const invoicePaymentNotes = document.getElementById('invoice-payment-notes');
    const invoicePaymentBalance = document.getElementById('invoice-payment-balance');
    const invoicePaymentError = document.getElementById('invoice-payment-error');
    const invoicePaymentTitle = document.getElementById('invoicePaymentModalLabel');

    function prepareInvoicePaymentModal(triggerEl) {
        const actionUrl = triggerEl ? triggerEl.getAttribute('data-action-url') : '';
        const balanceAttr = triggerEl ? triggerEl.getAttribute('data-balance') : '';
        const invoiceNumber = triggerEl ? triggerEl.getAttribute('data-invoice-number') : '';
        const headerBalanceText = document.getElementById('balance-due-amount')?.textContent || '';
        const balanceValue = balanceAttr
            ? parseMoneyValue(balanceAttr)
            : (headerBalanceText ? parseMoneyValue(headerBalanceText) : getDisplayBalanceDue());

        if (actionUrl) {
            invoicePaymentForm.action = actionUrl;
        }
        if (invoicePaymentAmount) invoicePaymentAmount.value = balanceValue.toFixed(2);
        if (invoicePaymentBalance) {
            invoicePaymentBalance.textContent = formatCurrency(balanceValue);
        }

        const today = invoicePaymentModal.getAttribute('data-today');
        if (invoicePaymentDate) invoicePaymentDate.value = invoicePaymentDate.value || today;
        if (invoicePaymentMethod) invoicePaymentMethod.selectedIndex = 0;
        if (invoicePaymentNotes) invoicePaymentNotes.value = '';
        if (invoicePaymentTitle) {
            invoicePaymentTitle.textContent = invoiceNumber ? `Record Payment for ${invoiceNumber}` : 'Record Payment';
        }
        if (invoicePaymentError) {
            invoicePaymentError.classList.add('d-none');
            invoicePaymentError.textContent = '';
        }
    }

    if (invoicePaymentModal && invoicePaymentForm) {
        $('#invoicePaymentModal').on('show.bs.modal', function (event) {
            prepareInvoicePaymentModal(event.relatedTarget);
        });

        invoicePaymentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (invoicePaymentError) {
                invoicePaymentError.classList.add('d-none');
                invoicePaymentError.textContent = '';
            }
            const fd = new FormData(invoicePaymentForm);

            fetch(invoicePaymentForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken ? csrfToken.value : '',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: fd,
                credentials: 'same-origin',
            })
                .then(r => r.json())
                .then(data => {
                    if (data.status !== 'success') {
                        throw new Error(data.message || 'Unable to save payment.');
                    }
                    const balanceValue = parseMoneyValue(data.balance_due);
                    if (pageShell) {
                        pageShell.dataset.balanceDue = balanceValue.toFixed(2);
                    }
                    serverBalanceDue = balanceValue;
                    $('#balance-due-amount').text(formatCurrency(balanceValue));
                    if (latestGrandTotal && balanceValue <= latestGrandTotal) {
                        invoiceTotalPaid = latestGrandTotal - balanceValue;
                    } else {
                        invoiceTotalPaid = (invoiceTotalPaid || 0) + parseMoneyValue(fd.get('amount'));
                    }
                    if (receivePaymentBtn) {
                        receivePaymentBtn.setAttribute('data-balance', balanceValue.toFixed(2));
                    }
                    if (pageShell) {
                        pageShell.dataset.totalPaid = String(invoiceTotalPaid);
                    }
                    calculateTotal();
                    hideModal('invoicePaymentModal');
                    showToast('Payment recorded.', 'is-success');
                })
                .catch(err => {
                    if (invoicePaymentError) {
                        invoicePaymentError.textContent = err.message || 'Unable to save payment.';
                        invoicePaymentError.classList.remove('d-none');
                    }
                });
        });
    }
    if (receivePaymentBtn && invoicePaymentModal) {
        receivePaymentBtn.addEventListener('click', function () {
            prepareInvoicePaymentModal(receivePaymentBtn);
        });
    }

    if (saveSendBtn) {
        saveSendBtn.addEventListener('click', function (event) {
            if (!formElement) { return; }
            event.preventDefault();
            if (saveSendFlag) {
                saveSendFlag.value = '1';
            }
            sessionStorage.setItem('qb_auto_send', '1');
            if (formElement.requestSubmit) {
                formElement.requestSubmit(saveSendBtn);
            } else {
                formElement.submit();
            }
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', window.handleCancelClick);
    }

    if (clearBtn) {
        clearBtn.addEventListener('click', window.handleClearClick);
    }

    const extraFieldsWrap = document.querySelector('.extra-fields-wrap');
    const extraFieldsTrigger = document.querySelector('.extra-fields-trigger');
    if (extraFieldsWrap && extraFieldsTrigger) {
        extraFieldsTrigger.addEventListener('click', function (event) {
            event.preventDefault();
            extraFieldsWrap.classList.toggle('is-open');
        });
        document.addEventListener('click', function (event) {
            if (!extraFieldsWrap.contains(event.target)) {
                extraFieldsWrap.classList.remove('is-open');
            }
        });
    }

    const saveSendGroup = document.getElementById('qb-save-send-group');
    const saveSendToggle = document.getElementById('qb-save-send-toggle');
    if (saveSendGroup && saveSendToggle) {
        const saveSendMenu = saveSendGroup.querySelector('.qb-split-menu');
        const saveAndNewBtn = saveSendGroup.querySelector('button[name="save_continue"]');

        saveSendToggle.addEventListener('click', function (event) {
            event.preventDefault();
            event.stopPropagation();
            const isOpen = saveSendGroup.classList.toggle('is-open');
            saveSendToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
            if (saveSendMenu) {
                saveSendMenu.style.display = isOpen ? 'block' : 'none';
            }
        });
        saveSendGroup.querySelectorAll('.qb-split-item').forEach(function (item) {
            item.addEventListener('click', function () {
                saveSendGroup.classList.remove('is-open');
                saveSendToggle.setAttribute('aria-expanded', 'false');
                if (saveSendMenu) {
                    saveSendMenu.style.display = 'none';
                }
            });
        });
        document.addEventListener('click', function (event) {
            if (!saveSendGroup.contains(event.target)) {
                saveSendGroup.classList.remove('is-open');
                saveSendToggle.setAttribute('aria-expanded', 'false');
                if (saveSendMenu) {
                    saveSendMenu.style.display = 'none';
                }
            }
        });

    }

    function syncShopSupplyInputMeta() {
        const valueInput = $('#shop-supply-value');
        if (!valueInput.length) {
            return;
        }
        const supplyType = $('input[name="shop_supply_type"]:checked').val() || 'percentage';
        if (supplyType === 'percentage') {
            valueInput.attr('max', '100');
        } else {
            valueInput.removeAttr('max');
        }
    }
    syncShopSupplyInputMeta();
    $('input[name="shop_supply_type"]').on('change', syncShopSupplyInputMeta);

    if (documentId && sessionStorage.getItem('qb_auto_send') === '1') {
        sessionStorage.removeItem('qb_auto_send');
        sendDocumentEmail();
    }

    calculateTotal(); // Final calculation after all initial setup
    toggleNoJobsMessage();

});

    (function () {
        try {
            const params = new URLSearchParams(window.location.search);
            if (!params.has('tour')) return;
            const tour = new Shepherd.Tour({ defaultStepOptions: { cancelIcon: { enabled: true }, scrollTo: true } });
            tour.addStep({ title: 'Direct Invoice', text: 'This creates an invoice directly without a workorder.', attachTo: { element: '#invoice-tab', on: 'bottom' }, buttons: [{ text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Invoice Form', text: 'Fill out invoice details and add job lines here.', attachTo: { element: '#grouped-invoice-form', on: 'top' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Done', action: tour.complete }] });
            tour.start();
        } catch (e) { }
    })();
</script>
{% endblock %}
