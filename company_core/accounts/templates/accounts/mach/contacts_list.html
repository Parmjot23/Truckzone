{% extends 'accounts/mach/mach_portal_base.html' %}
{% block title %}Contact Messages{% endblock %}
{% block extra_css %}
  {{ block.super }}
  {% include 'accounts/communications/_comm_styles.html' %}
{% endblock %}
{% block content %}
<div class="comm-wrapper container-fluid">
  <div class="comm-header">
    <div>
      <div class="eyebrow">Communication hub</div>
      <h1>Contact messages</h1>
      <p class="comm-subtitle">Review inbound messages from the website and portal.</p>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <a class="pill" href="{% url 'accounts:communication_hub' %}">
        <i class="fa-solid fa-tower-broadcast"></i>
        Hub overview
      </a>
      <a class="pill pill-primary" href="{% url 'accounts:appointments_list' %}">
        <i class="fa-regular fa-calendar-check"></i>
        Manage appointments
      </a>
    </div>
  </div>

  <div class="mt-3">
    {% include 'accounts/communications/_comm_nav.html' %}
  </div>

  <div class="row g-3 mt-2">
    <div class="col-12">
      <div class="comm-card">
        <div class="comm-card-header">
          <div>
            <h3>Inbox</h3>
            <p>Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} messages.</p>
          </div>
          <span class="badge-soft {% if contact_messages %}badge-soft-primary{% else %}badge-soft-green{% endif %}">
            {{ contact_messages|length }} on this page
          </span>
        </div>
        {% if contact_messages %}
        <div class="table-responsive">
          <table class="table table-sm align-middle comm-table mb-0">
            <thead>
              <tr>
                <th scope="col">Received</th>
                <th scope="col">Sender</th>
                <th scope="col">Topic</th>
                <th scope="col">Source</th>
                <th scope="col">Status</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              {% for m in contact_messages %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ m.created_at|date:'M d, Y' }}</div>
                  <div class="text-muted small">{{ m.created_at|date:'g:i a' }}</div>
                </td>
                <td>
                  <div class="fw-bold">{{ m.full_name }}</div>
                  <div class="text-muted small">{{ m.email }}</div>
                  <div class="text-muted small">{{ m.phone|default:'N/A' }}</div>
                </td>
                <td>
                  <div class="fw-semibold">{{ m.get_message_type_display }}</div>
                  <div class="text-muted small">{{ m.subject|default:'No subject' }}</div>
                  <div class="mt-1">
                    {% if m.service_type %}
                      <span class="badge-soft badge-soft-amber">{{ m.get_service_type_display }}</span>
                    {% endif %}
                  </div>
                </td>
                <td>{{ m.get_source_display }}</td>
                <td>
                  <span class="status-pill {% if m.status == 'new' %}status-new{% else %}status-open{% endif %}">
                    <span class="dot"></span>
                    {{ m.get_status_display }}
                  </span>
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'accounts:contacts_detail' m.pk %}">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if is_paginated %}
        <nav class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3" aria-label="Messages pagination">
          <div class="text-muted small">
            {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
          </div>
          <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">First</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">First</span></li>
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}
            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">Last</span></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="comm-empty">No contact messages yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
