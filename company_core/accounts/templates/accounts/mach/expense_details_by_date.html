{% extends "accounts/mach/mach_portal_base.html" %}
{% block title %}
    Expense Details - {{ specific_date }}
{% endblock %}
{% block content %}
<div class="container">
    <h3>Expenses on {{ specific_date|date:"Y-m-d" }}</h3>
    <a href="{% url 'accounts:tables' %}?month={{ month_selected }}" class="btn btn-secondary mb-3">Back to Detailed Expenses</a>

    <!-- Download Option -->
    <div class="mb-4 mt-3">
        <form method="get" action="{% if portal_read_only %}{% url 'accounts:accountant_portal_download_report' %}{% else %}{% url 'accounts:download_report' %}{% endif %}">
            <input type="hidden" name="format" value="excel"> <!-- or 'pdf' -->
            <input type="hidden" name="report_type" value="detailed_expense_date">
            <input type="hidden" name="date" value="{{ specific_date|date:'Y-m-d' }}">
            <input type="hidden" name="month" value="{{ month_selected }}">
            <button type="submit" class="btn btn-success">Download This Report</button>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover" id="expense-details-table">
            <thead class="thead-dark">
                <tr>
                    <th>Time</th>
                    <th>Receipt No</th>
                    <th>Tax</th>
                    <th>Total Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for receipt in expense_receipts %}
                <tr>
                    <td>
                        {% if receipt.receipt_date %}
                          {{ receipt.receipt_date|date:"Y-m-d" }}
                        {% else %}
                          {{ specific_date|date:"Y-m-d" }}
                        {% endif %}
                    </td>
                    <td>
                        {% if receipt.mech_expense_id %}
                          <a href="{% url 'accounts:mechexpense_detail' receipt.mech_expense_id %}">
                             {{ receipt.receipt_no|default:"(no receipt)" }}
                          </a>
                        {% else %}
                          <span class="text-muted">Missing receipt</span>
                        {% endif %}
                    </td>
                    <td>{{ receipt.total_tax|default:0|floatformat:2 }}</td>
                    <td>{{ receipt.total_amount|default:0|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="text-center text-muted">No expenses found for this date.</td>
                </tr>
                {% endfor %}
            </tbody>
        <tfoot class="table-secondary">
            <tr>
                <th colspan="2" class="text-start">Totals</th>
                <th id="total-tax" class="text-start">0.00</th>
                <th id="total-amount" class="text-start">0.00</th>
            </tr>
        </tfoot>

        </table>
    </div>

    <!-- JavaScript to Calculate Totals -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Select the table by its ID
            const table = document.getElementById('expense-details-table');
            if (!table) return; // Exit if the table is not found

            let totalTax = 0;
            let totalAmount = 0;

            // Select all rows within the tbody
            const tbody = table.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                // Assuming the 3rd and 4th cells contain Tax and Total Amount
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4) {
                    // Parse the text content to float, removing any non-numeric characters
                    const taxText = cells[2].textContent.trim().replace(/[^0-9.-]+/g,"");
                    const amountText = cells[3].textContent.trim().replace(/[^0-9.-]+/g,"");

                    const tax = parseFloat(taxText) || 0;
                    const amount = parseFloat(amountText) || 0;

                    totalTax += tax;
                    totalAmount += amount;
                }
            });

            // Update the totals in the <tfoot> of the table
            document.getElementById('total-tax').textContent = totalTax.toFixed(2);
            document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
        });
    </script>

    <!-- Custom Styling for Totals Row -->
    <style>
        /* Highlight the totals row */
        #expense-details-table tfoot tr {
            background-color: #f1f1f1;
            font-weight: bold;
        }

        /* Align the Totals label to the left */
        #expense-details-table tfoot .totals-label {
            text-align: left;
        }

        /* Align the Totals values to the right */
        #expense-details-table tfoot .totals-value {
            text-align: right;
        }
    </style>
</div>
{% endblock %}
