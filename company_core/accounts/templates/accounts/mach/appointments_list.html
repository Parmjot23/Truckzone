{% extends 'accounts/mach/mach_portal_base.html' %}
{% load custom_filters %}
{% block title %}Appointments{% endblock %}
{% block extra_css %}
  {{ block.super }}
  {% include 'accounts/communications/_comm_styles.html' %}
{% endblock %}
{% block content %}
<div class="comm-wrapper container-fluid">
  <div class="comm-header">
    <div>
      <div class="eyebrow">Communication hub</div>
      <h1>Appointments</h1>
      <p class="comm-subtitle">Review booking requests and manage public booking windows.</p>
    </div>
    <div class="d-flex flex-wrap align-items-center gap-2">
      <a class="pill" href="{% url 'accounts:communication_hub' %}">
        <i class="fa-solid fa-tower-broadcast"></i>
        Hub overview
      </a>
      <button class="pill pill-primary" type="button" data-bs-toggle="modal" data-bs-target="#manageAppointmentsModal">
        <i class="fa-regular fa-calendar-check"></i>
        Manage appointments
      </button>
    </div>
  </div>

  <div class="mt-3">
    {% include 'accounts/communications/_comm_nav.html' %}
  </div>

  <div class="row g-3 mt-2">
    <div class="col-lg-8">
      <div class="comm-card h-100">
        <div class="comm-card-header">
          <div>
            <h3>Booking requests</h3>
            <p>Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} requests.</p>
          </div>
          <span class="badge-soft {% if bookings %}badge-soft-primary{% else %}badge-soft-green{% endif %}">
            {{ bookings|length }} on this page
          </span>
        </div>
        {% if bookings %}
        <div class="table-responsive">
          <table class="table table-sm align-middle comm-table mb-0">
            <thead>
              <tr>
                <th scope="col">Requested</th>
                <th scope="col">Customer</th>
                <th scope="col">Service</th>
                <th scope="col">Status</th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              {% for b in bookings %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ b.created_at|date:'M d, Y' }}</div>
                  <div class="text-muted small">{{ b.created_at|date:'g:i a' }}</div>
                </td>
                <td>
                  <div class="fw-bold">{{ b.full_name }}</div>
                  <div class="text-muted small">{{ b.email }}</div>
                  <div class="text-muted small">{{ b.phone|default:'N/A' }}</div>
                </td>
                <td>
                  <span class="badge-soft badge-soft-amber">{{ b.get_service_type_display }}</span>
                  <div class="small text-muted mt-1">
                    {% if b.preferred_datetime %}
                      {{ b.preferred_datetime|date:'M j, g:i a' }}
                    {% else %}
                      Preferred time: N/A
                    {% endif %}
                  </div>
                </td>
                <td>
                  <span class="status-pill {% if b.status == 'new' %}status-new{% elif b.status == 'scheduled' %}status-success{% elif b.status == 'processing' %}status-open{% else %}status-open{% endif %}">
                    <span class="dot"></span>
                    {{ b.get_status_display }}
                  </span>
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'accounts:appointments_detail' b.pk %}">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if is_paginated %}
        <nav class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-3" aria-label="Appointments pagination">
          <div class="text-muted small">
            {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }}
          </div>
          <ul class="pagination mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">First</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">First</span></li>
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
            {% endif %}
            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a></li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">Last</span></li>
            {% endif %}
          </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="comm-empty">No appointments yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="col-lg-4">
      <div class="comm-card mb-3">
        <div class="comm-card-header">
          <div>
            <h3>Booking settings</h3>
            <p>Public hours and slot length for online bookings.</p>
          </div>
          <button class="pill pill-ghost" type="button" data-bs-toggle="modal" data-bs-target="#manageAppointmentsModal">
            <i class="fa-solid fa-pen"></i>
            Edit
          </button>
        </div>
        <div class="comm-list">
          <div class="comm-list-item">
            <div>
              <h6 class="mb-1">Booking hours</h6>
              <p class="mb-0 text-muted small">
                {{ booking_settings.start_time|time:"g:i a" }} - {{ booking_settings.end_time|time:"g:i a" }}
              </p>
            </div>
          </div>
          <div class="comm-list-item">
            <div>
              <h6 class="mb-1">Slot length</h6>
              <p class="mb-0 text-muted small">{{ booking_settings.slot_interval_minutes }} minutes per slot</p>
            </div>
          </div>
        </div>
      </div>

      <div class="comm-card" id="holidays">
        <div class="comm-card-header">
          <div>
            <h3>Upcoming closures</h3>
            <p>Dates blocked from the public booking flow.</p>
          </div>
          <button class="pill pill-ghost" type="button" data-bs-toggle="modal" data-bs-target="#manageAppointmentsModal">
            <i class="fa-solid fa-plus"></i>
            Add closure
          </button>
        </div>
        {% if holidays %}
        <div class="table-responsive">
          <table class="table table-sm align-middle comm-table mb-0">
            <thead>
              <tr>
                <th style="width: 30%">Date</th>
                <th>Reason</th>
                <th style="width: 96px"></th>
              </tr>
            </thead>
            <tbody>
              {% for holiday in holidays %}
              <tr>
                <td>{{ holiday.date|date:'M d, Y' }}</td>
                <td>
                  <div class="fw-semibold">{{ holiday.reason|default:'N/A' }}</div>
                  <div class="small text-muted">{{ holiday.notes|default:'N/A' }}</div>
                </td>
                <td class="text-end">
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="delete_holiday">
                    <input type="hidden" name="holiday_id" value="{{ holiday.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Remove this holiday?');">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="comm-empty">No holidays added yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="manageAppointmentsModal" tabindex="-1" aria-labelledby="manageAppointmentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="manageAppointmentsModalLabel">Manage appointments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-light fw-semibold">Booking hours</div>
              <div class="card-body">
                <form method="post" novalidate>
                  {% csrf_token %}
                  <input type="hidden" name="form_type" value="settings">
                  {% if settings_form.non_field_errors %}
                    <div class="alert alert-danger">{{ settings_form.non_field_errors }}</div>
                  {% endif %}
                  <div class="mb-3">
                    <label class="form-label" for="id_start_time">Opens at</label>
                    {{ settings_form.start_time }}
                    {% if settings_form.start_time.errors %}
                      <div class="text-danger small">{{ settings_form.start_time.errors|striptags }}</div>
                    {% endif %}
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="id_end_time">Closes at</label>
                    {{ settings_form.end_time }}
                    {% if settings_form.end_time.errors %}
                      <div class="text-danger small">{{ settings_form.end_time.errors|striptags }}</div>
                    {% endif %}
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="id_slot_interval_minutes">Slot length (minutes)</label>
                    {{ settings_form.slot_interval_minutes }}
                    {% if settings_form.slot_interval_minutes.help_text %}
                      <div class="form-text">{{ settings_form.slot_interval_minutes.help_text }}</div>
                    {% endif %}
                    {% if settings_form.slot_interval_minutes.errors %}
                      <div class="text-danger small">{{ settings_form.slot_interval_minutes.errors|striptags }}</div>
                    {% endif %}
                  </div>
                  <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Save hours</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-light fw-semibold">Add holiday / closure</div>
              <div class="card-body">
                <form method="post" novalidate>
                  {% csrf_token %}
                  <input type="hidden" name="form_type" value="holiday">
                  {% if holiday_form.non_field_errors %}
                    <div class="alert alert-danger">{{ holiday_form.non_field_errors }}</div>
                  {% endif %}
                  <div class="mb-3">
                    <label class="form-label" for="id_date">Date</label>
                    {{ holiday_form.date }}
                    {% if holiday_form.date.errors %}
                      <div class="text-danger small">{{ holiday_form.date.errors|striptags }}</div>
                    {% endif %}
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="id_reason">Public reason</label>
                    {{ holiday_form.reason }}
                    <div class="form-text">Shown on the public booking page when customers choose this date.</div>
                    {% if holiday_form.reason.errors %}
                      <div class="text-danger small">{{ holiday_form.reason.errors|striptags }}</div>
                    {% endif %}
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="id_notes">Internal notes</label>
                    {{ holiday_form.notes }}
                    {% if holiday_form.notes.errors %}
                      <div class="text-danger small">{{ holiday_form.notes.errors|striptags }}</div>
                    {% endif %}
                  </div>
                  <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-outline-primary">Add holiday</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
