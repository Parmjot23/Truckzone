{% extends 'customer_portal_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Vehicle Dashboard - {{ vehicle }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% if messages %}
    <div class="row mb-3">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-lg-4 col-md-6">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body">
                    <h5 class="card-title mb-3">Vehicle Overview</h5>
                    <dl class="row mb-0 small">
                        <dt class="col-5">Customer</dt>
                        <dd class="col-7">{{ vehicle.customer.name }}</dd>
                        <dt class="col-5">VIN</dt>
                        <dd class="col-7">{{ vehicle.vin_number }}</dd>
                        <dt class="col-5">Unit</dt>
                        <dd class="col-7">{{ vehicle.unit_number|default:'—' }}</dd>
                        <dt class="col-5">License Plate</dt>
                        <dd class="col-7">{{ vehicle.license_plate|default:'—' }}</dd>
                        <dt class="col-5">Make / Model</dt>
                        <dd class="col-7">{{ vehicle.make_model|default:'—' }}</dd>
                        <dt class="col-5">Mileage</dt>
                        <dd class="col-7">
                            {% if vehicle.current_mileage is not None %}
                                {{ vehicle.current_mileage|intcomma }}
                            {% else %}
                                —
                            {% endif %}
                        </dd>
                    </dl>
                    <div class="mt-3 d-flex flex-wrap gap-2">
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMaintenanceModal">
                            <i class="fas fa-plus"></i> Add Maintenance
                        </button>
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#quickWorkOrderModal">
                            <i class="fas fa-clipboard-list"></i> Quick Work Order
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#importMaintenanceModal">
                            <i class="fas fa-file-import me-1"></i> Import Maintenance
                        </button>
                        <a class="btn btn-outline-secondary btn-sm" href="{% url 'accounts:vehicle_maintenance_template' vehicle.id %}">
                            <i class="fas fa-file-export me-1"></i> Download Maintenance Template
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-9 col-lg-8 col-md-6">
            <div class="row g-3">
                <div class="col-sm-6 col-lg-3">
                    <div class="card shadow-sm border-0 h-100 text-white" style="background: linear-gradient(135deg, #2563eb, #1d4ed8);">
                        <div class="card-body">
                            <div class="text-uppercase small mb-2">Upcoming Tasks</div>
                            <div class="display-6 fw-semibold">{{ summary.upcoming_count }}</div>
                            <div class="small text-white-50">Maintenance items scheduled or planned.</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card shadow-sm border-0 h-100 text-white" style="background: linear-gradient(135deg, #dc2626, #b91c1c);">
                        <div class="card-body">
                            <div class="text-uppercase small mb-2">Overdue</div>
                            <div class="display-6 fw-semibold">{{ summary.overdue_count }}</div>
                            <div class="small text-white-50">Requires immediate attention.</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card shadow-sm border-0 h-100" style="background: linear-gradient(135deg, #10b981, #059669); color: #fff;">
                        <div class="card-body">
                            <div class="text-uppercase small mb-2">Open Work Orders</div>
                            <div class="display-6 fw-semibold">{{ summary.open_workorders }}</div>
                            <div class="small text-white-50">Assigned to this vehicle.</div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <div class="text-uppercase small mb-2">Last Completed</div>
                            {% if summary.last_completed_task %}
                            <div class="fw-semibold">{{ summary.last_completed_task.title }}</div>
                            <div class="text-muted small">{{ summary.last_completed_date|date:'Y-m-d' }}</div>
                            {% else %}
                            <div class="fw-semibold">No history</div>
                            <div class="text-muted small">Complete a maintenance entry to populate history.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-xl-7">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Upcoming Maintenance</h5>
                    <span class="badge bg-primary">{{ upcoming_tasks|length }} Tasks</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Task</th>
                                    <th>Due</th>
                                    <th>Next Mileage</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Last Reminder Sent</th>
                                    <th>Linked WO</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in upcoming_tasks %}
                                <tr>
                                    <td>
                                        <div class="fw-semibold">{{ task.title }}</div>
                                        <div class="small text-muted">{{ task.description|default:'No description provided.' }}</div>
                                    </td>
                                    <td>
                                        {% if task.due_date %}
                                            <span class="badge {% if task.is_overdue %}bg-danger{% else %}bg-secondary{% endif %}">{{ task.due_date|date:'Y-m-d' }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.due_mileage %}
                                            <div class="fw-semibold">{{ task.due_mileage|intcomma }} km</div>
                                        {% else %}
                                            <span class="text-muted">Not set</span>
                                        {% endif %}
                                        {% if task.mileage_interval_display %}
                                            <div class="small text-muted">{{ task.mileage_interval_display }}</div>
                                        {% endif %}
                                        {% if task.next_due_mileage %}
                                            <div class="small text-muted">Next at {{ task.next_due_mileage|intcomma }} km</div>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-light text-dark text-uppercase">{{ task.get_priority_display }}</span></td>
                                    <td><span class="badge bg-info text-dark">{{ task.get_status_display }}</span></td>
                                    <td>
                                        {% if task.last_reminder_sent %}
                                            <div>{{ task.last_reminder_sent|date:'Y-m-d' }}</div>
                                            <div class="small text-muted">{{ task.last_reminder_sent|date:'g:i A' }}</div>
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.work_order %}
                                            <a href="{% url 'accounts:workorder_detail' task.work_order.id %}">WO #{{ task.work_order.id }}</a>
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if task.work_order %}
                                            <div class="text-start small text-muted mb-2">
                                                Work order <a href="{% url 'accounts:workorder_detail' task.work_order.id %}">#{{ task.work_order.id }}</a>
                                                &middot; Status: {{ task.work_order.get_status_display }}<br>
                                                Assigned to:
                                                {% with assignments=task.work_order.assignments.all %}
                                                    {% if assignments %}
                                                        {% for assignment in assignments %}
                                                            {{ assignment.mechanic.name }}{% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        Unassigned
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                        {% else %}
                                            <div class="btn-group btn-group-sm mb-2" role="group">
                                            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#quickWorkOrderModal" data-maintenance-id="{{ task.id }}">
                                                    <i class="fas fa-tools"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <form method="post" action="{% url 'accounts:vehicle_update_maintenance_status' task.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <input type="hidden" name="status" value="{{ task.STATUS_IN_PROGRESS }}">
                                                <button type="submit" class="btn btn-outline-secondary" title="Mark In Progress">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            </form>
                                            <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#completeTaskModal" data-complete-url="{% url 'accounts:vehicle_complete_maintenance' task.id %}" data-task-title="{{ task.title }}">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <form method="post" action="{% url 'accounts:vehicle_update_maintenance_status' task.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <input type="hidden" name="status" value="{{ task.STATUS_CANCELLED }}">
                                                <button type="submit" class="btn btn-outline-danger" title="Cancel Task">
                                                    <i class="fas fa-ban"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">No upcoming maintenance scheduled.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-0">Completed Maintenance</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Task</th>
                                    <th>Completed On</th>
                                    <th>Mileage</th>
                                    <th>Work Order</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in completed_tasks %}
                                <tr>
                                    <td>{{ task.title }}</td>
                                    <td>{{ task.completed_date|date:'Y-m-d' }}</td>
                                    <td>
                                        {% if task.actual_mileage is not None %}
                                            {{ task.actual_mileage|intcomma }}
                                        {% else %}
                                            —
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if task.work_order %}
                                            <a href="{% url 'accounts:workorder_detail' task.work_order.id %}">WO #{{ task.work_order.id }}</a>
                                        {% else %}
                                            <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ task.completion_notes|default:'—' }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">No completed maintenance recorded yet.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% if cancelled_tasks %}
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-0">Cancelled Maintenance</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for task in cancelled_tasks %}
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-semibold">{{ task.title }}</div>
                                <div class="small text-muted">Cancelled {{ task.updated_at|date:'Y-m-d' }}</div>
                            </div>
                            {% if task.work_order %}
                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'accounts:workorder_detail' task.work_order.id %}">View Work Order</a>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-xl-5">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-0">Work Orders</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for wo in work_orders %}
                        <a href="{% url 'accounts:workorder_detail' wo.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <div>
                                <div class="fw-semibold">WO #{{ wo.id }} &middot; {{ wo.description|default:'No description' }}</div>
                                <div class="small text-muted">Scheduled {{ wo.scheduled_date|date:'Y-m-d' }}</div>
                            </div>
                            <span class="badge bg-secondary text-uppercase">{{ wo.get_status_display }}</span>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-muted text-center py-4">No work orders associated with this vehicle.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-0">Parts Usage</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Work Order</th>
                                    <th>Part</th>
                                    <th class="text-end">Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in parts_usage %}
                                <tr>
                                    <td>{% if record.work_order %}<a href="{% url 'accounts:workorder_detail' record.work_order.id %}">WO #{{ record.work_order.id }}</a>{% else %}—{% endif %}</td>
                                    <td>
                                        {% if record.product %}
                                            {{ record.product.name }}
                                        {% else %}
                                            {{ record.job|default:'—'|linebreaksbr }}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ record.qty|default:'—' }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center text-muted py-3">No parts usage recorded.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-bottom-0">
                    <h5 class="mb-0">Job History from Invoices</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th class="text-end">Cost</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in job_history_list|slice:':10' %}
                                <tr>
                                    <td>{{ entry.job_date|date:'Y-m-d' }}</td>
                                    <td>{{ entry.description|truncatechars:60 }}</td>
                                    <td class="text-end">{{ entry.total_job_cost|default:0|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-center text-muted py-3">No historical jobs found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="small text-muted">Total jobs: {{ job_totals.job_count }} &middot; Total spend: ${{ job_totals.total_overall_cost|floatformat:2 }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Maintenance Modal -->
<div class="modal fade" id="addMaintenanceModal" tabindex="-1" aria-labelledby="addMaintenanceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="post" action="{% url 'accounts:vehicle_add_maintenance' vehicle.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="addMaintenanceModalLabel">Add Maintenance Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ maintenance_form.as_p }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Task</button>
      </div>
  </form>
  </div>
</div>

<!-- Import Maintenance Modal -->
<div class="modal fade" id="importMaintenanceModal" tabindex="-1" aria-labelledby="importMaintenanceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" enctype="multipart/form-data" action="{% url 'accounts:vehicle_maintenance_import' vehicle.id %}" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="importMaintenanceModalLabel">Import Maintenance Tasks</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Fill out the template with each task you want to schedule and upload it here.</p>
        <div class="mb-3">
          <label for="importMaintenanceFile" class="form-label">Excel File (.xlsx)</label>
          <input id="importMaintenanceFile" type="file" name="file" class="form-control" accept=".xlsx" required>
        </div>
        <p class="small mb-0">Need a template? <a href="{% url 'accounts:vehicle_maintenance_template' vehicle.id %}">Download it here.</a></p>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Upload</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Quick Work Order Modal -->
<div class="modal fade" id="quickWorkOrderModal" tabindex="-1" aria-labelledby="quickWorkOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{% url 'accounts:vehicle_quick_workorder' vehicle.id %}" class="modal-content" id="quickWorkOrderForm">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="quickWorkOrderModalLabel">Create Work Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ quick_workorder_form.scheduled_date.label_tag }}
        {{ quick_workorder_form.scheduled_date }}
        {{ quick_workorder_form.mechanics.label_tag }}
        {{ quick_workorder_form.mechanics }}
        {% if quick_workorder_form.mechanics.help_text %}
        <div class="form-text">{{ quick_workorder_form.mechanics.help_text }}</div>
        {% endif %}
        {{ quick_workorder_form.maintenance_task.label_tag }}
        {{ quick_workorder_form.maintenance_task }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Work Order</button>
      </div>
    </form>
  </div>
</div>

<!-- Complete Maintenance Modal -->
<div class="modal fade" id="completeTaskModal" tabindex="-1" aria-labelledby="completeTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content" id="completeTaskForm">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="completeTaskModalLabel">Complete Maintenance</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted" id="completeTaskSummary"></p>
        {{ completion_form.as_p }}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Mark Completed</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
    const completeTaskModal = document.getElementById('completeTaskModal');
    const completeTaskForm = document.getElementById('completeTaskForm');
    const completeTaskSummary = document.getElementById('completeTaskSummary');
    const quickWorkOrderModal = document.getElementById('quickWorkOrderModal');
    const quickMaintenanceSelect = document.getElementById('id_maintenance_task');

    document.querySelectorAll('[data-bs-target="#completeTaskModal"]').forEach(btn => {
        btn.addEventListener('click', () => {
            const url = btn.getAttribute('data-complete-url');
            const title = btn.getAttribute('data-task-title');
            if (completeTaskForm) {
                completeTaskForm.action = url;
            }
            if (completeTaskSummary) {
                completeTaskSummary.textContent = `Record completion details for "${title}".`;
            }
        });
    });

    document.querySelectorAll('[data-bs-target="#quickWorkOrderModal"]').forEach(btn => {
        btn.addEventListener('click', () => {
            const maintenanceId = btn.getAttribute('data-maintenance-id');
            if (quickMaintenanceSelect) {
                quickMaintenanceSelect.value = maintenanceId || '';
            }
        });
    });
})();
</script>
{% endblock %}
