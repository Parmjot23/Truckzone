{% extends "accountant/portal_base.html" %}
{% load form_tags %}

{% block title %}Payroll Deductions{% endblock %}

{% block extra_css %}
  <style>
    .accountant-section {
      margin-bottom: 1.5rem;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
      font-size: 0.75rem;
      font-weight: 700;
      background: rgba(14, 165, 233, 0.12);
      color: var(--accountant-accent-strong);
    }
  </style>
{% endblock %}

{% block portal_content %}
  <div class="accountant-card accountant-section">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h2 class="h5 mb-1">{{ employee.full_name }}</h2>
        <p class="text-muted small mb-0">{{ employee.get_role_display }} - {{ employee.get_status_display }}</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="{% url 'accounts:accountant_portal_payroll_deductions' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fa-solid fa-arrow-left me-1"></i> Payroll deductions
        </a>
        {% if accountant_can_edit_payroll %}
          <span class="status-pill"><i class="fa-solid fa-pen-to-square"></i> Editing enabled</span>
        {% else %}
          <span class="status-pill"><i class="fa-solid fa-lock"></i> Read-only</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="accountant-card">
        <h5 class="mb-3">Tax profile</h5>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="save_tax_profile" value="1">
          {% if tax_form.non_field_errors %}
            <div class="alert alert-danger small">{{ tax_form.non_field_errors }}</div>
          {% endif %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Province</label>
              {{ tax_form.province }}
              {% if tax_form.province.errors %}
                <div class="text-danger small mt-1">{{ tax_form.province.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Additional withholding</label>
              {{ tax_form.additional_withholding }}
              {% if tax_form.additional_withholding.errors %}
                <div class="text-danger small mt-1">{{ tax_form.additional_withholding.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Federal claim amount</label>
              {{ tax_form.federal_claim_amount }}
              {% if tax_form.federal_claim_amount.errors %}
                <div class="text-danger small mt-1">{{ tax_form.federal_claim_amount.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label">Provincial claim amount</label>
              {{ tax_form.provincial_claim_amount }}
              {% if tax_form.provincial_claim_amount.errors %}
                <div class="text-danger small mt-1">{{ tax_form.provincial_claim_amount.errors|striptags }}</div>
              {% endif %}
            </div>
            <div class="col-md-4">
              <div class="form-check">
                {{ tax_form.cpp_exempt|add_class:'form-check-input' }}
                <label class="form-check-label" for="{{ tax_form.cpp_exempt.id_for_label }}">CPP exempt</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check">
                {{ tax_form.cpp2_exempt|add_class:'form-check-input' }}
                <label class="form-check-label" for="{{ tax_form.cpp2_exempt.id_for_label }}">CPP2 exempt</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check">
                {{ tax_form.ei_exempt|add_class:'form-check-input' }}
                <label class="form-check-label" for="{{ tax_form.ei_exempt.id_for_label }}">EI exempt</label>
              </div>
            </div>
          </div>
          <div class="mt-3">
            {% if accountant_can_edit_payroll %}
              <button type="submit" class="btn btn-primary btn-sm">Save tax profile</button>
            {% else %}
              <p class="text-muted small mb-0">Tax profile updates require full access.</p>
            {% endif %}
          </div>
        </form>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="accountant-card mb-4">
        <h5 class="mb-3">Add recurring deduction</h5>
        {% if accountant_can_edit_payroll %}
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="add_deduction" value="1">
            {% if deduction_form.non_field_errors %}
              <div class="alert alert-danger small">{{ deduction_form.non_field_errors }}</div>
            {% endif %}
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Name</label>
                {{ deduction_form.name }}
                {% if deduction_form.name.errors %}
                  <div class="text-danger small mt-1">{{ deduction_form.name.errors|striptags }}</div>
                {% endif %}
              </div>
              <div class="col-12">
                <label class="form-label">Amount (per pay)</label>
                {{ deduction_form.amount }}
                {% if deduction_form.amount.errors %}
                  <div class="text-danger small mt-1">{{ deduction_form.amount.errors|striptags }}</div>
                {% endif %}
              </div>
              <div class="col-12">
                <div class="form-check">
                  {{ deduction_form.is_pre_tax|add_class:'form-check-input' }}
                  <label class="form-check-label" for="{{ deduction_form.is_pre_tax.id_for_label }}">Pre-tax deduction</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-check">
                  {{ deduction_form.is_employee_contribution|add_class:'form-check-input' }}
                  <label class="form-check-label" for="{{ deduction_form.is_employee_contribution.id_for_label }}">Employee contribution</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-check">
                  {{ deduction_form.is_employer_contribution|add_class:'form-check-input' }}
                  <label class="form-check-label" for="{{ deduction_form.is_employer_contribution.id_for_label }}">Employer contribution</label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-check">
                  {{ deduction_form.active|add_class:'form-check-input' }}
                  <label class="form-check-label" for="{{ deduction_form.active.id_for_label }}">Active</label>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <button type="submit" class="btn btn-outline-primary btn-sm">Add deduction</button>
            </div>
          </form>
        {% else %}
          <p class="text-muted small mb-0">Full access is required to add deductions.</p>
        {% endif %}
      </div>

      <div class="accountant-card">
        <h6 class="mb-3">Current deductions</h6>
        {% if deduction_forms %}
          {% for item in deduction_forms %}
            <form method="post" class="border-top pt-3 mt-3">
              {% csrf_token %}
              <input type="hidden" name="update_deduction" value="1">
              <input type="hidden" name="deduction_id" value="{{ item.deduction.id }}">
              {% if item.form.non_field_errors %}
                <div class="alert alert-danger small">{{ item.form.non_field_errors }}</div>
              {% endif %}
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Name</label>
                  {{ item.form.name }}
                  {% if item.form.name.errors %}
                    <div class="text-danger small mt-1">{{ item.form.name.errors|striptags }}</div>
                  {% endif %}
                </div>
                <div class="col-12">
                  <label class="form-label">Amount (per pay)</label>
                  {{ item.form.amount }}
                  {% if item.form.amount.errors %}
                    <div class="text-danger small mt-1">{{ item.form.amount.errors|striptags }}</div>
                  {% endif %}
                </div>
                <div class="col-12">
                  <div class="form-check">
                    {{ item.form.is_pre_tax|add_class:'form-check-input' }}
                    <label class="form-check-label" for="{{ item.form.is_pre_tax.id_for_label }}">Pre-tax deduction</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    {{ item.form.is_employee_contribution|add_class:'form-check-input' }}
                    <label class="form-check-label" for="{{ item.form.is_employee_contribution.id_for_label }}">Employee contribution</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    {{ item.form.is_employer_contribution|add_class:'form-check-input' }}
                    <label class="form-check-label" for="{{ item.form.is_employer_contribution.id_for_label }}">Employer contribution</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    {{ item.form.active|add_class:'form-check-input' }}
                    <label class="form-check-label" for="{{ item.form.active.id_for_label }}">Active</label>
                  </div>
                </div>
              </div>
              {% if accountant_can_edit_payroll %}
                <div class="mt-3">
                  <button type="submit" class="btn btn-outline-primary btn-sm">Save changes</button>
                </div>
              {% endif %}
            </form>
          {% endfor %}
        {% else %}
          <div class="text-muted small">No deductions yet.</div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
