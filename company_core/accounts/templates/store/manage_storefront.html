{% extends 'customer_portal_base.html' %}
{% load humanize %}

{% block extra_css %}
<style>
  .storefront-filters {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem;
  }

  .floating-save {
    position: fixed;
    right: 1.5rem;
    bottom: 1.5rem;
    z-index: 1030;
  }

  .floating-save .btn {
    box-shadow: 0 14px 35px rgba(15, 23, 42, 0.25);
    border-radius: 999px;
    padding: 0.75rem 1.5rem;
  }

  .storefront-count {
    font-weight: 600;
  }

  .storefront-form {
    padding-bottom: 5rem;
  }

  @media (max-width: 767px) {
    .floating-save {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
    }

    .floating-save .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  {% include 'store/partials/_manage_store_nav.html' %}
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <div>
      <h1 class="h3 mb-1">Manage Online Store</h1>
      <p class="text-muted mb-0">Choose which inventory items are visible to customers on your public storefront.</p>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'accounts:inventory_category_groups' %}" class="btn btn-outline-secondary">
        <i class="fas fa-layer-group me-1"></i>
        Category Groups
      </a>
      <a href="{% url 'accounts:inventory_categories' %}" class="btn btn-outline-secondary">
        <i class="fas fa-tags me-1"></i>
        Categories
      </a>
      <a href="{% url 'accounts:inventory_products' %}" class="btn btn-outline-secondary">
        <i class="fas fa-boxes me-1"></i>
        Go to Inventory
      </a>
      <a href="{{ public_store_url }}" class="btn btn-outline-primary" target="_blank" rel="noopener">
        <i class="fas fa-external-link-alt me-1"></i>
        View Public Store
      </a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Category Groups</div>
          <div class="h4 mb-1">{{ active_group_count }} active</div>
          <div class="text-muted small">{{ group_count }} total</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Categories</div>
          <div class="h4 mb-1">{{ active_category_count }} active</div>
          <div class="text-muted small">{{ category_count }} total</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Published Products</div>
          <div class="h4 mb-1">{{ published_product_count }}</div>
          <div class="text-muted small">{{ product_count }} total</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="text-muted small">Promotions</div>
          <div class="h4 mb-1">{{ promotion_product_count }}</div>
          <div class="text-muted small">Featured: {{ featured_product_count }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      {% if product_count %}
      <p class="text-muted small mb-3">
        Update base pricing and inventory details in the Inventory > Products page. Promo price and featured settings apply to the storefront.
      </p>
      <div class="storefront-filters mb-4">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label fw-semibold" for="storefrontSearch">Search products</label>
            <input type="search" class="form-control" id="storefrontSearch" placeholder="Search name, SKU, or category">
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold" for="storefrontGroupFilter">Category Group</label>
            <select class="form-select" id="storefrontGroupFilter">
              <option value="">All groups</option>
              {% for group in group_options %}
              <option value="{{ group.id }}">{{ group.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold" for="storefrontCategoryFilter">Category</label>
            <select class="form-select" id="storefrontCategoryFilter">
              <option value="">All categories</option>
              {% for category in category_options %}
              <option value="{{ category.id }}" data-group-id="{{ category.group_id|default:'' }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold" for="storefrontStatusFilter">Status</label>
            <select class="form-select" id="storefrontStatusFilter">
              <option value="">All</option>
              <option value="published">Published</option>
              <option value="unpublished">Unpublished</option>
              <option value="featured">Featured</option>
              <option value="promo">Promotion</option>
            </select>
          </div>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
          <span class="text-muted small">Bulk actions for filtered results:</span>
          <button type="button" class="btn btn-outline-primary btn-sm" data-bulk-action="publish">
            Show filtered
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bulk-action="unpublish">
            Hide filtered
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" data-bulk-action="feature">
            Feature filtered
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bulk-action="unfeature">
            Unfeature filtered
          </button>
          <button type="button" class="btn btn-outline-dark btn-sm" id="storefrontResetFilters">
            Reset filters
          </button>
          <span class="ms-auto text-muted small">Showing <span class="storefront-count" id="storefrontResultCount">0</span></span>
        </div>
      </div>
      <form method="post" novalidate class="storefront-form">
        {% csrf_token %}
        {{ formset.management_form }}
        {% if formset.non_form_errors %}
        <div class="alert alert-danger" role="alert">
          {{ formset.non_form_errors }}
        </div>
        {% endif %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">Product</th>
                <th scope="col" class="text-nowrap">SKU</th>
                <th scope="col" class="text-nowrap">Sale Price</th>
                <th scope="col" class="text-nowrap">Promo Price</th>
                <th scope="col" class="text-nowrap">Featured</th>
                <th scope="col" class="text-nowrap">In Stock</th>
                <th scope="col" class="text-nowrap">Visible in Store</th>
              </tr>
            </thead>
            <tbody>
              {% for form in formset %}
              {{ form.id }}
              {% if form.non_field_errors %}
              <tr>
                <td colspan="7" class="text-danger small">{{ form.non_field_errors }}</td>
              </tr>
              {% endif %}
              <tr
                class="storefront-row"
                data-product-name="{{ form.instance.name|default_if_none:''|escape }}"
                data-product-sku="{{ form.instance.sku|default_if_none:''|escape }}"
                data-product-description="{{ form.instance.description|default_if_none:''|escape }}"
                data-category-id="{{ form.instance.category_id|default_if_none:'' }}"
                data-category-name="{{ form.instance.category.name|default_if_none:''|escape }}"
                data-group-id="{{ form.instance.category.group_id|default_if_none:'' }}"
                data-group-name="{{ form.instance.category.group.name|default_if_none:''|escape }}"
              >
                <td>
                  <div class="fw-semibold">{{ form.instance.name }}</div>
                  {% if form.instance.description %}
                  <div class="text-muted small text-truncate" style="max-width: 420px;">
                    {{ form.instance.description }}
                  </div>
                  {% endif %}
                </td>
                <td class="text-muted">{{ form.instance.sku }}</td>
                <td>${{ form.instance.sale_price|floatformat:2 }}</td>
                <td>
                  {{ form.promotion_price }}
                  {% if form.promotion_price.errors %}
                  <div class="text-danger small">{{ form.promotion_price.errors|join:', ' }}</div>
                  {% endif %}
                </td>
                <td>
                  <div class="form-check">
                    {{ form.is_featured }}
                    <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                      Feature
                    </label>
                  </div>
                  {% if form.is_featured.errors %}
                  <div class="text-danger small">{{ form.is_featured.errors|join:', ' }}</div>
                  {% endif %}
                </td>
                <td>{{ form.instance.quantity_in_stock|intcomma }}</td>
                <td>
                  <div class="form-check">
                    {{ form.is_published_to_store }}
                    <label class="form-check-label" for="{{ form.is_published_to_store.id_for_label }}">
                      Show on store
                    </label>
                  </div>
                  {% if form.is_published_to_store.errors %}
                  <div class="text-danger small">{{ form.is_published_to_store.errors|join:', ' }}</div>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="py-4 text-center text-muted">No products available. Add inventory first.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="floating-save">
          <button type="submit" class="btn btn-primary d-inline-flex align-items-center gap-2">
            <i class="fas fa-save"></i>
            Save changes
          </button>
        </div>
      </form>
      {% else %}
      <div class="py-5 text-center">
        <p class="lead mb-3">You don't have any products in inventory yet.</p>
        <a href="{% url 'accounts:inventory_products' %}" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i>
          Add inventory products
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const rows = Array.from(document.querySelectorAll('.storefront-row'));
    const searchInput = document.getElementById('storefrontSearch');
    const groupFilter = document.getElementById('storefrontGroupFilter');
    const categoryFilter = document.getElementById('storefrontCategoryFilter');
    const statusFilter = document.getElementById('storefrontStatusFilter');
    const resetButton = document.getElementById('storefrontResetFilters');
    const resultCount = document.getElementById('storefrontResultCount');
    const form = document.querySelector('.storefront-form');

    if (!rows.length || !searchInput || !groupFilter || !categoryFilter || !statusFilter || !resultCount) {
      return;
    }

    const getInput = (row, suffix) => row.querySelector(`[name$="${suffix}"]`);

    const getRowState = (row) => {
      const publishedInput = getInput(row, 'is_published_to_store');
      const featuredInput = getInput(row, 'is_featured');
      const promoInput = getInput(row, 'promotion_price');
      return {
        published: publishedInput ? publishedInput.checked : false,
        featured: featuredInput ? featuredInput.checked : false,
        hasPromo: promoInput ? promoInput.value.trim() !== '' : false,
        name: (row.dataset.productName || '').toLowerCase(),
        sku: (row.dataset.productSku || '').toLowerCase(),
        description: (row.dataset.productDescription || '').toLowerCase(),
        categoryName: (row.dataset.categoryName || '').toLowerCase(),
        groupName: (row.dataset.groupName || '').toLowerCase(),
        categoryId: row.dataset.categoryId || '',
        groupId: row.dataset.groupId || '',
      };
    };

    const filterCategoryOptions = () => {
      const selectedGroup = groupFilter.value;
      let hasSelection = false;
      Array.from(categoryFilter.options).forEach((option) => {
        if (!option.value) {
          option.hidden = false;
          option.disabled = false;
          return;
        }
        const optionGroup = option.dataset.groupId || '';
        const matches = !selectedGroup || optionGroup === selectedGroup;
        option.hidden = !matches;
        option.disabled = !matches;
        if (matches) {
          hasSelection = hasSelection || option.value === categoryFilter.value;
        }
      });
      if (!hasSelection && categoryFilter.value) {
        categoryFilter.value = '';
      }
    };

    const applyFilters = () => {
      const term = searchInput.value.trim().toLowerCase();
      const selectedGroup = groupFilter.value;
      const selectedCategory = categoryFilter.value;
      const status = statusFilter.value;
      let visibleCount = 0;

      rows.forEach((row) => {
        const state = getRowState(row);
        const matchesSearch = !term || [
          state.name,
          state.sku,
          state.description,
          state.categoryName,
          state.groupName,
        ].some((value) => value.includes(term));
        const matchesGroup = !selectedGroup || state.groupId === selectedGroup;
        const matchesCategory = !selectedCategory || state.categoryId === selectedCategory;

        let matchesStatus = true;
        if (status === 'published') {
          matchesStatus = state.published;
        } else if (status === 'unpublished') {
          matchesStatus = !state.published;
        } else if (status === 'featured') {
          matchesStatus = state.featured;
        } else if (status === 'promo') {
          matchesStatus = state.hasPromo;
        }

        const isVisible = matchesSearch && matchesGroup && matchesCategory && matchesStatus;
        row.classList.toggle('d-none', !isVisible);
        if (isVisible) {
          visibleCount += 1;
        }
      });

      resultCount.textContent = `${visibleCount} of ${rows.length}`;
    };

    const applyBulkAction = (action) => {
      rows.forEach((row) => {
        if (row.classList.contains('d-none')) {
          return;
        }
        const publishInput = getInput(row, 'is_published_to_store');
        const featuredInput = getInput(row, 'is_featured');
        if (action === 'publish' && publishInput) {
          publishInput.checked = true;
        }
        if (action === 'unpublish' && publishInput) {
          publishInput.checked = false;
        }
        if (action === 'feature' && featuredInput) {
          featuredInput.checked = true;
        }
        if (action === 'unfeature' && featuredInput) {
          featuredInput.checked = false;
        }
      });
      applyFilters();
    };

    document.querySelectorAll('[data-bulk-action]').forEach((button) => {
      button.addEventListener('click', () => applyBulkAction(button.dataset.bulkAction));
    });

    searchInput.addEventListener('input', applyFilters);
    groupFilter.addEventListener('change', () => {
      filterCategoryOptions();
      applyFilters();
    });
    categoryFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);

    if (resetButton) {
      resetButton.addEventListener('click', () => {
        searchInput.value = '';
        groupFilter.value = '';
        categoryFilter.value = '';
        statusFilter.value = '';
        filterCategoryOptions();
        applyFilters();
      });
    }

    if (form) {
      form.addEventListener('change', (event) => {
        if (event.target && event.target.matches('input[name$="is_published_to_store"], input[name$="is_featured"], input[name$="promotion_price"]')) {
          applyFilters();
        }
      });
    }

    filterCategoryOptions();
    applyFilters();
  });
</script>
{% endblock %}
