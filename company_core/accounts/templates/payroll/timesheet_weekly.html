{% extends 'customer_portal_base.html' %}

{% block content %}
<div class="page-shell">
    <div class="page-header">
        <div>
            <h2 class="mb-0">Weekly Timesheet Grid</h2>
            <div class="text-muted small">Enter Mon-Sun shifts for each employee.</div>
        </div>
        <div class="page-toolbar d-flex gap-2">
            <a class="btn btn-outline-secondary btn-sm" href="{% url 'accounts:timesheet_list' %}">Back to timesheets</a>
        </div>
    </div>

    {% include 'payroll/_nav.html' %}

    <div class="card mb-3">
        <div class="card-body d-flex flex-wrap align-items-end justify-content-between gap-3">
            <form method="get" class="d-flex flex-wrap gap-2 align-items-end">
                <div>
                    <label class="form-label">Week start</label>
                    <input type="date" name="week_start" class="form-control" value="{{ week_start|date:'Y-m-d' }}">
                </div>
                <button type="submit" class="btn btn-outline-primary">Go</button>
                <a class="btn btn-outline-secondary" href="{% url 'accounts:timesheet_weekly_grid' %}?week_start={{ prev_week_start|date:'Y-m-d' }}">Previous</a>
                <a class="btn btn-outline-secondary" href="{% url 'accounts:timesheet_weekly_grid' %}?week_start={{ next_week_start|date:'Y-m-d' }}">Next</a>
                <a class="btn btn-outline-secondary" href="{% url 'accounts:timesheet_weekly_grid' %}?week_start={{ week_start|date:'Y-m-d' }}&copy=1">Copy last week</a>
            </form>
            <div class="d-flex flex-wrap gap-2 align-items-end">
                <div>
                    <label class="form-label">Shift template</label>
                    <select id="weekly-shift-template" class="form-select">
                        <option value="">Select shift</option>
                        {% for template in shift_templates %}
                        <option value="{{ template.id }}" data-start="{{ template.start_time|time:'H:i' }}" data-end="{{ template.end_time|time:'H:i' }}">
                            {{ template.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" class="btn btn-outline-secondary" id="weekly-shift-apply">Fill empty cells</button>
            </div>
        </div>
    </div>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="week_start" value="{{ week_start|date:'Y-m-d' }}">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0 align-middle">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                {% for date in week_dates %}
                                <th class="text-center">{{ date|date:"D M j" }}</th>
                                {% endfor %}
                                <th class="text-center">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in grid_rows %}
                            <tr data-employee-id="{{ row.employee.id }}">
                                <td>
                                    <div class="fw-semibold">{{ row.employee.full_name }}</div>
                                    <button type="button" class="btn btn-link p-0 small text-decoration-none apply-row-shift">Fill row</button>
                                </td>
                                {% for day in row.days %}
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <input type="time" class="form-control form-control-sm start-time" name="start_time_{{ row.employee.id }}_{{ day.date|date:'Y-m-d' }}" value="{{ day.start_time }}">
                                        <input type="time" class="form-control form-control-sm end-time" name="end_time_{{ row.employee.id }}_{{ day.date|date:'Y-m-d' }}" value="{{ day.end_time }}">
                                    </div>
                                </td>
                                {% endfor %}
                                <td class="text-center small text-muted total-hours">0.00</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center py-4">No employees found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">Save week</button>
            <a href="{% url 'accounts:timesheet_list' %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    (function () {
        const shiftSelect = document.getElementById('weekly-shift-template');
        const applyAllBtn = document.getElementById('weekly-shift-apply');

        const parseTime = (value) => {
            if (!value) return null;
            const parts = value.split(':');
            if (parts.length < 2) return null;
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            if (Number.isNaN(hours) || Number.isNaN(minutes)) {
                return null;
            }
            return hours * 60 + minutes;
        };

        const calculateRowTotal = (row) => {
            let total = 0;
            row.querySelectorAll('td').forEach((cell) => {
                const startInput = cell.querySelector('.start-time');
                const endInput = cell.querySelector('.end-time');
                if (!startInput || !endInput) return;
                const startMinutes = parseTime(startInput.value);
                const endMinutes = parseTime(endInput.value);
                if (startMinutes === null || endMinutes === null) return;
                let diff = endMinutes - startMinutes;
                if (diff < 0) {
                    diff += 24 * 60;
                }
                total += diff / 60;
            });
            const totalCell = row.querySelector('.total-hours');
            if (totalCell) {
                totalCell.textContent = total.toFixed(2);
            }
        };

        const applyShift = (row) => {
            if (!shiftSelect) return;
            const option = shiftSelect.options[shiftSelect.selectedIndex];
            if (!option || !option.dataset) return;
            const startValue = option.dataset.start;
            const endValue = option.dataset.end;
            if (!startValue || !endValue) return;

            row.querySelectorAll('td').forEach((cell) => {
                const startInput = cell.querySelector('.start-time');
                const endInput = cell.querySelector('.end-time');
                if (!startInput || !endInput) return;
                if (!startInput.value && !endInput.value) {
                    startInput.value = startValue;
                    endInput.value = endValue;
                }
            });
            calculateRowTotal(row);
        };

        if (applyAllBtn) {
            applyAllBtn.addEventListener('click', () => {
                document.querySelectorAll('tbody tr').forEach((row) => applyShift(row));
            });
        }

        document.querySelectorAll('.apply-row-shift').forEach((button) => {
            button.addEventListener('click', (event) => {
                const row = event.target.closest('tr');
                if (row) {
                    applyShift(row);
                }
            });
        });

        document.querySelectorAll('tbody tr').forEach((row) => {
            row.addEventListener('change', () => calculateRowTotal(row));
            calculateRowTotal(row);
        });
    })();
</script>
{% endblock %}
