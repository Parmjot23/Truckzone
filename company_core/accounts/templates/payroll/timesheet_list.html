{% extends 'customer_portal_base.html' %}

{% block content %}
<div class="page-shell">
    <div class="page-header">
        <div>
            <h2 class="mb-0">Timesheets</h2>
            <div class="text-muted small">Track hours for payroll runs.</div>
        </div>
        <div class="page-toolbar d-flex gap-2">
            <a href="{% url 'accounts:timesheet_weekly_grid' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-calendar-week me-1"></i>Weekly Grid
            </a>
            <a href="{% url 'accounts:timesheet_bulk_entry' %}" class="btn btn-outline-primary btn-sm">
                <i class="fa-solid fa-layer-group me-1"></i>Bulk Entry
            </a>
            <a href="{% url 'accounts:timesheet_import' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-file-import me-1"></i>Import/Export
            </a>
            <a href="{% url 'accounts:timesheet_create' %}" class="btn btn-primary btn-sm">
                <i class="fa-solid fa-clock me-1"></i>Add Timesheet
            </a>
        </div>
    </div>

    {% include 'payroll/_nav.html' %}

    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small">Total</div>
                    <div class="fs-5">{{ total_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small">Draft</div>
                    <div class="fs-5">{{ status_counts.draft }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small">Submitted</div>
                    <div class="fs-5">{{ status_counts.submitted }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small">Approved</div>
                    <div class="fs-5">{{ status_counts.approved }}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-3 align-items-end">
            <div>
                <label class="form-label">Employee</label>
                <select id="timesheet-employee-filter" class="form-select">
                    <option value="">All employees</option>
                    {% for employee in employees %}
                    <option value="{{ employee.id }}" {% if selected_employee_id == employee.id %}selected{% endif %}>
                        {{ employee.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="button" class="btn btn-outline-primary" id="timesheet-employee-open">
                    Open timesheet
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <div class="card-body border-bottom d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="text-muted small">Select timesheets to submit or approve in bulk.</div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" name="action" value="submit" type="submit">
                        Submit selected
                    </button>
                    <button class="btn btn-outline-primary btn-sm" name="action" value="approve" type="submit">
                        Approve selected
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table mb-0 table-hover">
                    <thead>
                        <tr>
                            <th>
                                <input class="form-check-input" type="checkbox" id="timesheet-select-all">
                            </th>
                            <th>Employee</th>
                            <th>Period</th>
                            <th>Status</th>
                            <th>Match</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for timesheet in timesheets %}
                        <tr {% if timesheet.mismatch_count %}class="table-warning"{% endif %}>
                            <td>
                                <input class="form-check-input timesheet-select" type="checkbox" name="timesheet_id" value="{{ timesheet.id }}">
                            </td>
                            <td>{{ timesheet.employee.full_name }}</td>
                            <td>{{ timesheet.period_start }} - {{ timesheet.period_end }}</td>
                            <td>{{ timesheet.get_status_display }}</td>
                            <td>
                                {% if timesheet.has_submission %}
                                    {% if timesheet.mismatch_count %}
                                        <span class="badge bg-warning text-dark">
                                            {{ timesheet.mismatch_count }} difference{% if timesheet.mismatch_count != 1 %}s{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success">Matched</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted small">No submission yet</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary" href="{% url 'accounts:timesheet_detail' timesheet.id %}">Open</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-4">No timesheets yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
</div>
<script>
    (function () {
        const selectEl = document.getElementById('timesheet-employee-filter');
        const openBtn = document.getElementById('timesheet-employee-open');
        if (!selectEl || !openBtn) {
            return;
        }
        const listUrl = "{% url 'accounts:timesheet_list' %}";
        const redirectBase = "{% url 'accounts:timesheet_employee_redirect' %}";

        const navigateToList = (value) => {
            if (!value) {
                window.location = listUrl;
                return;
            }
            window.location = `${listUrl}?employee_id=${value}`;
        };

        selectEl.addEventListener('change', () => {
            navigateToList(selectEl.value);
        });

        openBtn.addEventListener('click', () => {
            const value = selectEl.value;
            if (!value) {
                window.location = listUrl;
                return;
            }
            window.location = `${redirectBase}?employee_id=${value}`;
        });

        const selectAll = document.getElementById('timesheet-select-all');
        if (selectAll) {
            selectAll.addEventListener('change', () => {
                document.querySelectorAll('.timesheet-select').forEach((checkbox) => {
                    checkbox.checked = selectAll.checked;
                });
            });
        }
    })();
</script>
{% endblock %}
